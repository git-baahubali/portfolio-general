"use strict";(this.webpackChunk_hz_project_x=this.webpackChunk_hz_project_x||[]).push([[15957],{915561:(e,t,r)=>{var s=r(501933).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(6035),n=r(464964),i=r(528224),a=r(29578);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c,l,h=d(o),u=d(i);t.HeaderKeys=void 0,(c=t.HeaderKeys||(t.HeaderKeys={})).CONTENT_ID="content-id",c.CONTENT_LENGTH="content-length",c.CONTENT_TYPE="content-type",c.IF_MATCH="if-match",c.IF_NONE_MATCH="if-none-match",t.HTTPMethods=void 0,(l=t.HTTPMethods||(t.HTTPMethods={})).GET="GET",l.PUT="PUT",l.PATCH="PATCH",l.HEAD="HEAD",l.POST="POST",l.DELETE="DELETE";const p={ACCESS_CHECK:"http://ns.adobe.com/adobecloud/rel/ac/check",ACL_POLICY:"http://ns.adobe.com/adobecloud/rel/ac/policy",ANNOTATIONS:"http://ns.adobe.com/adobecloud/rel/annotations",APP_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/application",BASE_DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory/base",BLOCK_DOWNLOAD:"http://ns.adobe.com/adobecloud/rel/download",BLOCK_EXTEND:"http://ns.adobe.com/adobecloud/rel/block/extend",BLOCK_FINALIZE:"http://ns.adobe.com/adobecloud/rel/block/finalize",BLOCK_TRANSFER:"http://ns.adobe.com/adobecloud/rel/block/transfer",BLOCK_UPLOAD_INIT:"http://ns.adobe.com/adobecloud/rel/block/init",BULK_REQUEST:"http://ns.adobe.com/adobecloud/rel/bulk",COMPONENT:"http://ns.adobe.com/adobecloud/rel/component",CREATE:"http://ns.adobe.com/adobecloud/rel/create",DESCRIBED_BY:"describedBy",DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory",DISCARD:"http://ns.adobe.com/adobecloud/rel/discard",EFFECTIVE_PRIVILAGES:"http://ns.adobe.com/adobecloud/rel/ac/effective",EMBEDDED_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/embedded",ID:"http://ns.adobe.com/adobecloud/rel/id",MANIFEST:"http://ns.adobe.com/adobecloud/rel/manifest",PAGE:"http://ns.adobe.com/adobecloud/rel/page",PATH:"http://ns.adobe.com/adobecloud/rel/path",PRIMARY:"http://ns.adobe.com/adobecloud/rel/primary",RENDITION:"http://ns.adobe.com/adobecloud/rel/rendition",REPO_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/repository",REPO_OPS:"http://ns.adobe.com/adobecloud/rel/ops",REPOSITORY:"http://ns.adobe.com/adobecloud/rel/repository",RESOLVE_BY_ID:"http://ns.adobe.com/adobecloud/rel/resolve/id",RESOLVE_BY_PATH:"http://ns.adobe.com/adobecloud/rel/resolve/path",RESTORE:"http://ns.adobe.com/adobecloud/rel/restore",VERSION_HISTORY:"version-history"},f="application/vnd.adobecloud.directory+json",_="application/vnd.adobe.dcx-manifest+json",m="application/json-patch+json",E="application/vnd.adobecloud.bulk-transfer+json";var g,A,C,D,I,y;t.Properties=void 0,(g=t.Properties||(t.Properties={})).DC_FORMAT="dc:format",g.DC_TITLE="dc:title",g.LINKS="_links",g.PAGE="_page",g.CHILDREN="children",g.EMBEDDED="_embedded",g.REPO_ASSET_ID="repo:assetId",g.REPO_REPOSITORY_ID="repo:repositoryId",g.REPO_REPOSITORY_TYPE="repo:repositoryType",g.REPO_BASE_ASSET_ID="repo:baseAssetId",g.REPO_SIZE="repo:size",g.REPO_NAME="repo:name",g.REPO_PATH="repo:path",g.REPO_ASSET_CLASS="repo:assetClass",g.REPO_CREATE_DATE="repo:createDate",g.REPO_MODIFY_DATE="repo:modifyDate",g.REPO_DISCARD_DATE="repo:discardDate",g.REPO_ETAG="repo:etag",g.REPO_CREATED_BY="repo:createdBy",g.REPO_MODIFIED_BY="repo:modifiedBy",g.REPO_DISCARDED_BY="repo:discardedBy",g.REPO_DEVICE_CREATE_DATE="storage:deviceCreateDate",g.REPO_DEVICE_MODIFY_DATE="storage:deviceModifyDate",g.REPO_VERSION="repo:version",g.REPO_STATE="repo:state",g.REPO_AVAILABLE_REGIONS="repo:availableRegions",g.REPO_REGIONS="repo:regions",g.REPO_OWNER="repo:owner",g.REPO_OWNER_ID="id",g.REPO_OWNER_TYPE="type",g.STORAGE_ASSIGNEE="storage:assignee",g.STORAGE_ASSIGNEE_ID="id",g.STORAGE_ASSIGNEE_TYPE="type",g.IMAGE_LENGTH="tiff:imageLength",g.IMAGE_WIDTH="tiff:imageWidth",g.NUM_OF_PAGES="xmpTPg:NPages",g.PAGE_START="start",g.PAGE_ORDER_BY="orderBy",g.PAGE_NEXT="next",g.PAGE_COUNT="count",g.PAGE_LIMIT="limit",t.VersionProperties=void 0,(A=t.VersionProperties||(t.VersionProperties={})).REPO_ID="repo:id",A.CREATED="created",A.CREATED_BY="created_by",A.MILESTONE="milestone",A.VERSION="version",A.TOTAL_CHILDREN="total_children",t.PolicyProperties=void 0,(C=t.PolicyProperties||(t.PolicyProperties={})).REPO_ACL="repo:acl",C.REPO_PRINCIPLE="repo:principal",C.REPO_MODIFIER="repo:modifier",C.REPO_PRIVILEGES="repo:privileges",C.REPO_RELATIONS="repo:relations",C.REPO_INHERITANCE="repo:inheritance",t.PolicyPrincipalProperties=void 0,(D=t.PolicyPrincipalProperties||(t.PolicyPrincipalProperties={})).XDM_PROVIDER="xdm:provider",D.ID="@id",D.TYPE="@type",t.XDMProviderProperties=void 0,(t.XDMProviderProperties||(t.XDMProviderProperties={})).ID="@id",t.EmbeddedMetadataMediaTypes=void 0,(I=t.EmbeddedMetadataMediaTypes||(t.EmbeddedMetadataMediaTypes={})).XML="application/rdf+xml",I.JSON="application/ld+json",t.BlockTransferProperties=void 0,(y=t.BlockTransferProperties||(t.BlockTransferProperties={})).REPO_SIZE="repo:size",y.REPO_BLOCK_SIZE="repo:blocksize",y.REPO_REL_TYPE="repo:reltype",y.COMPONENT_ID="component_id",y.DC_FORMAT="dc:format",y.REPO_MD5="repo:md5",y.REPO_EXPIRES="repo:expires",y.REPO_IF_MATCH="repo:if-match",y.MAX_SINGLE_TRANSFER_SIZE="repo:maxSingleTransferSize",y.REPO_MIN_BLOCK_TRANSFER_SIZE="repo:minBlockTransferSize";const v=["buffer","arraybuffer","string","text","blob","json","stream","defaultbuffer"];function T(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}function b(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function P(e){const t="string"==typeof e?JSON.parse(e):e;return"repo:acl"in t&&Array.isArray(t["repo:acl"])}function R(e){return!!a.isObject(e)&&"headers"in e&&"responseType"in e&&"statusCode"in e&&"xhr"in e}function w(e){return!!a.isObject(e)&&R(e.response)}function O(e){return!!a.isObject(e)&&w(e)&&"result"in e}function N(e){return a.isObject(e)&&a.isFunction(e.slice)}function S(e){return!!a.isObject(e)&&"resolvePullWithBranch"in e}function L(e){return"undefined"!=typeof Blob&&e instanceof Blob}function k(e){return!!a.isObject(e)&&("string"==typeof e.repositoryId&&"string"==typeof e.path||"string"==typeof e.assetId)}function M(e){return a.isObject(e)&&("AdobeHTTPService"===e.name||a.isFunction(e.invoke))}function X(e){return a.isObject(e)&&M(e.service)}function x(e){if(!a.isObject(e))return!1;const r=e[t.Properties.LINKS];return!!a.isObject(r)&&!!(r[p.BLOCK_TRANSFER]&&r[p.BLOCK_EXTEND]&&r[p.BLOCK_FINALIZE])}const U=n.newDebug("dcx:assets:service"),B=e=>X(e)?e.service:e,j=e=>X(e)?e.cache:void 0;function V(e,t){U("constructServiceEndpoint()",e);const r=t._repoAPIBaseUrl;return r&&(e=`${r.endsWith("/")?r.substr(0,r.length-1):r}${e}`),U("cSE()",e),e}const H=(e,t,r)=>{if(null==t&&null==r&&null==e)return o._defaultStatusValidator;const s=r||{},n=t||{},i=e||[];return(e,t)=>{var r,a;if(!e||!t)return new h.default(o.ErrorCodes.NETWORK_ERROR,"Invalid or missing status code",void 0,t);if(i.includes(e))return!0;const d=n[e]||(null===(r=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===r?void 0:r.message)||"Unexpected response",c=s[e]||(null===(a=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===a?void 0:a.code),l=o._defaultStatusValidator(e,t);return!0===l&&null==c||(o.isAdobeDCXError(l)?l:!!c&&new h.default(c,d,void 0,t))}},F=(e,t=[],r,s)=>{if(!a.isObject(e))throw new h.default(r||h.default.INVALID_PARAMS,s||"Missing or invalid links on Asset");t.map((t=>{if(!(t in e)||!a.isObject(e[t]))throw new h.default(r||h.default.INVALID_PARAMS,s||`Missing required link: ${t}`)}))},Y=(e={},t=[])=>{if(0!==t.length){for(let r=0;r<t.length;r++){const s=t[r];if(s in e&&a.isObject(e[s]))return s}throw new h.default(h.default.INVALID_PARAMS,`Missing links, one required: ${t.join(", ")}`)}},W=(e,t,r,s)=>{const o=a.getLinkProperty(e,t,r);if(!o)throw new h.default(h.default.INVALID_DATA,`Missing ${r} param on Link`);if(o!==s)throw new h.default(h.default.INVALID_DATA,`Invalid ${r} param on Link, expected ${s}`)},q=(e,t=[])=>{try{F(e,t)}catch(e){return!1}return!0},z=(e,t=[])=>q(e.links||e._links,t);function G(e){if(!k(e))throw new h.default(h.default.INVALID_PARAMS,"Asset must contain links or repositoryId + path or assetId to be resolved.")}function K(e,t,r){if(!a.isObject(e))throw new h.default(h.default.INVALID_PARAMS,`Invalid parameter. Expected object, encountered "${null===e?"null":typeof e}".`);if(!(t in e))throw new h.default(h.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${t}".`);if(r)try{a.validateParam(t,e[t],r)}catch(s){throw new h.default(h.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${t}" with type "${r}", encountered type "${typeof e[t]}".`)}}function $(e,t,r){if(!(t.length<1)){for(const s of t)try{return void K(e,s,r)}catch(e){}throw new h.default(h.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing one of [${t.join(", ")}]`+(r?` with type ${r}, encountered types [${t.map((t=>typeof e[t])).join(", ")}].`:"."))}}const J=n.newDebug("dcx:assets:util:http");function Z(e,r,s){return J("headHTTPResource()"),B(e).invoke(t.HTTPMethods.HEAD,r,s,void 0,{isStatusValid:H()})}function Q(e,r,s,o){return B(e).invoke(t.HTTPMethods.GET,r,s,void 0,{isStatusValid:H(),responseType:o})}const ee=n.newDebug("dcx:assets:util:link");function te(e,t){ee("getIndexLinks()");const r=B(e),s=j(e);if(s){const e=s.getIndexLinks();if(e)return u.default.resolve(e);s.setPending("INDEX")}return Z(r,V("/",r),t).then((e=>se(e))).then((e=>(s&&s.setIndexLinks(e),e))).catch((e=>{throw s&&s.delete("INDEX"),e}))}function re(e,r){ee("getIndexDocument()");const s=B(e),o=j(e);if(o){const e=o.getIndexRepository();if(e)return u.default.resolve(e)}const n=V("/",s);return s.invoke(t.HTTPMethods.GET,n,r,void 0,{responseType:"json",isStatusValid:H()}).then((e=>{const r=se(e),s=e.response,n={};for(const e in s.children){const r=s.children[e],o=r[t.Properties.LINKS];switch(r[t.Properties.REPO_PATH]){case"/Index.json":n.indexLinks=o;break;case"/Assets.json":n.assetLinks=o;break;case"/Repositories.json":n.repositoryLinks=o}}return o&&(o.setIndexLinks(r),o.setIndexRepository(n)),n}))}function se(e){if(!e.headers||!e.headers.link)throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, missing link header");return oe(e.headers.link)}function oe(e){try{const r=a.parse(e),s={};for(const e in r.refs){const o=r.refs[e],{rel:n,uri:i,templated:d,type:c,width:l,height:h}=o,u=T(o,["rel","uri","templated","type","width","height"]),p=a.pruneUndefined({href:i,templated:d?"true"===d:void 0,type:c,width:l,height:h,[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE]:u[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE],[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE]:u[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE]});["width","height"].filter((e=>e in p)).forEach((e=>{const t=parseInt(p[e],10);isNaN(t)||(p[e]=t)}));const f=s[n];Array.isArray(f)?f.push(p):s[n]=f?[f,p]:p}return Object.assign({},s)}catch(e){throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, invalid link header",e)}}function ne(e,t){if(a.isObject(this)){if("string"==typeof this.opsHref)return u.default.resolve(this.opsHref);if(a.isFunction(this.opsHref))return u.default.resolve(this.opsHref())}return te(e,t).then((e=>{try{return a.getLinkHref(e,p.REPO_OPS)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ops href.",e)}}))}const ie=n.newDebug("dcx:assets:util:serialization");function ae(e,r){ie("deserializeAsset()");const s={};return s.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],s.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],s.name=e.name||e[t.Properties.REPO_NAME],s.size=null!=e.size?e.size:e[t.Properties.REPO_SIZE],s.path=e.path||e[t.Properties.REPO_PATH],s.assetClass=e.etag||e[t.Properties.REPO_ASSET_CLASS],s.etag=e.etag||e[t.Properties.REPO_ETAG],s.version=e.version||e[t.Properties.REPO_VERSION],s.format=e.format||e[t.Properties.DC_FORMAT],s.md5=e.md5,s.createDate=e.createDate||e[t.Properties.REPO_CREATE_DATE],s.modifyDate=e.modifyDate||e.modifiedDate||e[t.Properties.REPO_MODIFY_DATE],s.discardDate=e.discardDate||e[t.Properties.REPO_DISCARD_DATE],s.createdBy=e.createdBy||e[t.Properties.REPO_CREATED_BY],s.modifiedBy=e.modifiedBy||e[t.Properties.REPO_MODIFIED_BY],s.discardedBy=e.discardedBy||e[t.Properties.REPO_DISCARDED_BY],s.deviceCreateDate=e.deviceCreateDate||e[t.Properties.REPO_DEVICE_CREATE_DATE],s.deviceModifyDate=e.deviceModifyDate||e[t.Properties.REPO_DEVICE_MODIFY_DATE],s.baseAssetId=e.baseAssetId||e[t.Properties.REPO_BASE_ASSET_ID],s.state=e.state||e[t.Properties.REPO_STATE],s.links=e.links||e[t.Properties.LINKS],r&&(r[p.EFFECTIVE_PRIVILAGES]&&(s.embedded={EffectivePrivileges:r[p.EFFECTIVE_PRIVILAGES]}),r[p.REPOSITORY]&&(s.embedded=a.merge({},s.embedded,{RepositoryResource:de(r[p.REPOSITORY])}))),e[t.Properties.EMBEDDED]&&(e[t.Properties.EMBEDDED][p.EFFECTIVE_PRIVILAGES]&&(s.embedded={EffectivePrivileges:e._embedded[p.EFFECTIVE_PRIVILAGES]}),e[t.Properties.EMBEDDED][p.REPOSITORY]&&(s.embedded=a.merge({},s.embedded,{RepositoryResource:de(e._embedded[p.REPOSITORY])}))),a.pruneUndefined(s)}function de(e={}){return ie("deserializeRepository()"),{repositoryId:e[t.Properties.REPO_REPOSITORY_ID],repositoryType:e[t.Properties.REPO_REPOSITORY_TYPE],owner:e[t.Properties.REPO_OWNER],createDate:e[t.Properties.REPO_CREATE_DATE],title:e[t.Properties.DC_TITLE],availableRegions:e[t.Properties.REPO_AVAILABLE_REGIONS]}}const ce=n.newDebug("dcx:assets:operations"),le=n.newDebug("dcx:assets:operations:builder");function he(e,t,r,s,o,n){ce("copyAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0]),$(t,["repo:path","path","assetId","repo:assetId"],"string"),$(r,["repo:path","path","assetId","repo:assetId"],"string");const i=be("copy",r,t,{overwriteExisting:o,createIntermediates:s}),d=B(e);return ne.call(this,e).then((e=>Ce(d,e,i,n))).then(Ie.bind(void 0,r)).then(ye)}const ue=e=>"string"==typeof e?{reltype:e,component_id:"",revision:""}:e;function pe(e,t,r,s,o){ce("moveAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0]),$(t,["repo:path","path","assetId","repo:assetId"],"string"),$(r,["repo:path","path","assetId","repo:assetId"],"string");const n=be("move",r,t,{createIntermediates:s,overwriteExisting:o}),i=B(e);return ne.call(this,e).then((e=>Ce(i,e,n))).then(Ie.bind(void 0,r)).then(ye)}function fe(e,t,r,s){ce("discardAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["etag",r,"string",!0],["recursive",s,"boolean",!0]);const o=B(e);$(t,["repo:path","path","assetId","repo:assetId"],"string");const n=be("discard",Object.assign(Object.assign({},t),{etag:r}),void 0,{recursive:s});return ne.call(this,e).then((e=>Ce(o,e,n))).then(ve)}function _e(e,r,s="*",o){ce("deleteAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0],["recursive",o,"boolean",!0]);const n=B(e);if(r.format===f&&null==o)throw new h.default(h.default.INVALID_PARAMS,"Recursive flag is required for directory assets.");if(!o&&z(r,[p.REPO_METADATA])){const e=a.getLinkHrefTemplated(r,p.REPO_METADATA,{});return n.invoke("DELETE",e,{[t.HeaderKeys.IF_MATCH]:s},void 0,{isStatusValid:H()}).then(ve)}$(r,["repo:path","path","assetId","repo:assetId"],"string");const i=Object.create(Object.getPrototypeOf(r),Object.getOwnPropertyDescriptors(r));i.etag=s;const d=be("delete",i,void 0,{recursive:o});return ne.call(this,e).then((e=>Ce(n,e,d))).then(ve)}function me(e,t){ce("restoreAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const r=B(e);$(t,["assetId","repo:assetId"],"string");const s=be("restore",t);return ne.call(this,e).then((e=>Ce(r,e,s))).then(Ie.bind(void 0,t)).then(ye)}function Ee(e,t,r,s,o){var n;ce("packageAssets()"),a.validateParams(["svc",e,"object"],["destination",r,"object"]),a.validateParam("sources",t,["object","object[]"]),t=a.isArray(t)?t:[t],n=["repo:path","path","assetId","repo:assetId"],t.map((e=>$(e,n,"string"))),$(r,["repo:path","path","assetId","repo:assetId"],"string");const i=be("package",r,t,{createIntermediates:s,overwriteExisting:o}),d=B(e);return ne.call(this,e).then((e=>Ce(d,e,i))).then(Ie.bind(void 0,r)).then(ve)}function ge(e){return{result:(a.isArray(e.response)?e.response:[e.response]).map(Ae),response:e}}function Ae(e){if(!e.error)return e;const t=Object.assign({},e),r=H()(e.error.status);return t.error=o.isAdobeDCXError(r)?r:new h.default(h.default.UNEXPECTED,"Unexpected response"),t._additionalData=e.error,t.error._message=e.error.title,t}function Ce(e,r,s,o){return ce("doOperation()"),a.validateParams(["svc",e,"object"],["opsEndpoint",r,"string"],["operationDocument",s,["string","object"]],["additionalHeaders",o,"object",!0]),function(e,r,s,o={}){return e.invoke(t.HTTPMethods.POST,r,Object.assign({[t.HeaderKeys.CONTENT_TYPE]:"application/vnd.adobe.asset-operation+json"},o),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"get"}})}(e,r,s,o).then((e=>{if(e.response=e.response||{},e.response.error)throw new h.default(h.default.UNEXPECTED_RESPONSE,e.response.type||"Operation failed.",new Error(e.response.title),e);return e}))}class De{constructor(){this.opBatchLimit=100,this._docs=[]}getDocumentEntry(e){return this._docs[e]}getDocument(){return this._docs}get entryCount(){return this._docs.length}copyResources(e,t,r){le("copyResource()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const s=be("copy_resources",t,e,void 0,{resources:r});return this._docs.push(s),this}copy(e,t,r,s,o){le("copy()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=be("copy",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}move(e,t,r,s,o){le("move()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=be("move",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}package(e,t,r,s,o){le("package()"),this._assertUnderLimit(),(e=a.isArray(e)?e:[e]).map((e=>{this._checkSourceType(e)})),this._checkTargetType(t);const n=be("package",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}discard(e,t,r){le("discard()"),this._assertUnderLimit(),this._checkTargetType(e);const s=be("discard",e,void 0,{recursive:t},r);return this._docs.push(s),this}restore(e,t){le("restore()"),this._assertUnderLimit(),$(e,["href","assetId","repo:assetId"],"string"),this._checkTargetType(e);const r=be("restore",e,void 0,void 0,t);return this._docs.push(r),this}delete(e,t,r){le("delete()"),this._assertUnderLimit(),this._checkTargetType(e);const s=be("delete",e,void 0,{recursive:t},r);return this._docs.push(s),this}_assertUnderLimit(){if(this._docs.length>=this.opBatchLimit)throw new h.default(h.default.INVALID_STATE,`Exceeds limit of ${this.opBatchLimit} operations in a single batch.`)}_checkTargetType(e){this._checkSourceOrTargetType(e,"Target")}_checkSourceType(e){this._checkSourceOrTargetType(e,"Source")}_checkSourceOrTargetType(e,t){if(0===[!!e.href,!!e.assetId||!!e["repo:assetId"],!!e.path||!!e["repo:path"]].filter((e=>e)).length)throw new h.default(h.default.INVALID_PARAMS,`${t} identifier is underspecified. Exactly one of [href, repo:path, repo:assetId] required.`);const r=this._getSourceType(e),s="Source"===t?this._batchSourceType:this._batchTargetType;if(s){if(r!==s)throw new h.default(h.default.INVALID_PARAMS,`Operation ${t.toLowerCase()} types must all be the same type. Expected ${s}, encountered ${r}.`)}else"Source"===t?this._batchSourceType=r:this._batchTargetType=r}_getSourceType(e){return e.href?"idBasedHref":e.assetId||e["repo:assetId"]?"id":e.path||e["repo:path"]?e.baseAssetId||e["repo:baseAssetId"]?"pathAndBaseAssetId":"path":void 0}}function Ie(e,t){return t.response.asset=Object.assign(Object.assign({},t.response.asset||{}),{repositoryId:e.repositoryId||e["repo:repositoryId"]}),t}function ye(e){return{response:e,result:ae(e.response.asset)}}function ve(e){return{response:e,result:{success:e.statusCode>199&&e.statusCode<400}}}function Te(e,r,s){if(ce("_convertToACPSource()"),"object"!=typeof r)return;const o={"repo:repositoryId":r.repositoryId||r["repo:repositoryId"],"repo:path":r.path||r["repo:path"],"repo:assetId":r.assetId||r["repo:assetId"],"repo:baseAssetId":r.baseAssetId||r["repo:baseAssetId"],href:r.href};return"string"==typeof o.href?(delete o["repo:path"],delete o["repo:assetId"],delete o["repo:baseAssetId"]):"string"==typeof o["repo:assetId"]&&(delete o["repo:path"],delete o["repo:baseAssetId"]),"target"===e?!0===s?o[t.HeaderKeys.IF_MATCH]="directory"!==r.format&&"directory"!==r["dc:format"]&&r.etag||"*":!1===s?o[t.HeaderKeys.IF_NONE_MATCH]="*":"directory"!==r.format&&"directory"!==r["dc:format"]&&(o[t.HeaderKeys.IF_MATCH]=r.etag):"directory"!==r.format&&"directory"!==r["dc:format"]&&(o[t.HeaderKeys.IF_MATCH]=r.etag||"*"),o["repo:path"]&&K(o,"repo:repositoryId","string"),ce("_cTACPS() out",o),a.pruneUndefined(o)}function be(e,t,r,s={},o={}){ce("_buildOperationDoc()");const n=a.pruneUndefined({op:e,target:t,source:a.isArray(r)?[]:r?{}:void 0}),{overwriteExisting:i,createIntermediates:d,recursive:c}=s;if(n.source&&(n.source=a.isArray(r)?r.map((e=>Te("source",e,i))).filter((e=>null!=e)):Te("source",r,i)),"object"==typeof t){const e=Te("target",t,i);e&&(n.target=e)}return null==n.target["repo:assetId"]&&null!=d&&(n.intermediates=d),null!=c&&(n.recursive=c),Object.assign(n,o),ce("_OD() doc",n),n}var Pe;t.BlockTransferStates=void 0,(Pe=t.BlockTransferStates||(t.BlockTransferStates={})).NOT_INITIALIZED="NOT_INITIALIZED",Pe.INITIALIZING="INITIALIZING",Pe.INITIALIZED="INITIALIZED",Pe.WAITING="WAITING",Pe.STARTED="STARTED",Pe.PAUSING="PAUSING",Pe.PAUSED="PAUSED",Pe.CANCELED="CANCELED",Pe.ERROR="ERROR",Pe.FINALIZING="FINALIZING",Pe.COMPLETE="COMPLETE";const Re=new class{constructor(){this._uploads=[],this._downloads=[],this._pendingUploadRequests=[],this._pendingDownloadRequests=[],this._downloadChunkSize=10485760}get downloads(){return this._downloads}get uploads(){return this._uploads}set downloadChunkSize(e){a.validateParams(["downloadChunkSize",e,"+number"]),this._downloadChunkSize=e}get downloadChunkSize(){return this._downloadChunkSize}get pendingUploadRequests(){return this._pendingUploadRequests}get pendingDownloadRequests(){return this._pendingDownloadRequests}resetUploads(){this._uploads=[],this._pendingUploadRequests=[]}addAndStartUpload(e){return this._addAndStart("upload",e)}addAndStartDownload(e){return e.state!==t.BlockTransferStates.INITIALIZED?Promise.resolve(e):this._addAndStart("download",e)}startNextWaiting(e){const r="upload"===e?this._uploads:this._downloads,s=[];let o=!1;for(const e of r)!o&&e&&e.state===t.BlockTransferStates.WAITING?(e.start(),o=!0):e.state!==t.BlockTransferStates.CANCELED&&e.state!==t.BlockTransferStates.ERROR&&e.state!==t.BlockTransferStates.FINALIZING&&e.state!==t.BlockTransferStates.COMPLETE||s.push(e);const n=r.filter((e=>!s.includes(e)));"download"===e?this._downloads=n:this._uploads=n}_addAndStart(e,r){const s="upload"===e?this._uploads:this._downloads;return 0===s.filter((e=>e&&(e.state===t.BlockTransferStates.NOT_INITIALIZED||e.state===t.BlockTransferStates.INITIALIZED||e.state===t.BlockTransferStates.INITIALIZING||e.state===t.BlockTransferStates.STARTED))).length?r.start():r._setWaiting(),s.push(r),r.promise}},we=n.newDebug("dcx:assets:blockdownload"),Oe=n.newDebug("dcx:assets:blockdownload:leaf"),Ne=function*(){let e=0;for(;;)yield e++}();class Se extends a.EventEmitter{constructor(e,r,s={}){super(["stateChanged"]),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._cachedBlocks=new Map,this._blockRequestIndex=0,this._blockHandledIndex=0,this._currentByteRange=[void 0,void 0],this._pending=[],we("constructor");const{startByte:o,blockSize:n,endByte:i,url:d,totalSize:c,maxConcurrentRequests:l}=Object.assign({blockSize:Re.downloadChunkSize,maxConcurrentRequests:4},a.pruneUndefined(s));a.validateParams(["svc",e,"object"],["responseType",r,"enum",!1,["buffer"]],["blockSize",n,"+number"],["url",d,"string",!0],["startByte",o,"number",!0],["endByte",i,"number",!0],["totalSize",c,"number",!0],["maxConcurrentRequests",l,"+number"]),this._dbgId=Ne.next().value,this._maxConcurrentRequests=l,this._blockSize=Math.round(n),this._service=e,this._url=d,this._startByte=o,this._endByte=i,this._totalSize=c,this._bytes=new Uint8Array,this._promise=new u.default(((e,t)=>{this._resolve=()=>{we(this._dbgId,"resolving"),this.removeAllHandlers(),e(this)},this._reject=e=>{we(this._dbgId,"rejecting: ",e),this.removeAllHandlers(),t(e)}}))}get contentType(){var e;return null!==(e=this._contentType)&&void 0!==e?e:""}get totalSize(){return this._totalSize}get buffer(){return this._bytes}get state(){return this._state}get promise(){return this._promise}_requestBlock(e,r,s,o){we(this._dbgId,"_requestBlock(): ",e,r,s,o);const n=Xe(e,r);return this._service.invoke(t.HTTPMethods.GET,this._url,n,void 0,{responseType:"defaultbuffer",isStatusValid:H(),isExternalRequest:!0}).then((e=>({response:e,index:s,lane:o}))).catch(this._handleErrorAndThrow.bind(this))}init(e=this._url,r=this._totalSize){if(we(this._dbgId,"init(): ",e,r),this._state===t.BlockTransferStates.INITIALIZED&&e===this._url&&r===this._totalSize)return u.default.resolve(this);if(this._assertStateIsValid("init"),this._shiftState(t.BlockTransferStates.INITIALIZING),this._url=e,this._initByteRange(r),this._totalSize!==1/0||null==this._currentByteRange[0])return this._shiftState(t.BlockTransferStates.INITIALIZED),u.default.resolve(this);const{startByte:s,endByte:o,blockIndex:n}=this._nextBlockData();let i=t.BlockTransferStates.INITIALIZED;return this._requestBlock(s,o,n,0).then((e=>(this._updateTotalSize(e),(!o||o>this._endByte)&&(i=t.BlockTransferStates.FINALIZING),e))).then(this._handleBlock.bind(this)).then((()=>this._shiftState(i))).catch(this._handleErrorAndThrow.bind(this))}start(){if(we(this._dbgId,"start()"),this._assertStateIsValid("start"),this._shiftState(t.BlockTransferStates.STARTED),null!=this._currentByteRange[0])return this._start(),this._promise;const[e,r]=this._currentByteRange,s=this._blockRequestIndex;return this._blockRequestIndex+=1,this._currentByteRange=[r+1,r],this._requestBlock(e,r,s,0).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this)),this._promise}pause(){return we(this._dbgId,"pause()"),this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),u.default.allSettled(this._pending).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Re.startNextWaiting("download"),this)))}resume(){return we(this._dbgId,"resume()"),this.state===t.BlockTransferStates.PAUSED&&(this._shiftState(t.BlockTransferStates.STARTED),this._start()),this}cancel(){return we(this._dbgId,"cancel()"),this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),this._reject(new h.default(h.default.ABORTED,"BlockDownload aborted.")),Re.startNextWaiting("download"),this._promise}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}_start(){we(this._dbgId,"_start()");for(let e=0;e<this._maxConcurrentRequests;e++)this._loop(e).catch(this._handleError.bind(this))}get _loopShouldContinue(){const e=this._state===t.BlockTransferStates.STARTED&&this._currentByteRange[0]<=this._endByte;return we(this._dbgId,"_loopShouldContinue() ",e,this._currentByteRange,this._endByte),e}_loop(e){return b(this,void 0,void 0,(function*(){we(this._dbgId,"_loop(): ",e);let r=!1;for(;this._loopShouldContinue&&!r;){const{startByte:t,endByte:s,blockIndex:o,done:n}=this._nextBlockData();r=n;const i=this._requestBlock(t,s,o,e).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this));this._pending[e]=i,yield i}we(this._dbgId,`_loop(${e}) done, ${r}`),r&&(we(this._dbgId,`_loop(${e}) finalize`),this._shiftState(t.BlockTransferStates.FINALIZING))}))}_nextBlockData(){we(this._dbgId,"_nextBlockData()");const e=this._blockRequestIndex;this._blockRequestIndex+=1;const[t,r]=this._currentByteRange;return this._currentByteRange[0]+=this._blockSize,this._currentByteRange[1]=Math.min(this._currentByteRange[1]+this._blockSize,this._endByte),{startByte:t,endByte:r,blockIndex:e,done:r>=this._endByte}}_initByteRange(e=this._totalSize){if(we(this._dbgId,"_initByteRange(): ",e),this._totalSize=e,null!=this._totalSize&&this._totalSize<0)throw new h.default(h.default.INVALID_PARAMS,"Total size must be positive.");if(this._totalSize||(this._totalSize=1/0),this._endByte||(this._endByte=this._totalSize),!this._startByte&&this._endByte===this._totalSize)return this._startByte=0,void(this._currentByteRange=[0,this._blockSize-1]);if(!this._startByte&&this._endByte<0&&this._totalSize!==1/0?(this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize):!this._startByte&&this._endByte>0&&(this._startByte=0),null!=this._startByte&&(this._currentByteRange[0]=Math.max(this._startByte,0)),(null==this._endByte||this._endByte>0)&&(this._currentByteRange[1]=Math.min(this._endByte,(this._startByte||0)+this._blockSize-1)),null!=this._startByte||this._endByte===1/0)return;if(this._totalSize===1/0){if(-this._endByte>this._blockSize)throw new h.default(h.default.INVALID_PARAMS,"Cannot download last N bytes without a total size.");return void(this._currentByteRange=[void 0,this._endByte])}this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize;const t=Math.min(this._startByte+this._blockSize-1,this._endByte);this._currentByteRange=[this._startByte,t]}_finalize(){return we(this._dbgId,"_finalize() start"),Re.startNextWaiting("download"),u.default.allSettled(this._pending).then((()=>{this._checkCachedBlocks(),this._shiftState(t.BlockTransferStates.COMPLETE)}))}_updateTotalSize(e){if(we(this._dbgId,"_updateTotalSize()"),null==this._totalSize||this._totalSize===1/0)try{const t=e.response.headers["content-range"],r=parseInt(t.split("/")[1]);a.assert((()=>!isNaN(r)),"Invalid number."),this._totalSize=r,this._endByte===1/0&&(this._endByte=this._totalSize)}catch(t){throw new h.default(h.default.INVALID_DATA,"Could not determine total size.",t,e.response)}return we(this._dbgId,"_uTS(): ",this._totalSize,this._endByte),e}_handleError(e){we(this._dbgId,"_handleError(): ",e),this._shiftState(t.BlockTransferStates.ERROR),this._error=e,o.isAdobeDCXError(e)||(this._error=new h.default(h.default.UNEXPECTED,"An unexpected error occurred.",e)),this._reject(this._error)}_handleErrorAndThrow(e){throw this._handleError(e),this._error}_handleBlock(e){this._endByte===1/0&&this._updateTotalSize(e);const{index:t,response:r}=e;if(we(this._dbgId,`_handleBlock(${t})`),t!==this._blockHandledIndex)return we(this._dbgId,`_handleBlock(${t}) cached`),void this._cachedBlocks.set(t,e);we(this._dbgId,`_handleBlock(${t}) handled`),this._pushBlockData(r),this._markCurrentBlockHandled()}_markCurrentBlockHandled(){this._cachedBlocks.delete(this._blockHandledIndex),this._blockHandledIndex+=1,this._checkCachedBlocks()}_checkCachedBlocks(){const e=this._cachedBlocks.get(this._blockHandledIndex);e&&this._handleBlock(e)}_pushBlockData(e){if(this._state===t.BlockTransferStates.ERROR)return;this._contentType=this._contentType||e.headers[t.HeaderKeys.CONTENT_TYPE];const r=void 0!==s&&e.response instanceof s?e.response:new Uint8Array(e.response);this._bytes=a.concatUint8Arrays(this._bytes,r)}_shiftState(e){return we(this._dbgId,"_shiftState(): ",e),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state,this]),e===t.BlockTransferStates.FINALIZING&&this._finalize(),e===t.BlockTransferStates.COMPLETE&&Promise.all(this._pending).then(this._resolve.bind(this))),this}_assertStateIsValid(e,r=this._state){we(this._dbgId,"_assertStateIsValid() ",e,r);let s=!1;const o="Invalid state transition.";switch(e){case"init":r===t.BlockTransferStates.NOT_INITIALIZED&&(s=!0);break;case"start":r!==t.BlockTransferStates.INITIALIZED&&r!==t.BlockTransferStates.WAITING||(s=!0);break;case"pause":r===t.BlockTransferStates.STARTED&&(s=!0);break;case"cancel":s=!0}if(!s)throw we(this._dbgId,"_aSIV() throw ",o),new h.default(h.default.INVALID_STATE,o,void 0,void 0,{method:e,currentState:r})}}function Le(e,t,r){return new Se(e,t,r)}function ke(e,r,s,o,n="defaultbuffer",i,d){Oe("_doBlockDownload()");const c="stream"===n?void 0:Le(e,"buffer",{startByte:s,endByte:o});(null!=this?this:{}).blockDownload=c;let l=u.default.resolve(r,this);return i||(l=l.then((()=>e.invoke(t.HTTPMethods.GET,r,void 0,void 0,{responseType:"text",isStatusValid:H(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}}))).then((e=>{const t=e.response.indexOf("href")>0?a.getFirstRegexpCapture(e.response,'"href":\\s*"([^;"]*)"'):"";if("string"!=typeof t||""===t)throw new h.default(h.default.UNEXPECTED_RESPONSE,"No block download href found in response.",void 0,e);return d=d||parseInt(a.getFirstRegexpCapture(e.response,'"size":\\s*(\\d+)')),t}))),l.then((r=>b(this,void 0,void 0,(function*(){return c?Promise.race([c.init(r,d).then((()=>Re.addAndStartDownload(c))),c.promise]).then((()=>({statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:c.contentType,[t.HeaderKeys.CONTENT_LENGTH]:c.totalSize}),responseType:n,response:Me(c.buffer,n,c.contentType),message:"OK"}))):e.invoke(t.HTTPMethods.GET,r,Xe(s,o),void 0,{responseType:"stream",isExternalRequest:!0})}))))}function Me(e,t,r){if("defaultbuffer"===t||"buffer"===t||"arraybuffer"===t)return e.buffer;if("blob"===t)return new Blob([e],{type:r});const s=a.arrayBufferToString(e);if("text"===t)return s;try{return JSON.parse(s)}catch(e){return s}}function Xe(e,t){return null==e&&null==t?{}:{range:`bytes=${null!=e?e:null!=t&&t>0?"0":""}-${null!=t?Math.abs(t):""}`}}const xe=n.newDebug("dcx:assets:private");function Ue(e,t){let r;if(!a.isFunction(this.slice))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Data cannot be sliced");return r=this.slice(e,t),new Promise((e=>{e(r)}))}function Be(e,r,s,n,i="defaultbuffer",d,c,l={}){let h;xe("_getUrlFallbackDirect()");const f=void 0!==this?this:{};return u.default.resolve(void 0,f).then((()=>e.invoke(t.HTTPMethods.GET,s,l,void 0,{responseType:i,isStatusValid:H([400])}))).then((e=>(xe("_gUFD() status code",e.statusCode),h=e,400===e.statusCode&&e.xhr?e.xhr.getResponseDataAsJSON():e))).then((e=>{const t=a.isObject(e)&&(400===h.statusCode||400===e.status)&&e.type===o.ProblemTypes.RESPONSE_TOO_LARGE;if(xe("_gUFD() do direct",t),!t&&400===h.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,h);return t})).then((t=>{if(!t)return h;if(!("location"in h.headers)||"string"!=typeof h.headers.location){if(!q(r.links,[p.BLOCK_DOWNLOAD]))throw new o.DCXError(o.DCXError.INVALID_DATA,"Resource too large and missing download link.");const t=a.pruneUndefined({reltype:n,component_id:d,revision:c}),s=a.getLinkHrefTemplated(r.links,p.BLOCK_DOWNLOAD,{resource:n?JSON.stringify(t):void 0});return ke.call(f,e,s,void 0,void 0,i,!1)}return ke.call(f,e,h.headers.location,void 0,void 0,i,!0)}))}function je({additionalHeaders:e={},asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:l,relation:h,svc:u},p=!1){if(xe("_doUpload()"),a.validateParams(["svc",u,"object"],["asset",r,"object"],["href",c,"string"],["headHref",d,"string"],["contentType",s,"string",!0],["maybeIsNew",l,"boolean",!0],["etag",i,"string",!0],["isRetry",p,"boolean",!0],["additionalHeaders",e,"object",!0]),null==l)return u.invoke(t.HTTPMethods.HEAD,d,e,void 0,{isStatusValid:H([404])}).then((t=>{const o=200!==t.statusCode;return je({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:o,relation:h,svc:u},p)}));const f=l;return f?delete e[t.HeaderKeys.IF_MATCH]:e[t.HeaderKeys.IF_MATCH]=i||"*",s&&(e[t.HeaderKeys.CONTENT_TYPE]=s),u.invoke(t.HTTPMethods.PUT,c,e,n,{isStatusValid:H([404,409,412]),retryOptions:{pollHeader:"location",pollCodes:[202]}}).then((t=>{const a=t.statusCode;if(a>400&&!p){if(null!=i)throw H()(a,t);if(!f&&404===a)return je({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:!0,relation:h,svc:u},!0);if(404===a)throw new o.DCXError(o.DCXError.NOT_FOUND,"Unexpected response",void 0,t);if(409===a||412===a)return je({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:void 0,relation:h,svc:u},!0)}return t}))}const Ve=n.newDebug("dcx:assets:bulk");function He(e,r){let s=Uint8Array.from([]);for(let o=0;o<e.length;o++){const n=e[o];s=0===o?a.concatUint8Arrays(s,a.stringToBuffer(`--${r}\r\n`)):a.concatUint8Arrays(s,a.stringToBuffer(`\r\n--${r}\r\n`)),s=a.concatUint8Arrays(s,a.stringToBuffer(`${[t.HeaderKeys.CONTENT_TYPE]}: application/http\r\n`)),s=a.concatUint8Arrays(s,a.stringToBuffer(`\r\n${n.method} ${n.href}`));let i=!1;for(const e in n.headers){const t=e.toLowerCase();"content-length"===t&&(i=!0),s=a.concatUint8Arrays(s,a.stringToBuffer(`\r\n${t}: ${n.headers[e]}`))}if(n.body){const e=Fe(n.body);i||(s=a.concatUint8Arrays(s,a.stringToBuffer(`\r\ncontent-length: ${e.length}`))),s=a.concatUint8Arrays(s,a.stringToBuffer("\r\n\r\n")),s=a.concatUint8Arrays(s,e)}}return s=a.concatUint8Arrays(s,a.stringToBuffer(`\r\n--${r}--\r\n`)),s}function Fe(e){if("string"==typeof e)return a.stringToBuffer(e);if(a.isArrayBuffer(e))return new Uint8Array(e);if(N(e))return e;throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Bulk subrequest body expecting string | ArrayBuffer | Buffer")}function Ye(e,r){const s=e.headers[t.HeaderKeys.CONTENT_TYPE];if(!s)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,"Missing boundary header in multipart response");const n=s.split("=")[1],i=function(e,r){const s=[],o=new Uint8Array(e),n=a.stringToBuffer(`--${r}`),i=qe(o,We(o,n),n.byteLength);for(const e of i){const r=a.stringToBuffer("\r\n\r\n"),[o,n,i]=qe(e,We(e,r).slice(0,2),r.byteLength,!0),d=a.parseHeaders(a.arrayBufferToString(o)),c=a.arrayBufferToString(n),l=parseInt(c.split("\r\n",1)[0].split(" ")[1]);Object.assign(d,a.parseHeaders(c));const h=parseInt(d["content-length"],10);let u;u=isNaN(h)?0===i.length?void 0:i:0===h?void 0:i.subarray(0,h);const p={headers:d,response:"application/problem+json"===d[t.HeaderKeys.CONTENT_TYPE]&&void 0!==u?JSON.parse(a.arrayBufferToString(u)):u,statusCode:l};s.push(p)}return s}(e.response,n);if(r&&i.length!==r)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,`Unexpected number of parts; Expected ${r}, Received ${i.length}`);return i}function We(e,t){const r=new Array(256).fill(-1),s=[];for(let e=0;e<t.length;e++)r[t[e]]=e;let o=0;for(;o<=e.length-t.length;){let n=t.length-1;for(;n>=0&&t[n]===e[o+n];)n--;n<0?(s.push(o),o+=o+t.length<e.length?t.length-r[e[o+t.length]]:1):o+=Math.max(1,n-r[e[o+n]])}return s}function qe(e,t,r,s=!1){let o=s?0:void 0;const n=[];for(const s of t)void 0!==o&&n.push(e.subarray(o,s)),o=s+r;return s&&n.push(e.subarray(o)),n}function ze(e){if(e.length>10)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A single bulk request can only contain a maximum of 10 sub-requests.");const{writeOperations:r,readOperations:s}=e.reduce(((e,r)=>{if("string"!=typeof r.href)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing an href");if("string"!=typeof r.method)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing the HTTP method");const s=r.method.toUpperCase();if(!Object.values(t.HTTPMethods).includes(s))throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation includes an invalid HTTP method");return[t.HTTPMethods.GET,t.HTTPMethods.HEAD].includes(s)?e.readOperations.push(r):e.writeOperations.push(r),e}),{readOperations:[],writeOperations:[]});if(r.length>0&&s.length>0)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Cannot mix READ and WRITE operations in bulk sub requests.")}function Ge(e,t,r,s="id",o={},n=!1){return Ve("performBulkRequest()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["requests",r,"array"],["linkMode",s,"string",!0,["id","path"]]),F(t.links,[p.BULK_REQUEST]),ze(r),Ke(e,t,r,s,o).then((({response:i,subresponses:a})=>b(this,void 0,void 0,(function*(){const d=$e(a,r);return{result:n?yield Je(e,t,d,s,o,a):a,response:i}}))))}function Ke(e,r,s,o="id",n={}){const i=`boundary-${Date.now()}`,d=He(s,i),c=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:`multipart/mixed;boundary=${i}`}),l=a.getLinkHref(r.links,p.BULK_REQUEST,o);return e.invoke(t.HTTPMethods.POST,l,c,d,{isStatusValid:H(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}}).then((e=>({response:e,subresponses:Ye(e,s.length)})))}function $e(e,t){return e.filter((({statusCode:e})=>a.checkRetriable(e))).map((e=>t.find((({href:t})=>t===e.headers["content-id"])))).filter((e=>e))}function Je(e,r,s,o="id",n={},i,a=5){return b(this,void 0,void 0,(function*(){if(0===s.length||a<=0)return i;if(1===s.length){const[r]=s,o=yield e.invoke(r.method,r.href,r.headers,r.body,{isStatusValid:H(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}});return o.headers["content-id"]=r.href,i.map((e=>"content-id"in e.headers&&e.headers["content-id"]===o.headers["content-id"]?o:e))}const d=yield Ke(e,r,s,o,n).then((t=>b(this,void 0,void 0,(function*(){const i=$e(t.subresponses,s);return i.length?yield Je(e,r,i,o,n,t.subresponses,a-1):t.subresponses}))));return i.map((e=>d.find((t=>t.headers["content-id"]===e.headers["content-id"]))||e))}))}const Ze=n.newDebug("dcx:assets:asset"),Qe=n.newDebug("dcx:assets:asset:leaf");class et{constructor(e,t,r={}){this.type="asset",this._data={},this._data=ae(e),this._svc=B(t),this._cache=j(t),this._links=a.merge({},e.links||{},e._links||{},r)}setLinks(e){this._links=e,this._updateCachedLinks()}get links(){return this._links}set links(e){this.setLinks(e)}setLink(e,t){this._links[e]=t,this._updateCachedLinks()}getLink(e){return this._links[e]}removeLink(e){delete this._links[e],this._updateCachedLinks()}_updateCachedLinks(){this._cache&&this._cache.setValueWithAsset(this.links,this.asset)}getLinkProperty(e,t,r="id"){return Ze("getLinkProperty()"),a.getLinkProperty({_links:this._links},e,t,r)}getLinkHrefTemplated(e,t,r="id"){return Ze("getLinkHrefTemplated()"),a.getLinkHrefTemplated({_links:this._links},e,t,r)}getLinkHref(e,t="id"){return Ze("getLinkHref()"),a.getLinkHref({_links:this._links},e,t)}get asset(){return Object.assign(Object.assign({},this._data),this.links)}get serviceConfig(){return{service:this._svc,cache:this._cache}}get repositoryId(){return this._data.repositoryId}set repositoryId(e){this._data.repositoryId=e}get assetId(){return this._data.assetId}set assetId(e){this._data.assetId=e}get path(){return this._data.path}set path(e){this._data.path=e}get name(){return this._data.name}get etag(){return this._data.etag}set etag(e){this._data.etag=e}get version(){return this._data.version}set version(e){this._data.version=e}get format(){return this._data.format}set format(e){this._data.format=e}get assetClass(){return this._data.assetClass}get createDate(){return this._data.createDate}get modifyDate(){return this._data.modifyDate}get discardDate(){return this._data.discardDate}get createdBy(){return this._data.createdBy}get modifiedBy(){return this._data.modifiedBy}get discardedBy(){return this._data.discardedBy}get deviceCreateDate(){return this._data.deviceCreateDate}get deviceModifyDate(){return this._data.deviceModifyDate}get baseAssetId(){return this._data.baseAssetId}set baseAssetId(e){this._data.baseAssetId=e}get state(){return this._data.state}get size(){return this._data.size}set size(e){this._data.size=e}get md5(){return this._data.md5}fetchLinksIfMissing(e=[],t){return Ze("fetchLinksIfMissing()"),It(this.serviceConfig,this,e,void 0,t).then((({result:e,response:t})=>(this.setLinks(a.merge(this.links,e)),this._updateDataWithResponse(t),this)))}useLinkOrResolveResource(e,t){return Ze("useLinkOrResolveResource()"),At(this.serviceConfig,this,e,t).then((e=>(this._updateDataWithResponse(e.response),this.setLinks(a.merge(this.links,e.result.links)),e)))}headPrimaryResource(e){return Ze("headPrimaryResource()"),this.fetchLinksIfMissing([p.PRIMARY],e).then((()=>rt(this._svc,this,e))).then((e=>{this._updateDataWithResponse(e);const t=se(e);return this.setLinks(t),e}))}getRepoMetadata(){return Ze("getRepoMetadata()"),this.useLinkOrResolveResource(p.REPO_METADATA,"json").then((e=>{this._data=a.merge(this._data,e.result,ae(e.response.response));const t=e.response.response;return t&&t._links&&this.setLinks(a.merge(this.links,t._links)),{result:this._data,response:e.response}}))}headAppMetadata(e){return Ze("headAppMetadata()"),this.fetchLinksIfMissing([p.APP_METADATA],e).then((()=>lt(this._svc,this))).then((e=>{const t=se(e);return this.setLinks(t),e}))}getAppMetadata(e,t){return Ze("getAppMetadata()"),a.validateParams(["etag",e,"string",!0]),this.fetchLinksIfMissing([p.APP_METADATA],t).then((()=>ht(this._svc,this,e,t)))}putAppMetadata(e,t,r){return Ze("putAppMetadata()"),a.validateParams(["etag",t,"string",!0],["metadata",e,["object","string"]]),this.fetchLinksIfMissing([p.APP_METADATA],r).then((()=>ut(this._svc,this,e,t,r)))}patchAppMetadata(e,t){return Ze("patchAppMetadata()"),a.validateParams(["patchDoc",e,["string","object[]"]],["etag",t,"string"]),this.fetchLinksIfMissing([p.APP_METADATA]).then((()=>pt(this._svc,this,e,t)))}getBaseDirectoryMetadata(){return Ze("getBaseDirectoryMetadata()"),dt(this._svc)}getLinks(e){return Ze("getLinks()"),a.isObject(this.links)&&Object.keys(this.links).length>0?u.default.resolve(this.links):at(this._svc,this,e).then((e=>(this.setLinks(e),e)))}getRepositoryResource(e){return Ze("getRepositoryResource()"),this.fetchLinksIfMissing([p.REPOSITORY],e).then((()=>ct(this._svc,this,e))).then((e=>(this.repositoryId=e.result["repo:repositoryId"],e)))}getEffectivePrivileges(e){return Ze("getEffectivePrivileges()"),this.fetchLinksIfMissing([p.EFFECTIVE_PRIVILAGES],e).then((()=>ft(this._svc,this)))}performBulkRequest(e,t,r){return Ze("performBulkRequest()"),a.validateParams(["requests",e,"array"],["linkMode",t,"string",!0,["id","path"]]),this.fetchLinksIfMissing([p.BULK_REQUEST],r).then((()=>Ge(this._svc,this,e,t,r)))}getACLPolicy(e){return Ze("getACLPolicy()"),this.fetchLinksIfMissing([p.ACL_POLICY],e).then((()=>_t(this._svc,this)))}checkACLPrivilege(e,t,r){return Ze("checkACLPrivilege()"),a.validateParams(["privilege",e,"string"],["relation",t,"string"]),this.fetchLinksIfMissing([p.ACCESS_CHECK],r).then((()=>mt(this._svc,this,e,t)))}patchACLPolicy(e,t){return Ze("patchACLPolicy()"),a.validateParams(["policy",e,["string","object"]]),this.fetchLinksIfMissing([p.ACL_POLICY]).then((()=>P(e)?Et(this._svc,this,e):Et(this._svc,this,e,t)))}deleteACLPolicy(){return Ze("deleteACLPolicy()"),this.fetchLinksIfMissing([p.ACL_POLICY]).then((()=>gt(this._svc,this)))}getPrimaryResource(e,t){Ze("getPrimaryResource()"),a.validateParams(["responseType",e,"string"]);const r={};return this._withSourcePromise(r).then((()=>this.fetchLinksIfMissing([p.PRIMARY],t))).then((()=>tt.call(r,this._svc,this,e,t)))}copy(e,t,r,s){return Ze("copy()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),"string"==typeof e&&(e=vt.call(this,e)),he(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s).then((({response:e,result:t})=>({response:e,result:new et(t,this.serviceConfig)})))}move(e,t,r){return Ze("move()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),"string"==typeof e&&(e=vt.call(this,e)),pe(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{response:e,result:this})))}delete(e,t=!1){return Ze("delete()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),_e(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t).then((e=>(this._data.state="DELETED",e)))}discard(e,t=!1){return Ze("discard()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),fe(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t).then((e=>(this._data.state="DISCARDED",e)))}package(e,t,r){return Ze("package()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),"string"==typeof e&&(e=vt.call(this,e)),Ee(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r)}restore(){return Ze("restore()"),me(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId}).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{state:"ACTIVE"}),{response:e,result:this})))}_updateDataWithResponse(e){return e?(this._data.etag=e.headers.etag||this._data.etag,this._data.version=e.headers.version||this._data.version,this._data.assetId=e.headers["asset-id"]||this._data.assetId,this._data.md5=e.headers["content-md5"]||this._data.md5,this._data.repositoryId=e.headers["repository-id"]||this._data.repositoryId,e):e}_withSourcePromise(e){return u.default.resolve(void 0,e)}}function tt(e,t,r,s){Ze("getPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["responseType",r,"enum",!0,v]),F(t.links,[p.PRIMARY]);const o=a.getLinkHref(t.links,p.PRIMARY);return Be.call({},e,t,o,p.PRIMARY,r,void 0,void 0,s)}function rt(e,r,s){Ze("headPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.PRIMARY]);const o=a.getLinkHref(r.links,p.PRIMARY);return e.invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:H()})}function st(e,t,r="id",s,o){return Qe("getResolveLinkForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!1,["id","path"]],["resource",s,["string","object"],!0]),G(t),te(e,o).then((e=>{const o="string"==typeof t.assetId,n={repositoryId:t.repositoryId,[o?"id":"path"]:t.assetId||t.path,mode:r,resource:a.isObject(s)?JSON.stringify(s):s};return a.getLinkHrefTemplated(e,o?p.RESOLVE_BY_ID:p.RESOLVE_BY_PATH,n)}))}function ot(e,t,r="id",s,o,n){Qe("resolveAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!0,["id","path"]],["resource",s,["string","object"],!0]),G(t);const i=B(e),d=j(e),c=d&&t.assetId&&t.repositoryId&&"id"===r;return c&&(Qe("rA() set pending"),d.setPending(t.assetId,t.repositoryId)),st(e,t,r,s,n).then((e=>null==s?Z(i,e,n):Q(i,e,n,o))).then((e=>({response:e,result:Tt(t,e,"id"===r,d)}))).catch((e=>{throw c&&d.deleteWithAsset(t),e}))}function nt(e,t,r){return Qe("fetchLinksForAsset()"),it(e,t,r).then((e=>e.result.links))}function it(e,r,s){if(Qe("fetchAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),k(r))return ot(e,r,"id",void 0,void 0,s).then((e=>e));let n;try{n=Y(r.links,[p.ID,p.REPO_METADATA,p.PRIMARY,p.PATH])}catch(e){throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repositoryId & path, assetId, or links.",e)}const i=a.getLinkHref(r.links,n),d=B(e),c=j(e);return d.invoke(t.HTTPMethods.HEAD,i,s,void 0,{isStatusValid:H()}).then((e=>({result:Tt(r,e,n===p.ID,c),response:e})))}function at(e,r,s){Qe("getLinksForAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]);const o=r.links||r[t.Properties.LINKS];if(a.isObject(o)&&0!==Object.keys(o).length)return u.default.resolve(o);const n=j(e);if(n){const e=n.getValueWithAsset(r);if(e)return u.default.resolve(e)}return nt(e,r,s)}function dt(e,t){throw Qe("getBaseDirectoryMetadata()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}function ct(e,r,s){Qe("getRepositoryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.REPOSITORY]);const o=a.getLinkHref(r.links,p.REPOSITORY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function lt(e,r,s){Ze("headAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.APP_METADATA]);const o=a.getLinkHref(r.links,p.APP_METADATA);return e.invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:H()})}function ht(e,r,s,o={}){Qe("getAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0]);const n=a.getLinkHref(r.links,p.APP_METADATA),i=Object.assign({},o);return s&&(i[t.HeaderKeys.IF_NONE_MATCH]=s),e.invoke(t.HTTPMethods.GET,n,i,void 0,{responseType:"json",isStatusValid:H([304])}).then((e=>{let t=e.response,r=e.headers.etag;return 304===e.statusCode&&(t=null,r=s),{result:t,response:e,etag:r}}))}function ut(e,r,s,o,n={}){Qe("putAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object","string"]],["etag",o,"string",!0]),F(r.links,[p.APP_METADATA]);const i=a.getLinkHref(r.links,p.APP_METADATA);return e.invoke(t.HTTPMethods.PUT,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:"application/json"})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function pt(e,r,s,o){Qe("patchAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object[]","string"]],["etag",o,"string"]),F(r.links,[p.APP_METADATA]);const n=a.getLinkHref(r.links,p.APP_METADATA);return e.invoke(t.HTTPMethods.PATCH,n,a.pruneUndefined({[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:m}),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function ft(e,r,s){Qe("getEffectivePrivileges()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.EFFECTIVE_PRIVILAGES]);const o=a.getLinkHref(r.links,p.EFFECTIVE_PRIVILAGES);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function _t(e,r,s){Qe("getACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.ACL_POLICY]);const o=a.getLinkHref(r.links,p.ACL_POLICY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function mt(e,r,s,o,n={}){Qe("checkACLPrivilege()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["privilege",s,"string",!1,["ack","read","write","delete"]]),F(r.links,[p.ACCESS_CHECK]);const i=a.getLinkHrefTemplated(r.links,p.ACCESS_CHECK,{privilege:s.toString(),relation:o});return e.invoke(t.HTTPMethods.GET,i,Object.assign({directive:"acl-check-no-body"},n),void 0,{responseType:"json",isStatusValid:H([403])}).then((e=>({result:403!==e.statusCode,response:e})))}function Et(e,r,s,o){Qe("patchACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["policy",s,["string","object"]],["etag",o,"string",!0]),F(r.links,[p.ACL_POLICY]);const n=a.pruneUndefined(P(s)?{[t.HeaderKeys.CONTENT_TYPE]:"application/vnd.adobecloud.accesscontrolpolicy+json"}:{[t.HeaderKeys.CONTENT_TYPE]:m,[t.HeaderKeys.IF_MATCH]:o}),i=a.getLinkHref(r.links,p.ACL_POLICY);return B(e).invoke(t.HTTPMethods.PATCH,i,n,"string"==typeof s?s:JSON.stringify(s),{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function gt(e,r){Qe("deleteACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.ACL_POLICY]);const s=a.getLinkHref(r.links,p.ACL_POLICY);return B(e).invoke(t.HTTPMethods.DELETE,s,{},void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function At(e,r,s,n,i){Qe("useLinkOrResolveResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["resource",s,"string"]);const d=B(e);let c;try{c=a.getLinkHref(r.links,s)}catch(e){}return u.default.resolve(c).then((t=>{if("string"==typeof t)return Qe("uLORR() asset has link"),t;const o=j(e);return yt(r,o,[s])})).then((e=>{if("string"==typeof e)return e;try{return a.getLinkHref(e,s)}catch(e){return}})).then((a=>{if("string"==typeof a)return Qe("uLORR() cache or asset had link"),d.invoke(t.HTTPMethods.GET,a,i,void 0,{isStatusValid:H(),responseType:n});if(!k(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repository ID + path/id or links.");return ot(e,r,"id",s,n,i)})).then((e=>O(e)?e:{result:r,response:e}))}function Ct(e,t,r=[],s=!1,o){return It(e,t,r,s,o).then((({result:e})=>e))}const Dt=new Set([p.BASE_DIRECTORY,p.RESOLVE_BY_ID,p.RESOLVE_BY_PATH,p.REPO_OPS,p.REPOSITORY,p.DIRECTORY,p.DISCARD,p.RESTORE,p.PATH,p.ANNOTATIONS]);function It(e,r,s=[],n=!1,i){if(Qe("fetchLinksIfMissing()",s),a.validateParams(["svc",e,"object"],["asset",r,"object"],["linksToPopulate",s,"string[]"],["suppressMissingErrors",n,"boolean",!0]),q(r.links,s))return Qe("fLIM() links exist"),u.default.resolve({result:r.links});const d=j(e);return yt(r,d,s,!0).then((o=>o||(function(e,t,r){return!0===r.featureFlags.useLinksAPI&&"string"==typeof e.assetId&&e.assetId.length>0&&t.every((e=>!Dt.has(e)))}(r,s,B(e))?function(e,r,s){const o=function(e,t){Qe("getLinksAPIUrlForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const r=V("/links{?assetId,repositoryId,clientRegion}",B(e)),{assetId:s,repositoryId:o,contentRegion:n}=t,i=a.pruneUndefined({assetId:s,repositoryId:o,contentRegion:n});return a.expandURITemplate(r,i)}(e,r);return B(e).invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json"}).then((e=>(r.links=Object.assign({},r.links,e.response._links),{response:e,result:r})))}(e,r,i):(Qe("fLIM() fetching links"),it(e,r,i))))).then((e=>{let t,i,d=e;if(O(e)&&(t=e.response,d=e.result.links,i=e.result),!n&&!q(d,s))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Required links could not be fetched for asset.",void 0,t,a.pruneUndefined({required:s,asset:i}));return Qe("fLIM() fetchedOCached exists"),{result:d||r.links,response:t}}))}function yt(e,t,r,s){if(Qe("getLinksFromCache()"),!t)return u.default.resolve(void 0);const o=t.getValueWithAsset(e);return null==o?(s&&t.setPending(e.assetId,e.repositoryId),u.default.resolve(void 0)):u.default.resolve(o).then((o=>r?q(o,r)?o:void(s&&t.setPending(e.assetId,e.repositoryId)):o))}function vt(e){return{[a.isValidAdobeURN(e)?"assetId":"path"]:e,repositoryId:this.asset.repositoryId}}function Tt(e,r,s,o){const n=se(r),i=Object.assign(Object.assign(Object.assign({},function(e){return a.isObject(e.asset)?e.asset:e}(e)),a.pruneUndefined({assetId:r.headers["asset-id"]||r.headers["x-resource-id"],format:r.headers[t.HeaderKeys.CONTENT_TYPE],md5:r.headers["content-md5"],etag:r.headers.etag,version:r.headers.version,repositoryId:r.headers["repository-id"]})),{links:n});return s&&n&&Object.keys(n).length>0&&o&&o.setValueWithAsset(n,i),i}const bt=n.newDebug("dcx:assets:block_transfer");function Pt(e,t,r){if(a.isAnyFunction(r))return!0;const s=Rt(e),n=wt(r),i=t||n;if(!i)throw new o.DCXError(o.DCXError.INVALID_DATA,"Data size could not be determined");return!!(s&&i>s||n>s)||i>10485760||n>10485760}function Rt(e){let r;return q(e.links,[p.BLOCK_UPLOAD_INIT])&&(r=a.getLinkProperty(e.links,p.BLOCK_UPLOAD_INIT,t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE)),r?parseInt(r):10485760}const wt=e=>e.byteLength||e.size||a.isFunction(e.getBytes)&&e.getBytes().length||e.length;function Ot(e,t,r,s){const o=a.parseHeaders(s);return{id:t,length:r,type:e,links:oe(o.link),etag:o.etag,location:o.location,version:o.version,revision:o.revision,md5:o["content-md5"]}}function Nt(e){return new Promise((t=>{let r;e.finally((()=>{clearTimeout(r),t(void 0)})),function s(){["blockUpload","blockDownload"].forEach((o=>{if(a.isObject(e[o]))return clearTimeout(r),t(e[o]);r=setTimeout(s,1)}))}()}))}const St=n.newDebug("dcx:assets:blockupload"),Lt=n.newDebug("dcx:assets:blockupload:leaf");class kt extends a.EventEmitter{constructor(e,r,s,n,i,d,c,l,h){super(["stateChanged"]),this._internalBlockUploadId=a.generateUuid(),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._currentBlockIndex=0,this._pendingBlockRequests=[],this._bytesUploaded=0,this._totalBlocksUploaded=0,this._finalizeDocumentSizeEstimate=0,this._indeterminateTransfer=!1,this._svc=e,this._getSliceCallback=r,x(s)?(this._blockTransferDocument=s,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][p.BLOCK_TRANSFER],this._shiftState(t.BlockTransferStates.INITIALIZED),St(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`)):(a.validateParams(["relationType",n,"string"],["dataSize",i,"number"],["contentType",d,"string"],["componentId",c,"string",!0],["etag",h,"string",!0]),this._asset=s,F(this._asset.links,[p.BLOCK_UPLOAD_INIT],o.DCXError.UNEXPECTED,"/rel/block/init missing from BlockTransferDocument."),this._relationType=n,this._dataSize=i,this._contentType=d,this._componentId=c,this._md5=l,this._ifMatch=h),this._promise=new u.default(((e,t)=>{this._reject=t,this._resolve=e})),Re.uploads.push(this)}init(){if(this._assertStateIsValid("init"),!this._blockTransferDocument){this._shiftState(t.BlockTransferStates.INITIALIZING);const e=a.pruneUndefined({"repo:reltype":this._relationType.toString(),"repo:if-match":this._ifMatch,"repo:size":this._dataSize,"dc:format":this._contentType,component_id:this._componentId,"repo:md5":this._md5});return Mt(this._svc,this._asset,e).then((e=>(this._blockTransferDocument=e.result,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][p.BLOCK_TRANSFER],this._finalizeDocumentSizeEstimate=JSON.stringify(this._blockTransferDocument).length,this._shiftState(t.BlockTransferStates.INITIALIZED),St(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`),this)))}return this._finalizeDocumentSizeEstimate=JSON.stringify(this._blockTransferDocument).length,u.default.resolve(this)}get state(){return this._state}get promise(){return this._promise}start(){return this._assertStateIsValid("start"),Re.uploads[0]!==this||this._state!==t.BlockTransferStates.INITIALIZED&&this._state!==t.BlockTransferStates.PAUSED||(St(`Starting the transfer of BlockUpload: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.STARTED),this._uploadLoop()),this._promise}pause(){return this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),u.default.allSettled(this._pendingBlockRequests).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),St(`BlockUploading has been paused.  BlockUploadId: ${this._internalBlockUploadId}`),this)))}resume(){return this._assertStateIsValid("resume"),St(`BlockUploading has been resumed.  BlockUploadId: ${this._internalBlockUploadId}`),this.start(),this}cancel(){this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),St(`A BlockUpload has been canceled... BlockUploadId: ${this._internalBlockUploadId}`),this._promise.cancel(),this._cancel()}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}uploadNextBlock(e){if(this._assertStateIsValid("uploadNextBlock"),this._isEmptyBlock(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Trying to upload empty data block.");const r=this._blockTransferDocument[t.Properties.LINKS][p.BLOCK_TRANSFER][this._currentBlockIndex].href;let s;St(`Uploading a block... BlockUploadId: ${this._internalBlockUploadId}`);const n=wt(e),i=this._uploadBlock(e,r).then((e=>(this._totalBlocksUploaded++,this._updateProgress(n),s(),St(`A block has completed... ${this._pendingBlocksCount} requests still active. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{St(`A block upload has failed. BlockUploadId: ${this._internalBlockUploadId}`),s(),this._shiftState(t.BlockTransferStates.ERROR),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"A block has failed during upload",e,e.response)),this.cancel()}));return s=this._pushPendingBlockRequest(i),i}get _pendingBlocksCount(){return Re.pendingUploadRequests.filter((e=>!!e)).length}_nextBlockLock(){return this._pendingBlocksCount<4?Promise.resolve():Promise.race(Re.pendingUploadRequests.filter((e=>!!e)))}_uploadLoop(){this._nextBlockLock().then((()=>{if(this._state===t.BlockTransferStates.FINALIZING||this._state===t.BlockTransferStates.COMPLETE)throw t.BlockTransferStates.COMPLETE;if(this._state===t.BlockTransferStates.PAUSING||this._state===t.BlockTransferStates.PAUSED)throw t.BlockTransferStates.PAUSED;if(this._state===t.BlockTransferStates.CANCELED)throw t.BlockTransferStates.CANCELED;if(this._state===t.BlockTransferStates.ERROR)throw t.BlockTransferStates.ERROR})).then((()=>this._getBlockAtIndex(this._currentBlockIndex))).then((e=>this._isEmptyBlock(e)?(St(`No more blocks.  BlockUploadId: ${this._internalBlockUploadId}`),this._continueBlockUploads(),Promise.all(this._pendingBlockRequests).then(this._finalize.bind(this))):e&&wt(e)>0&&this._currentBlockIndex>=this._transferBlockLinks.length?this._extend().then((()=>e)):e)).then((e=>{if(!e)throw t.BlockTransferStates.COMPLETE;this.uploadNextBlock(e),this._currentBlockIndex++})).then((()=>{this._uploadLoop()})).catch((e=>{if("string"!=typeof e&&(this._continueBlockUploads(),this._reject(e)),e!==t.BlockTransferStates.COMPLETE){if(e!==t.BlockTransferStates.PAUSED)return e===t.BlockTransferStates.CANCELED?(St(`BlockUpload loop is terminated due to the upload being canceled. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):e===t.BlockTransferStates.ERROR?(St(`BlockUpload loop is terminated due to error state. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):void 0;St(`BlockUpload loop is terminated due to paused state. BlockUploadId: ${this._internalBlockUploadId}`)}else St(`BlockUpload loop is complete. BlockUploadId: ${this._internalBlockUploadId}`)}))}_getBlockAtIndex(e){St(`_getBlockAtIndex(${e})`);const r=Math.min(this._dataSize,this._blockTransferDocument[t.BlockTransferProperties.REPO_BLOCK_SIZE]);if(this._state===t.BlockTransferStates.STARTED){const t=e*r;return St("calling _getSliceCallback",t,t+r),Promise.resolve(this._getSliceCallback(t,t+r).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"The getSliceCallback threw an unexpected error.",e)})))}}_uploadBlock(e,r){return this._svc.invoke(t.HTTPMethods.PUT,r,void 0,e,{isStatusValid:H(),isExternalRequest:!0})}_isEmptyBlock(e){return"string"==typeof e?0===e.length:L(e)?0===e.size:null==e||0===e.byteLength}_extend(){F(this._blockTransferDocument[t.Properties.LINKS],[p.BLOCK_EXTEND],o.DCXError.UNEXPECTED,"The transfer document does not contain an extend href");const e=Math.ceil(1.5*this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE]),r=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],p.BLOCK_EXTEND,{size:e});return this._svc.invoke(t.HTTPMethods.POST,r,{},void 0,{isStatusValid:H(),responseType:"json"}).then((e=>(this._indeterminateTransfer=!0,this._blockTransferDocument=e.response,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][p.BLOCK_TRANSFER],St(`Transfer document was extended to ${this._transferBlockLinks.length} transfer links. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An unexpected error occurred while extending the block transfer document.",e,e.response)}))}_pushPendingBlockRequest(e){const t=this._pendingBlockRequests.push(e),r=Re.pendingUploadRequests.push(e);return()=>{delete this._pendingBlockRequests[t-1],delete Re.pendingUploadRequests[r-1]}}_updateProgress(e){St("_updateProgress()",e);let r,s=Math.max(this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._bytesUploaded)+this._finalizeDocumentSizeEstimate;if(!0===e?r=s:(r=this._bytesUploaded+=e,s+=e),this.onProgress&&a.isFunction(this.onProgress))try{this.onProgress(r,s,this._indeterminateTransfer)}catch(e){console.error("Error in onProgress callback",e)}}_cancel(){this._pendingBlockRequests.map((e=>{e&&e.cancel()})),this._state!==t.BlockTransferStates.ERROR&&this._resolve(this)}_assertStateIsValid(e,r){const s=r||this._state;switch(e){case"init":if(s!==t.BlockTransferStates.NOT_INITIALIZED&&s!==t.BlockTransferStates.INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"BlockUpload has already been initialized");break;case"start":if(s===t.BlockTransferStates.NOT_INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Please call init before starting the block upload");break;case"uploadNextBlock":if(s===t.BlockTransferStates.PAUSED||s===t.BlockTransferStates.CANCELED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Cannot add block when Paused or Cancelled");break;case"getBlockAtIndex":if(s!==t.BlockTransferStates.STARTED)throw new o.DCXError(o.DCXError.INVALID_STATE,`Cannot fetch block while in the ${s} state`);break;case"cancel":if(s!==t.BlockTransferStates.STARTED&&s!==t.BlockTransferStates.FINALIZING&&s!==t.BlockTransferStates.PAUSING&&s!==t.BlockTransferStates.PAUSED&&s!==t.BlockTransferStates.ERROR)throw new o.DCXError(o.DCXError.INVALID_STATE,`Trying to cancel while in an invalid state ${s}`)}}_continueBlockUploads(){if(Re.uploads[0]===this)if(Re.uploads.shift(),Re.uploads.length>0){const e=Re.uploads[0];St("Another block upload found in the queue, starting..."),e.start()}else 0===this._pendingBlocksCount&&(St("There are no more pending block transfers.. Clean up blockUploadManager.."),Re.resetUploads())}_finalize(){St(`Finalizing block transfer.  BlockUploadId: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.FINALIZING);const e=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],p.BLOCK_FINALIZE,{});return this._blockTransferDocument[t.Properties.LINKS][p.BLOCK_TRANSFER]=this._transferBlockLinks.slice(0,this._totalBlocksUploaded),this._svc.invoke(t.HTTPMethods.POST,e,{[t.HeaderKeys.CONTENT_TYPE]:E},JSON.stringify(a.pruneUndefined(this._blockTransferDocument)),{isStatusValid:H(),retryOptions:{pollHeader:"location",pollCodes:[202],timeoutAfter:12e4}}).then((e=>{200!==e.statusCode&&201!==e.statusCode||(St(`Finalize complete.  BlockUploadId: ${this._internalBlockUploadId}`),this.finalizeResponse=e,this.uploadRecord=Ot(this._blockTransferDocument.format,this._blockTransferDocument.component_id,this._bytesUploaded,e.response),this._shiftState(t.BlockTransferStates.COMPLETE),this._updateProgress(!0),this._resolve(this)),this._continueBlockUploads()})).catch((e=>{St("Error occurred finalizing the block transfer.. Rejecting"),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An error occurred while finalizing the block transfer.",e,e.response)),this._continueBlockUploads()}))}_shiftState(e){return St(`_shiftState(): ${e}`),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state])),this}}function Mt(e,r,s,n={}){if(a.validateParams(["svc",e,"object"],["asset",r,"object"],["transferDocument",s,"object"],["additionalHeaders",n,"object",!0]),F(r.links,[p.BLOCK_UPLOAD_INIT]),s["repo:resource"]){if(!s["repo:resource"].reltype)throw new o.DCXError(o.DCXError.INVALID_DATA,"reltype param is required in the Resource Designator");s["repo:reltype"]=s["repo:resource"].reltype,s["repo:resource"].component_id&&(s.component_id=s["repo:resource"].component_id),s["repo:resource"].etag&&(s["repo:if-match"]=s["repo:resource"].etag),delete s["repo:resource"]}if(s["repo:reltype"]===p.COMPONENT&&!s.component_id)throw new o.DCXError(o.DCXError.INVALID_DATA,"Component Id required to block upload to a component");const i=a.getLinkHref(r.links,p.BLOCK_UPLOAD_INIT);n[t.HeaderKeys.CONTENT_TYPE]=E;const d=a.normalizeHeaders(n);return e.invoke(t.HTTPMethods.POST,i,d,JSON.stringify(s),{responseType:"json",isStatusValid:H()}).then((e=>({response:e,result:e.response})))}function Xt({additionalHeaders:e,asset:t,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,maybeIsNew:i,md5:d,progressCb:c,relation:l,size:h,svc:p}){if(Lt("_doBlockUpload()"),a.validateParams(["svc",p,"object"],["asset",t,"object"],["size",h,"number",!0],["md5",d,"string",!0],["etag",n,"string",!0]),Pt(t,h,o))return xt({asset:t,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,md5:d,progressCb:c,relation:l,size:h,svc:p});const f=o,_=h||wt(o);F(t.links,[l]);const m=a.getLinkHrefTemplated(t.links,l,{component_id:r});return u.default.resolve(void 0,{blockUpload:void 0}).then((()=>je({asset:t,additionalHeaders:e,contentType:s,data:f,etag:n,headHref:m,href:m,maybeIsNew:i,relation:l,svc:p}))).then((e=>{let r={};try{r=se(e)}catch(e){}return{response:e,result:{revision:e.headers.revision||e.headers.version,location:e.headers.location,links:r,etag:e.headers.etag,version:e.headers.version||e.headers.revision,md5:e.headers.md5||e.headers["content-md5"],length:_,type:s},isBlockUpload:!1,asset:{assetId:t.assetId||e.headers["asset-id"],repositoryId:t.repositoryId||e.headers["repository-id"],links:t.links||r}}})).catch((e=>{throw e}))}function xt({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,progressCb:n,relation:i,size:d,componentId:c,md5:l,etag:h}){if(!d)throw new o.DCXError(o.DCXError.INVALID_DATA,"A size estimate is required when a GetSliceCallback is provided. The size is used to determine the number of requests required to block transfer the asset.");let u=r;r&&!a.isAnyFunction(r)&&(u=Ue.bind("string"==typeof r?r:a.dataToBuffer(r))),F(t.links,[p.BLOCK_UPLOAD_INIT]);const f=new kt(e,u,t,i,d,s,c,l,h);f.onProgress=n;const _=f.init();return _.then((e=>(_.blockUpload=e,e.start()))).then((e=>{const r=e.finalizeResponse||{headers:{}};return{response:r,result:e.uploadRecord,blockUpload:e,isBlockUpload:!0,asset:{assetId:t.assetId||r.headers["asset-id"],repositoryId:t.repositoryId||r.headers["repository-id"],etag:r.headers.etag,links:t.links}}}))}const Ut=Re;class Bt{constructor(e=1e5,t="SESSION"){if(this.values={},this.maxEntries=1e5,this.promiseToResolveMap=new Map,e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Cache Max enteries must be great than 0.");this.maxEntries=e,this.defaultSessionKey=t}clear(){this.promiseToResolveMap.forEach((e=>{e.call(void 0)}));for(const e in this.values)this.values[e].clear();this.values={}}getKey(e){if(e.assetId||"object"!=typeof e)return e.assetId}getValueWithAsset(e){if(!e.assetId&&"object"==typeof e)return;const t=this.getKey(e);return t?this.get(t,e.repositoryId):void 0}setPending(e,t=this.defaultSessionKey){let r;this.values[t]||(this.values[t]=new Map);const s=this.values[t].get(e);if(s&&s instanceof Promise)return this.promiseToResolveMap.get(s);const o=new Promise((e=>{r=e}));return this.values[t].set(e,o),this.promiseToResolveMap.set(o,r),o.then((()=>this.promiseToResolveMap.delete(o))).catch((()=>this.promiseToResolveMap.delete(o))),r}get(e,t=this.defaultSessionKey){if(this.values[t]&&t in this.values)return this.values[t].get(e)}setValueWithAsset(e,t){if(!e)return;const r=this.getKey(t);if(r){const s=t.repositoryId||this.defaultSessionKey;this.set(e,r,s)}}set(e,t,r=this.defaultSessionKey){if(this.values[r]){if(this.values[r]&&this.values[r].get(t)instanceof Promise){const s=this.values[r].get(t),o=this.promiseToResolveMap.get(s);this.promiseToResolveMap.delete(s),o&&o(e)}}else this.values[r]=new Map;if(this.values[r].size>=this.maxEntries){const e=this.values[r].keys().next().value;this.values[r].delete(e)}this.values[r].set(t,Promise.resolve(e))}delete(e,t=this.defaultSessionKey){this.values[t]&&this.values[t].delete(e)}deleteWithAsset(e){const t=this.getKey(e);t&&this.delete(t,e.repositoryId)}}function jt(e){return e||"defaultbuffer"}function Vt(e,r,s="json"){a.validateParams(["svc",e,"object"],["asset",r,"object"],["format",s,"enum",!1,["json","xml"]]),F(r.links,[p.EMBEDDED_METADATA]);const o=a.getLinkHref(r.links,p.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.GET,o,{accept:t.EmbeddedMetadataMediaTypes[s.toUpperCase()],vary:"accept"},void 0,{isStatusValid:H(),responseType:"json"===s?"json":"text"}).then((e=>({result:e.response,response:e})))}function Ht(e,r,s,o,n="json",i={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0],["format",n,"enum",!1,["json","xml"]]),F(r.links,[p.EMBEDDED_METADATA]);const d=a.getLinkHref(r.links,p.EMBEDDED_METADATA),c=Object.assign(Object.assign({},i),{[t.HeaderKeys.CONTENT_TYPE]:t.EmbeddedMetadataMediaTypes[n.toUpperCase()],[t.HeaderKeys.IF_MATCH]:o});return e.invoke(t.HTTPMethods.PUT,d,c,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H()})}function Ft(e,r,s,o){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0]),F(r.links,[p.EMBEDDED_METADATA]);const n=a.getLinkHref(r.links,p.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.PATCH,n,{[t.HeaderKeys.CONTENT_TYPE]:m,[t.HeaderKeys.IF_MATCH]:o},"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}})}const Yt=n.newDebug("dcx:assets:filebase"),Wt=n.newDebug("dcx:assets:filebase:leaf");class qt extends et{constructor(e,r,s){super(e,r,s),this._data.width=null!=e.width?e.width:e[t.Properties.IMAGE_WIDTH],this._data.length=null!=e.length?e.length:e[t.Properties.IMAGE_LENGTH],this._data.renderable=null!=e.renderable?e.renderable:"object"==typeof this._data.links?p.RENDITION in this._data.links:void 0}get width(){return this._data.width}get length(){return this._data.length}get renderable(){return this._data.renderable}getRendition(e,t,r,s){return Yt("getRendition()"),a.validateParams(["opts",e,"object",!0],["responseType",t,"string",!0],["linkProvider",r,"object",!0]),this.fetchLinksIfMissing([p.RENDITION],s).then((()=>zt(this._svc,this,e,t,r,s)))}getEmbeddedMetadata(e="json"){return Yt("getEmbeddedMetadata()"),a.validateParams(["format",e,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([p.EMBEDDED_METADATA]).then((()=>Vt(this._svc,this,e)))}putEmbeddedMetadata(e,t,r="json"){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([p.EMBEDDED_METADATA]).then((()=>Ht(this._svc,this,e,t,r)))}patchEmbeddedMetadata(e,t){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([p.EMBEDDED_METADATA]).then((()=>Ft(this._svc,this,e,t)))}blockDownload(e,t,r,s,o,n){Yt("blockDownload()"),a.validateParams(["startByte",e,"number",!0],["endByte",t,"number",!0],["resource",r,"string",!0],["componentId",s,"string",!0],["version",o,"string",!0],["responseType",n,"enum",!0,v]),a.assert((()=>null==e||null==t||e<t),"endByte must be greater than startByte");const i={};return this._withSourcePromise(i).then((()=>this.fetchLinksIfMissing([p.BLOCK_DOWNLOAD]))).then((()=>Gt.call(i,this._svc,this,e,t,r,s,o,n)))}updatePrimaryResource(e,t,r,s,o){Yt("updatePrimaryResource()");const n=a.isFunction(e)?p.BLOCK_UPLOAD_INIT:p.PRIMARY;return this.fetchLinksIfMissing([n]).then((()=>Kt(this._svc,this,e,t,r,s,o))).then((e=>(this._data.etag=e.result.etag,this._data.md5=e.result.md5,this._data.length=e.result.length,this._data.version=e.result.version,e)))}}function zt(e,r,s,o="defaultbuffer",n,i){Wt("getRendition()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["opts",s,"object",!0],["linkProvider",n,"object",!0]),F(r.links,[p.RENDITION]);const d=n?a.provideLink(r.links[p.RENDITION],n,s):a.getLinkHrefTemplated(r.links,p.RENDITION,Object.assign({},s));return e.invoke(t.HTTPMethods.GET,d,i,void 0,{responseType:jt(o),isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function Gt(e,t,r,s,o,n,i,d){Wt("doBlockDownload()"),a.validateParams(["svc",e,"object"],["assetOrPresignedUrl",t,["object","string"]],["startByte",r,"number",!0],["endByte",s,"number",!0],["resource",o,"string",!0],["componentId",n,"string",!0],["version",i,"string",!0],["responseType",d,"enum",!0,v]),a.assert((()=>null==r||null==s||r<s),"endByte must be greater than startByte");const c=null!=this?this:{};if("string"==typeof t)return ke.call(c,e,t,r,s,d,!0);const l=t;F(l.links,[p.BLOCK_DOWNLOAD]);const h=a.pruneUndefined({reltype:o,component_id:n,revision:i}),u=a.getLinkHrefTemplated(l.links,p.BLOCK_DOWNLOAD,{resource:void 0!==typeof o?JSON.stringify(h):void 0});return ke.call(c,e,u,r,s,d,!1)}function Kt(e,t,r,s,o,n,i,d){return Wt("updatePrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["dataOrSliceCallback",r,["function","object","string"]],["contentType",s,"string"],["size",o,"number",!0],["md5",i,"string",!0]),F(t.links,[p.PRIMARY]),Xt({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,relation:p.PRIMARY,size:o,md5:i,maybeIsNew:!1,etag:n,additionalHeaders:d}).catch((a=>{var d;if(413===(null===(d=a.response)||void 0===d?void 0:d.statusCode))return xt({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,relation:p.PRIMARY,size:o,md5:i,etag:n});throw a}))}const $t=n.newDebug("dcx:assets:pagination");class Jt{constructor(e,t,r){if(this._links=e,this._svc=t,this._transformer=r,this._items={},!e||!e[p.PAGE])throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset must have links that contain a page relation.")}get items(){return Object.values(this._items)}get data(){return this._data}getPage(e={},r){$t("getPage()");const{embed:s}=e,o=T(e,["embed"]);s&&(o.embed=s.join(","));const n=a.getLinkHrefTemplated(this._links,p.PAGE,o);return this._svc.invoke(t.HTTPMethods.GET,n,r,void 0,{isStatusValid:H(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}getNextPage(){if($t("getNextPage()"),this.hasNextPage()&&this._nextPageLink)return this._svc.invoke(t.HTTPMethods.GET,this._nextPageLink.href,void 0,void 0,{isStatusValid:H(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}hasNextPage(){return $t("hasNextPage() ",void 0!==this._nextPageLink),void 0!==this._nextPageLink}[Symbol.asyncIterator](){return this}next(){return b(this,void 0,void 0,(function*(){if($t("next()"),!this.hasNextPage())return{done:!0,value:void 0};const e=yield this.getNextPage();return e?{done:!1,value:e}:{done:!0,value:void 0}}))}parseResponse(e){$t("parseResponse()"),this._items={};const r=e.response;for(const e in r[t.Properties.CHILDREN]){const s=r[t.Properties.CHILDREN][e],[o,n]=this._transformer(s,this._svc);this._items[o]=n}return this._nextPageLink=r[t.Properties.LINKS].next,this.currentPage=r[t.Properties.PAGE],r}}const Zt=n.newDebug("dcx:assets:version"),Qt=n.newDebug("dcx:assets:version:leaf");class er extends qt{constructor(e,t,r){super(e,t,r),this._svc=t,this.type="version",this._data=sr(e)}get milestone(){return this._data.milestone}getRepositoryResource(){throw Zt("getRepositoryResource()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getEffectivePrivileges(){throw Zt("getEffectivePrivileges()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}performBulkRequest(e,t){throw Zt("performBulkRequest()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}checkACLPrivilege(e,t){throw Zt("checkACLPrivilege()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getACLPolicy(){throw Zt("getACLPolicy()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}}function tr(e){Qt("adobeVersionTransformer()");const t=sr(e);return t.links=a.merge({},e.links,e._links),[t.version,t]}function rr(e,t){Qt("versionTransformer()");const r=new er(e,t);return[r.version,r]}function sr(e){return Qt("deserializeVersion()"),{version:e.version||e[t.VersionProperties.VERSION],createDate:e.created||e[t.VersionProperties.CREATED],createdBy:e.createdBy||e[t.VersionProperties.CREATED_BY],milestone:e.milestone||e[t.VersionProperties.MILESTONE],links:e._links}}const or=n.newDebug("dcx:assets:file"),nr=n.newDebug("dcx:assets:file:leaf");class ir extends qt{constructor(e,t,r){super(e,t,r),this.type="file"}getPagedVersions(e={itemTransformer:rr},t){return or("getPagedVersions()"),a.validateParams(["pageOpts",e,"object",!0]),this.fetchLinksIfMissing([p.PAGE],t).then((()=>cr(this._svc,this,e,t)))}getVersionResource(e,t){return or("getVersionResource()"),a.validateParams(["version",e,"string"]),this.fetchLinksIfMissing([p.PAGE],t).then((()=>dr(this._svc,this,e,t).then((e=>({result:e.result?new er(e.result,this._svc):void 0,response:e.response})))))}patchVersions(e,t){return or("patchVersions()"),a.validateParams(["patchDoc",e,["string","array"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([p.VERSION_HISTORY]).then((()=>ar(this._svc,this,e,t)))}initBlockUpload(e,t){return a.validateParams(["transferDocument",e,"object"],["additionalHeaders",t,"object",!0]),this.fetchLinksIfMissing([p.BLOCK_UPLOAD_INIT],t).then((()=>Mt(this._svc,this,e,t)))}copy(e,t,r,s){return super.copy(e,t,r).then((({response:e,result:t})=>({response:e,result:new ir(t,this.serviceConfig)})))}}function ar(e,r,s,o){nr("patchVersions()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["patchDoc",s,["string","array"]],["etag",o,"string",!0]),F(r.links,[p.VERSION_HISTORY]);const n={[t.HeaderKeys.CONTENT_TYPE]:m};o&&(n[t.HeaderKeys.IF_MATCH]=o);const i=a.getLinkHref(r.links,p.VERSION_HISTORY);return e.invoke(t.HTTPMethods.PATCH,i,n,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H()})}function dr(e,r,s,o){nr("getVersionResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string"]),F(r.links,[p.PAGE]),W(r.links,p.PAGE,"type","application/vnd.adobe.versions+json");const n=a.getLinkHrefTemplated(r.links,p.PAGE,{version:s});return e.invoke(t.HTTPMethods.GET,n,o,void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response[t.VersionProperties.TOTAL_CHILDREN]>0?e.response[t.Properties.CHILDREN][0]:void 0,response:e})))}function cr(e,t,r={},s){return nr("getPagedVersions()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["pageOpts",r,"object"]),F(t.links,[p.PAGE]),W(t.links,p.PAGE,"type","application/vnd.adobe.versions+json"),new Jt(t.links,e,r.itemTransformer||tr).getPage(r,s)}const lr=n.newDebug("dcx:assets:composite"),hr=n.newDebug("dcx:assets:composite:leaf"),ur=n.AdobeDCXLogger.getInstance();class pr extends ir{constructor(e,t,r){super(e,t,r),this.type="composite"}headManifest(e){return lr("headManifest()"),this.fetchLinksIfMissing([p.MANIFEST],e).then((()=>fr(this._svc,this,e))).then((e=>this._updateDataWithResponse(e)))}getManifest(e,t,r){return lr("getManifest()"),a.validateParams(["version",e,"string",!0],["etag",t,"string",!0]),this.fetchLinksIfMissing([p.MANIFEST],r).then((()=>_r(this._svc,this,e,t,r)))}getManifestUrl(e){lr("getManifestUrl()");const t=null==e?p.MANIFEST:p.PAGE;return this.fetchLinksIfMissing([t]).then((()=>mr(this._svc,this,e)))}getManifestAndComponentsByPath(e,t,r,s){return hr("getManifestAndComponentsByPath()"),Er(this._svc,this,e,t,r,s)}getComponent(e,t,r,s){lr("getComponent()");const o={};return this._withSourcePromise(o).then((()=>this.fetchLinksIfMissing([p.COMPONENT],s))).then((()=>Ir.call(o,this._svc,this,e,t,r,s)))}getComponentByPath(e,t="defaultbuffer",r){return lr("getComponentByPath()"),Dr(this.serviceConfig,this,e,t,r)}getComponentUrl(e,t,r){return lr("getComponentUrl()"),this.fetchLinksIfMissing([p.COMPONENT],r).then((()=>Cr(this._svc,this,e,t)))}updateManifest(e,t,r,s,o){return lr("updateManifest()"),this.fetchLinksIfMissing([p.MANIFEST],o).then((()=>yr(this._svc,this,e,t,r,s,o))).then(this._updateDataWithResponse.bind(this))}putComponent(e,t,r,s,n,i,d,c){if(lr("putComponent()"),s&&!a.verifyUuid(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(e)||ur.warn("Existing component id is not a uuid"),this.fetchLinksIfMissing([p.COMPONENT],c).then((()=>vr(this._svc,this,e,t,r,s,n,i,d,c)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([p.EMBEDDED_METADATA],s).then((()=>Ht(this._svc,this,e,t,r,s))).then((e=>b(this,void 0,void 0,(function*(){return yield this.headManifest(s),e}))))}patchEmbeddedMetadata(e,t){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([p.EMBEDDED_METADATA]).then((()=>Ft(this._svc,this,e,t))).then((e=>b(this,void 0,void 0,(function*(){return yield this.headManifest(),e}))))}copy(e,t,r,s){return super.copy(e,t,r,s).then((({response:e,result:t})=>({response:e,result:new pr(t,this.serviceConfig)})))}}function fr(e,r,s){hr("headCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.MANIFEST]);const o=a.getLinkHref(r.links,p.MANIFEST);return e.invoke(t.HTTPMethods.HEAD,o,s,void 0,{responseType:"json",isStatusValid:H()})}function _r(e,r,s,o,n){return hr("getCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string",!0],["etag",o,"string",!0]),F(r.links,[p.MANIFEST]),mr(e,r,s,n).then((r=>e.invoke(t.HTTPMethods.GET,r,Object.assign(null!=n?n:{},o?{[t.HeaderKeys.IF_NONE_MATCH]:o}:{}),void 0,{responseType:"json",isStatusValid:H([304])}))).then((e=>({manifestData:e.response||null,manifestEtag:e.headers.etag,response:e})))}function mr(e,r,s,n){return hr("getCompositeManifestUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["versionId",s,"string",!0]),u.default.resolve().then((()=>{if(s)return dr(e,r,s,n)})).then((e=>{if(null!=s){if(!e||!a.isObject(e)||"object"!=typeof e.result)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Invalid version resource.",void 0,e?e.response:void 0);return F(e.result[t.Properties.LINKS],[p.MANIFEST]),a.getLinkHref(e.result[t.Properties.LINKS],p.MANIFEST)}return a.getLinkHref(r.links,p.MANIFEST)}))}function Er(e,r,s,n,i,d){a.validateParams(["svc",e,"object"],["asset",r,"object"],["components",s,"array"],["version",n,"string",!0],["etag",i,"string",!0]);const c=[p.MANIFEST,p.COMPONENT,p.BULK_REQUEST,p.BLOCK_DOWNLOAD];return n&&c.push(p.PAGE),Ct(e,r,c,void 0,d).then((c=>b(this,void 0,void 0,(function*(){r.links=Object.assign({},r.links,c);const l={method:t.HTTPMethods.GET,href:yield mr(e,r,n,d),headers:Object.assign(i?{[t.HeaderKeys.IF_NONE_MATCH]:i}:{},d)},h=s.map((({component_path:e})=>({method:t.HTTPMethods.GET,href:a.getLinkHrefTemplated(r.links,p.COMPONENT,{component_path:e}),headers:d})));h.unshift(l);const f=yield Promise.all(a.chunkArray(h,10).map((t=>a.withRetries((()=>Ge(e,r,t,void 0,d,!0))))));return u.default.resolve(yield f.reduce(((n,i,d)=>b(this,void 0,void 0,(function*(){var d,c;const l=yield n;if(l.responses.push(i.response),200!==i.response.statusCode)return l;const{componentResponses:h,manifestResponse:u}=i.result.reduce(((e,r)=>{var s,o;return(null===(s=r.headers[t.HeaderKeys.CONTENT_TYPE])||void 0===s?void 0:s.startsWith(_))||(null===(o=r.headers[t.HeaderKeys.CONTENT_ID])||void 0===o?void 0:o.includes("component_id=manifest"))?e.manifestResponse=r:e.componentResponses.push(r),e}),{componentResponses:[]});if(Object.assign(l.components,yield function(e,r,s,n){return b(this,void 0,void 0,(function*(){return(yield Promise.all(r.map((r=>b(this,void 0,void 0,(function*(){if("application/problem+json"===r.headers[t.HeaderKeys.CONTENT_TYPE]&&r.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){const o=gr(r,e),i=r.headers.location?r.headers.location:a.getLinkHrefTemplated(n,p.BLOCK_DOWNLOAD,{resource:JSON.stringify({component_path:o.component_path})}),d=yield ke(s,i,void 0,void 0,"defaultbuffer",!0);return Object.assign(d.headers,{[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),d}return r})))))).reduce(((t,r)=>{const s=gr(r,e);try{const e=o._responseToError(r);t[s.component_path]=Object.assign({},s,{response:r,[e?"error":"data"]:e||Ar(r.response,s.responseType||"defaultbuffer",r.headers["content-type"])})}catch(e){t[s.component_path]=Object.assign({},s,{response:r,error:new o.DCXError(o.DCXError.UNEXPECTED,"Error parsing sub-response into requested responseType",e)})}return t}),{})}))}(s,h,e,r.links)),!u)return l;if(200===u.statusCode)return l.manifest.data=Ar(u.response,"json"),l.manifest.response=u,S(r)&&"function"==typeof(null===(d=r.current)||void 0===d?void 0:d.parse)&&r.current.parse(a.arrayBufferToString(u.response)),r.links=se(u),l;if(304===u.statusCode)return l.manifest.response=u,l;if(404===u.statusCode)return l.manifest.error=new o.DCXError(o.DCXError.NO_COMPOSITE,a.arrayBufferToString(u.response)||"Composite missing or deleted",void 0,u),l;if("application/problem+json"===u.headers[t.HeaderKeys.CONTENT_TYPE]&&u.response.type!==o.ProblemTypes.RESPONSE_TOO_LARGE)return l.manifest.error=o._responseToError(u)||new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,u.response.title||"Operation failed.",void 0,u),l;try{const t=u.headers.location?u.headers.location:a.getLinkHrefTemplated(r.links,p.BLOCK_DOWNLOAD,{resource:JSON.stringify({reltype:p.MANIFEST})}),s=yield ke(e,t,void 0,void 0,"json");l.manifest.data=s.response,l.manifest.response=s,S(r)&&"function"==typeof(null===(c=r.current)||void 0===c?void 0:c.parse)&&r.current.parse(JSON.stringify(s.response)),r.links=se(s)}catch(e){l.manifest.error=new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Error fetching manifest via block download",e)}return l}))),Promise.resolve({manifest:{},components:{},responses:[]})))}))))}function gr(e,r){if(!e.headers[t.HeaderKeys.CONTENT_ID])throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Sub-response is missing content-id header",void 0,e);const s=new URL(e.headers[t.HeaderKeys.CONTENT_ID]).searchParams.get("component_path");return r.find((e=>e.component_path===s))}function Ar(e,t,r){switch(t){case"text":return a.arrayBufferToString(e);case"json":return JSON.parse(a.arrayBufferToString(e));case"blob":return new Blob([e],{type:r});case"buffer":case"defaultbuffer":return e;case"arraybuffer":return e.buffer}throw new o.DCXError(o.DCXError.INVALID_PARAMS,"requested response type is not supported")}function Cr(e,t,r,s){return hr("getCompositeComponentUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string",!0]),F(t.links,[p.COMPONENT]),a.getLinkHrefTemplated(t.links,p.COMPONENT,{component_id:r,revision:s})}function Dr(e,t,r,s="defaultbuffer",o){return a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentPath",r,"string"],["responseType",s,"string",!0],["additionalHeaders",o,"object",!0]),Ct(e,t,[p.COMPONENT],void 0,o).then((n=>Be(B(e),t,a.getLinkHrefTemplated(n,p.COMPONENT,{component_path:r}),p.COMPONENT,s,void 0,void 0,o)))}function Ir(e,t,r,s,o="defaultbuffer",n){hr("getCompositeComponent()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"],["responseType",o,"string",!0],["additionalHeaders",n,"object",!0]);const i=Cr(e,t,r,s);return Be.call({},e,t,i,p.COMPONENT,o,r,s,n)}function yr(e,r,s,n,i=1,d,c={}){if(hr("updateCompositeManifest() ",n,d),a.validateParams(["svc",e,"object"],["asset",r,"object"],["manifest",s,["object","string"]],["overwrite",n,"boolean"],["validationLevel",i,"+number"],["etag",d,"string",!0]),i<1)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"ValidationLevel must be >=1");return F(r.links,[p.BULK_REQUEST,p.REPO_METADATA]),mr(e,r,void 0,c).then((r=>{const o=Object.assign({},c);n?o[t.HeaderKeys.IF_MATCH]="*":d&&(o[t.HeaderKeys.IF_MATCH]=d);const a=`${_}; validation-level=${i}`;return o[t.HeaderKeys.CONTENT_TYPE]=a,e.invoke(t.HTTPMethods.PUT,r,o,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:H([412,409]),responseType:"json"})})).then((t=>{if(hr("uCM() status code: ",t.statusCode),412===t.statusCode&&n)return hr("uCM() retry 412 without overwrite"),yr(e,r,s,!1,i,void 0,c);if(409===t.statusCode&&n)return hr("uCM() retry 409 without overwrite"),yr(e,r,"string"==typeof s?s:JSON.stringify(s),!1,i,d,c);if(409===t.statusCode)throw new o.DCXError(o.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,t);if(412===t.statusCode)throw new o.DCXError(o.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,t);return t}))}function vr(e,t,r,s,n,i,d,c,l,h){if(a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["contentType",n,"string"],["maybeIsNew",i,"boolean",!0],["size",d,"number",!0],["md5",c,"string",!0]),i&&!a.verifyUuid(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");a.verifyUuid(r)||ur.warn("Existing component id is not a uuid");const u=Xt({svc:e,asset:t,dataOrSliceCallback:s,contentType:n,relation:p.COMPONENT,size:d,componentId:r,md5:c,maybeIsNew:i,additionalHeaders:h,progressCb:l});return u.progress=l,u.then((({response:e,result:t,isBlockUpload:s,asset:o})=>{const i={response:e,result:Object.assign(Object.assign({},t),{id:r,type:n}),isBlockUpload:s,asset:o};return Object.defineProperty(i,"compositeAsset",{get:()=>o}),i}))}const Tr=n.newDebug("dcx:assets:directory"),br=n.newDebug("dcx:assets:directory:leaf");class Pr extends et{constructor(e,r,s){super(e,r,s),this.type="directory",this.children=[],this.children=e[t.Properties.CHILDREN]}getPagedChildren(e,t){return Tr("getPagedChildren()"),this.fetchLinksIfMissing([p.PAGE],t).then((()=>Or(this._svc,this,e,t)))}createAsset(e,t,r,s,o){return Tr("createAsset()"),a.validateParams(["relPath",e,"string"],["createIntermediates",t,"boolean"],["contentType",r,"string"],["additionalHeaders",o,"object",!0]),this.fetchLinksIfMissing([p.CREATE],o).then((()=>Nr(this._svc,this,e,t,r,s,o))).then((e=>(this._cache&&e.result.links&&this._cache.setValueWithAsset(e.result.links,e.result),{result:new et(e.result,this.serviceConfig),response:e.response})))}copy(e,t,r){return super.copy(e,t,r).then((({response:e,result:t})=>({response:e,result:new Pr(t,this.serviceConfig)})))}}function Rr(e){br("directoryTransformer()");const r=ae(e);r.links=a.merge({},e.links,e._links);const s=e.children||e[t.Properties.CHILDREN];return s&&s.length>0?r.children=s.map((e=>ae(e))):r.children=[],[r.assetId,r]}function wr(e,r){return br("getDirectoryByURL()"),e.invoke(t.HTTPMethods.GET,r,void 0,void 0,{responseType:"json",isStatusValid:H()}).then((e=>({result:e.response,response:e})))}function Or(e,t,r={},s){if(br("getPagedChildren()"),F(t.links,[p.PAGE]),r&&r.embed&&r.embed.includes(p.REPOSITORY))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Repository Resource embeds on directory listings are not supported");try{return new Jt(t.links,e,Rr).getPage(r,s)}catch(e){return u.default.reject(e)}}function Nr(e,r,s,n,i,d,c={}){br("createAsset()"),a.validateParams(["service",e,"object"],["parentDir",r,"object"],["relPath",s,"string"],["createIntermediates",n,"boolean"],["contentType",i,"string"],["additionalHeaders",c,"object",!0]),F(r.links,[p.CREATE]);const l=a.isObject(d)?JSON.stringify(d):d,u=a.getLinkHrefTemplated(r.links,p.CREATE,{path:s,intermediates:n.toString(),respondWith:l,mode:"id"}),f=Object.assign({},{[t.HeaderKeys.CONTENT_TYPE]:i},c);return e.invoke(t.HTTPMethods.POST,u,f,void 0,{responseType:"json",isStatusValid:H()}).then((e=>{var n;const c=s.split("/")[s.split("/").length-1];let l;r.path&&(l=a.appendPathElements(r.path,s));const u=se(e),f=e.headers;if(null===(n=f[t.HeaderKeys.CONTENT_TYPE])||void 0===n?void 0:n.includes("multipart/mixed")){const t=Ye(e)[1];throw 404===t.statusCode?new h.default(o.DCXError.ASSET_NOT_FOUND,"Asset was created successfully but repository metadata could not be found.",void 0,e):403===t.statusCode?new h.default(o.DCXError.FORBIDDEN,"Asset was created successfully but Permission denied for fetching repository metadata.",void 0,e):o.unexpectedResponse("Unexpected Server Response",void 0,e)}const _=a.isObject(e.response)?e.response:{etag:"",md5:""},m=f["asset-id"]||f["x-resource-id"],E=r.repositoryId;let g=_.etag,A=_.md5;null==d&&(g=f.etag,A=f["content-md5"]);const C=a.isObject(e.response)&&d&&(d===p.REPO_METADATA||a.isObject(d)&&d.reltype===p.REPO_METADATA)?ae(e.response):{};return{result:a.pruneUndefined(a.mergeDeep({name:c},C,a.pruneUndefined({links:u,assetId:m,etag:g,md5:A,repositoryId:E,format:i,path:l}))),response:e}}))}const Sr=n.newDebug("dcx:assets:discoverable");function Lr(e){Sr("discoverableAssetTransformer()");const r=e[t.Properties.EMBEDDED][p.REPO_METADATA],s=ae(r,e[t.Properties.EMBEDDED]);return s.links=a.merge({},e.links,r._links),[s.assetId,s]}function kr(e){Sr("discoverableReposTransformer()");const r=e[t.Properties.EMBEDDED][p.PRIMARY],s=de(r);return s.links=r._links,[s.repositoryId,s]}var Mr;t.RenditionType=void 0,(Mr=t.RenditionType||(t.RenditionType={})).IMAGE_JPG="image/jpg",Mr.IMAGE_PNG="image/png",Mr.VIDEO_MP4="video/mp4",Mr.VIDEO_METADATA="application/vnd.adobe.ccv.videometadata";const Xr=n.newDebug("dcx:assets:factory");function xr(e,t){Xr("hydrateAsset()"),a.validateParams(["asset",e,"object"],["svc",t,"object"]);const r=e.format||"",s=r.endsWith("+dcx")?"composite":r===f?"directory":r.split("/").length>1?"file":"asset";switch(s){case"directory":return e.type===s&&e instanceof Pr?e:new Pr(e,t);case"composite":return e.type===s&&e instanceof pr?e:new pr(e,t);case"file":return e.type===s&&e instanceof ir?e:new ir(e,t);case"asset":return e.type===s&&e instanceof et?e:new et(e,t);default:return new et(e,t)}}const Ur=n.newDebug("dcx:assets:indexdocument");function Br(e){Ur("deserializeIndexDocument()");const r=e.children.map((e=>{const r=ae(e[t.Properties.EMBEDDED][p.REPO_METADATA]),s=de(e[t.Properties.EMBEDDED][p.REPOSITORY]);return r.embedded={RepositoryResource:s},r}));return{regions:e[t.Properties.REPO_REGIONS],assignedDirectories:r,links:e._links}}const jr=n.newDebug("dcx:assets:versionset"),Vr=n.newDebug("dcx:assets:versionset:leaf");Object.defineProperty(t,"ProblemTypes",{enumerable:!0,get:function(){return o.ProblemTypes}}),t.ACLPolicyMediaType="application/vnd.adobecloud.accesscontrolpolicy+json",t.Asset=et,t.AssetFactory=class{constructor(e){this._svc=e}hydrate(e){return xr(e,this._svc)}},t.BlockTransferMediaType=E,t.BlockUpload=kt,t.Composite=pr,t.DEFAULT_BLOCK_DOWNLOAD_THRESHOLD=52428800,t.DEFAULT_BLOCK_UPLOAD_THRESHOLD=10485760,t.DEFAULT_CACHE_MAX_ENTRIES=1e5,t.DEFAULT_MAX_CONCURRENT_REQUESTS=4,t.Directory=Pr,t.DirectoryMediaType=f,t.File=ir,t.GenericCache=Bt,t.JSONLDMediaType="application/ld+json",t.JSONMediaType="application/json",t.JSONPatchMediaType=m,t.JSONProblemMediaType="application/problem+json",t.LinkRelation=p,t.MAX_CACHE_PERIOD_MS=2592e6,t.ManifestMediaType=_,t.OperationDocumentBuilder=De,t.OperationDocumentMediaType="application/vnd.adobe.asset-operation+json",t.PageResource=Jt,t.RepositoryLinksCache=class extends Bt{constructor(e=1e5,t=2592e6){super(e,"SESSION"),this.timestampsOnLinkCreation=0,this.maxCachePeriodMS=0,this.maxCachePeriodMS=t}isLinkExpired(){return this.maxCachePeriodMS<Date.now()-this.timestampsOnLinkCreation}setIndexLinks(e){this.set(e,"INDEX","SESSION"),this.timestampsOnLinkCreation=Date.now()}getIndexLinks(){if(!this.isLinkExpired())return this.get("INDEX","SESSION")}setIndexRepository(e){this.indexRepository=e}getIndexRepository(){return this.indexRepository}},t.STREAMABLE_RESPONSE_TYPES=v,t.Version=er,t.VersionSet=class{constructor(e,r,s){this._svc=r,this.versionCount=e.versionCount||e[t.VersionProperties.TOTAL_CHILDREN],this.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],this.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],this.versions=[];for(const s in e.versions||e[t.Properties.CHILDREN])this.versions.push(new er(e.versions&&e.versions[s]?e.versions[s]:e[t.Properties.CHILDREN][s],r));this.links=a.merge({},e.links,e._links,s)}versionByVersionId(e){return jr("versionByVersionId()"),this.versions.find((t=>t.version===e))}versionsByLabel(e){return jr("versionsByLabel()"),this.versions.filter((t=>!(!t.milestone||t.milestone.label!==e)))}},t._linksThatRequireFullResolve=Dt,t.adobeVersionTransformer=tr,t.assertLinksContain=F,t.assertLinksContainAny=Y,t.assertValidBulkRequest=ze,t.assetTransformer=function(e){Qe("assetTransformer()");const t=ae(e);return t.links=a.merge({},e.links,e._links),[t.assetId,t]},t.blockTransferManager=Ut,t.bodyToUint8Array=Fe,t.buildRangeHeader=Xe,t.checkACLPrivilege=mt,t.constructMultipartRequestBody=He,t.constructServiceEndpoint=V,t.convertToACPRepoMetadataResource=function(e){ie("convertToACPRepoMetadataResource()");const r={};return r[t.Properties.REPO_REPOSITORY_ID]=e[t.Properties.REPO_REPOSITORY_ID]||e.repositoryId,r[t.Properties.REPO_ASSET_ID]=e[t.Properties.REPO_ASSET_ID]||e.assetId,r[t.Properties.REPO_NAME]=e[t.Properties.REPO_NAME]||e.name,r[t.Properties.REPO_SIZE]=null!=e[t.Properties.REPO_SIZE]?e[t.Properties.REPO_SIZE]:e.size,r[t.Properties.REPO_PATH]=e[t.Properties.REPO_PATH]||e.path,r[t.Properties.REPO_ASSET_CLASS]=e[t.Properties.REPO_ASSET_CLASS]||e.etag,r[t.Properties.REPO_ETAG]=e[t.Properties.REPO_ETAG]||e.etag,r[t.Properties.REPO_VERSION]=e[t.Properties.REPO_VERSION]||e.version,r[t.Properties.DC_FORMAT]=e[t.Properties.DC_FORMAT]||e.format,r[t.Properties.REPO_CREATE_DATE]=e[t.Properties.REPO_CREATE_DATE]||e.createDate,r[t.Properties.REPO_MODIFY_DATE]=e[t.Properties.REPO_MODIFY_DATE]||e.modifyDate||e.modifiedDate,r[t.Properties.REPO_DISCARD_DATE]=e[t.Properties.REPO_DISCARD_DATE]||e.discardDate,r[t.Properties.REPO_CREATED_BY]=e[t.Properties.REPO_CREATED_BY]||e.createdBy,r[t.Properties.REPO_MODIFIED_BY]=e[t.Properties.REPO_MODIFIED_BY]||e.modifiedBy,r[t.Properties.REPO_DISCARDED_BY]=e[t.Properties.REPO_DISCARDED_BY]||e.discardedBy,r[t.Properties.REPO_DEVICE_CREATE_DATE]=e[t.Properties.REPO_DEVICE_CREATE_DATE]||e.deviceCreateDate,r[t.Properties.REPO_DEVICE_MODIFY_DATE]=e[t.Properties.REPO_DEVICE_MODIFY_DATE]||e.deviceModifyDate,r[t.Properties.REPO_BASE_ASSET_ID]=e[t.Properties.REPO_BASE_ASSET_ID]||e.baseAssetId,r[t.Properties.REPO_STATE]=e[t.Properties.REPO_STATE]||e.state,r[t.Properties.LINKS]=e[t.Properties.LINKS]||e.links,a.pruneUndefined(r)},t.copyAsset=he,t.copyResources=function(e,t,r,s){ce("copyResource()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["resources",s,"object"]),$(t,["path","assetId"],"string"),$(r,["path","assetId"],"string");const o=be("copy_resources",r,t,void 0,{resources:s}),n=B(e);return ne.call(this,e).then((e=>Ce(n,e,o))).then(Ie.bind(void 0,r)).then(ve)},t.createAsset=Nr,t.defaultBufferResponseType=jt,t.deleteACLPolicy=gt,t.deleteAsset=_e,t.deserializeAsset=ae,t.deserializeIndexDocument=Br,t.deserializeRepository=de,t.deserializeUploadComponentRecord=Ot,t.deserializeVersion=sr,t.deserializeVersionSet=function(e){Vr("deserializeVersionSet()");const r={versionCount:e[t.VersionProperties.TOTAL_CHILDREN],repositoryId:e[t.VersionProperties.REPO_ID],assetId:e[t.Properties.REPO_ASSET_ID],links:{},versions:[]},s=e.children||e[t.Properties.CHILDREN];return s&&s.length>0&&(r.versions=s.map((e=>sr(e)))),r.links=e._links,r},t.directoryTransformer=Rr,t.discardAsset=fe,t.discoverableAssetTransformer=Lr,t.discoverableReposTransformer=kr,t.doBatchOperation=function(e,t,r,s){return Ce(e,t,r,s).then(ge)},t.doBlockDownload=Gt,t.doLinksContain=q,t.doOperation=Ce,t.doesAssetContainLinks=z,t.fetchLinksForAsset=nt,t.fetchLinksForAssetWithResponse=it,t.fetchLinksIfMissing=Ct,t.getACLPolicy=_t,t.getAppMetadata=ht,t.getBaseDirectoryMetadata=dt,t.getCompositeComponent=Ir,t.getCompositeComponentByPath=Dr,t.getCompositeComponentPresignedUrl=function(e,r,s,n,i){return hr("getCompositeComponentPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["componentId",s,"string"],["componentRevision",n,"string"]),Ct(e,r,[p.BLOCK_DOWNLOAD],void 0,i).then((r=>{const o=a.getLinkHrefTemplated(r,p.BLOCK_DOWNLOAD,{resource:JSON.stringify({reltype:p.COMPONENT,revision:n,component_id:s})});return(X(e)?e.service:e).invoke(t.HTTPMethods.GET,o,i,void 0,{isStatusValid:H(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:t.HTTPMethods.GET}})})).then((e=>{if("string"!=typeof e.response.href)throw new o.DCXError(o.DCXError.INVALID_DATA,"Direct download URL not found.",void 0,e);return{response:e,result:e.response.href}}))},t.getCompositeComponentUrl=Cr,t.getCompositeManifest=_r,t.getCompositeManifestUrl=mr,t.getDataLength=wt,t.getDirectory=function(e,t){return br("directoryTransformer()"),Ct(e,t,[p.PRIMARY]).then((t=>wr(B(e),a.getLinkHref(t,p.PRIMARY))))},t.getDirectoryByURL=wr,t.getDiscoverableAssets=function(e,t={},r){Sr("getDiscoverableAssets()"),a.validateParams(["svc",e,"object"],["pageOpts",t,"object"]);const s=B(e);return re(e,r).then((e=>new Jt(e.assetLinks,s,Lr).getPage(t,r))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getDiscoverableRepos=function(e,r={},s){Sr("getDiscoverableRepos()"),a.validateParams(["svc",e,"object"],["pageOpts",r,"object"]);const o=B(e);return re(e,s).then((e=>{const r=a.getLinkHref(e.repositoryLinks,p.PRIMARY);return o.invoke(t.HTTPMethods.HEAD,r,s,void 0,{isStatusValid:H()})})).then((e=>{const t=se(e);return new Jt(t,o,kr).getPage(r,s)})).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getEffectivePrivileges=ft,t.getEmbeddedMetadata=Vt,t.getHTTPResource=Q,t.getIndexDocument=function(e,r){return Ur("getIndexDocument()"),a.validateParams(["svc",e,"object"]),re(e,r).then((s=>{const o=B(e),n=a.getLinkHref(s.indexLinks,p.PRIMARY);return o.invoke(t.HTTPMethods.GET,n,r,void 0,{responseType:"json",isStatusValid:H()})})).then((e=>({result:Br(e.response),response:e.response})))},t.getIndexLinks=te,t.getIndexRepository=re,t.getLinksForAsset=at,t.getLinksFromCache=yt,t.getManifestAndComponentsByPath=Er,t.getOpsHref=ne,t.getPagedChildren=Or,t.getPagedVersions=cr,t.getPrimaryResource=tt,t.getRendition=zt,t.getRepoMetadata=function(e,r,s){Qe("getRepoMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),F(r.links,[p.REPO_METADATA]);const o=a.getLinkHref(r.links,p.REPO_METADATA);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:H()}).then((e=>{const r=se(e),s=e.response;return s[t.Properties.LINKS]=a.merge({},s[t.Properties.LINKS],r),{result:s,response:e}}))},t.getRepositoryResource=ct,t.getReposityLinksCache=j,t.getResolveByIdHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByIdHref)return u.default.resolve(this.resolveByIdHref);if(a.isFunction(this.resolveByIdHref))return u.default.resolve(this.resolveByIdHref())}return te(e).then((e=>{try{return a.getLinkHref(e,p.RESOLVE_BY_ID)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByID href.",e)}}))},t.getResolveByPathHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByPathHref)return u.default.resolve(this.resolveByPathHref);if(a.isFunction(this.resolveByPathHref))return u.default.resolve(this.resolveByPathHref())}return te(e).then((e=>{try{return a.getLinkHref(e,p.RESOLVE_BY_PATH)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByPath href.",e)}}))},t.getResolveLinkForAsset=st,t.getService=B,t.getVersionResource=dr,t.headAppMetadata=lt,t.headCompositeManifest=fr,t.headHTTPResource=Z,t.headPrimaryResource=rt,t.hydrateAsset=xr,t.isACPAccessControlListLike=P,t.isAdobeDCXCompositeLike=S,t.isAdobeResponseLike=R,t.isBlob=L,t.isBufferLike=N,t.isHttpService=M,t.isMinimalAdobeAsset=function(e){return!!a.isObject(e)&&(a.isObject(e.links)||"string"==typeof e.repositoryId&&("string"==typeof e.path||"string"==typeof e.assetId))},t.isRepoResponseLike=w,t.isRepoResponseResultLike=O,t.isResolvableAsset=k,t.isServiceConfig=X,t.isTransferDocument=x,t.maybeGetBlockTransfer=Nt,t.moveAsset=pe,t.newBlockDownload=Le,t.newOperationDocBuilder=function(){return new De},t.normalizeCopyResourcesDesignator=e=>{if((e=>e.hasOwnProperty("source")&&e.hasOwnProperty("target"))(e))return{source:ue(e.source),target:ue(e.target)};const t=ue(e);return{source:t,target:t}},t.packageAssets=Ee,t.parseLinkString=oe,t.parseLinksFromResponseHeader=se,t.parseMultipartResponseParts=Ye,t.patchACLPolicy=Et,t.patchAppMetadata=pt,t.patchEmbeddedMetadata=Ft,t.patchVersions=ar,t.pauseBlockTransfer=function(e,t){return b(this,void 0,void 0,(function*(){const r=yield Nt(e);if(r)return t&&r.on("stateChanged",t),yield r.pause(),r}))},t.performBulkRequest=Ge,t.putAppMetadata=ut,t.putCompositeComponent=vr,t.putEmbeddedMetadata=Ht,t.resolveAsset=ot,t.restoreAsset=me,t.shouldUseBlockTransferForDownload=(e,t=52428800)=>((e,t)=>e>=t)(e,t),t.shouldUseBlockTransferForUpload=Pt,t.streamToGetSliceCallback=function(e,t,r,s=4){const n=Rt(r),i=n*s,d=new ArrayBuffer(i),c=new Uint8Array(d);let l=0;const h=a.isWHATWGReadableStream(e)?e.pipeThrough(function(e,t){let r;const s=new ByteLengthQueuingStrategy({highWaterMark:e*t});return{writable:new WritableStream({write(t){if(bt("Chunk Received:",t.byteLength),t.byteLength<e)r.enqueue(t);else{const s=Math.ceil(t.byteLength/e),o=[...Array(s).keys()].map((r=>t.subarray(r*e,Math.min((r+1)*e,t.byteLength))));for(const e of o)bt("enqueue smaller chunk:",e.byteLength),r.enqueue(e)}},close(){r.close()}},s),readable:new ReadableStream({start(e){r=e}},s)}}(n,s)).getReader():e;let u=!1,p=Promise.resolve();return function(e,t){return b(this,void 0,void 0,(function*(){if(u)return new Uint8Array([]);try{let r;const s=new Promise(((o,n)=>b(this,void 0,void 0,(function*(){function d(r){const s=l%i;if(r.byteLength+s>i){const e=i-s;c.set(r.subarray(0,e),s),c.set(r.subarray(e),0)}else c.set(r,s);if(l+=r.byteLength,bt(`chunk ${e}-${t} progress: ${l-e}/${t-e}`),l>=t){const r=c.subarray(e%i,t%i||t);bt(`resolving slice - start:  ${e}, end: ${t}, length: ${r.byteLength}`),o(r)}}if(a.isNodeReadableStream(h)){function f(){return b(this,void 0,void 0,(function*(){const e=h.read(t-l);null!==e&&d(e)}))}const _=()=>{u=!0,o(c.subarray(e%i,l%i||i))},m=()=>{h.off("readable",f),h.off("end",_),h.off("error",n)},E=()=>{h.on("readable",f),h.on("end",_),h.on("error",n)};r=()=>b(this,void 0,void 0,(function*(){E(),yield f(),s.finally(m)}))}else{function g(){return b(this,void 0,void 0,(function*(){const{value:r,done:s}=yield h.read();return s?(u=!0,bt("End of stream",e,l),o(c.subarray(e%i,l%i||i))):(d(r),l<=t?yield g():void 0)}))}r=()=>(bt("starting read for slice",e,t),g())}p=p.then((()=>b(this,void 0,void 0,(function*(){r(),yield s}))))}))));return s}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,e.message,e)}}))}},t.updateCompositeManifest=yr,t.updatePrimaryResource=Kt,t.useLinkOrResolveResource=At,t.versionTransformer=rr,t.waitForBlockDownloadToStart=function(e){return new Promise((t=>{let r;e.finally((()=>{clearTimeout(r),t()})),function s(){if(a.isObject(e.blockDownload))return clearTimeout(r),t();r=setTimeout(s,1)}()}))}},135623:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(464964);var o=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(r(528224));let n=!1;const i=globalThis;var a,d;n||(n=!0,i.dcxjs={_modules:{}},Object.assign(i.dcxjs,{getModule:e=>{var t;return null===(t=i.dcxjs)||void 0===t?void 0:t.modules[e]},registerModule:(e,t)=>{const r=i.dcxjs;if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");if(e in r.modules)throw new Error(`[@dcx/core] Module ${e} already registered.`);r.modules[e]={module:t}}}),Object.defineProperty(i.dcxjs,"modules",{get:()=>i.dcxjs._modules}),null===(a=i.dcxjs)||void 0===a||a.registerModule("AdobeDCXLogger",s.AdobeDCXLogger),Object.defineProperty(i.dcxjs,"logger",{get:()=>{var e;return null===(e=i.dcxjs)||void 0===e?void 0:e.getModule("AdobeDCXLogger").module},enumerable:!0}),null===(d=i.dcxjs)||void 0===d||d.registerModule("AdobeDCXPromise",o.default));const c=globalThis.dcxjs;t.dcxjs=c,t.default=c,t.getModule=e=>{var t;const r=i.dcxjs;if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");return null===(t=r.getModule(e))||void 0===t?void 0:t.module}},91427:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),r(135623);var s=r(882594),o=r(464964);r(14200);var n=r(29578),i=r(915561),a=r(6035),d=r(528224),c=r(616189),l=r(327350);function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=h(o),p=function(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}(n),f=h(a),_=h(d);class m{constructor(){this._communityId=null,this._artworkComponentId=null,this._assetId=null,this._resourcePath=null,this._mainResource=null,this._mainResourceVersion=null,this._artworkResource=null,this._artworkResourceVersion=null,this._title=null,this._alias=null,this._tags=[],this._description=null,this._categoryId=null,this._subCategoryIds=[],this._creatorIds=[],this._undiscoverable=!1,this._isPrivate=!1,this._custom=null}get communityId(){return this._communityId}set communityId(e){this._communityId=e}get artworkComponentId(){return this._artworkComponentId}set artworkComponentId(e){this._artworkComponentId=e}get assetId(){return this._assetId}set assetId(e){this._assetId=e}get resourcePath(){return this._resourcePath}set resourcePath(e){this._resourcePath=e}get mainResource(){return this._mainResource}set mainResource(e){this._mainResource=e}get mainResourceVersion(){return this._mainResourceVersion}set mainResourceVersion(e){this._mainResourceVersion=e}get artworkResource(){return this._artworkResource}set artworkResource(e){this._artworkResource=e}get artworkResourceVersion(){return this._artworkResourceVersion}set artworkResourceVersion(e){this._artworkResourceVersion=e}get title(){return this._title}set title(e){this._title=e}get alias(){return this._alias}set alias(e){this._alias=e}get tags(){return this._tags}set tags(e){this._tags=this._tags.concat(e)}get description(){return this._description}set description(e){this._description=e}get categoryId(){return this._categoryId}set categoryId(e){this._categoryId=e}get subCategoryIds(){return this._subCategoryIds}set subCategoryIds(e){this._subCategoryIds=this._subCategoryIds.concat(e)}get creatorIds(){return this._creatorIds}set creatorIds(e){this._creatorIds=this._creatorIds.concat(e)}get undiscoverable(){return this._undiscoverable}set undiscoverable(e){this._undiscoverable=e}get isPrivate(){return this._isPrivate}set isPrivate(e){this._isPrivate=e}get custom(){return this._custom}set custom(e){this._custom=e}}var E="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{};function g(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}var A=g((function(e,t){!function(r){var s=t&&!t.nodeType&&t,o=e&&!e.nodeType&&e,n="object"==typeof E&&E;n.global!==n&&n.window!==n&&n.self!==n||(r=n);var i,a,d=2147483647,c=36,l=/^xn--/,h=/[^\x20-\x7E]/,u=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,_=String.fromCharCode;function m(e){throw RangeError(p[e])}function g(e,t){for(var r=e.length,s=[];r--;)s[r]=t(e[r]);return s}function A(e,t){var r=e.split("@"),s="";return r.length>1&&(s=r[0]+"@",e=r[1]),s+g((e=e.replace(u,".")).split("."),t).join(".")}function C(e){for(var t,r,s=[],o=0,n=e.length;o<n;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<n?56320==(64512&(r=e.charCodeAt(o++)))?s.push(((1023&t)<<10)+(1023&r)+65536):(s.push(t),o--):s.push(t);return s}function D(e){return g(e,(function(e){var t="";return e>65535&&(t+=_((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+_(e)})).join("")}function I(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function y(e,t,r){var s=0;for(e=r?f(e/700):e>>1,e+=f(e/t);e>455;s+=c)e=f(e/35);return f(s+36*e/(e+38))}function v(e){var t,r,s,o,n,i,a,l,h,u,p,_=[],E=e.length,g=0,A=128,C=72;for((r=e.lastIndexOf("-"))<0&&(r=0),s=0;s<r;++s)e.charCodeAt(s)>=128&&m("not-basic"),_.push(e.charCodeAt(s));for(o=r>0?r+1:0;o<E;){for(n=g,i=1,a=c;o>=E&&m("invalid-input"),((l=(p=e.charCodeAt(o++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:c)>=c||l>f((d-g)/i))&&m("overflow"),g+=l*i,!(l<(h=a<=C?1:a>=C+26?26:a-C));a+=c)i>f(d/(u=c-h))&&m("overflow"),i*=u;C=y(g-n,t=_.length+1,0==n),f(g/t)>d-A&&m("overflow"),A+=f(g/t),g%=t,_.splice(g++,0,A)}return D(_)}function T(e){var t,r,s,o,n,i,a,l,h,u,p,E,g,A,D,v=[];for(E=(e=C(e)).length,t=128,r=0,n=72,i=0;i<E;++i)(p=e[i])<128&&v.push(_(p));for(s=o=v.length,o&&v.push("-");s<E;){for(a=d,i=0;i<E;++i)(p=e[i])>=t&&p<a&&(a=p);for(a-t>f((d-r)/(g=s+1))&&m("overflow"),r+=(a-t)*g,t=a,i=0;i<E;++i)if((p=e[i])<t&&++r>d&&m("overflow"),p==t){for(l=r,h=c;!(l<(u=h<=n?1:h>=n+26?26:h-n));h+=c)D=l-u,A=c-u,v.push(_(I(u+D%A,0))),l=f(D/A);v.push(_(I(l,0))),n=y(r,g,s==o),r=0,++s}++r,++t}return v.join("")}if(i={version:"1.3.2",ucs2:{decode:C,encode:D},decode:v,encode:T,toASCII:function(e){return A(e,(function(e){return h.test(e)?"xn--"+T(e):e}))},toUnicode:function(e){return A(e,(function(e){return l.test(e)?v(e.slice(4).toLowerCase()):e}))}},s&&o)if(e.exports==s)o.exports=i;else for(a in i)i.hasOwnProperty(a)&&(s[a]=i[a]);else r.punycode=i}(E)})),C=function(e){return"string"==typeof e},D=function(e){return"object"==typeof e&&null!==e},I=function(e){return null===e};function y(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var v=function(e,t,r,s){t=t||"&",r=r||"=";var o={};if("string"!=typeof e||0===e.length)return o;var n=/\+/g;e=e.split(t);var i=1e3;s&&"number"==typeof s.maxKeys&&(i=s.maxKeys);var a=e.length;i>0&&a>i&&(a=i);for(var d=0;d<a;++d){var c,l,h,u,p=e[d].replace(n,"%20"),f=p.indexOf(r);f>=0?(c=p.substr(0,f),l=p.substr(f+1)):(c=p,l=""),h=decodeURIComponent(c),u=decodeURIComponent(l),y(o,h)?Array.isArray(o[h])?o[h].push(u):o[h]=[o[h],u]:o[h]=u}return o},T=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}},b=function(e,t,r,s){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?Object.keys(e).map((function(s){var o=encodeURIComponent(T(s))+r;return Array.isArray(e[s])?e[s].map((function(e){return o+encodeURIComponent(T(e))})).join(t):o+encodeURIComponent(T(e[s]))})).join(t):s?encodeURIComponent(T(s))+r+encodeURIComponent(T(e)):""},P=g((function(e,t){t.decode=t.parse=v,t.encode=t.stringify=b})),R=H;function w(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var O=/^([a-z0-9.+-]+:)/i,N=/:[0-9]*$/,S=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,L=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),k=["'"].concat(L),M=["%","/","?",";","#"].concat(k),X=["/","?","#"],x=/^[+a-z0-9A-Z_-]{0,63}$/,U=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,B={javascript:!0,"javascript:":!0},j={javascript:!0,"javascript:":!0},V={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function H(e,t,r){if(e&&D(e)&&e instanceof w)return e;var s=new w;return s.parse(e,t,r),s}w.prototype.parse=function(e,t,r){if(!C(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var s=e.indexOf("?"),o=-1!==s&&s<e.indexOf("#")?"?":"#",n=e.split(o);n[0]=n[0].replace(/\\/g,"/");var i=e=n.join(o);if(i=i.trim(),!r&&1===e.split("#").length){var a=S.exec(i);if(a)return this.path=i,this.href=i,this.pathname=a[1],a[2]?(this.search=a[2],this.query=t?P.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var d=O.exec(i);if(d){var c=(d=d[0]).toLowerCase();this.protocol=c,i=i.substr(d.length)}if(r||d||i.match(/^\/\/[^@\/]+@[^@\/]+/)){var l="//"===i.substr(0,2);!l||d&&j[d]||(i=i.substr(2),this.slashes=!0)}if(!j[d]&&(l||d&&!V[d])){for(var h,u,p=-1,f=0;f<X.length;f++)-1!==(_=i.indexOf(X[f]))&&(-1===p||_<p)&&(p=_);for(-1!==(u=-1===p?i.lastIndexOf("@"):i.lastIndexOf("@",p))&&(h=i.slice(0,u),i=i.slice(u+1),this.auth=decodeURIComponent(h)),p=-1,f=0;f<M.length;f++){var _;-1!==(_=i.indexOf(M[f]))&&(-1===p||_<p)&&(p=_)}-1===p&&(p=i.length),this.host=i.slice(0,p),i=i.slice(p),this.parseHost(),this.hostname=this.hostname||"";var m="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!m)for(var E=this.hostname.split(/\./),g=(f=0,E.length);f<g;f++){var D=E[f];if(D&&!D.match(x)){for(var I="",y=0,v=D.length;y<v;y++)D.charCodeAt(y)>127?I+="x":I+=D[y];if(!I.match(x)){var T=E.slice(0,f),b=E.slice(f+1),R=D.match(U);R&&(T.push(R[1]),b.unshift(R[2])),b.length&&(i="/"+b.join(".")+i),this.hostname=T.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),m||(this.hostname=A.toASCII(this.hostname));var w=this.port?":"+this.port:"",N=this.hostname||"";this.host=N+w,this.href+=this.host,m&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==i[0]&&(i="/"+i))}if(!B[c])for(f=0,g=k.length;f<g;f++){var L=k[f];if(-1!==i.indexOf(L)){var H=encodeURIComponent(L);H===L&&(H=escape(L)),i=i.split(L).join(H)}}var F=i.indexOf("#");-1!==F&&(this.hash=i.substr(F),i=i.slice(0,F));var Y=i.indexOf("?");if(-1!==Y?(this.search=i.substr(Y),this.query=i.substr(Y+1),t&&(this.query=P.parse(this.query)),i=i.slice(0,Y)):t&&(this.search="",this.query={}),i&&(this.pathname=i),V[c]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){w=this.pathname||"";var W=this.search||"";this.path=w+W}return this.href=this.format(),this},w.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",s=this.hash||"",o=!1,n="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&D(this.query)&&Object.keys(this.query).length&&(n=P.stringify(this.query));var i=this.search||n&&"?"+n||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||V[t])&&!1!==o?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),s&&"#"!==s.charAt(0)&&(s="#"+s),i&&"?"!==i.charAt(0)&&(i="?"+i),t+o+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(i=i.replace("#","%23"))+s},w.prototype.resolve=function(e){return this.resolveObject(H(e,!1,!0)).format()},w.prototype.resolveObject=function(e){if(C(e)){var t=new w;t.parse(e,!1,!0),e=t}for(var r=new w,s=Object.keys(this),o=0;o<s.length;o++){var n=s[o];r[n]=this[n]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var i=Object.keys(e),a=0;a<i.length;a++){var d=i[a];"protocol"!==d&&(r[d]=e[d])}return V[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!V[e.protocol]){for(var c=Object.keys(e),l=0;l<c.length;l++){var h=c[l];r[h]=e[h]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||j[e.protocol])r.pathname=e.pathname;else{for(var u=(e.pathname||"").split("/");u.length&&!(e.host=u.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==u[0]&&u.unshift(""),u.length<2&&u.unshift(""),r.pathname=u.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var p=r.pathname||"",f=r.search||"";r.path=p+f}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),m=e.host||e.pathname&&"/"===e.pathname.charAt(0),E=m||_||r.host&&e.pathname,g=E,A=r.pathname&&r.pathname.split("/")||[],D=(u=e.pathname&&e.pathname.split("/")||[],r.protocol&&!V[r.protocol]);if(D&&(r.hostname="",r.port=null,r.host&&(""===A[0]?A[0]=r.host:A.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===u[0]?u[0]=e.host:u.unshift(e.host)),e.host=null),E=E&&(""===u[0]||""===A[0])),m)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,A=u;else if(u.length)A||(A=[]),A.pop(),A=A.concat(u),r.search=e.search,r.query=e.query;else if(!function(e){return null==e}(e.search))return D&&(r.hostname=r.host=A.shift(),(P=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=P.shift(),r.host=r.hostname=P.shift())),r.search=e.search,r.query=e.query,I(r.pathname)&&I(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!A.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var y=A.slice(-1)[0],v=(r.host||e.host||A.length>1)&&("."===y||".."===y)||""===y,T=0,b=A.length;b>=0;b--)"."===(y=A[b])?A.splice(b,1):".."===y?(A.splice(b,1),T++):T&&(A.splice(b,1),T--);if(!E&&!g)for(;T--;T)A.unshift("..");!E||""===A[0]||A[0]&&"/"===A[0].charAt(0)||A.unshift(""),v&&"/"!==A.join("/").substr(-1)&&A.push("");var P,R=""===A[0]||A[0]&&"/"===A[0].charAt(0);return D&&(r.hostname=r.host=R?"":A.length?A.shift():"",(P=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=P.shift(),r.host=r.hostname=P.shift())),(E=E||r.host&&A.length)&&!R&&A.unshift(""),A.length?r.pathname=A.join("/"):(r.pathname=null,r.path=null),I(r.pathname)&&I(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},w.prototype.parseHost=function(){var e=this.host,t=N.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)};const F=o.newDebug("dcx:dcxjs:sb"),Y=()=>!0,W={disableRetry:!0};let q=null,z=null;class G{constructor(e,t){this._maxRedirects=5,this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._assetInfoCache={},this._assetIdResolutionTemplate=null,this.SYNC_ASYNC_DEFAULT_DELAY=5,this.ASYNC_DEFAULT_DELAY=1,this.DEFAULT_POLL_DELAY=10,this._service=e,this._server=t,t&&(this._endPoint=n.endPointOf(t))}get maxRedirects(){return this._maxRedirects}set maxRedirects(e){if("number"!=typeof e)throw new f.default(f.default.INVALID_PARAMS,"Expecting a number.");this._maxRedirects=Math.floor(e)}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new f.default(f.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}isValidHref(e){const t=n.endPointOf(e);return!t||t===this._endPoint}isDomainOnAllowList(e){F("isDomainOnAllowList");const t=n.parseURI(e).authority;if(!t||0===t.length)return!0;const r=t.length,s=this._authenticationAllowList.length;for(let e=0;e<s;e++){const s=this._authenticationAllowList[e],o=s.length;let n;if(n=r>o?t.slice(-o):t,n===s)return F("iDOAL true"),!0}return F("iDOAL false"),!1}getAsset(e,t,r,s){return this._getAsset(e,t,r,void 0,s)}_getAsset(e,t={},r,s,o){if(F("_getAsset()"),!(e=this._resolveUrl(e)))return void o(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));let d=s;const c={};"string"==typeof t?c["if-none-match"]=t:n.merge(c,t);let l,h=0;const u=(e,t)=>{if(F("_getAsset() respHandler",e,t),e)return void o(a.networkError("Error downloading an asset",e,t));const r=t.statusCode;if(200===r)o(void 0,t);else if(304===r)o(void 0,t);else if(301===r||302===r||303===r||307===r)if(!this._service.handlesRedirects&&this.maxRedirects)if(h<this.maxRedirects){const r=t.headers.location;r?l(r):o(a.unexpectedResponse("Missing location header in redirect response",e,t))}else o(a.unexpectedResponse("Too many redirects",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t))};return l=t=>{const s={responseType:r,isStatusValid:Y,retryOptions:W,autoParseJson:!1};return t&&(h++,s.reuseRequestDesc=d,this.isDomainOnAllowList(t)||(c.authorization=null)),this._service.invoke(i.HTTPMethods.GET,t||e,c,void 0,s,u)},d=l(),d.progress=n.noOp,d}getAssetAsType(e,t,r,s){return this._getAssetAsType(e,t,r,void 0,void 0,void 0,s)}_cacheLinksFromResponse(e,t){if("string"==typeof e){const r=this._parseCachableLinks(t);if(Object.keys(r).length>0){const t=this._assetInfoCache[e],s=Object.assign({},t||{},n.pruneUndefined(r));this._cacheInfoForAssetId(e,void 0,s)}}}_getAssetAsType(e,t,r,s,o,n,i){return F("_getAssetAsType"),this._getAsset(e,r,t,s,((e,t)=>{if(e)return i(e);if(200===t.statusCode){const e=t.response||t.responseText;null==n&&this._cacheLinksFromResponse(o,t),i(void 0,e,t.headers.etag,t)}else 304===t.statusCode?i(void 0,null,t.headers.etag,t):i(a.unexpectedResponse("Unexpected response getting asset",e,t))}))}_getResourcePathFromHref(e,t){return F("_getResourcePathFromHref"),this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{isStatusValid:Y,retryOptions:W,autoParseJson:!1},((e,r)=>{if(F("_gRPFH invoked",e,r),e)return t(e);if(200===r.statusCode){const e=r.headers.link;if(e){const r=n.parse(e).get("rel","http://ns.adobe.com/ccapi/path");if(r&&r[0]&&r[0].uri)return t(void 0,r[0].uri)}}return t(a.unexpectedResponse("Unexpected response trying to retrieve path to asset.",void 0,r))}))}resolveRootURLAsync(){F("resolveRootURLAsync()");const e=this._resolveUrl("/");let t;return F("rRUA() rootHref",e),q=this._service.invoke(i.HTTPMethods.GET,e,{},void 0,{responseType:"text",isStatusValid:Y,retryOptions:W,autoParseJson:!1}).then((e=>{if(F("rRUA() resolved",e),200!==e.statusCode)throw t=new f.default(f.default.UNEXPECTED_RESPONSE,"Resolve root URL did not succeed with 200",void 0,e),t;{const r=e.responseText||e.response;try{const e=JSON.parse(r),t=e._links?e._links["http://ns.adobe.com/ccapi/resolve/id"]:void 0;if(t)return{href:t.href,self:this}}catch(r){throw t=new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",r,e),t}}})).catch((e=>{throw F("rRUA() rejected",e),e})),F("rRUA() rootReqDesc",q),q}getPromiseCacheInfo(e){return F("getPromiseCacheInfo()"),null!=z||(z=e(),z&&z.then&&z.then((()=>{F("gPCI() resolved"),z=null}),(()=>{F("gPCI() rejected"),z=null}))),z}_parseCachableLinks(e){const t={},r=e.headers["content-location"],s=e.headers.link;if(s){const e=n.parse(s);let o=e.get("rel","primary");o&&(t.primaryTemplate=r?R(o[0].uri,r).href:o[0].uri),o=e.get("rel","http://ns.adobe.com/ccapi/manifest2"),o?t.manifestTemplate=r?R(o[0].uri,r).href:o[0].uri:(o=e.get("rel","http://ns.adobe.com/ccapi/manifest"),o&&(t.manifestTemplate=r?R(o[0].uri,r).href:o[0].uri)),o=e.get("rel","http://ns.adobe.com/ccapi/component"),o&&(t.componentTemplate=r?R(o[0].uri,r).href:o[0].uri),o=e.get("rel","version-history"),o&&(t.versionHistory=r?R(o[0].uri,r).href:o[0].uri),o=e.get("rel","rendition"),o&&(t.renditionTemplates=r?R(o[0].uri,r).href:o)}return t}getCachedAssetInfo(e,t){F("getCachedAssetInfo()");const r=this._infoForAssetId(e);if(r)return F("gCAI() cached"),t(void 0,r);const s=this._awaitInfoForAssetId(e,t);if(F("gCAI() needs head req",s),s){let r;const s=s=>{let o=n.expandURITemplate(s,{asset_id:e});if(o=this._resolveUrl(o),!o)return F("gCAI() no href"),t(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+o));let d={};return r&&(d={reuseRequestDesc:r},F("gCAI() reuse RD",d)),r=this._service.invoke(i.HTTPMethods.HEAD,o,{},void 0,Object.assign(Object.assign({},d),{isStatusValid:Y,retryOptions:W,autoParseJson:!1}),((t,r)=>{if(F("gCAI() resolveAssetId() resolved",t,r),t)return this._cacheInfoForAssetId(e,t);const s=r.statusCode;if(200===s){const t=this._parseCachableLinks(r);return this._cacheInfoForAssetId(e,void 0,t)}return 404===s?this._cacheInfoForAssetId(e,new f.default(f.default.ASSET_NOT_FOUND,"Asset not found",t,r)):this._cacheInfoForAssetId(e,a.unexpectedResponse("Unable to resolve asset id.",t,r))})),r};return this._assetIdResolutionTemplate?(F("gCAI() has resolution template"),s(this._assetIdResolutionTemplate)):(F("gCAI() get resolution template"),q=this.getPromiseCacheInfo(this.resolveRootURLAsync.bind(this)).then((e=>(F("gCAI() getPromiseCacheInfo() resolved",e),this._assetIdResolutionTemplate=e.href,s(e.self._assetIdResolutionTemplate)))).catch((e=>{F("gCAI() getPromiseCacheInfo() rejected",e);const r=new f.default(f.default.UNEXPECTED_RESPONSE,"Unable to retrieve asset id resolution link from root resource.",e,e.response);return t(r)})),F("gCAI() rootReqDesc",q),q)}}registerLinks(e){e=e._links||e;const t={};t.assetId="urn:aaid:faux:"+n.generateUuid();let r=e.primary;return r&&(t.primaryTemplate=r.href),r=e["http://ns.adobe.com/ccapi/manifest"],r&&(t.manifestTemplate=r.href),r=e["http://ns.adobe.com/ccapi/manifest2"],r&&(t.manifestTemplate=r.href),r=e["http://ns.adobe.com/ccapi/component"],r&&(t.componentTemplate=r.href),r=e["version-history"],r&&(t.versionHistory=r.href),r=e.rendition,r&&(t.renditionTemplates=[{rel:"rendition",uri:r.href}]),this._assetInfoCache[t.assetId]=t,t.assetId}_infoForAssetId(e){const t=this._assetInfoCache[e];if(t&&!t.callbacks)return t}_awaitInfoForAssetId(e,t){F("_awaitInfoForAssetId");let r=this._assetInfoCache[e];return r?(F("_aIFA pending"),r.callbacks.push(t),!1):(F("_aIFA not pending"),r={},r.assetId=e,r.callbacks=[t],this._assetInfoCache[e]=r,!0)}_cacheInfoForAssetId(e,t,r){F("_cacheInfoForAssetId");let s=this._assetInfoCache[e];if(s){if(t){const r=s.callbacks;this._assetInfoCache[e]=void 0;for(let e=0;e<r.length;e++)r[e](t)}}else!t&&r&&(this._assetInfoCache[e]=s={});if(!t&&r&&(s.assetId||(s.assetId=e),s.primaryTemplate=r.primaryTemplate,s.manifestTemplate=r.manifestTemplate,s.componentTemplate=r.componentTemplate,s.versionHistory=r.versionHistory,s.renditionTemplates=r.renditionTemplates,s.callbacks)){for(let e=0;e<s.callbacks.length;e++)s.callbacks[e](void 0,s);s.callbacks=void 0}}_resolveUrl(e){return n.endPointOf(e)?e:n.appendPathElements(this._server,e)}_makeRelativeUrl(e){if(n.endPointOf(e)){const t=n.parseURI(e);(t.scheme||t.authority)&&(e=t.path,t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment))}return e}_parseAsyncResponse(e){F("_parseAsyncResponse");const t=e.responseText||e.response;if(!t)throw new f.default(f.default.INVALID_DATA,"No body data.");const r={},s=t.indexOf("\n");if(-1===s)throw new f.default(f.default.INVALID_DATA,"Could not find status line.");const o=t.slice(0,13===t.charCodeAt(s-1)?s-1:s).split(" ");if(r.statusCode=parseInt(o[1],10),!r.statusCode)throw new f.default(f.default.INVALID_DATA,"Could not find status code.");o.length>2&&(r.statusText=o[2]);let i=t.search(/\r?\n\r?\n/);-1===i&&(i=t.length);const a=t.slice(s+1,i);r.headers=n.parseHeaders(a);const d="\r"===t.charAt(i)?i+4:i+2;return r.response=t.slice(d),r}_pollForAsyncResponse(e,t,r,s){F("_pollForAsyncResponse");const n=Date.now()+1e3*t,d={responseType:"text",reuseRequestDesc:r,noSoonerThen:n,isStatusValid:Y,retryOptions:W,autoParseJson:!1};o.log("asynchronous request - polling");const c=this._service.invoke(i.HTTPMethods.GET,e,void 0,void 0,d,((t,n)=>{if(t)return s(a.networkError("Error polling for an asynchronous reponse",t,n));let i=n.statusCode;if(202===i){let t;o.log("asynchronous request - not yet ready"),n.headers["retry-after"]&&(t=parseInt(n.headers["retry-after"],10)),this._pollForAsyncResponse(e,t||10,r,s)}else if(200===i){o.log("asynchronous request - success");try{n=this._parseAsyncResponse(n)}catch(e){return s(a.unexpectedResponse("Error parsing response body.",e,n))}i=n.statusCode,200===i||201===i||204===i?s(void 0,n):s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}else o.log("asynchronous request - error"),s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}));r=c}_handle202Response(e,t,r,s){F("_handle202Response");const o=e.responseText||e.response;let n;try{n=JSON.parse(o)}catch(t){return s(a.unexpectedResponse("Error parsing 202 response body.",t,e))}const i=n.href;if(!i)return s(a.unexpectedResponse("202 response missing an href.",void 0,e));let d=e.headers["retry-after"];d=d?parseInt(d,10):r,this._pollForAsyncResponse(this._resolveUrl(i),d,t,s)}}G.StreamProvider=s.StreamProvider;const K=()=>!0,$={disableRetry:!0},J=/^\/?content\/2\/[^\/]+\/[^\/]+/,Z=/^\/?api\/v2\/[^\/]+\/assets\/[^\/]+/,Q={"image/jpeg":"jpg","image/png":"png"};class ee extends G{constructor(e,t){if(super(e,t),this.name="AdobeCommunitySession",!this._endPoint)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Could not determine endpoint from: "+t)}publishCompositeAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets";s=this._resolveUrl(s);const o={resource_path:this.assetIdFromSSResourceHref(t.resourcePath),resource_type:e,metadata:this.metadataFromPubRecord(t)},n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.POST,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:!1,isStatusValid:K,retryOptions:$},(function(e,s){if(e)return r(a.networkError("Error publishing composite",e,s));if(201===s.statusCode){const o=s.headers.location;if(!o)return e=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Missing location header returned on response by server",void 0,s),r(a.unexpectedResponse("Unexpected response publishing composite",e,s));const n=function(e){const t=e.match("^.*?\\/api\\/v2\\/([^/]*)/assets\\/([^\\/]*).*$");return t?t[2]:null}(o);if(n)return t.assetId=n,r(void 0,o)}return r(a.unexpectedResponse("Unexpected response publishing composite",e,s))}))}updateCpMetadataAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets/"+t.assetId;s=this._resolveUrl(s);const o=this.metadataFromPubRecord(t),n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.PUT,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:!1,isStatusValid:K,retryOptions:$},((e,t)=>e?r(a.networkError("Error publishing composite",e,t)):200===t.statusCode?r(void 0,s):r(a.unexpectedResponse("Unexpected response publishing composite",e,t))))}getCpMetadata(e,t){let r="/api/v2/"+e.communityId+"/assets/"+e.assetId;r=this._resolveUrl(r),this._service.invoke(i.HTTPMethods.GET,r,{},void 0,{responseType:"text",autoParseJson:!1,isStatusValid:K,retryOptions:$},(function(r,s){if(r)return t(a.networkError("Error getting metadata for CP composite",r,s));if(200===s.statusCode){let r;const o=s.response||s;try{r=JSON.parse(o),e.resourcePath=r.resource_path,e.description=r.description||null,e.title=r.title||null,e.alias=r.alias||null,e.undiscoverable=r.undiscoverable||!1,e.isPrivate=r.private||!1;let t=r.tags;t&&null!==t&&t.length>0&&(e.tags=t);let s=r._embedded;if(s&&null!==s&&(t=r.creators,t&&null!==t&&t.length>0)){const r=[];for(let e=0;e<t.length;++e){const s=t[e];if(s&&null!==s){const e=s.id;e&&null!==e&&r.push(e)}}0!==r.length&&(e.creatorIds=r)}if(s=r.category_id,s&&null!==s&&(e.categoryId=s.id||null),t=r.sub_categories,t&&null!==t&&t.length>0){e.subCategoryIds=[];for(let r=0;r<t.length;++r)s=t[r],e.subCategoryIds.push(s.id)}s=r.custom,s&&null!==s&&(e.custom=s)}catch(e){const r=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Invalid JSON returned by server",e,s);return t(r)}return t(void 0,e)}return t(a.unexpectedResponse("Unexpected response while getting metadata for CP composite",r,s))}))}updatePublicationRecordData(e,t){const r=t.versionId;if(e.mainResource="manifest",r&&(e.mainResourceVersion=r),null!==e.artworkComponentId){const r=t.getComponentWithId(e.artworkComponentId);if(null==r)throw new a.AdobeDCXError(a.AdobeDCXError.COMPONENT_DOWNLOAD_ERROR,"Bad component ID = "+e.artworkComponentId);let s=e.resourcePath;s=this.assetIdFromSSResourceHref(s),s+=r.absolutePath,e.artworkResource=s,e.artworkResourceVersion=r.version}}getCompositeManifestHref(e,t,r){if(t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"AdobeCommunitySession does not support version manifests.");if(!e.assetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.assetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");const s=this._resolveUrl(e.assetId);if(!s)throw new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId);return r(void 0,n.appendPathElements(s,"manifest"))}getComponent(e,t,r){const s={};let o=s;return this.getComponentHref(e,e.version,((e,n)=>e?r(e):(o=o||s,this._getAsset(n,void 0,t,o,r)))),o||s}getRenditionOfComponent(e,t,r,s,o,n){const i={};let a=i;return this.getComponentRenditionHref(e,e.version,t,r,s,((e,r)=>e?n(e):(a=a||i,this._getAsset(r,{accept:t},o,a,n)))),a||i}getCompositeManifest(e,t,r,s){let o=e.assetId;return o&&(o=this._resolveUrl(o)),o?(o=n.appendPathElements(o,"manifest"),this.getAssetAsType(o,"text",r,s)):s(new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId))}headRequest(e,t){return this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{responseType:"text",autoParseJson:!1,isStatusValid:K,retryOptions:$},(function(e,r){if(e)return t(e);t(e,r)}))}getComponentHref(e,t,r){const s=e._owner;if(!s||!s.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(s.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(s._core){const t=s._core._getSourceAssetInfoOfComponent(e);if(t)return void r(void 0,this._constructComponentHref(t.compositeAssetId,t.componentPath,t.componentVersion))}r(void 0,this._constructComponentHref(s.compositeAssetId,e.absolutePath,t))}getComponentRenditionHref(e,t,r,s,o,n){const i=e._owner;if(!i||!i.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(i.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(i._core&&i._core._getSourceAssetInfoOfComponent(e))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Getting a rendition of a source href not implemented.");return n(void 0,this._constructComponentRenditionHref(i.compositeAssetId,e.absolutePath,t,r,s,o))}isProperAssetId(e){return n.ensureRelativeHrefStartsWithSlash(e)}_constructComponentHref(e,t,r){const s=t.slice(1);let o=n.appendPathElements(this._resolveUrl(e),s);return o&&void 0!==r&&(this._hrefUsesContentApis(e)?o+="/version/"+r:o+="?version="+r),o}_constructComponentRenditionHref(e,t,r,s,o,i){let d,c;const l=t.slice(1),h=n.parseURI(e).path;if("/content/2/"===h.slice(0,"/content/2/".length)){const t=Q[s];if(!t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Unsupported rendition media type: "+s);if(d=J.exec(h),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",l,"version",r,"format",t,"dimension",o,"size",String(i)))}else{if(d=Z.exec(h),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",o,String(i),l)+"?version="+r)}return c}_hrefUsesContentApis(e){return"/content/2/"===n.parseURI(e).path.slice(0,"/content/2/".length)}assetIdFromSSResourceHref(e){const t=e.match("^\\/pubs\\/([^\\/]*).*$");return t?t[1]:null}metadataFromPubRecord(e){const t={};if(null!==e.title&&(t.title=e.title),null!==e.description&&(t.description=e.description),null!==e.alias&&(t.alias=e.alias),t.undiscoverable=e.undiscoverable,e.isPrivate&&(t.private=e.isPrivate),null!==e.tags&&e.tags.length>0){const r=[];for(let t=0;t<e.tags.length;t++)r.concat(e.tags[t]);t.tags=r}if(null!==e.creatorIds&&e.creatorIds.length>0){const r=[];for(let t=0;t<e.creatorIds.length;t++)r.concat(e.creatorIds[t]);t.creator_ids=r}if(null!==e.categoryId&&(t.category_id=e.categoryId),null!==e.subCategoryIds&&e.subCategoryIds.length>0){const r=[];for(let t=0;t<e.subCategoryIds.length;t++)r.concat(e.subCategoryIds[t]);t.sub_category_ids=r}if(null!==e.custom&&(t.custom=e.custom),null!==e.mainResource&&null!==e.mainResourceVersion){const r={};r.resource_path=e.mainResource,r.resource_version=e.mainResourceVersion,t.main_resource=r}if(null!==e.artworkResource&&null!==e.artworkResourceVersion){const r={};r.resource_path=e.artworkResource,r.resource_version=e.artworkResourceVersion,t.artwork=r}return t}}const te={unmodified:"unmodified",modified:"modified",pendingDelete:"pendingDelete",committedDelete:"committedDelete"},re={pending:"pending",active:"active",archived:"archived"},se={name:!0,id:!0,state:!0,path:!0,rel:!0,type:!0,etag:!0,length:!0,version:!0,md5:!0,width:!0,height:!0};class oe{constructor(e,t=!1){this._readOnly=!1,this._data={},this.records={},e&&this._setData(e),this._readOnly=t}get compositeId(){return this._compositeId}get owner(){return this._owner}get data(){return this._data}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a component that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.type=e,this._setDirty()}get path(){return this._data.path}set path(e){if(this._data.path!==e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path.");this._owner?this._owner._core._setPathOfComponent(this,e):(this._data.path=e,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){return this._data.path&&this._owner?n.appendPathElements(this._parentPath,this._data.path):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get state(){return this._data.state}set state(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.keys(te).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');this._data.state=e,this._setDirty()}get etag(){return this._data.etag}set etag(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.etag=e,this._setDirty()}get md5(){return this._data.md5}set md5(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.md5=e,this._setDirty()}get version(){return this._data.version}set version(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(void 0!==e&&"string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.version=e,this._setDirty()}get length(){return this._data.length}set length(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.length=e,this._setDirty()}get width(){return this._data.width}set width(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.width=e,this._setDirty()}get height(){return this._data.height}set height(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.height=e,this._setDirty()}get assetId(){return this._assetId}set assetId(e){if(e!==this._assetId){if(this._assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"assetId property cannot be changed.");this._assetId=e}}get repositoryId(){return this._repoId}set repositoryId(e){if(e!==this._repoId){if(this._repoId)throw new a.DCXError(a.DCXError.INVALID_STATE,"repoId property cannot be changed.");this._repoId=e}}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];se[r]||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');delete this._data[e],this._setDirty()}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}isEqualTo(e,t){return n.objectsEqual(this._data,e._data,t)}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_setDirty(){this._owner&&this._owner._setDirty()}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Component is missing an id of type string"):null}}oe.STATES=te;class ne{constructor(e,t=!1,r=!1){this._data={},e&&this._setData(e),this._readOnly=t,this._isRoot=r}get owner(){return this._owner}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a node that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.type=e,this._setDirty()}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get path(){return this._isRoot?ne.ROOT_PATH:this._data.path}set path(e){if(e!==this.path){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._isRoot)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the path of the root node.");if(e&&!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path or undefined.");this._owner?this._owner._setPathOfNode(this,e||void 0):(this._data.path=e||void 0,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){const e=this.path;return this._isRoot?e:e&&this._owner?n.appendPathElements(this._parentPath,e):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get isRoot(){return this._isRoot}set isRoot(e){throw new a.DCXError(a.DCXError.READ_ONLY,"isRoot is read-only.")}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];(this._isRoot?ie[r]:ae[r])||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");delete this._data[e],this._setDirty()}copy(){let e;const t=this._data.children,r=this._data.components;try{t&&delete this._data.children,r&&delete this._data.components;const s=JSON.parse(JSON.stringify(this._data));e=new ne(s)}finally{t&&(this._data.children=t),r&&(this._data.components=r)}return e}isEqualTo(e,t,r){return this._isEqual(this._data,e._data,n.merge({children:!0,components:!0},t),r)}_isEqual(e,t,r,s){let o,i,a,d,c;if(!n.objectsEqual(e,t,r))return!1;if(i=e.components,a=t.components,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d){let e,t,r;for(o=0;o<d;o++){for(e=i[o],t=null,r=0;r<d;r++)if(e.id===a[r].id){t=a[r];break}if(!t)return!1;if(!n.objectsEqual(e,t,s))return!1}}if(i=e.children,a=t.children,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d)for(o=0;o<d;o++)if(!this._isEqual(i[o],a[o],r,s))return!1;return!0}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Node is missing an id of type string"):null}_setDirty(){this._owner&&this._owner._setDirty()}}ne.ROOT_PATH="/";const ie={components:!0,children:!0,"manifest-format-version":!0,id:!0,name:!0,type:!0,state:!0,local:!0},ae={components:!0,children:!0,rel:!0,path:!0,id:!0,name:!0,type:!0};class de{constructor(e,t,r=!1){this._allNodes={},this._allComponents={},this._absolutePaths={},this._readOnly=!1,this._isDirty=!1,this._sourceAssetInfoLookup={},this._readOnly=r,this._owner=t,this._setData(e)}get allNodes(){return this._allNodes}get rootNode(){return this.getChildWithAbsolutePath(ne.ROOT_PATH)}set rootNode(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "rootNode" is read-only.')}get isDirty(){return this._isDirty}set isDirty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isDirty.")}get changeCount(){return this._data.local&&this._data.local.change||0}set changeCount(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property changeCount.")}getChildWithId(e){return this._allNodes[e]}getChildWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof ne?t:void 0}getChildrenOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.children;if(Array.isArray(s))for(let e=0;e<s.length;e++){const t=s[e],o=this._allNodes[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Node not in cache");r.push(o)}return r}addChild(e,t,r,s){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(t=t||n.generateUuid(),this._allNodes[t])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Node already exists in branch.");if(r&&("number"!=typeof r||r%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const o=s?this._allNodes[s.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const i=new ne;i.id=t,e&&(i.name=e),i._parentPath=o.absolutePath||o._parentPath;const d=o._data.children;return d?(r>=0&&r<=d.length||(r=d.length),r===d.length?d[r]=i._data:d.splice(r,0,i._data)):o._data.children=[i._data],this._allNodes[i.id]=i,i._owner=this._owner,this._setDirty(),i}removeChild(e){let t=e;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(t.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot remove the root node.");const r=t.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const s=this._nodeDataOfParentOfNode(t);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const o=s.parentNodeData.children;return o&&(o.splice(s.index,1),0===o.length&&delete s.parentNodeData.children),t=this._allNodes[r],this._removeNodeFromCachesRecursively(t._data),this._setDirty(),t}moveChild(e,t,r){let s=e;const o=r;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(s.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot move the root node.");if(t&&("number"!=typeof t||t%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const n=s.id;if(!n)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const i=this._nodeDataOfParentOfNode(s);if(s=this._allNodes[n],!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const d=o?this._allNodes[o.id]:this.rootNode;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(this._nodeIdIsDescendantOf(d.id,s._data))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Must not create a cycle.");const c=i.parentNodeData.children.splice(i.index,1)[0];try{const e=d._data.children;e?(t>=0&&t<=e.length||(t=e.length),t===e.length?e[t]=c:e.splice(t,0,c)):d._data.children=[c]}catch(e){throw i.parentNodeData.children.splice(i.index,0,c),e}return 0===i.parentNodeData.children.length&&delete i.parentNodeData.children,this._setDirty(),this._allNodes[n]}copyChild(e,t,r,s,o,n){return this._copyChild(e,t,r,s,o,!1,n)}replaceChild(e,t,r,s){return this._copyChild(e,void 0,void 0,t,r||e.id,!0,s)}getMissingComponentsFromError(e){var t;return e.code!==a.DCXError.INCOMPLETE_COMPOSITE?[]:(null!==(t=e.response.response.report.failures.filter((e=>"MissingComponent"===e.rule)))&&void 0!==t?t:[]).map((e=>this.getComponentWithId(e.component_id)||this.getComponentWithAbsolutePath(e.component_path))).filter((e=>e))}allComponents(){const e=[];for(const t in this._allComponents)Object.prototype.hasOwnProperty.call(this._allComponents,t)&&e.push(this._allComponents[t]);return e}getComponentWithId(e){return this._allComponents[e]}getComponentWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof oe?t:void 0}getComponentsOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.components;if(Array.isArray(s)){let e;for(e=0;e<s.length;e++){const t=s[e],o=this._allComponents[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Component not in cache");r[r.length]=o}}return r}addComponentWithUploadResults(e,t,r,s,o){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(o.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear valid to be for this composite.");const n=Object.keys(o.records);if(1!==n.length)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults must contain records of exactly one component upload.");const i=o.records[n[0]],d=i.id;if(this._allComponents[d])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+d);const c=s?this._allNodes[s.id]:this.rootNode;if(!c)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const l=new oe;l.id=d,l.name=e,l.type=i.type,l.relationship=t,l.path=r,l.state=te.unmodified,l.etag=i.etag,l.length=i.length,l.version=i.version,l.md5=i.md5;const h=this._normalizedAbsolutePathForItem(l,c);if(this._absolutePaths[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);l._parentPath=c.absolutePath||c._parentPath;const u=c._data.components;return u?u.push(l.data):c._data.components=[l.data],l._owner=this._owner,this._allComponents[d]=l,this._absolutePaths[h]=l,this._setDirty(),l}updateComponentWithUploadResults(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!(e=this._allComponents[e.id]))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");if(t.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear valid to be for this composite.");const r=t.records[e.id];if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not contain an upload record for the given component.");return e.etag=r.etag,e.version=r.version,e.md5=r.md5,e.length=r.length,this._setSourceAssetInfoOfComponent(void 0,e),e.state=te.unmodified,this._setDirty(),e}removeComponent(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const t=e.id;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const r=this._nodeDataOfParentOfComponent(e);if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");return r.parentNodeData.components.splice(r.index,1),0===r.parentNodeData.components.length&&delete r.parentNodeData.components,e=this._allComponents[t],delete this._allComponents[t],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._owner=void 0,e._parentPath="",this._setDirty(),e}moveComponent(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const r=e.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const s=this._nodeDataOfParentOfComponent(e);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");const o=t?this._allNodes[t.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const n=this._normalizedAbsolutePathForItem(e,o);if(this._absolutePaths[n])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+n);const i=s.parentNodeData.components.splice(s.index,1)[0],d=o._data.components;return d?d.push(i):o._data.components=[i],0===s.parentNodeData.components.length&&delete s.parentNodeData.components,e=this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._parentPath=o.absolutePath||o._parentPath,this._absolutePaths[n]=e,this._setDirty(),e}copyComponent(e,t,r,s,o){return this._copyComponent(e,t,r,s,!1,o)}replaceComponent(e,t,r,s){const o=this._copyComponent(e,void 0,t,r||e.id,!0,s);return r&&r!==e.id&&delete this._allComponents[e.id],o}_getHrefOfComponent(e){let t;const r=this._getBranchOf(e).compositeHref;return r&&void 0!==e.version&&(t=n.appendPathElements(r,e.id),t+=";version="+e.version),t}_setSourceAssetInfoOfComponent(e,t){const r=t.id,s=this._sourceAssetInfoLookup;e?s[r]=e:s[r]&&delete s[r]}_getSourceAssetInfoOfComponent(e){const t=e.id,r=this._sourceAssetInfoLookup;if(r)return r[t]}_copySourceHrefsFrom(e){const t=e._sourceAssetInfoLookup,r=this.allComponents(),s=r.length;if(s&&t){const e=this._sourceAssetInfoLookup;for(let o=0;o<s;o++){const s=r[o].id;e[s]=t[s]}}}_getBranchOf(e){return e._owner?this._getBranchOf(e._owner):e}_isSameComposite(e){const t=this._getBranchOf(this),r=this._getBranchOf(e);return t._data.id===r._data.id&&t.compositeAssetId===r.compositeAssetId&&t.compositeRepositoryId===r.compositeRepositoryId}_stringify(e,t=!1){if(e){const e=this._data.local;let r=null;try{delete this._data.local,r=JSON.stringify(this._data,void 0,t?2:void 0)}finally{e&&(this._data.local=e)}return r}return JSON.stringify(this._data,void 0,t?2:void 0)}_setData(e){const t=new ne(e,this._readOnly,!0);t._owner=this._owner,t._parentPath="";const r=t.id,s={},o={},i={};o[r]=t,i[ne.ROOT_PATH]=t;const d=(e,t)=>{let r,c;const l=e.components;if(Array.isArray(l))for(let e=0;e<l.length;e++){const r=l[e],o=new oe(r,this._readOnly);if(s[o.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate component id: "+o.id);if(o._owner=this._owner,o._parentPath=t,c=this._normalizedAbsolutePathForItem(o),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid absolute component path: "+c);s[o.id]=o,i[c]=o}const h=e.children;if(Array.isArray(h))for(let e=0;e<h.length;e++){const s=h[e],l=new ne(s,this._readOnly);if(o[l.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate node id: "+l.id);if(r=l.path,l._owner=this._owner,l._parentPath=t,r){if(c=this._normalizedAbsolutePathForItem(l),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid node absolute path: "+c);i[c]=l}o[l.id]=l,d(s,l.path?n.appendPathElements(t,l.path):t)}};return d(e,ne.ROOT_PATH),this._data=e,this._allComponents=s,this._allNodes=o,this._absolutePaths=i,this._isDirty=!1,this}_removeNodeFromCachesRecursively(e){const t=e.components;if(Array.isArray(t))for(let e=0;e<t.length;e++){const r=t[e].id,s=this._allComponents[r];delete this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(s)],s._owner=void 0}const r=e.children;if(Array.isArray(r))for(let e=0;e<r.length;e++)this._removeNodeFromCachesRecursively(r[e]);const s=e.id,o=this._allNodes[s];delete this._allNodes[s],o.path&&delete this._absolutePaths[this._normalizedAbsolutePathForItem(o)],o._owner=void 0}_local(){return this._data.local||(this._data.local={version:2}),this._data.local}_recursiveReset(e,t){const r=e.components;if(r)for(let e=r.length-1;e>=0;e--){const s=r[e];s.state===te.committedDelete?(delete r[e],delete this._allComponents[s.id],delete s._owner,this._setSourceAssetInfoOfComponent(void 0,s)):(delete s.etag,delete s.version,delete s.length,delete s.md5,s.state=te.modified,t&&t(s))}const s=e.children;if(s)for(let e=0;e<s.length;e++)this._recursiveReset(s[e],t)}_nodeIdIsDescendantOf(e,t){const r=t.children;if(r)for(let t=0;t<r.length;t++){const s=r[t];if(s.id===e||this._nodeIdIsDescendantOf(e,s))return!0}return!1}_recursivelyGetAllComponentsOfChild(e,t=[]){const r=e._data||e,s=r.components;if(s){const e=s.length;for(let r=0;r<e;r++)t[t.length]=this._allComponents[s[r].id]}const o=r.children;if(o){const e=o.length;for(let r=0;r<e;r++)t=this._recursivelyGetAllComponentsOfChild(o[r],t)}return t}_nodeDataOfParentOfNode(e,t=this._data){const r=e._data.id,s=t.children;if(s)for(let o=0;o<s.length;o++){const n=s[o];if(n.id===r)return{parentNodeData:t,index:o};const i=this._nodeDataOfParentOfNode(e,n);if(i)return i}return null}_nodeDataOfParentOfComponent(e,t=this._data){const r=e._data.id,s=t.components;if(s)for(let e=0;e<s.length;e++)if(s[e].id===r)return{parentNodeData:t,index:e};const o=t.children;if(o)for(let t=0;t<o.length;t++){const r=o[t],s=this._nodeDataOfParentOfComponent(e,r);if(s)return s}return null}_determineAbsolutePathChangesRecursively(e,t,r){const s=e.components;if(s)for(let e=0;e<s.length;e++){const o=s[e],i=this._allComponents[o.id];r.push({item:i,parentPath:t,absPath:n.appendPathElements(t,o.path)})}const o=e.children;if(o)for(let e=0;e<o.length;e++){const s=o[e],i=this._allNodes[s.id],a=s.path,d=a?n.appendPathElements(t,a):t;r.push({item:i,parentPath:t,absPath:a?d:void 0}),this._determineAbsolutePathChangesRecursively(s,d,r)}}_setPathOfNode(e,t){const r=t?n.appendPathElements(e._parentPath,t):e._parentPath,s=[{item:e,absPath:t?r:void 0}];let o;this._determineAbsolutePathChangesRecursively(e._data,r,s);const i=n.flatCopy(this._absolutePaths);for(let e=0;e<s.length;e++){const t=s[e].item;t._data.path&&delete i[this._normalizedAbsolutePathForItem(t)]}for(let e=0;e<s.length;e++)if(o=s[e],o.absPath){const e=o.absPath.toLowerCase();if(i[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+e);i[e]=o.item}for(let e=0;e<s.length;e++)o=s[e],o.parentPath&&(o.item._parentPath=o.parentPath);e._data.path=t,this._absolutePaths=i}_setPathOfComponent(e,t){if(!this._allComponents[e.id])throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");const r=n.appendPathElements(e._parentPath,t).toLowerCase();if(this._absolutePaths[r])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path for component: "+r);if(!n.isValidAbsolutePath(r))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+r);delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],this._absolutePaths[r]=e,e._data.path=t}_setDirty(e=!1){if(!e){if(this._local().archivalState===re.pending||this._local().archivalState===re.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot modify an archived composite.");this._data.state!==te.pendingDelete&&this._data.state!==te.committedDelete||u.default.warn("Modifying deleted composite")}this._isDirty=!0,this._local().change=this.changeCount+1,e||this._data.state!==te.unmodified&&this._data.state||(this._data.state=te.modified)}_normalizedAbsolutePathForItem(e,t){let r;return r=t?n.appendPathElements(t.absolutePath||t._parentPath,e.path):e.absolutePath,r.toLowerCase()}_hasSameEndpoint(e){return!0}_copyComponent(e,t,r,s,o,i){n.validateParams(["component",e,"object"],["callback",i,"function",!0]);const d=e._owner._core;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy, undefined component owner");const c=this._isSameComposite(d),l=c||this._hasSameEndpoint(e);if(d._local(),!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy between two different endpoints.");const h=function(e,t,r){ce(e,t,c,l,!s)};if(!i)return this._copyComponentModel(e,t,o,r,s,h);try{i(void 0,this._copyComponentModel(e,t,o,r,s,h))}catch(e){i(e)}}_copyComponentModel(e,t,r,s,o,i){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const d=e._owner,c=new oe(JSON.parse(JSON.stringify(e._data)));if(s?(c.path=s,c.id=o||n.generateUuid()):o&&(c.id=o),c._owner=this._owner,e.id===c.id&&this._isSameComposite(d._core)||(c.state=te.modified,c.etag=void 0,c.version=void 0,c.md5=void 0,c.length=void 0),this._allComponents[c.id]&&!r)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Component already exists.");const l=this._allComponents[e.id];if(r&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing component.");let h,u;if(r){const e=this._nodeDataOfParentOfComponent(l);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent node of existing component not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");h=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");c._parentPath=u.absolutePath||u._parentPath;const p=this._normalizedAbsolutePathForItem(c),f=this._absolutePaths[p];if(f&&f!==l)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+p);if(!n.isValidAbsolutePath(p))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component path must be a valid path for a component.");let _=this._local();i&&(_=n.deepCopy(_),i(e,c,_));const m=u._data.components;return r?m[h]=c.data:m?m.push(c.data):u._data.components=[c.data],this._data.local=_,this._allComponents[c.id]=c,this._absolutePaths[p]=c,this._setDirty(),c}_copyChild(e,t,r,s,o,n,i){if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');const d=e._owner._core,c=this._isSameComposite(d),l=c||this._hasSameEndpoint(e);if(d._local(),d._recursivelyGetAllComponentsOfChild(e).length>0&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy components between two different endpoints.");const h=(e,t,r)=>{ce(e,t,c,l,!0)};if(!i)return this._copyChildModel(e,t,r,n,s,o,h);try{i(void 0,this._copyChildModel(e,t,r,n,s,o,h))}catch(e){i(e)}}_copyChildModel(e,t,r,s,o,i,d){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");const c=e._owner,l=new ne(JSON.parse(JSON.stringify(e._data)));o?(l.path=o,l.id=i||n.generateUuid()):i&&(l.id=i),l._owner=this._owner,e.isRoot&&(delete l._data.local,delete l._data.state,delete l._data["manifest-format-version"]);const h=this._allNodes[l.id];if(h&&!s)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Child node already exists.");if(s&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing node to replace.");let u;if(s){const e=this._nodeDataOfParentOfNode(h);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent of existing node not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");r=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(l._parentPath=u.absolutePath||u._parentPath,l.path){const e=this._normalizedAbsolutePathForItem(l),t=this._absolutePaths[e];if(t&&t!==h)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node path must be a valid path for a node.")}const p=n.flatCopy(this._allNodes),f=n.flatCopy(this._allComponents),_=n.flatCopy(this._absolutePaths),m=n.deepCopy(this._local()),E=function(e,t,r,s,o,n){let i,a;delete r[e.id],e.path&&delete o[t._normalizedAbsolutePathForItem(e)];const d=e._data.children;if(d)for(a=d.length,i=0;i<a;i++)E(r[d[i].id],t,r,s,o);const c=e._data.components;if(c)for(a=c.length,i=0;i<a;i++){const e=s[c[i].id];delete s[e.id],delete o[t._normalizedAbsolutePathForItem(e)]}};h&&E(h,this,p,f,_);const g=(e,t,r,s,o,i,l)=>{if(r[e.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate node id: "+e.id);let h;if(r[e.id]=e,e.path){if(h=t._core._normalizedAbsolutePathForItem(e),o[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);o[h]=e}const u=e._data.children;if(u){const a=u.length;for(let d=0;d<a;d++){const a=new ne(u[d]);r[a.id]&&(a.id=n.generateUuid()),a._owner=t,a._parentPath=e.absolutePath||e._parentPath,g(a,t,r,s,o,i)}}const p=e._data.components;if(p){const r=p.length;for(let l=0;l<r;l++){const r=new oe(p[l]),u=r.id;if(s[u]&&(r.id=n.generateUuid(),r.state=te.modified,r.etag=void 0,r.version=void 0,r.md5=void 0,r.length=void 0),r._owner=t,r._parentPath=e.absolutePath||e._parentPath,d&&d(c.getComponentWithId(u),r,i),s[r.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+r.id);if(s[r.id]=r,h=t._core._normalizedAbsolutePathForItem(r),o[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);o[h]=r}}};if(g(l,this._owner,p,f,_,m,c._local()),s)u._data.children[r]=l._data;else{const e=u._data.children;e?(r>=0&&r<=e.length||(r=e.length),r===e.length?e[r]=l._data:e.splice(r,0,l._data)):u._data.children=[l._data]}return this._allNodes=p,this._allComponents=f,this._absolutePaths=_,this._data.local=m,this._setDirty(),l}_verifyIntegrity(e,t,r){const s=[];let o=!1;const i=e=>(s.push(new a.DCXError(a.DCXError.INVALID_STATE,e)),t&&(o||(t("Branch for composite "+this.rootNode.id+" has the following errors:"),o=!0),t("   "+e)),!1),d=function(e,t){return!!e||i(t)},c=[],l=function(e){(c.indexOf(e)<0||i("Item "+e.id+" encountered more than once"))&&c.push(e)},h=n.flatCopy(this._allComponents),u=n.flatCopy(this._allNodes),p=n.flatCopy(this._absolutePaths),f=Object.keys(p),_=f.length;for(let e=0;e<_;e++){const t=f[e];d("/"===t.charAt(0),"Absolute path "+t+" does not start with a slash.")}const m=(e,t)=>{let r,s;const o=e.children;if(o)for(r=0;r<o.length;r++){const e=o[r],a=u[e.id];(a||i("Node "+e.id+" is not in cache."))&&(l(a),d(a._data===e,"Node "+a.id+" _data property incorrect."),delete u[a.id],a.path&&a._owner&&(s=this._normalizedAbsolutePathForItem(a),(p[s]||i("Absolute path of node "+a.id+" ("+s+") is not in cache."))&&delete p[s]),d(a._parentPath===t,"Parent path of node "+a.id+" should be "+t+" but is "+a._parentPath),d(a._owner===this._owner,"Node "+a.id+" _owner property is not correct.")),m(e,e.path?n.appendPathElements(t,e.path):t)}const a=e.components;if(a)for(r=0;r<a.length;r++){const e=a[r],o=h[e.id];(o||i("Component "+e.id+" is not in cache."))&&(l(o),d(o._data===e,"Component "+o.id+" _data property incorrect."),delete h[o.id],o._owner&&(s=this._normalizedAbsolutePathForItem(o),(p[s]||i("Absolute path "+s+" is not in cache."))&&delete p[s]),d(o._parentPath===t,"Parent path of component "+o.id+" should be "+t+" but is "+o._parentPath),d(o._owner===this._owner,"Component "+o.id+" _owner property is not correct."))}},E=p[ne.ROOT_PATH];d(E,"Cannot find root node via path")&&(d(E.id===this._data.id,"Root node has correct id"),d(E.path===ne.ROOT_PATH,"Root node has correct path"),d(""===E._parentPath,"Root node has correct parent path"),d(E._owner===this._owner,"Root node has correct owner"),d(E._data===this._data,"Root node has correct data"),d(u[E.id]===E,"Cannot find root node via id")&&delete u[E.id],delete p[ne.ROOT_PATH]),m(this._data,ne.ROOT_PATH);let g=Object.keys(h);for(let e=0;e<g.length;e++)i("Component "+g[e]+" is in cache but could not be found.");g=Object.keys(u);for(let e=0;e<g.length;e++)i("Node "+g[e]+" is in cache but could not be found.");g=Object.keys(p);for(let e=0;e<g.length;e++)i("Absolute path "+g[e]+" is in cache but could not be found.");return s.length?s:null}}function ce(e,t,r,s,o,i,d){if(!t._owner||!e._owner)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Failed to update storage for copied component, missing target or source branch core.");const c=t._owner._core,l=e._owner._core,h=r&&e.id===t.id;let u=l._getSourceAssetInfoOfComponent(e);const p=c.getComponentWithId(t.id),f=s&&(!p||!p.etag)&&e.state===te.unmodified,_=!h&&!u,m=_;if(o&&!p&&(u||_)&&e.id===t.id&&(t._data.id=n.generateUuid(),t.state=te.modified,t.etag=void 0,t.version=void 0,t.md5=void 0,t.length=void 0),_){if(f&&e._owner.compositeAssetId)u={compositeAssetId:e._owner.compositeAssetId,componentId:e.id,componentVersion:e.version,componentPath:e.absolutePath,repositoryId:e._owner.compositeRepositoryId},c._setSourceAssetInfoOfComponent(u,t);else if(m)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not use server-to-server copy for component "+e.id)}else c._setSourceAssetInfoOfComponent(u,t);u&&(t.state=te.modified)}class le{constructor(e,t,r=!1){this._owner=t,e?this._setData(e,r):(e={id:n.generateUuid()},this._core=new de(e,this,r),this._data=e)}get owner(){return this._owner}get rootNode(){return this._core.rootNode}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._owner?this._owner.compositeAssetId:void 0}set compositeAssetId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeAssetId" is read-only.')}get compositeRepositoryId(){return this._owner?this._owner.compositeRepositoryId:void 0}set compositeRepositoryId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeRepositoryId" is read-only.')}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._isDirty}get changeCount(){return this._core.changeCount}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t,r){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message)}return this._setData(t,this._core._readOnly)}copy(){return new le(JSON.parse(JSON.stringify(this._data)),this._owner)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a type of type string"):null}_setData(e,t){const r=this._verify(e);if(null===r)return this._core=new de(e,this,t),this._data=e,this;throw r}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}var he;!function(e){e[e.NONE=0]="NONE",e[e.COPY=1]="COPY"}(he||(he={}));const ue=o.newDebug("dcx:dcxjs:dcxbranch");class pe{constructor(e,t,r,s){this._derivationType=he.NONE,e?this._setData(e,t,r,s):(e={"manifest-format-version":6,id:n.generateUuid()},this.originalManifestFormatVersion=6,this._core=new de(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e),this._pendingElements=[]}get data(){return this._data}set data(e){this._data=e}get compositeId(){return this._core.rootNode.id}set compositeId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");if(t.allNodes[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"There is already a node with the same id.");delete t.allNodes[this._data.id],this._data.id=e,t.allNodes[e]=this._core.rootNode,t._setDirty()}get rootNode(){return this._core.rootNode}set rootNode(e){this._core.rootNode=e}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._core._compositeAssetId}set compositeAssetId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._compositeAssetId=e}get compositeRepositoryId(){return this._core._compositeRepositoryId}set compositeRepositoryId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["repoId",e,"string",!0]),t._compositeRepositoryId=e}get compositeLinks(){return this._core._compositeLinks}set compositeLinks(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["links",e,"object",!0]),t._compositeLinks=e}get _isRepoComposite(){return!!this._core._compositeRepositoryId}get _collaborationType(){return this._data.local?this._data.local.collaborationType:void 0}set _collaborationType(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().collaborationType=e:delete t._local().collaborationType,t._setDirty(!0)}get _clientDataString(){return this._data.local?this._data.local.clientDataString:void 0}set _clientDataString(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().clientDataString=e:delete t._local().clientDataString,t._setDirty(!0)}get manifestEtag(){return this._data.local?this._data.local.manifestEtag:void 0}set manifestEtag(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._local().manifestEtag=e,t._setDirty(!0)}get compositeState(){return this._data.state||te.unmodified}set compositeState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(te).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');if(this._isRepoComposite&&(e===te.pendingDelete||e===te.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be deleted in one step using RepoAPISession.");if(!(this._isRepoComposite||e!==te.pendingDelete&&e!==te.committedDelete||this.compositeArchivalState!==re.pending)||this.compositeArchivalState===re.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot delete an archived composite.");this._data.state=e,t._setDirty(!0)}get compositeArchivalState(){return this._core._local().archivalState||re.active}set compositeArchivalState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(re).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "pending", "archived", or "active".');if(this._isRepoComposite&&e===re.pending)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be discarded in one step using RepoAPISession#discardAsset.");if(this.compositeArchivalState===re.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite has already been archived.");if(e!==re.active&&(this.compositeState===te.pendingDelete||this.compositeState===te.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot archive a deleted composite.");e===re.active?delete this._core._local().archivalState:this._core._local().archivalState=e,t._setDirty(!0)}get isBound(){return!(!this.manifestEtag||!this.compositeAssetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity instead.")}get versionId(){return this._versionId}set versionId(e){if(this._core._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._versionId=e}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._core.isDirty}set isDirty(e){this._core.isDirty=e}get localData(){return this._core._stringify(!1,!0)}set localData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property localData.")}get remoteData(){return this._core._stringify(!0)}set remoteData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property remoteData.")}get pendingElements(){return this._pendingElements}set pendingElements(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property pendingElements.")}get changeCount(){return this._core.changeCount}set changeCount(e){this._core.changeCount=e}get readOnly(){return this._core._readOnly}set readOnly(e){this._core._readOnly=e}static _newBranchAsCopyOfCore(e){ue("_newBranchAsCopyOfCore()");const t=JSON.parse(JSON.stringify(e._data)),r=new pe(t),s=r._core;return s._sourceCompositeInfo={links:e._compositeLinks,repositoryId:e._compositeRepositoryId,assetId:e._compositeAssetId},r._resetIdentity((function(t){const r=e.getComponentWithId(t.id);if(!r)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not find original component.");if(r.state===te.modified||!r.etag)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot create a new composite from a branch that contains modified or unbound components.");const o=r._owner.compositeAssetId;if(!o)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot make a copy of component of a composite that has not been bound with an asset id. Component id ="+r.id);const n=r._owner.compositeRepositoryId;ue("_nBACOC() origAssetId",o),ue("_nBACOC() origRepositoryId",n),ue("_nBACOC() resetComponent",t),s._setSourceAssetInfoOfComponent({compositeAssetId:o,componentId:r.id,componentVersion:r.version,componentPath:r.absolutePath,repositoryId:n},t)})),r}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message)}return this._setData(t,this._core._readOnly,this._core._compositeAssetId,this._core._compositeRepositoryId)}getElementWithId(e){return this._createElement(this._core.getChildWithId(e))}getElementWithAbsolutePath(e){return this._createElement(this._core.getChildWithAbsolutePath(e))}addElement(e,t,r,s,o,n){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a name of type string");if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a type of type string");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a path of type string");const i=this._core.addChild(e,s,o,n);try{i.path=r}catch(e){throw this._core.removeChild(i),e}return i._data.type=t,this._createElement(i)}updateElement(e){const t=this.getChildWithId(e.rootNode.id);if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element does not exist in branch.");const r=this._core.replaceChild(e.rootNode,t.path);return this._deleteElement(e),r}abandonElement(e){this._deleteElement(e)}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t=null,r=null){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}replaceChild(e,t,r,s){return this._core.replaceChild(e,t,r,s)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}replaceComponent(e,t,r,s){return this._core.replaceComponent(e,t,r,s)}copy(){const e=new pe(JSON.parse(JSON.stringify(this._data)),!1,this._core._compositeAssetId,this._core._compositeRepositoryId);if(e._derivationType=this._derivationType,e._derivationDatetime=this._derivationDatetime,this._core._sourceAssetInfoLookup){const t=JSON.stringify(this._core._sourceAssetInfoLookup);e._core._sourceAssetInfoLookup=JSON.parse(t)}return e}_isNodeLike(e){return n.isObject(e)}_createElement(e){if(!e)return;const t=JSON.parse(JSON.stringify(e._data));t["manifest-format-version"]=this._data["manifest-format-version"],delete t.path;const r=new le(t,this,this._core._readOnly);return this._pendingElements.push(r),r}_deleteElement(e){const t=this._pendingElements.indexOf(e);if(t<0)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown element.");this._pendingElements.splice(t,1)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a type of type string"):"number"!=typeof e["manifest-format-version"]?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a manifest-format-version of type number"):null}_setData(e,t,r,s){this.originalManifestFormatVersion=e["manifest-format-version"],function(e){const t=e["manifest-format-version"];if(t<6){if(t<4)throw new a.DCXError(a.DCXError.INVALID_DATA,"Encountered manifest format version "+e["manifest-format-version"]+". Format version conversion not yet implemented for that version.");t<6&&fe(e,!0)}}(e),e.local&&(e.local.version=2);const o=this._verify(e);if(null===o)return e["manifest-format-version"]=6,this._core=new de(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e,this;throw o}_reset(e,t){if(this.readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._data.local&&(delete this._data.local.manifestEtag,delete this._core._compositeAssetId,delete this._core._compositeRepositoryId),e||(this._data.id=n.generateUuid()),this._data.state=te.modified,this._core._recursiveReset(this._data,t),this._core._setDirty()}_resetBinding(e){this._reset(!0,e)}_resetIdentity(e){this._reset(!1,e)}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}function fe(e,t=!1){t&&e.path&&delete e.path;const r=e.components;if("object"==typeof r)for(let e=0;e<r.length;e++){const t=r[e];"number"==typeof t.version&&(t.version=t.version.toString())}const s=e.children;if("object"==typeof s)for(let e=0;e<s.length;e++)fe(s[e])}const _e=o.newDebug("dcx:dcxjs:dcxcomposite"),me={PRIVATE:void 0,SHARED_BY_USER:"sharedByUser",SHARED_WITH_USER:"sharedWithUser"};class Ee{constructor(e,t,r,s,o,n={}){this._collaborationType=me.PRIVATE,null!=o&&"object"==typeof o&&(n=o,o=void 0),this._repoId=o,this._current=new pe,o&&(this._current.compositeRepositoryId=o),(e||""===e)&&(this._current.data.name=e),t&&(this._current.data.type=t),r&&(this._current.compositeId=r),this._current._collaborationType=this._collaborationType,this._current.data.state=te.modified,this._current._setDirty(!0),this._options=n,s&&(this._assetId=s,this._current.compositeAssetId=s,(e||""===e)&&(this._name=e),t&&(this._type=t),r&&(this._id=r)),this._options.xhrBaseBranchSupport&&(this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0)}get href(){return this._href}set href(e){this._href=e}get links(){return this._links}set links(e){n.validateParams(["links",e,"object"]),this._current&&(this._current.compositeLinks=e),this._links=e}get repositoryId(){return this._current?this._current.compositeRepositoryId:this._repoId}set repositoryId(e){n.validateParams(["repoId",e,"string"]),this._current&&(this._current.compositeRepositoryId=e),this._repoId=e}get id(){return this._current?this._current.compositeId:this._id}set id(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeId=e),this._id=e}get name(){return this._current?this._current.name:this._name}set name(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.name=e),this._name=e}get type(){return this._current?this._current.type:this._type}set type(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.type=e),this._type=e}get assetId(){return this._current?this._current.compositeAssetId:this._assetId}set assetId(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeAssetId=e),this._assetId=e}get collaborationType(){return this._current?this._current._collaborationType:this._collaborationType}set collaborationType(e){if(e!==me.PRIVATE&&e!==me.SHARED_BY_USER&&e!==me.SHARED_WITH_USER)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid value: ."+e);this._current&&(this._current._collaborationType=e),this._collaborationType=e}get clientDataString(){return this._current?this._current._clientDataString:this._clientDataString}set clientDataString(e){if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: must be a string or undefined.");const t=this._options.maxClientDataLength||1024;if(e&&e.length>t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: cannot be greater than 1KB");this._current&&(this._current._clientDataString=e),this._clientDataString=e}get isBound(){return!!(this._current&&this._current.isBound||!this._current&&this._assetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity or resetBinding instead.")}get current(){return this._current}set current(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "current" is read-only.')}static newCompositeAsCopyOf(e,t,r,s,o){let i=e._core;if(i||e.current&&(i=e.current._core),!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"compositeBranchOrElement must be a branch, an element or a composite with a current branch.");const d=new Ee(void 0,void 0,void 0,void 0,void 0,o);return d._current=pe._newBranchAsCopyOfCore(i),d._current._derivationType=he.COPY,d._current._derivationDatetime=(new Date).toISOString(),d.id=s||n.generateUuid(),t&&(d.name=t),r&&(d.type=r),d}loadBaseBranch(e){if(!this._baseBranchData)throw new a.DCXError(a.DCXError.NO_BASE_BRANCH_DATA,"No base branch data.");let t,r;try{if(r=new pe(void 0,!0,this.assetId).parse(this._baseBranchData),!e)return _.default.resolve(r)}catch(r){if(!e)return _.default.reject(r);t=r}e(t,r)}resolvePullWithBranch(e,t){const r=e;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Need a branch.");if(r===this._current)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot resolve current.");if(this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pulledBranchData,this._pulledBranchData=void 0),(()=>{r.readOnly=!1,r._collaborationType=this.collaborationType,r._clientDataString=this.clientDataString,this._current=r})(),!t)return this._current;t(void 0,this._current)}acceptPush(e){const t=this._pushJournal;let r;if(t)try{t.applyToBranch(this._current,!0),this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pushedBranchData,this._pushedBranchData=void 0),this._pushJournal=void 0,e&&e()}catch(e){r=e}else e&&e();if(r){if(!e)throw r;e(r)}if(!e)return this._current}resetBinding(e){delete this._assetId,this._current&&this._current._resetBinding(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}resetIdentity(e){delete this._assetId,this._current?(this._current._resetIdentity(),this._id=this._current.compositeId):this._id=n.generateUuid(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}_setPath(e){this._path=e}get _isRepoComposite(){return n.isObject(this._current)&&"boolean"==typeof this._current._isRepoComposite?this._current._isRepoComposite:!!this.repositoryId}}function ge(e,t,r){if(_e("convertToDCXComposite()"),e.format&&!e.format.endsWith("+dcx"))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Format must end in "+dcx"');return new Ee(e.name,e.format,t,e.assetId,e.repositoryId,r)}Ee.COLLABORATION=me;class Ae{constructor(){this._originURL=null,this._manageUIURL=null,this._licenseType=null,this._licenseUrl=null,this._attributionURL=null,this._attributionName=null}get originURL(){return this._originURL}set originURL(e){this._originURL=e}get manageUIURL(){return this._manageUIURL}set manageUIURL(e){this._manageUIURL=e}get licenseType(){return this._licenseType}set licenseType(e){this._licenseType=e}get licenseUrl(){return this._licenseUrl}set licenseUrl(e){this._licenseUrl=e}get attributionURL(){return this._attributionURL}set attributionURL(e){this._attributionURL=e}get attributionName(){return this._attributionName}set attributionName(e){this._attributionName=e}}const Ce=o.newDebug("dcx:dcxjs:ss"),De=o.AdobeDCXLogger.getInstance(),Ie=()=>!0,ye={disableRetry:!0};class ve extends G{constructor(e,t){if(super(e,t),this.name="AdobeStorageSession",this.StreamProvider=G.StreamProvider,!this._endPoint)throw new f.default(f.default.INVALID_PARAMS,"Could not determine endpoint from: "+t)}publishComposite(e,t,r,s,o,n){Ce("publishComposite");const i={};if(e){if(t)return s&&(null!==s.originURL&&(i.originURL=s.originURL),null!==s.manageUIURL&&(i.manageUIURL=s.manageUIURL),null!==s.licenseType&&(i.licenseType=s.licenseType),null!==s.licenseUrl&&(i.licenseUrl=s.licenseUrl),null!==s.attributionURL&&(i.attributionURL=s.attributionURL),null!==s.attributionName&&(i.attributionName=s.attributionName)),r&&(null!==r.artworkComponentId&&(i.artworkComponentId=r.artworkComponentId),null!==r.title&&(i.title=r.title),null!==r.alias&&(i.alias=r.alias),null!==r.tags&&(i.tags=r.tags),null!==r.description&&(i.description=r.description),null!==r.categoryId&&(i.categoryId=r.categoryId),null!==r.subCategoryIds&&(i.subCategoryIds=r.subCategoryIds),null!==r.creatorIds&&(i.creatorIds=r.creatorIds),null!==r.undiscoverable&&(i.undiscoverable=r.undiscoverable),null!==r.isPrivate&&(i.private=r.isPrivate),null!==r.custom&&(i.custom=r.custom)),null!==o&&(i.creatorTool=o),this._invokeOperation("publish",{href:e},{href:t},i,((e,t,r)=>{let s;return r&&(s=r.result),n(e,s)}));n(new f.default(f.default.INVALID_PARAMS),"CP Target URI cannot be null.")}else n(new f.default(f.default.INVALID_PARAMS),"Source Href cannot be null.")}getCollection(e,t,r){if(Ce("getCollection",e,t),!(e=this._resolveUrl(e)))return r(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));let s;e+="?order=asc&orderby=name";const o={};t&&(o[i.HeaderKeys.IF_NONE_MATCH]=t);const n=(t,d)=>t?r(a.networkError("Error retrieving a collection",t,d)):200===d.statusCode?this._parseAndAppendJSONResponse(d,s,"children",((t,a)=>{if(t)return r(t);const c=d.headers["x-children-next-start"];if(c){s=a;const t=e+"&start="+c;return this._service.invoke(i.HTTPMethods.GET,t,o,void 0,{reuseRequestDesc:void 0,responseType:"text",isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},n)}return r(void 0,a,d.headers.etag,d.headers)})):304===d.statusCode?r(void 0,null,d.headers.etag,d.headers):r(a.unexpectedResponse("Unexpected status code while getting a collection",void 0,d));return this._service.invoke(i.HTTPMethods.GET,e,o,void 0,{responseType:"text",isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},n)}pagedGetCollection(e,t,r,s,o,n,d,c){if(Ce("pagedGetCollection"),!(e=this._resolveUrl(e)))return c(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));e+=((e,t,r,s)=>{const o=[];let n="";return t&&o.push("order="+t),e&&o.push("orderBy="+e),r&&o.push("start="+r),s&&o.push("limit="+s),o.length>0&&(n="?"+o.join("&")),n})(r,s,o,n);const l={};return t&&(l[i.HeaderKeys.IF_NONE_MATCH]=t),this._service.invoke(i.HTTPMethods.GET,e,l,void 0,{responseType:"text",isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},((e,t)=>e?c(a.networkError("Error retrieving a collection",e,t)):200===t.statusCode?this._parseAndAppendJSONResponse(t,d,"children",((e,r)=>c(e,r,t.headers.etag,t.headers))):304===t.statusCode?c(void 0,null,t.headers.etag,t.headers):c(a.unexpectedResponse("Unexpected status code while getting a collection",void 0,t))))}getComponent(e,t,r){Ce("getComponent");const s={};let o;return o=this.getComponentHref(e,e.version,((e,n)=>{if(e)return r(e);const i=this._resolveUrl(n);return i?(o=o||s,this._getAsset(i,void 0,t,o,r)):r(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+n))})),o||s}getRenditionOfComponent(e,t,r,s,o){Ce("getRenditionOfComponent()");const n={};let i;return i=this.getComponentRenditionHref(e,e.version,r,((e,r)=>{if(Ce("gROC() got href ",e,r),e)return o(e);const a=this._resolveUrl(r);return a?(i=i||n,Ce("gROC() getting asset ",i),this._getAsset(a,{accept:t},s,i,o)):o(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+r))})),i||n}pagedGetCompositeVersions(e,t,r,s,o,n,d=(()=>{})){Ce("pagedGetCompositeVersions");const c={},l=this._getPagedCompositeVersionsHref(e,t,r,s,o,((e,t)=>{if(e)return d(e);const r=this._resolveUrl(t);if(!r)return d(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+t));const s={responseType:"text",reuseRequestDesc:l||c,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1};return this._service.invoke(i.HTTPMethods.GET,r,{},void 0,s,((e,t)=>e?d(a.networkError("Error retrieving version history",e,t)):200===t.statusCode?this._parseAndAppendJSONResponse(t,n,"children",d):d(a.unexpectedResponse("Unexpected status code while getting a version history",void 0,t))))}));return l||c}getCompositeManifest(e,t,r,s){Ce("getCompositeManifest()");const o={};let n;return n=this.getCompositeManifestHref(e,t,((i,a)=>{if(Ce("gCM() result",i,a),i)return s(i);const d=this._resolveUrl(a);return d?(n=n||o,this._getAssetAsType(d,"text",r,n,e.assetId,t,s)):s(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+a))})),n||o}headRequest(e,t){return Ce("headRequest"),this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},((e,r)=>e?t(e):t(void 0,r)))}remixComposite(e,t,r,s,o,n){Ce("remixComposite");const i={compositeId:s};o&&(i.creatorTool=o);const a={href:e};return t&&(a.authorization=t),this._invokeOperation("remix",a,{href:r},i,((e,t,r)=>{let s;return r&&(s=r.result),n(e,s)}))}createComposite(e,t,r,s){Ce("createComposite");const o="+dcx";let d=n.ensureRelativeHrefStartsWithSlash(t);d=n.removeLeadingSlashForPath(d);const c=this._resolveUrl(d);if(!c)return s(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+c));if(r.substr(r.length-o.length)!==o)return s(new f.default(f.default.INVALID_PARAMS,'composite type must end in "+dcx"'));const l=((e,t)=>{const s={[i.HeaderKeys.CONTENT_TYPE]:r};return this._service.invoke(i.HTTPMethods.PUT,e,s,void 0,{isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},((e,r)=>e?t(a.networkError("Error creating composite",e,r)):t(void 0,r)))})(c,((e,t)=>{if(e)return s(e);const r=t.statusCode;let o=t.headers["x-resource-urn"];if(201===r&&o)return s(void 0,t,o);if(409!==r)return s(a.unexpectedResponse("Unexpected response creating composite",e,t));{const e={reuseRequestDesc:l,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1};this._service.invoke(i.HTTPMethods.HEAD,c,void 0,void 0,e,((e,r)=>{if(e)return s(a.networkError("Error creating composite",e,r));const n=r.headers[i.HeaderKeys.CONTENT_TYPE];return n?"+dcx"!==n.substr(n.length-4,4)?s(new f.default(f.default.FILE_EXISTS_IN_CLOUD,"Cannot overwrite file at "+c)):(o=r.headers["x-resource-urn"],200===r.statusCode&&o?s(new f.default(f.default.ALREADY_EXISTS,"Composite already exists at "+c),t,o):s(a.unexpectedResponse("Unexpected response creating composite",e,r))):s(a.unexpectedResponse("Missing Content-Type header.",e,r))}))}}));return l}deleteComposite(e,t){if(Ce("deleteComposite"),!e.assetId)throw Ce("dC no id"),new f.default(f.default.INVALID_PARAMS,"Component must be part of a branch of a bound composite.");const r={};let s;return s=this.getCachedAssetInfo(e.assetId,((e,o)=>{if(Ce("dC cached",e,o),e)return e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),t(e);if(!o)return t(new f.default(f.default.COMPOSITE_NOT_FOUND,"Source asset info not found."));if(!o.primaryTemplate)return Ce("dC no pT"),t(new f.default(f.default.UNEXPECTED_RESPONSE,"Primary resource URI is missing."));const d=n.expandURITemplate(o.primaryTemplate);let c=this._resolveUrl(d);if(!c)return Ce("dC no href"),t(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+d));const l={[i.HeaderKeys.IF_MATCH]:"*"};c+="?recursive=true&invocation_mode=sync,async",s=s||r;const h={reuseRequestDesc:s,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1};Ce("invoking delete"),this._service.invoke(i.HTTPMethods.DELETE,c,l,void 0,h,((e,r)=>{if(e)return Ce("dC invoke err",e),t(a.networkError("Error deleting composite directory",e,r));const o=r.statusCode;return 200===o||204===o||404===o?t(void 0,r):202===o?this._handle202Response(r,s,this.SYNC_ASYNC_DEFAULT_DELAY,t):t(a.unexpectedResponse("Unexpected response deleting composite directory",e,r))}))})),s||r}archiveComposite(e,t){if(Ce("archiveComposite"),!e.assetId)throw Ce("aC no id"),new f.default(f.default.INVALID_PARAMS,"Component must be part of a branch of a bound composite.");const r={};let s;return s=this.getCachedAssetInfo(e.assetId,((e,o)=>{if(e)return Ce("aC err",e),e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),t(e);if(!o.primaryTemplate)return Ce("aC no pT"),t(new f.default(f.default.UNEXPECTED_RESPONSE,"Primary resource URI is missing."));let d=n.expandURITemplate(o.primaryTemplate);if(d=this._resolveUrl(d),!d)return Ce("aC no pH"),t(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+d));s=s||r;const c={reuseRequestDesc:s,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1};this._service.invoke(i.HTTPMethods.HEAD,d,void 0,void 0,c,((r,o)=>{if(r)return Ce("aC invoke err",r),t(e);let n;if(o.headers&&(n=o.headers["content-location"]),!n)return Ce("aC no cL"),t(new f.default(f.default.UNEXPECTED_RESPONSE,"Missing content location."));n=this._makeRelativeUrl(n);const d={[i.HeaderKeys.CONTENT_TYPE]:i.DirectoryMediaType,Link:"<"+n+">;rel=self"},l=n.split("/");if(!l||0===l.length)return Ce("aC bad cL format"),t(new f.default(f.default.UNEXPECTED_RESPONSE,"Invalid content location format."));const h=l[l.length-1],u=this._resolveUrl("/archive/"+h)+"?invocation_mode=sync,async";s=this._service.invoke(i.HTTPMethods.PUT,u,d,void 0,c,((e,r)=>{if(e)return Ce("aC put invoke err",e),t(a.networkError("Error archiving composite directory",e,r));const o=r.statusCode;return Ce("aC put status",o),200===o||204===o||404===o?t(void 0,r):202===o?this._handle202Response(r,s,this.SYNC_ASYNC_DEFAULT_DELAY,t):t(a.unexpectedResponse("Unexpected response archiving composite directory",e,r))}))}))})),s||r}leaveSharedComposite(e,t){if(Ce("leaveSharedComposite"),e.collaborationType!==me.SHARED_WITH_USER)throw new f.default(f.default.INVALID_STATE,"Composite's collaboration type must be sharedWithUser.");return this.deleteComposite(e,t)}uploadDataForComponentId(e,t,r,s,o,d,c,l){if(Ce("uploadDataForComponentId"),s&&!n.verifyUuid(e))throw new f.default(f.default.INVALID_PARAMS,"Component id is not a uuid ");n.verifyUuid(e)||De.warn("Existing component id is not a uuid");const h={};if(r&&!this.isProperAssetId(r))return void l(new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format."));let u;return u=this._getComponentHref(r,e,void 0,((e,r)=>{if(e)return l(e);let n=r;o&&(n+="&intermediates=false"),n=this._resolveUrl(n);const p={[i.HeaderKeys.CONTENT_TYPE]:t},_=(e,t,r)=>{p[i.HeaderKeys.IF_MATCH]=e?void 0:"*",u=u||h;const s={reuseRequestDesc:u,isStatusValid:Ie,autoParseJson:!1,retryOptions:ye};u=this._service.invoke(i.HTTPMethods.PUT,n,p,c,s,((e,s)=>{if(e)return r(a.networkError("Error uploading component",e,s),t);const o=s.statusCode;if(200===o||201===o||204===o){let n;try{n=JSON.parse(s.response)}catch(o){return e=new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",o),r(e,t,s,n)}return r(void 0,t,s,n)}return 507===o?(e=new f.default(f.default.EXCEEDS_QUOTA,"Exceeds quota",e,s),r(e,t)):(e=a.unexpectedResponse("Unexpected response uploading component",e,s),r(e,t))})),u.token=d},m=(e,t,r,o)=>{if(e){if(!(r=e.response))return l(e);let o=r.statusCode;if(!t)if(s||404!==o){if(409===o||412===o)return this._service.invoke(i.HTTPMethods.HEAD,n,{},void 0,{isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},((e,r)=>{if(e)return l(a.networkError("Error uploading component",e,r),void 0,t);o=r.statusCode,_(200!==o,!0,m)}))}else _(!0,!0,m);return l(e)}return l(void 0,r,o)};_(s,!1,m)})),u||h}copyAssetToComponentId(e,t,r,s,o,d,c,l){if(Ce("copyAssetToComponentId"),s&&!n.verifyUuid(e))throw new f.default(f.default.INVALID_PARAMS,"Component id is not a uuid ");n.verifyUuid(e)||De.warn("Existing component id is not a uuid");const h=this._makeRelativeUrl(c);if(!h)return void l(new f.default(f.default.WRONG_ENDPOINT,"Cannot copy asset: "+c));const u={};if(r&&!this.isProperAssetId(r))return void l(new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format."));let p;return p=this._getComponentHref(r,e,void 0,((e,r)=>{if(e)return l(e);let n=r+"&invocation_mode=sync,async";o&&(n+="&intermediates=false"),n=this._resolveUrl(n),p=p||u;const c={reuseRequestDesc:p,responseType:"text",isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},_={};t&&(_[i.HeaderKeys.CONTENT_TYPE]=t),_.Link="<"+h+">;rel=source";const m=(e,t,r)=>(e?delete _[i.HeaderKeys.IF_MATCH]:_[i.HeaderKeys.IF_MATCH]="*",p=this._service.invoke(i.HTTPMethods.PUT,n,_,void 0,c,((e,s)=>{if(e)return r(a.networkError("Error uploading component",e,s));const o=s.statusCode;return 200===o||201===o||204===o?r(void 0,s,t):202!==o?r(a.unexpectedResponse("Unexpected response copying a component asset",e,s),s,t):void this._handle202Response(s,p,this.SYNC_ASYNC_DEFAULT_DELAY,((e,s)=>r(e,s,t)))})),p.token=d,p),E=(e,t,r)=>{let o;if(e){if(!(t=e.response))return l(e);const o=t.statusCode;return r||404!==o&&409!==o&&412!==o?507===o?(e=new f.default(f.default.EXCEEDS_QUOTA,"Exceeds quota",e,t),l(e)):l(e):void m(!s,!0,E)}try{o=JSON.parse(t.responseText||t.response)}catch(r){return e=new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",r,t),l(e)}return l(void 0,t,o)};p=m(s,!0,E)})),p||u}updateManifest(e,t,r,s){Ce("updateManifest");const o={};let n;return n=this.getBranchManifestHref(e,void 0,((d,c)=>{if(d)return s(d);const l={[i.HeaderKeys.CONTENT_TYPE]:i.ManifestMediaType},h=e.manifestEtag,u=(e,r,s)=>{e?l[i.HeaderKeys.IF_MATCH]="*":h&&r&&(l[i.HeaderKeys.IF_MATCH]=h),n=n||o;const d={reuseRequestDesc:n,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},u=this._resolveUrl(c);this._service.invoke(i.HTTPMethods.PUT,u,l,t,d,((e,t)=>{if(e)return s(a.networkError("Error updating manifest",e,t));const r=t.statusCode;return!t.headers.etag||200!==r&&201!==r&&204!==r?412===r||409===r?(e=new f.default(f.default.UPDATE_CONFLICT,"Manifest has been changed",void 0,t),s(e)):s(a.unexpectedResponse("Unexpected response updating manifest",e,t)):s(void 0,t)}))};u(r,!0,((e,t,o)=>e?(t=e.response)&&409===t.statusCode&&r?void u(!r,!1,s):s(e):s(void 0,t,o)))})),n||o}getCompositeManifestHref(e,t,r){if(Ce("getCompositeManifestHref"),!e.assetId)throw new f.default(f.default.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.assetId))throw new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format.");return this._getAssetManifestHref(e.assetId,t,r)}getBranchManifestHref(e,t,r){if(Ce("getBranchManifestHref"),!e.compositeAssetId)throw new f.default(f.default.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.compositeAssetId))throw new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format.");return this._getAssetManifestHref(e.compositeAssetId,t,r)}getComponentHref(e,t,r){const s=e;Ce("getComponentHref");const o=s._owner;if(!o||!o.compositeAssetId)throw new f.default(f.default.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(o.compositeAssetId))throw new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format.");if(o._core){const e=o._core._getSourceAssetInfoOfComponent(s);if(e)return void this._getComponentHref(e.compositeAssetId,e.componentId,e.componentVersion,r)}return this._getComponentHref(o.compositeAssetId,s.id,t,r)}_getComponentHref(e,t,r,s){return Ce("_getComponentHref"),this.getCachedAssetInfo(e,((e,o)=>{if(e)return e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),s(e);if(!o.componentTemplate)return s(new f.default(f.default.UNEXPECTED_RESPONSE,"Component URI template is missing."));const i={component_id:t};void 0!==r&&(i.version=r);const a=n.expandURITemplate(o.componentTemplate,i);return a?s(void 0,a):s(new f.default(f.default.UNEXPECTED_RESPONSE,"An error occurred when attempting expand manifest URI template."))}))}getComponentRenditionHref(e,t,r,s){Ce("getComponentRenditionHref");const o=e._owner;if(!o||!o.compositeAssetId)throw new f.default(f.default.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(o.compositeAssetId))throw new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format.");if(o._core&&o._core._getSourceAssetInfoOfComponent(e))throw new f.default(f.default.INVALID_STATE,"Getting a rendition of a source href not implemented.");r||(r="full");const a={version:t,size:r};if(e.assetId)return this.getCachedAssetInfo(e.assetId,((e,t)=>{if(e)return e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),s(e);if(t.renditionTemplates&&t.renditionTemplates[0]&&t.renditionTemplates[0].uri){const e=n.expandURITemplate(t.renditionTemplates[0].uri,a);return s(void 0,e)}return s(new f.default(f.default.UNEXPECTED_RESPONSE,"Rendition URI template is missing."))}));const d={};let c;return c=this._getComponentHref(o.compositeAssetId,e.id,t,((t,r)=>{if(t)return s(t);c=c||d;const o={reuseRequestDesc:c,isStatusValid:Ie,retryOptions:ye,autoParseJson:!1};return r=this._resolveUrl(r),this._service.invoke(i.HTTPMethods.HEAD,r,{},void 0,o,((t,o)=>{if(t)return s(t);if(200===o.statusCode){const t={},i=o.headers.link;if(i){const e=n.parse(i);let r=e.get("rel","primary");r&&(t.primaryTemplate=r[0].uri),r=e.get("rel","rendition"),r&&(t.renditionTemplates=r)}return e.assetId=t.assetId=o.headers["x-resource-urn"],this._cacheInfoForAssetId(t.assetId,void 0,t),r=n.expandURITemplate(t.renditionTemplates[0].uri,a),s(void 0,r)}}))})),c||d}isProperAssetId(e){return e.startsWith("urn:aaid:")}_getAssetManifestHref(e,t,r){return Ce("_getAssetManifestHref()"),this.getCachedAssetInfo(e,((e,s)=>{if(e)return e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),r(e);if(!s.manifestTemplate)return r(new f.default(f.default.UNEXPECTED_RESPONSE,"Manifest URI template is missing."));const o={};t&&(o.version=t);const i=n.expandURITemplate(s.manifestTemplate,o);return i?r(void 0,i):r(new f.default(f.default.UNEXPECTED_RESPONSE,"An error occurred when attempting expand manifest URI template."))}))}_invokeOperation(e,t,r,s,d){Ce("_invokeOperation");let c=this._resolveUrl("/ops");c+="?invocation_mode=sync,async";const l={[i.HeaderKeys.CONTENT_TYPE]:i.OperationDocumentMediaType},h={op:e,id:n.generateUuid(),target:r,source:t};s&&(h.value=s),o.log("[invoke operation]: "+JSON.stringify(h,void 0,2));const u=(e,t)=>{let r;if(e)return(t=e.response)&&507===t.statusCode?(e=new f.default(f.default.EXCEEDS_QUOTA,"Exceeds quota",e,t),d(e)):d(e);try{r=JSON.parse(t.responseText||t.response)}catch(r){return e=new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",r,t),d(e)}return r.error?(e=new f.default(f.default.UNEXPECTED_RESPONSE,"Error in operation result: "+JSON.stringify(r.error,void 0,2),r.error,t),d(e)):d(void 0,t,r)},p=this._service.invoke(i.HTTPMethods.POST,c,l,JSON.stringify(h),{responseType:"text",isStatusValid:Ie,retryOptions:ye,autoParseJson:!1},((t,r)=>{if(t)return u(a.networkError("Error invoking operation "+e,t,r));const s=r.statusCode;200===s||201===s||204===s?u(void 0,r):202===s?this._handle202Response(r,p,this.SYNC_ASYNC_DEFAULT_DELAY,((e,t)=>{u(e,t)})):u(a.unexpectedResponse("Unexpected response for operation "+e,t,r),r)}));return p}_getPagedCompositeVersionsHref(e,t,r,s,o,i){Ce("_getPagedCompositeVersionsHref");const a=e.assetId;if(!a)throw new f.default(f.default.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(a))throw new f.default(f.default.INVALID_STATE,"Composite asset id has invalid format.");return this.getCachedAssetInfo(a,((e,a)=>{if(e)return e.code===f.default.ASSET_NOT_FOUND&&(e=new f.default(f.default.COMPOSITE_NOT_FOUND,"CompositeNotFound",e)),i(e);if(!a.versionHistory)return i(new f.default(f.default.UNEXPECTED_RESPONSE,"Version history URI template is missing."));const d={};s&&(d.order=s),r&&(d.orderby=r),o&&(d.start=o),t&&(d.limit=t);const c=n.expandURITemplate(a.versionHistory,d);return c?i(void 0,c):i(new f.default(f.default.UNEXPECTED_RESPONSE,"An error occurred when attempting expand version history URI template."))}))}_parseAndAppendJSONResponse(e,t,r,s){Ce("_parseAndAppendJSONResponse");const o=e.responseText||e.response;let n;try{n=JSON.parse(o)}catch(t){return s(new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",t,e))}return t&&(n[r]=t[r].concat(n[r])),s(void 0,n)}}class Te{constructor(e){this._waitingCallbacks=[],this._commitInProgress=!1,this._needAnotherCommit=!1,this._data={"composite-href":e.href,"uploaded-components":{}}}get compositeHref(){return this._data["composite-href"]}set compositeHref(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get derivationType(){return this._data["derivation-type"]}set derivationType(e){this._data["derivation-type"]=e}get manifestEtag(){return this._data.etag}set manifestEtag(e){e?this._data.etag=e:delete this._data.etag}get versionId(){return this._data.versionId}set versionId(e){e?this._data.versionId=e:delete this._data.versionId}get currentBranchEtag(){return this._data["current-branch-etag"]}set currentBranchEtag(e){e?this._data["current-branch-etag"]=e:delete this._data["current-branch-etag"]}get changeCount(){return this._data.change}set changeCount(e){e?this._data.change=e:delete this._data.change}get compositeHasBeenDeleted(){return!!this._data["composite-deleted"]}set compositeHasBeenDeleted(e){e?this._data["composite-deleted"]=!0:delete this._data["composite-deleted"]}get compositeHasBeenArchived(){return!!this._data["composite-archived"]}set compositeHasBeenArchived(e){e?this._data["composite-archived"]=!0:delete this._data["composite-archived"]}get isEmpty(){return 0===Object.keys(this._data["uploaded-components"]).length&&!this.compositeHasBeenDeleted&&!this.compositeHasBeenArchived&&!this.manifestEtag}set isEmpty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get isComplete(){return!!(this._data.etag&&this._data.change||this._data["composite-deleted"]||this._data["composite-archived"])}set isComplete(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}recordUploadedComponent(e,t,r,s,o,n){const i={etag:t,length:o,version:r,md5:s,timestamp:(new Date).toISOString()};n&&(i["source-asset-info"]=n),this._data["uploaded-components"][e]=i}idsOfAllUploadedComponents(){return Object.keys(this._data["uploaded-components"])}getRecordForUploadedComponent(e){const t=this._data["uploaded-components"][e];if(t&&!this.isComplete){let r=t.timestamp;if(!r)return void this.removeRecordForUploadedComponent(e);if(r=new Date(r),isNaN(r.getTime()))return void this.removeRecordForUploadedComponent(e);if(Date.now()-r.getTime()>=6012e5)return void this.removeRecordForUploadedComponent(e)}return t}removeRecordForUploadedComponent(e){delete this._data["uploaded-components"][e]}applyToBranch(e,t){const r=e;if(!this.isComplete)throw new a.DCXError(a.DCXError.INVALID_STATE,"Journal is not complete.");const s=r.isDirty;if(this.compositeHasBeenDeleted)r._data.state=te.committedDelete,r.manifestEtag=this.manifestEtag;else{this.compositeHasBeenArchived&&(r.compositeArchivalState=re.archived);const e=r.compositeState!==te.unmodified&&this.changeCount!==r.changeCount,t=this.idsOfAllUploadedComponents(),s=t.length;for(let e=0;e<s;e++){const s=t[e],o=r.getComponentWithId(s);if(o){const e=this.getRecordForUploadedComponent(o.id);if(o._data.etag=e.etag,o._data.length=e.length,o._data.version=e.version,o._data.md5=e.md5,e["source-asset-info"]){const t=r._core._getSourceAssetInfoOfComponent(o),s=e["source-asset-info"];t&&s&&t.compositeAssetId===s.compositeAssetId&&t.componentId===s.componentId&&t.componentVersion===s.componentVersion&&(o._data.state=te.unmodified,r._core._setSourceAssetInfoOfComponent(void 0,o))}else o._data.state=te.unmodified}}r.manifestEtag=this.manifestEtag,"string"==typeof this.versionId&&(r.versionId=this.versionId),void 0!==this.derivationType&&(r._derivationType=this.derivationType),e||(r._data.state=te.unmodified)}t&&(r._isDirty=s)}}function be(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function Pe(e){let t=0;return(r,s,o)=>{e(r-t,o),t=r}}const Re=o.newDebug("dcx:dcxjs:compositexfer:upload");function we(e,t){Re("_uploadComponent()");const{additionalHeaders:r,_additionalData:{componentId:s,componentType:o,componentIsNew:i,size:a,md5:d},_composite:l,_session:h}=e;n.validateObject(l,"composite",["id","string"],["repositoryId","string"],["assetId","string"]),n.validateParams(["session",h,"object"],["dataOrSliceCallback",t,["object","function","string"]],["componentType",o,"string"],["componentId",s,"string",!0],["size",a,"+number",!0],["md5",d,"string",!0]);const{id:u,repositoryId:p}=l,f=a||t.length||t.byteLength||t.size;return e._bytesTotal=f,_.default.resolve(void 0,e).then((()=>h.putCompositeComponent(l,s,t,o,i,f,d,e.hasProgressHandler?Pe(e._reportProgress.bind(e)):void 0,r))).then((({result:t,response:r})=>{e._additionalData.response=r;const n=c.createUploadResults(u,l.assetId,p);return n.records[s]=Oe(s,f,o,t),n}))}function Oe(e,t,r,s){if("object"!=typeof s)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Invalid upload result, expecting object");const{md5:o,etag:n,revision:i,length:d=t}=s;if(null==d)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No length");if(null==n)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No etag");if(null==i)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No version");if(null==o)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No md5");return c.createUploadRecord(e,n,i,o,d,r)}function Ne(e){return _.default.resolve(void 0,e).then(Se.bind(e)).then(Le.bind(e)).then(ke.bind(e))}function Se(){const{_session:e,_composite:t,_additionalData:{componentId:r}}=this;return e.getCompositeComponentUrl(t,r)}function Le(e){const{_session:t,_additionalData:{assetHref:r}}=this,s=i.newOperationDocBuilder().copy({href:r},{href:e},!1,!1).getDocument();return t.performOperation(s)}function ke(e){const{_composite:t,_additionalData:{componentId:r,componentType:s}}=this,o=e.response,n=i.deserializeAsset(o&&o.asset?o.asset:{}),a=c.createUploadResults(t.id,t.assetId,t.repositoryId);return a.records[r]=Oe(r,n.size,s,{revision:n.version,id:r,links:n.links,etag:n.etag,version:n.version,md5:n.md5,length:n.size,type:s}),a}const Me=o.newDebug("dcx:dcxjs:compositexfer:pull");function Xe(e){Me("_pullCompositeManifest()");const{_composite:t,_session:r,_additionalData:{versionId:s,referenceBranch:o},additionalHeaders:d}=e;if(t._links){const{assetId:e,repositoryId:s}=r.registerLinks(t._links,t.repositoryId,t.assetId);t.assetId=e,t.repositoryId=s,delete t._links}if("string"!=typeof t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must have an asset id.");let c;return Me("_pCM() pullManifest()",e),o&&!s&&(c=o.manifestEtag),_.default.resolve(void 0,e).then((()=>{const o=r.getCompositeManifest(t,s,c,d);return e.hasProgressHandler&&(o.progress=Pe(e._reportProgress.bind(e))),o})).then((r=>{const{manifestData:o,manifestEtag:d,response:c}=r;e._additionalData.response=c;try{const e=i.parseLinksFromResponseHeader(c);t.links=e}catch(e){}if(Me("_pCM() pM() getCompositeManifest() cb",d),null===o)return;let l;try{l=n.isObject(o)?new pe(o):(new pe).parse(o),l.compositeAssetId=t.assetId,l.compositeRepositoryId=t.repositoryId,l._collaborationType=t.collaborationType,l._clientDataString=t.clientDataString,l.versionId=null!=c.headers.version?c.headers.version:s,l.manifestEtag=d}catch(e){throw Me("_pCM() pM() gCM() bad manifest"),new a.DCXError(a.DCXError.INVALID_JSON,"Corrupted manifest",e)}if(l.compositeState===te.committedDelete||l.compositeState===te.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");const h=l._core.allComponents();for(let e=0;e<h.length;++e){const t=h[e];t.state===te.pendingDelete||t.state===te.committedDelete?l.removeComponent(t):t.state=te.unmodified}return l})).then((e=>{if(null!=e)return e.compositeState=te.unmodified,e.readOnly=!0,t._options.xhrBaseBranchSupport&&!s&&(t._pulledBranchData=e.localData),e})).catch((e=>{if(e.code===a.DCXError.NOT_FOUND)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite missing or deleted",e.underlyingError||e);throw e}))}const xe=o.newDebug("dcx:dcxjs:compositexfer:push");var Ue;function Be(e,t){if(xe("_pushComposite()"),!t.assetId||!t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite is not bound to a cloud asset. createComposite() must be called to assign an asset ID and repository ID before calling push.");const{owner:r,compositeIsNew:s,shouldPushWithXMP:o}=e._additionalData;return function(e,t){return xe("_isNoOpPush()"),!t&&e.compositeState===te.unmodified}(r,s)?_.default.resolve(r,e):(function(e){if(xe("_assertStateIsValidForPush()"),e.compositeState===te.committedDelete)throw new a.DCXError(a.DCXError.DELETED_COMPOSITE,"Attempt to push a deleted composite");if(e.compositeState===te.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");if(e.compositeArchivalState===re.pending||e.compositeArchivalState===re.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites cannot be archived")}(r),e._bytesTotal=0,e._indeterminateTotalBytes=!0,Ze.call(e).then(qe.bind(e)).then(o&&!je(r)?Ve.bind(e):void 0).then(Fe.bind(e)).then(We.bind(e)).catch(He.bind(e)))}function je(e){return e.getComponentWithAbsolutePath("/META-INF/metadata.xml")}function Ve(){const{_composite:e,_session:r,_additionalData:{xmpConfig:s,owner:o,compositeIsNew:a}}=this,d=function(e,r,s){if(r.mode===t.XMPModes.CLIENT_MANAGED&&r.initialXMPXML)return r.initialXMPXML;const{creatorTool:o,modifyDate:i}=r,a=n.generateUuid(),d=[];if(e._derivationType===he.COPY){const t=e._derivationDatetime,r=l.makeHistoryEventXML(o,"copied",a,t);d.push(r)}else if(s){const e=l.makeHistoryEventXML(o,"created",a,i);d.push(e)}if(!s||e._derivationType===he.COPY){const e=l.makeHistoryEventXML(o,"saved",a,i);d.push(e)}return l.initializeXMPXML(o,a,i,d,void 0)}(o,s,a);return r.putCompositeComponent(e,n.generateUuid(),d,i.EmbeddedMetadataMediaTypes.XML,!0,d.length).then((t=>r.uploadResultsFromAdobeRepoUploadResult(t,e.id))).then((e=>(this._additionalData.xmpPushed=!0,o.addComponentWithUploadResults("xmp-metadata","metadata","META-INF/metadata.xml",void 0,e))))}function He(e){xe("_handleError()",e);const{_session:t,_composite:r,_additionalData:{compositeIsNew:s}}=this;if(s||0===this.failedComponents.length&&(e.response&&400===e.response.statusCode||e.additionalData&&e.additionalData.bulkResponse))throw e;let o=!1;return t.headCompositeManifest(r).then((()=>{throw o=!0,e})).catch((t=>{if(!o&&404===t.response.statusCode)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite does not exist; may have been deleted",e,e.response,{failedComponents:this.failedComponents});throw e.additionalData={failedComponents:this.failedComponents},e}))}function Fe(){xe("_pushManifest()");const e=this._additionalData.owner;if(e.compositeState!==te.modified)return;const{_session:t,_additionalData:{overwriteExisting:r,validationLevel:s,xmpConfig:o,compositeIsNew:n,shouldPushWithXMP:i,xmpPushed:a}}=this;e.compositeState=te.unmodified;const d=e.remoteData,c=d.length;this._bytesTotal+=c,this._indeterminateTotalBytes=!1;const l=function(e,t){return xe("_updateManifestEtag()"),e._journal.manifestEtag&&e._journal.currentBranchEtag===t.manifestEtag&&(xe("_uME() updating etag, previous: ",t.manifestEtag),t.manifestEtag=e._journal.manifestEtag),xe("_uME() using if-match: ",t.manifestEtag),t.manifestEtag}(this,e);let h;return!i||a?(h=t.updateCompositeManifest(e,d,r,s,l),this.hasProgressHandler&&(h.progress=Pe(this._reportProgress.bind(this))),h):Ye(this,e,d,r,s,l,n,o)}function Ye(e,r,s,o,d,c,h,u,p=0){const{_session:f,_composite:m}=e,E=function(e,r){if(r.mode===t.XMPModes.CLIENT_MANAGED)return r.xmpPatch;const{creatorTool:s,modifyDate:o}=r,n=[];return e._derivationType===he.COPY&&l.makeDerivedWithAction.call({patchDocument:n},s,"copied",void 0,o),l.appendHistoryEvent.call({patchDocument:n},"saved",s,o),n}(r,u),g=f.getLinkHrefForAsset(m,i.LinkRelation.EMBEDDED_METADATA),A=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:"*",[i.HeaderKeys.CONTENT_TYPE]:i.JSONPatchMediaType}),C=f.getLinkHrefForAsset(m,i.LinkRelation.MANIFEST),D=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:c,[i.HeaderKeys.CONTENT_TYPE]:`${i.ManifestMediaType};validation-level=${d}`});return _.default.allSettled([C,g]).then((([e,t])=>{if("rejected"===t.status||"rejected"===e.status)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not retrieve required links.");return f.performBulkRequest(m,[{method:i.HTTPMethods.PUT,href:e.value,headers:D,body:s},{method:i.HTTPMethods.PATCH,href:t.value,headers:A,body:JSON.stringify(E)}])})).then((t=>function(e,t,r,s,o,n,d,c,h,u=0){xe("_handleManifestAndXMPResponse()");const[p,f]=h.result,{statusCode:_}=p,{statusCode:m}=f;if(xe("_hMAXR() manifest, embedded status: ",_,m),u>2&&(_>=400||m>=400))throw xe("_hMAXR() circuit break retries"),new a.DCXError(a.DCXError.INVALID_STATE,"Repairing failed or repeated failures during XMP/manifest push. Check additionalData.",void 0,h[0],{bulkResponse:h});let E=s,g=d,A=n;function C(s=r){return xe("_hMAXR() retry bulk; isNew, etag, overwrite: ",g,A,E),Ye(e,t,s,E,o,A,g,c,u+1)}if(_>=400){if(404===_)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite not found.",void 0,p,{bulkResponse:h});if(424===_);else{if(s&&409===_)throw new a.DCXError(a.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,p,{bulkResponse:h});if(s&&412===_)throw new a.DCXError(a.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,p,{bulkResponse:h});if(409===_)E=!1;else{if(412!==_)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from manifest PUT in bulk.",void 0,p,{bulkResponse:h});E=!1,A=void 0}}}if(m>=400){if(424===m);else{if(404!==m){if(400===m){const r=je(t);if(r)return function(e,t,r){const{_session:s,_composite:o,_additionalData:{owner:n}}=e;return s.getCompositeComponent(o,t.id,t.version,"text").then((({response:e})=>{const n=l.repairXMPXML(e,r.creatorTool,r.modifyDate);if(e!==n)return s.putCompositeComponent(o,t.id,n,i.EmbeddedMetadataMediaTypes.XML,!1,n.length)})).then((e=>e&&s.uploadResultsFromAdobeRepoUploadResult(e,o.id))).then((e=>{if(e)return n.updateComponentWithUploadResults(t,e),e.records[t.id].etag}))}(e,r,c).then((()=>C(t.remoteData)));throw new a.DCXError(a.DCXError.INVALID_STATE,"Manifest appears to be corrupted.",void 0,p,{bulkResponse:h})}throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from embedded request in bulk.",void 0,p,{bulkResponse:h})}g=!0}return C()}const D=je(t);return e._journal.recordUploadedComponent(D.id,"*",`${parseInt(D.version)+1}`,f.headers["content-md5"]||D.md5,D.length),p}(e,r,s,o,d,c,h,u,t,p)))}function We(e){if(void 0===e)return this._additionalData.owner;this._additionalData.manifestResponse=e;const{_journal:t,_composite:r,_additionalData:{owner:s}}=this,o=e.headers.etag,n=e.headers.version,i=s.changeCount;return t.manifestEtag=o,t.derivationType=he.NONE,t.currentBranchEtag=s.manifestEtag,t.changeCount=i,t.versionId=n,t.applyToBranch(s),s.compositeState=te.unmodified,r._options.xhrBaseBranchSupport&&(r._pushedBranchData=s.localData),s}function qe(e){if(xe("_handleFailedComponents()"),0===e.length)return this._additionalData.owner;if(e.filter((e=>e.error&&e.error.code===a.DCXError.EXCEEDS_QUOTA)).length>0)throw new a.DCXError(a.DCXError.EXCEEDS_QUOTA,"One or more components failed to upload.",void 0,void 0,{failedComponents:e});throw new a.DCXError(a.DCXError.COMPONENT_UPLOAD_ERROR,"One or more components failed to upload.",void 0,void 0,{failedComponents:e})}function ze(e){return xe("_getCurrentCopyOpCollector()"),(0===e.length||e[e.length-1].docBuilder.entryCount>=Qe(this))&&(xe("_gCCOC() new copy op collector"),e.push({docBuilder:i.newOperationDocBuilder(),orderedPendingComponents:[]})),e[e.length-1]}function Ge(e,t,r){xe("_reduceComponent()");const{_journal:s,_session:o,_composite:n,_additionalData:{owner:i},additionalHeaders:d}=this,{state:c=te.unmodified,etag:l}=r,h=null==l;if(!h&&c===te.unmodified)return xe("_rC() not new, not modified"),s.removeRecordForUploadedComponent(r.id),t;if(!h&&(c===te.committedDelete||c===te.pendingDelete))return xe("_rC() not new, committedDelete or pendingDelete"),i.removeComponent(r),t;const u=i._core._getSourceAssetInfoOfComponent(r);if(xe("_rC() source asset",u),null==u)return this._failedComponents.push({component:r,error:new a.DCXError(a.DCXError.INVALID_STATE,"Component should not be modified or new without local storage")}),t;const p=s.getRecordForUploadedComponent(r.id);if(u&&p){const e=p["source-asset-info"];if(e&&e.compositeAssetId===u.compositeAssetId&&e.componentId===u.componentId&&e.componentVersion===u.componentVersion)return r.etag=p.etag,r.version=p.version,r.md5=p.md5,r.length=p.length,r.state=te.unmodified,t}const f=u.repositoryId,_=o.getCompositeComponentUrl({repositoryId:f,assetId:u.compositeAssetId},u.componentId,u.componentVersion,d),m=o.getCompositeComponentUrl(n,r.id,r.version,d);return t.push(Promise.all([_,m]).then((([t,s])=>{if(xe("_rC() got sourceHref, targetHref: ",t,s),"string"!=typeof t||"string"!=typeof s)return void this._failedComponents.push({component:r,error:new a.DCXError(a.DCXError.INVALID_STATE,"Could not resolve component href for copy.")});const o=ze.call(this,e);o.docBuilder.copy({href:t},{href:s},!1,!0),o.orderedPendingComponents.push([r,u])})).catch((e=>{this._failedComponents.push({component:r,error:new a.DCXError(a.DCXError.UNEXPECTED,"Could not resolve hrefs to copy component.",e)})}))),t}function Ke(e){xe("_handleBatchResults(): ",e);const{_journal:t,_failedComponents:r}=this;e.map((e=>{if("rejected"===e.status)throw xe("_hBR() error",e.reason),e.reason;const{orderedPendingComponents:s,results:o,response:i}=e.value;o.map(((e,o)=>{const[d,c]=s[o];try{const{etag:r,version:s,md5:o,length:l}=function(e,t){if(xe("_validateCopyResponse()"),!n.isObject(e))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid result",void 0,t);if(e.error)throw xe("_vCR() error: ",e.error),e.error;if(!n.isObject(e.asset))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid result asset",void 0,t);const r={etag:e.asset["repo:etag"],version:e.asset["repo:version"],md5:e.asset.md5,length:e.asset["repo:size"]};for(const e in r)if(null==r[e])throw new a.DCXError(a.DCXError.INVALID_DATA,`No ${e}`,void 0,t);return r}(e,i);d.etag=r,d.version=s,d.md5=o,d.length=l,d.state=te.unmodified,t.recordUploadedComponent(d.id,r,s,o,l,c)}catch(e){r.push({component:d,error:e})}}))}))}function $e(e,t){xe("_parallelBatchOperations()");const{value:r,done:s}=t.next();return xe("_pBO() next generator: ",r,s),_.default.resolve(r).then((t=>{const r=t.map((t=>{const r=t.docBuilder.getDocument(),s=JSON.stringify(r);this._bytesTotal+=s.length;const o=e.performBatchOperation(s).then((({result:e,response:r})=>({results:e,response:r,orderedPendingComponents:t.orderedPendingComponents})));return this.hasProgressHandler&&(o.progress=Pe(this._reportProgress.bind(this))),o}));return _.default.allSettled(r)})).then(Ke.bind(this)).then((()=>s?this.failedComponents:$e.call(this,e,t)))}function*Je(e){xe("_makeCopyOpGenerator()");let t=[],r=[];for(let s=0;s<e.length;s++){const o=e[s];Ge.call(this,t,r,o),r.length===Qe(this)*(this._additionalData._test_maxConcurrentBatches||4)&&(yield Promise.all(r).then((()=>t)),t=[],r=[])}return Promise.all(r).then((()=>t))}function Ze(){xe("_pushComponents()");const{_session:e,_additionalData:{owner:t}}=this,r=t.allComponents();xe("_pC() component count: ",r.length);const s=Je.call(this,r);return _.default.resolve(void 0,this).then((()=>$e.call(this,e,s)))}function Qe(e){return e._additionalData._test_operationsPerBatch||50}t.XMPModes=void 0,(Ue=t.XMPModes||(t.XMPModes={}))[Ue.MANAGED=0]="MANAGED",Ue[Ue.PARTIALLY_MANAGED=1]="PARTIALLY_MANAGED",Ue[Ue.CLIENT_MANAGED=2]="CLIENT_MANAGED",Ue[Ue.UNMANAGED=3]="UNMANAGED";const et=o.newDebug("dcx:dcxjs:repocompositexfer:xferctx");class tt{constructor(e,t,r,s,o){this.additionalHeaders=o,this._aborted=!1,this._bytesTransfered=0,this._abortHandlers=[],this._bytesTotal=0,this._additionalData={},this._failedComponents=[],this._session=e,this._composite=t,this.onProgress=s,r&&(this._additionalData=r)}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}get failedComponents(){return this._failedComponents}get hasProgressHandler(){return void 0!==this._progressHandler}set onProgress(e){n.isFunction(e)&&(this._progressHandler=e)}get onProgress(){return this._progressHandler}onAbort(e){this._abortHandlers.push(e)}abort(e){this._aborted||(this._abortHandlers.forEach((t=>n.isFunction(t)&&t.call(void 0,e))),this._session._service.abortAllWithToken(this),this._aborted=!0)}_reportProgress(e,t){if(et("progress",e),t&&(this._indeterminateTotalBytes=!0),e>0&&(this._bytesTransfered+=e,n.isFunction(this._progressHandler)))try{this._progressHandler(this._bytesTransfered,this._bytesTotal,this._indeterminateTotalBytes)}catch(e){console.error("Error in progress callback",e)}}}const rt=o.newDebug("dcx:dcxjs:compositexfer");var st={pullCompositeManifestOnly:nt,pullCompositeVersionManifestOnly:it,getURLForComponent:at,pushComposite:ut,uploadComponent:lt,uploadNewComponent:ct,copyAssetForNewComponent:ht,copyResources:function(e,t,r,s){n.validateParams(["resources",s,"array",!1]);const o=i.newOperationDocBuilder().copyResources(t,r,s).getDocument();return e.performOperation(o).then(a._handleErrorResponsePayload).then((e=>({result:{source:t,target:r,resources:e.response[0].resources},response:e}))).catch((o=>{var d;if(o.code===a.DCXError.NOT_IMPLEMENTED||501===(null===(d=o.response)||void 0===d?void 0:d.statusCode))return function(e,t,r,s){if(1!==s.length)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED,"Support for copying multiple resources is not yet implemented.");const o=s[0],d=i.normalizeCopyResourcesDesignator(o);if(d.source.reltype!==i.LinkRelation.COMPONENT)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED,"Support for resources other than components will be added in a future update.");return e.getCompositeComponentUrl(t,d.source.component_id,d.source.revision).then((t=>be(this,void 0,void 0,(function*(){const r=yield e.headHTTPResource(t);return{contentType:r.headers["content-type"],contentLength:r.headers["content-length"]}})))).then((s=>{const{source:o,target:c}=d;return e.getCompositeComponent(t,o.component_id,o.revision,"stream").then((({response:o})=>be(this,void 0,void 0,(function*(){if(!n.isReadableStream(o))throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"The response type was not in the requested stream format");const l=s.contentLength?parseInt(s.contentLength):i.DEFAULT_BLOCK_UPLOAD_THRESHOLD,h=i.streamToGetSliceCallback(o,l,r,e.serviceConfig.service.maxOutstanding),u=yield e.putCompositeComponent(r,c.component_id,h,s.contentType,void 0,l);return Object.assign(d.target,{etag:u.result.etag,component_id:u.result.id,revision:u.result.revision}),{result:{source:t,target:r,op:"copy_resources",resources:[d]},response:u.response}}))))}))}(e,t,r,s);throw o}))}};function ot(e,t,r,s){const n=e._additionalData.response;if((n||r&&r.response)&&o.emitAnalyticsEvent(t,{composite:e._composite,error:r,response:n||r.response,branch:s}),r)throw r}function nt(e,t,r){const s=new tt(e,t,{referenceBranch:t.current},void 0,r),n=(e,t)=>(ot(s,o.AnalyticsEvent.PullComposite,e,t),t);return Xe(s).then(n.bind(void 0,void 0)).catch(n)}function it(e,t,r,s){const n=new tt(e,t,{versionId:r,referenceBranch:t.current},void 0,s),i=(e,t)=>(ot(n,o.AnalyticsEvent.PullCompositeVersion,e,t),t);return Xe(n).then(i.bind(void 0,void 0)).catch(i)}function at(e,t,r,s){return e.getCompositeComponentUrl(t,t.id,void 0!==r?r:t.version,s)}function dt(e,t,r,s,n){const i=e._additionalData.response;if((i||s&&s.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.UploadComponent,{composite:e._composite,error:s,response:i||s.response,isBlockTransferred:t,component:r}),s)throw s;return n}function ct(e,t,r,s,o,i,d,c,l){if(rt("uploadNewComponent()"),o&&!n.verifyUuid(o))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");const h=new tt(e,t,{componentType:s,componentIsNew:!0,componentId:o||n.generateUuid(),size:i,md5:d},c,l),u=(e,t)=>(dt(h,!!p.blockUpload,{length:i,type:s},e,t),t),p=we(h,r).then(u.bind(void 0,void 0)).catch(u);return p}function lt(e,t,r,s,o,i,a,d){rt("uploadComponent()"),n.validateObject(r,"component",["id","string"],["type","string"]);const{id:c,type:l}=r,h=new tt(e,t,{componentType:l,componentIsNew:!1,componentId:c,size:o,md5:i},a,d),u=(e,t)=>(dt(h,!!p.blockUpload,r,e,t),t),p=we(h,s).then(u.bind(void 0,void 0)).catch(u);return p}function ht(e,t,r,s,o){if(rt("copyAssetForNewComponent()"),n.validateParams(["session",e,"object"],["composite",t,"object"],["assetHref",r,"string"],["type",s,"string"],["componentId",o,"string",!0]),o&&!n.verifyUuid(o))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");return Ne(new tt(e,t,{componentType:s,componentIsNew:!0,componentId:o||n.generateUuid(),assetHref:r}))}function ut(e,r,s,i=1,d={mode:t.XMPModes.MANAGED},c){rt("pushComposite()"),n.validateParams(["session",e,"object"],["composite",r,"object"],["overwriteExisting",s,"boolean"],["validationLevel",i,"+number"],["options",d,"object",!0]);const l=function(e){void 0===e.mode&&(e.mode=t.XMPModes.MANAGED);const r=e.modifyDate||(new Date).toISOString(),s=e.creatorTool||"dcx-js";if(e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.PARTIALLY_MANAGED)return rt("push: using managed XMP mode"),n.validateObject(e,"options",["creatorTool","string",!0],["modifyDate","string",!0]),{mode:e.mode,creatorTool:s,modifyDate:r};if(e.mode===t.XMPModes.CLIENT_MANAGED){rt("push: using client managed XMP mode"),n.validateObject(e,"options",["xmpPatch","object[]",!0],["initialXMPXML","string",!0]);const t=e.xmpPatch||[],o=n.validateJSONPatchDocument(t);if(!0!==o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Invalid parameter "options.xmpPatch".',void 0,void 0,{issues:o});return Object.assign(Object.assign({},e),{modifyDate:r,creatorTool:s})}if(e.mode===t.XMPModes.UNMANAGED)return rt("push: using unmanaged XMP mode"),e;throw new a.DCXError(a.DCXError.INVALID_PARAMS,`Invalid XMP mode '${e.mode}'`)}(d),h=!r.isBound;!function(e,r){e.mode===t.XMPModes.PARTIALLY_MANAGED||e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.CLIENT_MANAGED&&(r||!r&&e.xmpPatch)}(l,h);const u=r._current.copy(),p=u._derivationType,f=new tt(e,r,{owner:u,overwriteExisting:s,compositeIsNew:h,validationLevel:i,xmpConfig:l,shouldPushWithXMP:!1,xmpPushed:!1},void 0,c);f._journal=f._composite._pushJournal||new Te(r);const _=function(e,t){const s=f._additionalData.manifestResponse;(s||t&&t.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.PushComposite,{composite:r,branch:u,error:t,response:s||t.response,derivationType:p});const n=f._journal;return f._composite._pushJournal=n.isEmpty?void 0:n,e};return Be(f,r).then(_).catch((e=>{throw _(void 0),e}))}const pt=(e,t)=>`It looks like you're using a ${e} bundle in a ${t} environment. \r\nThis may lead to unexpected results. \n\nSee https://git.corp.adobe.com/DMA/dcx-js/blob/dev/docs/guides/bundles.md for main field definitions.`;class ft{constructor(e,t,r){this._aborted=!1,this._session=e,this._callback=t,this._cleanup=r,this._componentsPending=0,this._bytesTransfered=0,this._bytesTotal=0,this._onProgress=n.noOp,this._reportProgress=e=>{if(e>0){this._bytesTransfered+=e;const t=this._onProgress;t&&t(this._bytesTransfered,this._bytesTotal)}}}get xferComplete(){return this._xferComplete}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}set onProgress(e){this._onProgress=e}get onProgress(){return this._onProgress}_callCallback(e,t){const r=this._callback;if(r)return this._callback=void 0,r(e,t)}_xferComplete(e,t){const r=this._cleanup;if(!r)return this._callCallback(e,t);this._cleanup=void 0,r(e,t)}abort(e){return this._aborted||(this._aborted=!0,this._session._service.abortAllWithToken(this)),e||(this._callback=void 0,e=new Error("Aborted")),this._xferComplete(e,null)}}class _t{constructor(){}static publishCompositeAlreadyPushedToPubs(e,t,r,s,o,n){if(!t||null==t.resourcePath||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"ResourcePath & communityId must be set on publication record for the composite to be published.");const i=new ft(o,n),d=null!==t.assetId;let c;return e.current&&o.updatePublicationRecordData(t,e.current),d?(c=o.updateCpMetadataAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i):(c=o.publishCompositeAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i)}static getCpMetadata(e,t,r){if(!t||null==t.assetId||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Asset Id & communityId must be set on publication record to fetch its CP metadata.");return e.getCpMetadata(t,r)}}const mt=o.AdobeDCXLogger.getInstance();class Et{constructor(e){this.session=e,this.isRepoSession=e instanceof c.AdobeRepoAPISession}createComposite(e,t,r,s){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.createComposite(e,t,r,s)}publishComposite(e,t,r,s,o,n){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.publishComposite(e,t,r,s,o,n)}archiveComposite(e,t){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.archiveComposite(e,t)}remixComposite(e,t,r,s,o,n){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.remixComposite(e,t,r,s,o,n)}copyAssetToComponentId(e,t,r,s,o,i,d,c){if(s&&!n.verifyUuid(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");if(n.verifyUuid(e)||mt.warn("Existing component id is not a uuid"),this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.copyAssetToComponentId(e,t,r,s,o,i,d,c)}uploadDataForComponentId(e,t,r,s,o,i,d,c){if(s&&!n.verifyUuid(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");if(n.verifyUuid(e)||mt.warn("Existing component id is not a uuid"),this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.uploadDataForComponentId(e,t,r,s,o,i,d,c)}headRequest(e,t){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.headRequest(e,t)}getComponentHref(e,t,r){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.getComponentHref(e,t,r)}getCompositeManifestHref(e,t,r){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.getCompositeManifestHref(e,t,r)}_getComponentHref(e,t,r,s){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session._getComponentHref(e,t,r,s)}_getAssetManifestHref(e,t,r){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session._getAssetManifestHref(e,t,r)}getCompositeManifest(e,t,r,s=(()=>{})){const o=new Ee(e.name,e.format,void 0,e.assetId);if(!this.isRepoSession)return this.session.getCompositeManifest(o,t,r,s);o.repositoryId=e.repositoryId;const n=this.session.getCompositeManifest(o,t,r);return n.then((e=>(s(void 0,e.manifestData,e.manifestEtag),e))).catch((e=>{s(e)})),n}updateManifest(e,t,r,s){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.updateManifest(e,t,r,s)}deleteComposite(e,t){if(this.isRepoSession)throw new a.DCXError(a.DCXError.NOT_IMPLEMENTED);return this.session.deleteComposite(e,t)}registerLinks(e,t,r){return this.isRepoSession?this.session.registerLinks(e,t,r):{assetId:this.session.registerLinks(e),repositoryId:void 0}}}const gt=o.newDebug("dcx:dcxjs:xfer"),At=o.newDebug("dcx:dcxjs:xferctx"),Ct=o.AdobeDCXLogger.getInstance();class Dt{constructor(e,t,r){this._usingRepoSession=!1,this._bytesTotal=0,this._aborted=!1,this._abortHandlers=[],this._componentsPending=0,this._bytesTransfered=0,this._onProgress=n.noOp,At("create",null!=e,null!=t,null!=r),this._session=e,this._callback=t,this._cleanup=r,this._reportProgress=e=>{if(At("progress",e),e>0){this._bytesTransfered+=e;const t=this.onProgress;t&&t(this._bytesTransfered,this._bytesTotal)}}}get reportProgress(){return this._reportProgress}set reportProgress(e){this._reportProgress=e}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}get onProgress(){return this._onProgress}set onProgress(e){this._onProgress=e}_isPromiseRequest(){return null!=this._reject}_callCallback(e,t){At("_callCallback()","object"==typeof e?e.message:e,this._isPromiseRequest(),null!=this._callback);const r=this._callback;return this._isPromiseRequest()?(At("_cC() promise req"),null!=e&&this._reject(e),void this._callback(void 0,t)):r?(this._callback=void 0,r(e,t)):void 0}_xferComplete(e,t){At("_xferComplete",null!=e,null!=this._cleanup);const r=this._cleanup;r?(this._cleanup=void 0,r(e,t)):this._callCallback(e,t),this._abortHandlers=[]}abort(e){return At("abort"),this._aborted||(this._aborted=!0,this._session._service.abortAllWithToken(this),this._abortHandlers.forEach((t=>t.call(null,e)))),e||(At("no abort error, rm callback"),this._callback=void 0,e=new Error("Aborted")),this._xferComplete(e)}onAbort(e){this._abortHandlers.push(e)}}const It={pullCompositeManifestOnly:(e,t,r,s)=>(gt("pullCompositeManifestOnly()"),vt(t)?yt(e,void 0,t,r):nt(t,e,s)),pullCompositeVersionManifestOnly:(e,t,r,s,o)=>(gt("pullCompositeVersionManifestOnly"),vt(r)?yt(e,t,r,s):it(r,e,t,o)),createComposite(e,t,r,s,o){if(gt("createComposite()"),e.assetId)throw new f.default(f.default.INVALID_STATE,"composite must not already have an assigned asset id.");let n;return n=new Dt(s,o,(function(e,t){return n._callCallback(e,t)})),n._composite=e,n._overwriteExisting=r,n._compositeIsNew=!0,n._journal=e._pushJournal||new Te(e),n._callback=o,function(e,t){gt("_createCompositeAtHref");const r=t._composite,s=t._overwriteExisting;function o(e){t._xferComplete(e,r.assetId)}if(r.assetId)return o();{const n=t.token=t._session.createComposite(r,e,r.type,(function(e,n,i){if(e){if(e.code!==f.default.ALREADY_EXISTS)return e.code===f.default.INVALID_PARAMS?o(e):o(a.unexpectedResponse("Unexpected response creating a composite directory",e,n));if(s)r.assetId=i,o();else{const s=t._session._getAssetManifestHref(i,void 0,(function(s,n){if(s)return o(s);n=t._session._resolveUrl(n);const a=t._session.headRequest(n,(function(t,s){return t?o(t):404!==s.statusCode?o(e):(r.assetId=i,void o())}));a&&(a.token=t)}));s&&(s.token=t)}}else r.assetId=i,o()}));n&&(n.token=t)}}(t,n),n},pushComposite(e,t,r,s){const o=e;if(gt("pushComposite()"),!vt(r))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");let n;const i=!o.isBound;return n=new Dt(r,s,(function(e,t){const r=n._journal;return o._pushJournal=r.isEmpty?void 0:r,n._callCallback(e,t)})),n._composite=o,n._overwriteExisting=t,n._compositeIsNew=i,n._owner=o._current.copy(),n._journal=o._pushJournal||new Te(o),function(e,t){gt("_pushComposite()");const r=t._owner,s=t._journal,o=t._compositeIsNew,n=t._overwriteExisting,i=t._session;if(!e.assetId)throw gt("_pC() error: not bound"),new f.default(f.default.INVALID_STATE,"createComposite must be called before pushComposite to create a composite directory and assign an asset id.");const a=r.changeCount,d=r.remoteData.length+50;if(t._bytesTotal=d,r.compositeState===te.committedDelete)return gt("_pC() error: push deleted"),t._xferComplete(new f.default(f.default.DELETED_COMPOSITE,"Attempt to push a deleted composite"));if(r.compositeArchivalState===re.archived)return gt("_pC() error: push archived"),t._xferComplete(new f.default(f.default.DELETED_COMPOSITE,"Attempt to push an archived composite"));const c=r.compositeArchivalState===re.pending;if(!o&&!c&&r.compositeState===te.unmodified)return gt("_pC() not new, unmodified, return null"),t._xferComplete();if(r.compositeState===te.pendingDelete)return o&&!n?(gt("_pC() error: delete unbound without overwriteExisting"),t._xferComplete(new f.default(f.default.INVALID_STATE,"Attempt to delete unbound composite without specifying overwriteExisting."))):(gt("_pC() deleting"),function(e,t,r){gt("_deleteComposite");const s=e._composite,o=e._owner,n=e._session;o.compositeState=te.committedDelete;const i=o.remoteData;e._bytesTotal=i.length,e._journal.manifestEtag&&e._journal.currentBranchEtag===o.manifestEtag&&(o.manifestEtag=e._journal.manifestEtag);const a=n.updateManifest(o,i,t,(function(t){if(t)return r(t);const i=n.deleteComposite(s,(function(t){return t?r(t):(e._journal.compositeHasBeenDeleted=!0,r(void 0,o))}));i&&(i.token=e)}));a&&(a.token=e)}(t,n,(function(e,r){return t._xferComplete(e,r)})));function l(r,s){if(!c)return s(void 0,r);{gt("_pC() archiving");const o=i.archiveComposite(e,(function(e){return e?s(e):(r.compositeArchivalState="archived",t._journal.compositeHasBeenArchived=!0,s(void 0,r))}));o&&(o.token=t)}}function h(r){if(o)return t._xferComplete(r);const s=i.getCompositeManifestHref(e,void 0,(function(e,s){if(e)return t._xferComplete(e);s=i._resolveUrl(s);const o=i.headRequest(s,(function(e,s){return e?t._xferComplete(e):404===s.statusCode?t._xferComplete(new f.default(f.default.NO_COMPOSITE,"Composite does not exist; may have been deleted")):t._xferComplete(r)}));o&&(o.token=t)}));s&&(s.token=t)}!function(e,t,r){gt("_pushComponents");const s=t.allComponents(),o=e._composite,n={},i=e._journal;function a(t,s,o){s?n[t.id]=s:delete n[t.id],o&&(e.failedComponents=e.failedComponents||[],e.failedComponents.push({component:t,error:o})),0===Object.keys(n).length&&r()}function d(t,r,s){const n=i.getRecordForUploadedComponent(t.id);if(r&&n){const e=n["source-asset-info"];if(e&&e.compositeAssetId===r.compositeAssetId&&e.componentId===r.componentId&&e.componentVersion===r.componentVersion)return t.etag=n.etag,t.version=n.version,t.md5=n.md5,t.length=n.length,void(t.state=te.unmodified)}a(t,"copying");const d=function(e,s,o){const n=s,d=o;if(!e){const s=n.headers.etag,o=n.headers.version||n.headers["x-latest-version"],a=d.md5,c=d.size;s||(e=new f.default(f.default.UNEXPECTED_RESPONSE,"No etag")),o||(e=new f.default(f.default.UNEXPECTED_RESPONSE,"No version")),a||(e=new f.default(f.default.UNEXPECTED_RESPONSE,"No md5")),c||(e=new f.default(f.default.UNEXPECTED_RESPONSE,"No length")),t.etag=s,t.version=o,t.md5=a,t.length=c,t.state=te.unmodified,i.recordUploadedComponent(t.id,s,o,a,c,r)}a(t,null,e)};let c;if(e._session._getComponentHref(r.compositeAssetId,r.componentId,r.componentVersion,(function(t,r){t||(c=e._session._resolveUrl(r))})),!c)throw new f.default(f.default.INVALID_STATE,"Session missing cached asset info for asset id = "+r.compositeAssetId);e._session._getResourcePathFromHref(c,(function(r,n){if(r)return d(r);c=e._session._resolveUrl(n);const i=e._session.copyAssetToComponentId(t.id,t.type,o.assetId,s,o.collaborationType===me.SHARED_WITH_USER,e,c,d);i&&(i.progress=e._reportProgress,i.token=e)}))}for(let r=0;r<s.length;++r){const o=s[r];let n=o.state;const a=!o.etag;if(n||(n=te.unmodified),a||n===te.modified){const r=t._core._getSourceAssetInfoOfComponent(o);r?d(o,r,a||e._compositeIsNew):(e.failedComponents=e.failedComponents||[],e.failedComponents.push({component:o,error:new f.default(f.default.INVALID_STATE,"Component should not be modified or new without local storage")}))}else n===te.unmodified?i.removeRecordForUploadedComponent(o.id):n!==te.committedDelete&&n!==te.pendingDelete||t.removeComponent(o)}0===Object.keys(n).length&&r()}(t,r,(function(){if(t.aborted)return;const o=t.failedComponents;if(o){let e=new f.default(f.default.COMPONENT_UPLOAD_ERROR,"One or more components failed to upload.",void 0,void 0,{failedComponents:[]});const t=o.length;for(let r=0;r<t;r++){const t=o[r].error;if(t.code===f.default.EXCEEDS_QUOTA){e=new f.default(t.code,t.message);break}}return e.additionalData.failedComponents=o,h(e)}if(r.compositeState===te.modified){r.compositeState=te.unmodified,s.manifestEtag&&s.currentBranchEtag===r.manifestEtag&&(r.manifestEtag=s.manifestEtag);const o=r.remoteData;t._bytesTotal+=o.length,t._bytesTotal-=d;const c=i.updateManifest(r,o,n,(function(o,n){if(t.aborted)return;if(o)return h(o);const i=n.headers.etag;s.manifestEtag=i,s.currentBranchEtag=r.manifestEtag,s.changeCount=a,s.applyToBranch(r),r.compositeState=te.unmodified,e._options.xhrBaseBranchSupport&&(e._pushedBranchData=r.localData),l(r,(function(e,r){return t._xferComplete(e,r)}))}));c&&(c.progress=t._reportProgress,c.token=t)}else l(r,(function(e,r){return t._xferComplete(e,r)}))}))}(o,n),n},remixComposite(e,t,r,s,o,n,i){if(gt("remixComposite"),!vt(n))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");const a=new Et(n);function d(n){const i=a.remixComposite(e,t,r,s,o,(function(e,t){return n._xferComplete(e,e?void 0:t)}));return i&&(i.token=n),n}return vt(n)?d(new Dt(n,i)):Tt(a,d)},publishComposite(e,t,r,s,o,n,i){if(gt("publishComposite"),!vt(n))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");const a=new Et(n);function d(n){const i=a.publishComposite(e,t,r,s,o,(function(e,t){return n._xferComplete(e,e?void 0:t)}));return i&&(i.token=n),n}return vt(n)?d(new Dt(n,i)):Tt(a,d)},uploadNewComponent(e,t,r,s,o,i){if(gt("uploadNewComponent"),!vt(o))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");if(!n.verifyUuid(s))throw new f.default(f.default.INVALID_PARAMS,"Component id is not a uuid");const a=new Et(o);function d(o){return bt(s||n.generateUuid(),t,!0,r.collaborationType===me.SHARED_WITH_USER,e,r.id,r.assetId,a,o)}if(vt(o)){if("function"!=typeof i)throw new f.default(f.default.INVALID_PARAMS,'Param "callback" must be a function.');return d(new Dt(o,i))}return Tt(a,d)},uploadComponent(e,t,r,s,o){if(gt("uploadComponent"),!vt(s))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");const n=new Et(s);function i(s){return bt(e.id,e.type,!1,r.collaborationType===me.SHARED_WITH_USER,t,r.id,r.assetId,n,s)}if(vt(s)){if("function"!=typeof o)throw new f.default(f.default.INVALID_PARAMS,'Param "callback" must be a function.');return i(new Dt(s,o))}return Tt(n,i)},copyAssetForNewComponent(e,t,r,s,o,i){if(gt("copyAssetForNewComponent"),!vt(o))throw new f.default(f.default.NOT_IMPLEMENTED,"Method not yet implemented for RepoAPISession");if(!n.verifyUuid(s))throw new f.default(f.default.INVALID_PARAMS,"Component id is not a uuid");const a=new Et(o);function d(i){return Pt(s||n.generateUuid(),t,!0,r.collaborationType===me.SHARED_WITH_USER,e,r.id,r.assetId,o,i)}if(vt(o)){if("function"!=typeof i)throw new f.default(f.default.INVALID_PARAMS,'Param "callback" must be a function.');return d(new Dt(o,i))}return Tt(a,d)},getURLForComponent:(e,t,r)=>(gt("getURLForComponent()"),vt(t)?t.getComponentHref(e,e.version,(function(e,s){let o=s;e||(o=t._resolveUrl(o)),r&&r(e,o)})):at(t,e))};function yt(e,t,r,s){if(gt("_pullCompositeManifest()"),e._links){const t=r.registerLinks(e._links);e.assetId=t,e._links=void 0}if("string"!=typeof e.assetId)throw new f.default(f.default.INVALID_STATE,"Composite must have an asset id.");let o;return o=new Dt(r,s,(function(r,s){return gt("_pCM() finalizePull()",r,s),r?o._callCallback(r):null===s?o._callCallback(void 0,null):(s.compositeState=te.unmodified,s.readOnly=!0,e._options.xhrBaseBranchSupport&&!t&&(e._pulledBranchData=s.localData),o._callCallback(void 0,s))})),o._composite=e,function(){if(gt("_pCM() pullManifest()",o),o.aborted)return void gt("_pCM() pM() aborted");let s;e.current&&!t&&(s=e.current.manifestEtag,o._referenceBranch=e.current);const i=r.getCompositeManifest(e,t,s,(function(r,s,a){if(gt("_pCM() pM() getCompositeManifest() cb",r,a),o.aborted)return void gt("_pCM() pM() gCM() aborted: ",i);if(r){const e=r;return e.response&&404===e.response.statusCode?o._xferComplete(new f.default(f.default.NO_COMPOSITE,"Composite missing or deleted",e.underlyingError||r)):o._xferComplete(r)}if(null===s)return o._xferComplete(void 0,null);let d;try{if(d=n.isObject(s)?new pe(s):(new pe).parse(s),d.compositeAssetId=e.assetId,d._collaborationType=e.collaborationType,d._clientDataString=e.clientDataString,d.manifestEtag=a,d.versionId=t,(d.compositeState===te.committedDelete||d.compositeState===te.pendingDelete)&&!t){const t=o._session.deleteComposite(e,(function(e){return gt("_pCM() pM() gCM() deleteComposite() cb",e),e?o._xferComplete(new f.default(f.default.DELETED_COMPOSITE,"Error deleting composite directory",e)):o._xferComplete(new f.default(f.default.DELETED_COMPOSITE,"Composite is deleted"))}));return void(t&&(t.token=o))}}catch(e){return gt("_pCM() pM() gCM() bad manifest"),o._xferComplete(new f.default(f.default.INVALID_JSON,"Corrupted manifest",e))}const c=d.allComponents();for(let e=0;e<c.length;++e){const t=c[e];t.state===te.pendingDelete||t.state===te.committedDelete?d.removeComponent(t):t.state=te.unmodified}return o._xferComplete(void 0,d)}));i&&(i.token=o,i.progress=o._reportProgress,o.onAbort((e=>i.cancel(e)))),gt("_pCM() pM() after:",i,o)}(),o}function vt(e){return e instanceof ve||e instanceof ee}function Tt(e,t){return gt("createPromiseRequest"),new d.AdobePromise(((r,s,o)=>{const n=new Dt(e,r);return n._reject=s,o((()=>{n.abort()})),t(n)}))}const bt=function(e,t,r,s,o,i,a,d,l){if(gt("internalUploadComponent"),r&&!n.verifyUuid(e))throw new f.default(f.default.INVALID_PARAMS,"Component id is not a uuid");n.verifyUuid(e)||Ct.warn("Existing component id is not a uuid");let h,u=o.length||o.byteLength||o.size;return l._bytesTotal=u,h=d.uploadDataForComponentId(e,t,a,r,s,l,o,(function(r,s,o){let n;if(!r)try{n=c.createUploadResults(i,a,void 0),u=u||h.bytesSent,n.records[e]=function(e,t,r,s,o){if("number"!=typeof t)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No length");const n=s.headers.etag,i=s.headers.version||s.headers["x-latest-version"],a=o.md5;if(!n)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No etag");if(!i)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No version");if(!a)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No md5");return c.createUploadRecord(e,n,i,a,t,r)}(e,u,t,s,o)}catch(e){r=e,n=void 0}return l._xferComplete(r,n)})),h&&(h.progress=l.reportProgress,h.token=l),l},Pt=function(e,t,r,s,o,n,i,a,d){gt("internalCopyComponent");const l=a.copyAssetToComponentId(e,t,i,r,s,d,o,(function(r,s,o){if(d.aborted)return;let a;if(!r)try{a=c.createUploadResults(n,i,void 0),a.records[e]=function(e,t,r,s){const o=s.headers.etag,n=s.headers.version||s.headers["x-latest-version"],i=t.md5,a=t.size;if("number"!=typeof a)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No length");if(!o)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No etag");if(!n)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No version");if(!i)throw new f.default(f.default.UNEXPECTED_RESPONSE,"No md5");return c.createUploadRecord(e,o,n,i,a,r)}(e,o,t,s)}catch(e){r=e,a=void 0}return d._callCallback(r,a)}));return l&&(l.progress=d.reportProgress,l.token=d),d},Rt=s.AdobeNetworkHTTPService,wt=Rt,Ot=st,Nt=st;n.isBrowserSDK()&&n.isNode()?u.default.warn(pt("browser","Node")):!n.isBrowserSDK()&&n.isBrowser()&&u.default.warn(pt("Node","browser"));const St=o.getGlobalLogger(),Lt=p,kt=Ee.COLLABORATION,Mt=s.StreamProvider,Xt=m;Object.defineProperty(t,"createHTTPService",{enumerable:!0,get:function(){return s.createHTTPService}}),Object.defineProperty(t,"AdobeDCXLogger",{enumerable:!0,get:function(){return o.AdobeDCXLogger}}),Object.defineProperty(t,"getGlobalLogger",{enumerable:!0,get:function(){return o.getGlobalLogger}}),Object.defineProperty(t,"AdobeDCXError",{enumerable:!0,get:function(){return a.AdobeDCXError}}),Object.defineProperty(t,"DCXError",{enumerable:!0,get:function(){return a.DCXError}}),Object.defineProperty(t,"isAdobeDCXError",{enumerable:!0,get:function(){return a.isAdobeDCXError}}),t.AdobeCommunityPlatform=_t,t.AdobeCommunityPublicationRecord=m,t.AdobeCommunitySession=ee,t.AdobeDCXBranch=pe,t.AdobeDCXComponent=oe,t.AdobeDCXComposite=Ee,t.AdobeDCXCompositeXfer=It,t.AdobeDCXElement=le,t.AdobeDCXNode=ne,t.AdobeDCXPushJournal=Te,t.AdobeDCXRepoCompositeXfer=Ot,t.AdobeDCXUtil=Lt,t.AdobeNetworkHTTPService=Rt,t.AdobeRemixData=Ae,t.AdobeStorageSession=ve,t.COLLABORATION=kt,t.CommunityPublicationRecord=Xt,t.CommunitySession=ee,t.HTTPService=wt,t.RemixData=Ae,t.StorageSession=ve,t.StreamProvider=Mt,t.communityPlatform=_t,t.compositeXfer=It,t.convertToDCXComposite=ge,t.copyAssetForNewComponent=ht,t.createCommunityPublicationRecord=()=>new m,t.createCommunitySession=(e,t)=>new ee(e,t),t.createComposite=function(e,t,r,s,o,d){if(_e("createComposite()"),n.validateParams(["session",e,"object"],["composite",t,"object"],["parentDir",r,"object"],["relPath",s,"string"]),t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must not already have an assigned asset id.");if("string"!=typeof r.repositoryId&&"string"!=typeof t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Either composite or parentDir must contain valid repositoryId.");if("string"==typeof r.repositoryId&&"string"==typeof t.repositoryId&&r.repositoryId!==t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Composite contains a repositoryId that does not match parentDir.");if("string"!=typeof t.type)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must contain a valid type.");const c="string"==typeof t.repositoryId?t.repositoryId:r.repositoryId,l=r;if(Object.getOwnPropertyNames(r).forEach((e=>{l[e]=r[e],l.repositoryId=c})),!i.isMinimalAdobeAsset(l))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return function(e,t,r,s,o,a,d){const{repositoryId:c}=r;return e.createComposite(r,s,o,a,d).then((e=>{const{assetId:r,links:s}=e.result;return t.assetId=r,t.repositoryId=c,t.links=s,a?e.result:t})).catch((r=>{try{if(r.response&&n.isObject(r.response.headers)){const s=r.response.headers["asset-id"]||r.response.headers["x-resource-id"],o=i.parseLinksFromResponseHeader(r.response);t.links=o,"string"==typeof s&&n.isObject(o)&&e.updateCachedAssetLinks({assetId:s,repositoryId:c,links:o})}}catch(e){}throw r}))}(e,t,l,s,t.type,o||void 0,d)},t.createRemixData=()=>new Ae,t.createStorageSession=(e,t)=>new ve(e,t),t.getCompositeManifestAndComponentsByPath=function(e,t,r,s,o,n){const a=i.isAdobeDCXCompositeLike(t)?t:ge(t);return e.getManifestAndComponentsByPath(a,r,s,o,n).then((e=>Object.assign(e,{composite:a})))},t.getURLForComponent=at,t.logger=St,t.newCompositeAsCopyOf=(e,t,r,s,o={})=>Ee.newCompositeAsCopyOf(e,t,r,s,o),t.newDCXComposite=function(e,t,r,s,o,n,i={}){if(null==e&&null==n){if("string"!=typeof o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a type.");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a name.")}const d=new Ee(r,o,s,e,t,i);return n&&(d.links=n),d},t.pullCompositeManifestOnly=nt,t.pullCompositeVersionManifestOnly=it,t.pushComposite=ut,t.repoCompositeXfer=Nt,t.uploadComponent=lt,t.uploadNewComponent=ct,Object.keys(d).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})})),Object.keys(c).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}})}))},6035:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.ProblemTypes=void 0,(r=t.ProblemTypes||(t.ProblemTypes={})).ACCESS_DENIED="http://ns.adobe.com/adobecloud/problem/accessdenied",r.ASSET_LOCKED="http://ns.adobe.com/adobecloud/problem/assetlocked",r.ASSET_NAME_CONFLICT="http://ns.adobe.com/adobecloud/problem/assetnameconflict",r.ASSET_NAME_INVALID="http://ns.adobe.com/adobecloud/problem/assetnamenotvalid",r.ASSET_NOT_FOUND="http://ns.adobe.com/adobecloud/problem/assetnotfound",r.ASSET_STATE_NOT_ALLOWED="http://ns.adobe.com/adobecloud/problem/assetstatenotallowed",r.BAD_REQUEST="http://ns.adobe.com/adobecloud/problem/badrequest",r.BULK_REQUEST_NOT_ATTEMPTED="http://ns.adobe.com/adobecloud/problem/bulkrequestnotattempted",r.COMPOSITE_INTEGRITY="http://ns.adobe.com/adobecloud/problem/compositeintegrity",r.DCX_VALIDATION="http://ns.adobe.com/adobecloud/problem/dcxvalidation",r.DIRECTORY_NOT_EMPTY="http://ns.adobe.com/adobecloud/problem/directorynotempty",r.EMBED_INVALID="http://ns.adobe.com/adobecloud/problem/embedinvalid",r.EMBED_TOO_LARGE="http://ns.adobe.com/adobecloud/problem/embedtoolarge",r.ENCRYPTION_KEY_INACCESSIBLE="http://ns.adobe.com/adobecloud/problem/encryptionkeyinaccessible",r.INVALID_FRAGMENT="http://ns.adobe.com/adobecloud/problem/invalidfragment",r.LIMIT_CHILDREN_COUNT="http://ns.adobe.com/adobecloud/problem/limit/childrencount",r.LIMIT_COMPONENT_COUNT="http://ns.adobe.com/adobecloud/problem/limit/componentcount",r.LIMIT_EMBED_SELECTOR_COUNT="http://ns.adobe.com/adobecloud/problem/limit/embedspecifierselectorcount",r.LIMIT_MILESTONE_COUNT="http://ns.adobe.com/adobecloud/problem/limit/milestonecount",r.LIMIT_MILESTONE_LABEL_LENGTH="http://ns.adobe.com/adobecloud/problem/limit/milestonelabellength",r.LIMIT_NAME_LENGTH="http://ns.adobe.com/adobecloud/problem/limit/namelength",r.LIMIT_OPERATION_COUNT="http://ns.adobe.com/adobecloud/problem/limit/operationcount",r.LIMIT_PATH_SEGMENT_COUNT="http://ns.adobe.com/adobecloud/problem/limit/pathsegmentcount",r.LIMIT_RESOURCE_COUNT="http://ns.adobe.com/adobecloud/problem/limit/resourcecount",r.LIMIT_RESOURCE_SIZE="http://ns.adobe.com/adobecloud/problem/limit/resourcesize",r.OPERATION_FAILED="http://ns.adobe.com/adobecloud/problem/operationfailed",r.OPERATION_TARGET_CONFLICT="http://ns.adobe.com/adobecloud/problem/operation/targetconflict",r.QUOTA_EXCEEDED="http://ns.adobe.com/adobecloud/problem/quotaexceeded",r.REPOSITORY_NOT_FOUND="http://ns.adobe.com/adobecloud/problem/repositorynotfound",r.RESOURCE_BLOCKED="http://ns.adobe.com/adobecloud/problem/resourceblocked",r.RESOURCE_NOT_ALLOWED="http://ns.adobe.com/adobecloud/problem/resourcenotallowed",r.RESOURCE_NOT_FOUND="http://ns.adobe.com/adobecloud/problem/resourcenotfound",r.RESOURCE_NOT_READY="http://ns.adobe.com/adobecloud/problem/resourcenotready",r.RESPONSE_TOO_LARGE="http://ns.adobe.com/adobecloud/problem/responsetoolarge",r.USER_BLOCKED="http://ns.adobe.com/adobecloud/problem/userblocked",r.VERSION_NOT_FOUND="http://ns.adobe.com/adobecloud/problem/versionnotfound";const s={INVALID_JSON:"INVALID_JSON",READ_ONLY:"READ_ONLY",INVALID_PARAMS:"",INVALID_LINKS:"INVALID_LINKS",PRECONDITION_FAILED:"PRECONDITION_FAILED",INVALID_DATA:"INVALID_DATA",DUPLICATE_VALUE:"DUPLICATE_VALUE",NO_BASE_BRANCH_DATA:"NO_BASE_BRANCH_DATA",INVALID_STATE:"INVALID_STATE",DELETED_COMPOSITE:"DELETED_COMPOSITE",INCOMPLETE_COMPOSITE:"INCOMPLETE_COMPOSITE",UNEXPECTED_RESPONSE:"UNEXPECTED_RESPONSE",NETWORK_ERROR:"NETWORK_ERROR",COMPONENT_DOWNLOAD_ERROR:"COMPONENT_DOWNLOAD_ERROR",COMPONENT_UPLOAD_ERROR:"COMPONENT_UPLOAD_ERROR",COMPONENT_MODIFIED_ERROR:"COMPONENT_MODIFIED_ERROR",UPDATE_CONFLICT:"UPDATE_CONFLICT",NO_COMPOSITE:"NO_COMPOSITE",ALREADY_EXISTS:"ALREADY_EXISTS",SERVICE_IS_INACTIVE:"SERVICE_IS_INACTIVE",EXCEEDS_QUOTA:"EXCEEDS_QUOTA",NOT_IMPLEMENTED:"NOT_IMPLEMENTED",RETRYABLE_SERVER_ERROR:"RETRYABLE_SERVER_ERROR",TIMED_OUT:"TIMED_OUT",UNEXPECTED:"UNEXPECTED",TERMINATED_INPUTSTREAM:"TERMINATED_INPUTSTREAM",WRONG_ENDPOINT:"WRONG_ENDPOINT",OUT_OF_SPACE:"ENOSPC",FILE_EXISTS_IN_CLOUD:"FILE_EXISTS_IN_CLOUD",ASSET_NOT_FOUND:"ASSET_NOT_FOUND",COMPOSITE_NOT_FOUND:"COMPOSITE_NOT_FOUND",NOT_FOUND:"NOT_FOUND",UNAUTHORIZED:"UNAUTHORIZED",FORBIDDEN:"FORBIDDEN",ABORTED:"ABORTED",TOO_MANY_REDIRECTS:"TOO_MANY_REDIRECTS",INSECURE_REDIRECT:"INSECURE_REDIRECT"},o={[s.SERVICE_IS_INACTIVE]:!0,[s.ABORTED]:!0,[s.INSECURE_REDIRECT]:!0,[s.TOO_MANY_REDIRECTS]:!0,[s.NOT_IMPLEMENTED]:!0,[s.EXCEEDS_QUOTA]:!0,[s.RETRYABLE_SERVER_ERROR]:!0,[s.TIMED_OUT]:!0,[s.TERMINATED_INPUTSTREAM]:!0,[s.WRONG_ENDPOINT]:!0,[s.OUT_OF_SPACE]:!0,[s.INVALID_PARAMS]:!0,[s.INVALID_STATE]:!0};class n extends Error{constructor(e,t,r,s,o){var i;if(super(),this.code=e,this.underlyingError=r,this.name="AdobeDCXError",this._additionalData={},this._response=s||(null===(i=r)||void 0===i?void 0:i.response),this._additionalData=o,this._message=t,this.message=("string"==typeof e&&""!==e?"["+e+"] ":"")+(this._message||""),Object.setPrototypeOf(this,n.prototype),Error.captureStackTrace)Error.captureStackTrace(this,n);else try{const e=new Error;if(e.name=this.name,e.stack){const t=e.stack.split("\n");t.length>0&&t.splice(1,1),this.stack=t.join("\n")}}catch(e){}}get response(){return this._response}get problemType(){var e;if("application/problem+json"===(null===(e=this._response)||void 0===e?void 0:e.headers["content-type"]))return this._response.response.type}get additionalData(){return this._additionalData}set additionalData(e){this._additionalData=e}get failedComponents(){return this._additionalData.failedComponents}static wrapError(e,r,i,a){var d,c,l,h;if(i&&o[i.code])return i;if(a&&"object"==typeof a){const o=a.statusCode,u=403===o&&("403.1"===(null===(l=null===(c=null===(d=a.response)||void 0===d?void 0:d.message)||void 0===c?void 0:c.match(/code=(\d+.\d+)/))||void 0===l?void 0:l[1])||(null===(h=a.response)||void 0===h?void 0:h.type)===t.ProblemTypes.QUOTA_EXCEEDED);if(o>=500&&o<600||u)501===o?(e=s.NOT_IMPLEMENTED,r="Unimplemented request"):507===o||u?(e=s.EXCEEDS_QUOTA,r="Quota exceeded"):(e=s.RETRYABLE_SERVER_ERROR,r="Server error");else if(i instanceof n&&e===i.code&&i.code===this.UNEXPECTED_RESPONSE)return i}return new n(e,r,i,a)}toString(){return`${this.name}: ${this.message}`}static networkError(e,t,r){return n.wrapError(s.NETWORK_ERROR,e,t,r)}static unexpectedResponse(e,t,r){return n.wrapError(s.UNEXPECTED_RESPONSE,e,t,r)}}n.ABORTED=s.ABORTED,n.INSECURE_REDIRECT=s.INSECURE_REDIRECT,n.TOO_MANY_REDIRECTS=s.TOO_MANY_REDIRECTS,n.INVALID_JSON=s.INVALID_JSON,n.READ_ONLY=s.READ_ONLY,n.INVALID_PARAMS=s.INVALID_PARAMS,n.INVALID_DATA=s.INVALID_DATA,n.DUPLICATE_VALUE=s.DUPLICATE_VALUE,n.NO_BASE_BRANCH_DATA=s.NO_BASE_BRANCH_DATA,n.INVALID_STATE=s.INVALID_STATE,n.DELETED_COMPOSITE=s.DELETED_COMPOSITE,n.INCOMPLETE_COMPOSITE=s.INCOMPLETE_COMPOSITE,n.UNEXPECTED_RESPONSE=s.UNEXPECTED_RESPONSE,n.NETWORK_ERROR=s.NETWORK_ERROR,n.COMPONENT_DOWNLOAD_ERROR=s.COMPONENT_DOWNLOAD_ERROR,n.COMPONENT_UPLOAD_ERROR=s.COMPONENT_UPLOAD_ERROR,n.COMPONENT_MODIFIED_ERROR=s.COMPONENT_MODIFIED_ERROR,n.UPDATE_CONFLICT=s.UPDATE_CONFLICT,n.NO_COMPOSITE=s.NO_COMPOSITE,n.ALREADY_EXISTS=s.ALREADY_EXISTS,n.SERVICE_IS_INACTIVE=s.SERVICE_IS_INACTIVE,n.EXCEEDS_QUOTA=s.EXCEEDS_QUOTA,n.NOT_IMPLEMENTED=s.NOT_IMPLEMENTED,n.RETRYABLE_SERVER_ERROR=s.RETRYABLE_SERVER_ERROR,n.TIMED_OUT=s.TIMED_OUT,n.UNEXPECTED=s.UNEXPECTED,n.TERMINATED_INPUTSTREAM=s.TERMINATED_INPUTSTREAM,n.WRONG_ENDPOINT=s.WRONG_ENDPOINT,n.OUT_OF_SPACE=s.OUT_OF_SPACE,n.FILE_EXISTS_IN_CLOUD=s.FILE_EXISTS_IN_CLOUD,n.ASSET_NOT_FOUND=s.ASSET_NOT_FOUND,n.COMPOSITE_NOT_FOUND=s.COMPOSITE_NOT_FOUND,n.NOT_FOUND=s.NOT_FOUND,n.UNAUTHORIZED=s.UNAUTHORIZED,n.FORBIDDEN=s.FORBIDDEN,n.PRECONDITION_FAILED=s.PRECONDITION_FAILED;const i=new Map([[400,{code:s.UNEXPECTED_RESPONSE,message:"Bad request"}],[401,{code:s.UNAUTHORIZED,message:"Unauthorized"}],[403,{code:s.FORBIDDEN,message:"Forbidden"}],[404,{code:s.NOT_FOUND,message:"Not found"}],[409,{code:s.ALREADY_EXISTS,message:"Already exists"}],[412,{code:s.PRECONDITION_FAILED,message:"Precondition failed"}],[501,{code:s.NOT_IMPLEMENTED,message:"Not implemented"}],[507,{code:s.EXCEEDS_QUOTA,message:"Exceeds quota"}]]),a=new Map([[t.ProblemTypes.COMPOSITE_INTEGRITY,{code:s.INCOMPLETE_COMPOSITE,message:"Incomplete composite. invoke missingComponentsFromError with this error for more information."}]]),d=e=>{var t,r;const s=a.get(null!==(r=null===(t=e.response)||void 0===t?void 0:t.type)&&void 0!==r?r:"")||i.get(e.statusCode);return s?new n(s.code,s.message,void 0,e,e.response):void 0},c=(e,t)=>e&&t?e<300&&e>199||d(t)||!1:new n(s.NETWORK_ERROR,"Invalid or missing status code or response",void 0,t);t.AdobeDCXError=n,t.DCXError=n,t.ErrorCodes=s,t.HTTP_STATUS_ERROR_MAP=i,t._defaultStatusValidator=c,t._handleErrorResponsePayload=function(e){const t=Array.isArray(e.response)?e.response.reduce(((e,t)=>e||t.error),void 0):e.response.error;if(!t)return e;const r=c(t.status,e);if(r instanceof n)throw r;throw new n(t.type||n.UNEXPECTED_RESPONSE,t.title||"Unexpected Error",t,e)},t._responseToError=d,t.default=n,t.isAdobeDCXError=function(e){return!(!e||"object"!=typeof e)&&"AdobeDCXError"===e.name},t.networkError=function(e,t,r){return n.networkError(e,t,r)},t.unexpectedResponse=function(e,t,r){return n.unexpectedResponse(e,t,r)}},882594:(e,t,r)=>{var s=r(501933).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(6035),n=r(464964),i=r(528224),a=r(29578);var d=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(i);function c(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}const l=n.newDebug("dcx:http:auth");class h{constructor(e,t,r){this._authToken=e,this._apiKey=t,this._pendingAuth=!1,this._hasBaseRefreshCb=!1,this._authListeners=[],this._persistentListeners=[],this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._authTokenScheme="Bearer",a.validateParams(["authToken",e,"string",!0],["apiKey",t,"string",!0],["refreshCb",r,"function",!0]),r&&(this._hasBaseRefreshCb=!0,this.onChange(((e,t)=>{"unauthenticated"===e&&r.call(null,t)}),!0)),e&&t||(l("init unauthenticated"),this._pendingAuth=!0,setTimeout((()=>{l("after tick",this._pendingAuth),this._pendingAuth&&this.refreshAuth()})))}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}get isNoAuthMode(){return!this._hasBaseRefreshCb}set isNoAuthMode(e){this._hasBaseRefreshCb=!e}get apiKey(){return this._apiKey}get authToken(){return this._authToken}get authTokenScheme(){return this._authTokenScheme}set authTokenScheme(e){this._authTokenScheme=e}setAuthToken(e){l("setAuthToken"),this._authToken=e,this._pendingAuth=!1,this._authChanged("updated")}setApiKey(e){this._apiKey=e}resume(){l("resume()"),this._pendingAuth=!1,this._authChanged("updated")}get pendingAuth(){return this._pendingAuth}onChange(e,t=!1){l("onChange, persistent:",t);const r=this._authListeners.push(e)-1;return t&&this._persistentListeners.push(r),()=>{try{t&&(this._persistentListeners=this._persistentListeners.filter((e=>e!==r))),delete this._authListeners[r]}catch(e){}}}clearListeners(e=!1){if(l("clearListeners, persistent:",e),!0===e)return this._authListeners=[],void(this._persistentListeners=[]);this._authListeners=this._authListeners.map(((e,t)=>{if(this._persistentListeners.includes(t))return e}))}get refreshPromise(){return this._refreshPromise}_authChanged(e){return c(this,void 0,void 0,(function*(){l("authChanged",e),this._pendingAuth="unauthenticated"===e,queueMicrotask((()=>c(this,void 0,void 0,(function*(){const t=[];this._authListeners.map((r=>{if("function"==typeof r){const s=r.call(null,e,this);s&&"object"==typeof s&&s.then&&t.push(s)}})),yield Promise.all(t),"updated"===e&&this._resolveRefresh()}))))}))}_resolveRefresh(){l("_resolveRefresh"),this._refreshResolve&&this._refreshResolve(this.getAuthData()),this._refreshResolve=void 0,this._refreshPromise=void 0}refreshAuth(){return l("refreshAuth"),this._refreshPromise||(this._refreshPromise=new Promise((e=>{this._refreshResolve=e})),this._authChanged("unauthenticated")),this._refreshPromise}getAuthData(){return{authToken:this._authToken,apiKey:this._apiKey}}getAuth(){return c(this,void 0,void 0,(function*(){return Promise.resolve(this.getAuthData())}))}isAuthorizedURL(e){const t=a.getDomainFromURL(e);return this._authenticationAllowList.includes(t)}logout(){l("logout"),this._apiKey=void 0,this._authToken=void 0,!1===this._pendingAuth&&(this._pendingAuth=!0,this._authChanged("unauthenticated"))}applyAuthHeaders(e,t){const r={"x-api-key":void 0,authorization:void 0};return this.isAuthorizedURL(e)&&(null!==t["x-api-key"]&&this.apiKey&&(r["x-api-key"]=this.apiKey),null!==t.authorization&&this.authToken&&(r.authorization=(this.authTokenScheme?`${this.authTokenScheme} `:"")+this.authToken)),a.pruneUndefined(Object.assign(Object.assign({},t),r))}}const u=n.newDebug("dcx:http:xhr");let p;if(p="undefined"!=typeof window?window.XMLHttpRequest:XMLHttpRequest,null==p)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_STATE,"XMLHttpRequest module not found.");const f={NO_ERROR:"",ABORTED:o.ErrorCodes.ABORTED,NETWORK:o.ErrorCodes.NETWORK_ERROR,TIMEOUT:o.ErrorCodes.TIMED_OUT,TOO_MANY_REDIRECTS:o.ErrorCodes.TOO_MANY_REDIRECTS,INSECURE_REDIRECT:o.ErrorCodes.INSECURE_REDIRECT};class _{constructor(e={}){this._autoParseJson=!1,this._bytesReported=0,this._errorCode=f.NO_ERROR,this._isFetchRequest=!1,this._fetchAbort=()=>{},this._preferFetch=!1,this._sent=!1,this.headers={},this.responseType="text",this._progressListeners=[];const{forceXhr:t,preCallback:s,postCallback:n,timeout:i,preferFetch:a}=e;this._preCallback=s,this._postCallback=n,this._timeout=null==i?12e4:i,this._xhr=t?new t:new p,this._preferFetch=!0===a,this._fetch=e.fetch?e.fetch:"undefined"!=typeof window&&"fetch"in window?fetch.bind(window):"undefined"!=typeof self&&"fetch"in self?fetch.bind(self):void 0!==r.g&&"fetch"in r.g?fetch.bind(r.g):void 0,this._parseFetchResponse=this._parseFetchResponse.bind(this),this._autoParseJson=null==e.autoParseJson||e.autoParseJson,e.additionalNodeOptions&&this._xhr.setNodeOptions&&this._xhr.setNodeOptions(e.additionalNodeOptions),this._promise=new Promise((e=>{this._resolve=e,this._xhr.addEventListener("abort",(()=>{u("aborted",this._errorCode,this._timeout),this._errorCode=this._errorCode||f.ABORTED,this._finalize()})),this._xhr.addEventListener("progress",(e=>{u(`progress ${e.loaded}/${e.total}`),this._bytesReported+=e.loaded,e.lengthComputable?(this._estimatedTotalBytes=e.total,this._notifyProgressListeners(this._bytesReported,this._estimatedTotalBytes,!1)):this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._bytesReported,this._estimatedTotalBytes||e.total,!0)})),this._xhr.addEventListener("error",(e=>{switch(u("err",this._errorCode,e,this._xhr.status,this._timeout),this._underlyingError=e,e?e.code:void 0){case"ERR_FR_TOO_MANY_REDIRECTS":this._errorCode=f.TOO_MANY_REDIRECTS;break;case o.AdobeDCXError.INSECURE_REDIRECT:this._errorCode=f.INSECURE_REDIRECT;break;case f.TIMEOUT:break;default:this._errorCode=f.NETWORK}this._finalize()})),this._xhr.addEventListener("load",(()=>{u("load"),this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._estimatedTotalBytes,this._estimatedTotalBytes,!1),this._finalize()})),this._xhr.addEventListener("timeout",(()=>{u("timeout",this._timeout),this._errorCode=f.TIMEOUT,this._finalize()}))}))}get xhr(){return this._xhr}_parseFetchResponse(e){return c(this,void 0,void 0,(function*(){if(204===e.status)return e;if(parseInt(e.headers.get("content-length")||"0")>0)switch(this.responseType){case"json":a.isJsonContentType(e.headers.get("content-type")||"")&&(this._fetchBodyAsResponseType=yield e.json());break;case"arraybuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer();break;case"blob":this._fetchBodyAsResponseType=yield e.blob();break;case"text":this._fetchBodyAsResponseType=yield e.text();break;case"void":break;case"buffer":case"defaultbuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer().then((e=>new Uint8Array(e)))}return"stream"===this.responseType&&(this._fetchBodyAsResponseType=e.body),e}))}_shouldAutoParseResponse(){const e=this._errorCode===f.NO_ERROR&&this._sent&&!this._isFetchRequest&&"text"===this._xhr.responseType&&this._autoParseJson&&"string"==typeof this._xhr.response&&this._xhr.response.length<102400&&a.isJsonContentType(this.getResponseHeader("content-type"));return u("_shouldAutoParseResponse()",e),e}_fetchWithTimeout(e,t={}){if("function"!=typeof this._fetch)throw new o.DCXError(o.DCXError.UNEXPECTED,"fetch method not found but was invoked");const{timeout:r}=t,s=function(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}(t,["timeout"]);if(this._isFetchRequest=!0,"function"!=typeof AbortController||void 0===r)return this._fetch(e,s).then(this._parseFetchResponse);const n=new AbortController;return this._fetchAbort=()=>{this._errorCode=this._errorCode||f.ABORTED,n.abort(),this._finalize()},this._timeoutTimeout=setTimeout((()=>{this._errorCode=f.TIMEOUT,n.abort(),this._finalize()}),r),this._fetch(e,Object.assign({signal:n.signal},s)).then(this._parseFetchResponse).finally((()=>{clearTimeout(this._timeoutTimeout)}))}_finalize(){if(u("_finalize",this._xhr.status,this._errorCode),this._shouldAutoParseResponse())try{const e=JSON.parse(this._xhr.response);this._autoParsedResponse=e,this._xhr.responseType="json"}catch(e){}this._postCallback&&this._postCallback(this),this._timeoutTimeout&&clearTimeout(this._timeoutTimeout),this._progressListeners=[],this._resolve(this)}_validateResponseType(e){if("buffer"===e){if("function"!=typeof s)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===e){if("function"!=typeof Blob)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Blob class")}else if("text"!==e&&"json"!==e&&"arraybuffer"!==e&&"stream"!==e)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Unsupported response type");return e.toLowerCase()}send(e,t,r,s={},n="text",i={}){if(u("send"),this._sent)throw new Error("Xhr already sent");this.href=e,this.method=t.toUpperCase(),this.body=r,this.body?this._estimatedTotalBytes=this.body.byteLength||this.body.length||this.body.size:this._estimatedTotalBytes=Number.MAX_SAFE_INTEGER,this._timeout=i.timeout||this._timeout||0,u("setting timeout",this._timeout),this._xhr.timeout=this._timeout,n&&(n=this._validateResponseType(n),u("responseType: ",n),this.responseType="buffer"===n?"arraybuffer":"stream"===n?"stream":"void"===n?"text":n);const d=a.normalizeHeaders(s);if(this.headers=d,this.href.startsWith("http:")&&null!==this.headers.authorization)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Must not send auth token over unsecured connection");if(this._preCallback&&this._preCallback(this),(this._preferFetch||"stream"===n)&&"function"==typeof this._fetch)return this._xhr.responseType=this.responseType,this._promise=new Promise((e=>{this._resolve=e,this._fetchWithTimeout(this.href,{body:["GET","HEAD"].includes(this.method.toUpperCase())?void 0:r,credentials:i.withCredentials?"include":void 0,headers:d,method:this.method,timeout:this._timeout}).then((e=>{this._fetchResponse=e,this._finalize()})),this._sent=!0})),this._promise;this._xhr.open(this.method,this.href,!0),this._xhr.responseType=this.responseType;for(const[e,t]of Object.entries(d))this._xhr.setRequestHeader(e,t);if(null!=i.withCredentials&&(this._xhr.withCredentials=i.withCredentials),null!=r?this._xhr.send(r):this._xhr.send(),this._sent=!0,this._timeout){u("set timeout",this._timeout);const e=setTimeout((()=>{u("timed out"),this._errorCode=f.TIMEOUT,this._xhr.abort()}),this._timeout);this._promise.finally((()=>{clearTimeout(e)}))}return this._promise}abort(){if(u("abort()"),!this._sent)throw new Error("Cannot abort before sending.");this._isFetchRequest?this._fetchAbort():this._xhr.abort()}getResponseHeader(e){if(!this._sent)throw new Error("Cannot getResponseHeader before sending.");const t=e.toLowerCase(),r=this.getAllResponseHeaders();if(t in r)return r[t]}getAllResponseHeaders(){var e,t;if(!this._sent)throw new Error("Cannot getAllResponseHeaders before sending.");if(this._parsedResponseHeaders)return this._parsedResponseHeaders;const r=this._isFetchRequest?a.objectFromEntries(null!==(t=null===(e=this._fetchResponse)||void 0===e?void 0:e.headers.entries())&&void 0!==t?t:[]):this._xhr.getAllResponseHeaders();return this._parsedResponseHeaders="string"==typeof r?a.parseHeaders(r):a.normalizeHeaders(r),this._parsedResponseHeaders}isError(){if(!this._sent)throw new Error("Cannot check isError before sending.");return this._errorCode!==f.NO_ERROR}isAborted(){if(!this._sent)throw new Error("Cannot check isAborted before sending.");return this._errorCode===f.ABORTED}isTimedOut(){if(!this._sent)throw new Error("Cannot check isTimedOut before sending.");return this._errorCode===f.TIMEOUT}isSent(){return this._sent}getErrorCode(){return this._errorCode}getStatus(){if(!this._sent)throw new Error("Cannot getStatus before sending.");return this._fetchResponse?this._fetchResponse.status:this._xhr.status}getResponse(){var e;if(!this._sent)throw new Error("Cannot getResponse before sending.");return this._response||(this._response={statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._isFetchRequest?(null===(e=this._fetchResponse)||void 0===e?void 0:e.statusText)||"":this._xhr.statusText,xhr:this},this._autoParsedResponse&&(this._response.originalResponseData=this._xhr.response)),this._response}toJSON(){const e={statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._xhr.statusText};return JSON.parse(JSON.stringify(e))}getResponseDataAsJSON(){return c(this,void 0,void 0,(function*(){if(this._fetchResponse)return yield this._fetchResponse.json();if("json"===this._xhr.responseType)return this._autoParsedResponse||this._xhr.response;if(this._autoParsedResponse)return this._autoParsedResponse;let e=this._xhr.response;if("text"===this._xhr.responseType&&null!=this._xhr.responseText)e=this._xhr.responseText;else if("arraybuffer"===this._xhr.responseType)e=a.arrayBufferToString(this._xhr.response);else if("blob"===this._xhr.responseType&&(e instanceof Blob||a.isFunction(e.text)))try{return JSON.parse(yield e.text())}catch(t){e=this._xhr.responseText}else"stream"===this.responseType?yield new Promise(((t,r)=>{if(e="","function"==typeof this.xhr.response.on)return this.xhr.response.on("data",(t=>{e+=t})),this.xhr.response.on("end",t),void this.xhr.response.on("error",r);if("string"==typeof this.xhr.response)return t(e=this.xhr.response);throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type")})):e=this._xhr.responseText?this._xhr.responseText:e;if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}return e}))}getResponseData(){if(!this._sent)throw new Error("Cannot getResponseData before sending.");return this._isFetchRequest&&this._fetchBodyAsResponseType?this._fetchBodyAsResponseType:this._autoParsedResponse||this._xhr.response}onProgress(e){const t=this._progressListeners.push(e)-1;return()=>{try{delete this._progressListeners[t]}catch(e){}}}_notifyProgressListeners(e,t,r){this._progressListeners.map((s=>s&&s.call&&s.call(null,e,t,r)))}}const m=n.newDebug("dcx:http:backoff");function E(e,t,r,s={},o,i={},d=!1){const{disableRetry:l=!1,responseType:h="text",authCallback:u=null,progressListeners:p=[],initialWait:E=2e3,maxWait:g=32e3,preCallback:A,postCallback:C,preScheduleCallback:D,postScheduleCallback:I,preferRetryAfterHeader:y=!0,pollCodes:v=[],pollHeader:T,pollMethod:b="get"}=i;let{retryCodes:P=[],timeoutAfter:R=72e3}=i;P=d?[...v,...P]:l||a.isReadableStream(r)||a.isStreamProvider(r)?[]:i.retryCodes||a.DEFAULT_RETRY_CODES,m("retry codes",P);const w=i.increase||((e,t,r)=>1===e?r:t*t>g?g:t*t);let O=0,N=0,S=!1;const L=a.now();let k,M,X,x=a.now(),U=0,B=!1,j=!1;const V=[];let H;function F(){m("getSnapshot()",S,O,a.now(),x,U);const e=S||null!=k?0:O-(a.now()-x);let t=U;t+=S?a.now()-x:0;const r=(k||a.now())-L;return{count:N,canceled:B,timedOut:j,requests:V,duration:r,totalWaited:t,requestPending:S,waitingFor:e}}function Y(){const e=w(N,O,E);return Math.min(e,g)}function W(e){if(e)return t=>e(t,F())}function q(e){const t=e.getResponseHeader("retry-after");if(y&&t){if(isNaN(t)){const e=Date.parse(t)-Date.now();return m("nextWait from retry-after",e),e<0?Y():e}return 1e3*parseInt(e.getResponseHeader("retry-after"))}}function z(l=O){return c(this,void 0,void 0,(function*(){if(U>=R)return m("timed out",U,R),j=!0,M(X);x=a.now(),D&&(yield D(F())),m("retry in ",l),H=setTimeout((()=>{m("retry start"),n.log(`${t.toUpperCase()} ${e}`),S=!0,U+=l,X=new _(Object.assign(Object.assign({},i),{timeout:o,preCallback:W(A),postCallback:W(C)})),V.push(X),N++;for(const e of p)X.onProgress(e);X.send(e,t,r,s,h).then((r=>c(this,void 0,void 0,(function*(){if(S=!1,!(r.isError()||a.checkRetriable(r.getStatus(),P)||401===r.getStatus()&&null!=u||"string"==typeof T&&null!=v&&a.checkRetriable(r.getStatus(),v)))return k=a.now(),M(r);if(r.isAborted()||B)return k=a.now(),B=!0,M(r);if(!d&&"string"==typeof T&&null!=v&&a.checkRetriable(r.getStatus(),v)){const s=r.getResponseHeader(T.toLowerCase());if(s){d=!0,e=s,t=b,P=[...P,...v],U=0,R*=3;const o=r.getResponseHeader("retry-after");if(y&&o){const e=q(r);if(null!=e)return O=e,z(O)}return z(0)}}if(401===r.getStatus()){if(u){try{s=yield u(e,s)}catch(e){return M(r)}return U+=a.now()-x,z(0)}return k=a.now(),M(r)}if(a.checkRetriable(r.getStatus(),P)){const e=r.getResponseHeader("retry-after");if(y&&e){const e=q(r);if(null!=e)return O=e,z(O)}return O=Y(),z(O)}return k=a.now(),M(r)}))))}),l),I&&(yield I(F()))}))}const G=new Promise((e=>{M=e,z(0)}));return{getPromise:()=>G,cancel:function(){m("cancel()"),B=!0,null!=X&&X.abort(),S||(m("abort"),clearTimeout(H),M({getErrorCode:()=>f.ABORTED}))},onProgress:function(e){if(!p.includes(e))return p.push(e),null!=X?X.onProgress&&X.onProgress(e):void 0},getSnapshot:F}}class g{constructor(e,t,r,s,o="text",n,i,a={}){const{descriptor:d}=a;delete a.descriptor;const{cancel:c,getPromise:l,onProgress:h,getSnapshot:u}=E(e,t,r,s,a.timeout,Object.assign(Object.assign(Object.assign(Object.assign({},a),{responseType:o,authCallback:i}),a.retryOptions),{descriptor:d,forceXhr:a.forceXhr,autoParseJson:a.autoParseJson}));this.onProgress=h,"function"==typeof n&&h(((e,t)=>n("progress",{total:t,sentOrReceived:e}))),this._cancel=c,this._promise=l(),this._getSnapshot=u}getSnapshot(){return this._getSnapshot()}getPromise(){return this._promise}cancel(e){this._cancel(e)}}const A=n.newDebug("dcx:http:req");class C{constructor(e){var t;if(this._pausable=!1,this._listeners={progress:[],cancel:[]},this._isStatusValid=e.isStatusValid||(()=>!0),this._isExternalRequest=e.isExternalRequest,this._authProvider=e.authProvider,this._id=e.id,this._descriptor=e.descriptor,e.descriptor&&e.descriptor.progress){const t=e.descriptor.progress;this.on("progress",(({sentOrReceived:e,total:r})=>{t.call(void 0,e,r)}))}const r=this._authProvider.applyAuthHeaders(e.url,a.normalizeHeaders(e.headers||{}));this._isExternalRequest&&C._internalOnlyHeaders.forEach((e=>delete r[e])),this._networkRequest=new g(e.url,e.method,e.body,r,e.responseType,(null===(t=e.descriptor)||void 0===t?void 0:t.progress)?this._emit.bind(this):void 0,this._getAuthCb(),e),this._promise=this._networkRequest.getPromise().then((t=>{const r=t.getErrorCode(),s=r||this._isStatusValid(t.getStatus(),t.getResponse());if(r||!0!==s){if(r===f.ABORTED)throw new o.DCXError(o.DCXError.ABORTED,"Aborted");if(r===f.NETWORK)throw new o.DCXError(o.DCXError.NETWORK_ERROR,"Network error",void 0,t.getResponse());if(s instanceof o.DCXError||s instanceof Error)throw new o.DCXError(s.code||o.DCXError.UNEXPECTED_RESPONSE,s._message||s.message,s.underlyingError,t.getResponse());throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,t.getResponse())}const n=this._networkRequest.getSnapshot().requests;return A("resolve",e.id),Object.assign(Object.assign({},t.getResponse()),{xhr:n[n.length-1]})})).catch((t=>{throw A("reject",e.id),t}))}get id(){return this._id}get descriptor(){return this._descriptor}_getAuthCb(){if(!this._authProvider.isNoAuthMode)return this._authCb.bind(this)}_authCb(e,t){return A("_authCb()"),this._authProvider.isAuthorizedURL(e)?this._authProvider.refreshAuth().then((()=>this._authProvider.applyAuthHeaders(e,t))):Promise.reject(new o.DCXError(o.DCXError.UNAUTHORIZED,"URL is not part of authenticationAllowList.",void 0,void 0,{url:e}))}_emit(e,t){this._listeners[e].map((e=>e.call(null,t)))}getPromise(){return this._promise}cancel(e){return this._networkRequest.cancel(e)}on(e,t){var r;"progress"===e&&0===this._listeners[e].length&&(null===(r=this._networkRequest)||void 0===r||r.onProgress(((t,r)=>this._emit(e,{total:r,sentOrReceived:t})))),this._listeners[e].push(t)}}C._internalOnlyHeaders=["x-request-id","x-api-key","authorization"];const D=n.newDebug("dcx:http:map");class I{constructor(){this._map=new Map}addRequest(e,t){return D("addRequest()",e),this._map.set(e,t),t.getPromise().then((t=>{D("then",e),this._map.delete(e)})).catch((t=>{D("catch",e,t),this._map.delete(e)})),e}get(e){return this._map.get(e)}get length(){return this._map.size}has(e){return this._map.has(e)}removeById(e){const t=this._map.get(e);t&&this.remove(t)}remove(e,t){return e&&e.cancel&&e.cancel(t)}clear(e){this._map.forEach((t=>{this.remove(t,e)})),this._map.clear()}removeAllWithToken(e){this._map.forEach((t=>{t.descriptor.token===e&&this.remove(t)}))}}const y=n.newDebug("dcx:http:q"),v=e=>"head"===e.method.toLowerCase();class T{constructor(){this._queue=[],this._later={},this._headEndPtr=0,this._isPriority=v,this._usePriority=!1}push(e,t,r){return c(this,void 0,void 0,(function*(){let s;const o=new Promise((e=>{s=e}));if("number"!=typeof t||t<=0){const t={descriptor:e,notifySent:e=>s(e),notifyCanceled:this._notifyCanceled(s)};return this._push(t),o}const{id:n}=e,i=setTimeout((()=>{this._ready(n)}),t),a=e=>s(e);return this._later[n]={readyTimeout:i,wait:t,descriptor:e,notifySent:a,notifyCanceled:this._notifyCanceled(s),notifyReady:()=>{r&&r.call(null,{wait:t,descriptor:e,notifySent:a})}},o}))}_notifyCanceled(e){return t=>{if(!t)return e({canceled:!0});e({canceled:!0,error:t})}}_push(e){this._usePriority&&this._isPriority(e.descriptor)?this._queue.splice(this._headEndPtr++,0,e):this._queue.push(e)}remove(e){if(e.id in this._later)return y("remove from later",e.id),this._remove(e.id);const t=this._indexOf(e);return y("remove from q",t),t>=0?this._remove(t):void 0}_remove(e,t){if(y("_remove",e),"string"==typeof e){const r=this._later[e];return r.notifyCanceled.call(null,t),r.readyTimeout&&clearTimeout(r.readyTimeout),void delete this._later[e]}this._queue[e].notifyCanceled.call(null,t),this._queue.splice(e,1),e<this._headEndPtr&&this._headEndPtr--}_indexOf(e){const t=!!e.method,r=t&&this._usePriority&&this._isPriority(e),s=r?this._headEndPtr:this._queue.length,o=r||!t?0:this._headEndPtr;for(let t=o;t<o+s;t++)if(e.id===this._queue[t].descriptor.id)return t;return-1}exists(e){return e.id in this._later||this._indexOf(e)>=0}_ready(e){const t=this._later[e],r=t.notifyReady;delete this._later[e],delete t.notifyReady,delete t.readyTimeout,delete t.wait,this._push(t),"function"==typeof r&&r.call(null)}pop(){const e=this._queue.shift();return this._headEndPtr>0&&this._headEndPtr--,e}get length(){return y("length: ",this._queue.length,Object.keys(this._later).length),this._queue.length+Object.keys(this._later).length}clear(e){for(let t=this._queue.length-1;t>=0;t--)this._remove(t,e);this._queue=[];const t=Object.keys(this._later);for(const r in t){const s=t[r];this._remove(s,e)}this._later={}}removeAllWithToken(e){for(let t=this._queue.length-1;t>=0;t--)this._queue[t].descriptor.token===e&&this._remove(t);const t=Object.keys(this._later);for(const r in t){const s=t[r];this._later[s].descriptor.token===e&&this._remove(s)}}}const b=n.newDebug("dcx:http:service");class P{constructor(e,t={}){this.name="AdobeHTTPService",this._requestQueue=new T,this._requestsOutstanding=new I,this._authProvider=void 0,this._isActive=!0,this._preferFetch=!1,this._handlesRedirects=!0,this._withCredentials=!1,this._additionalNodeOptions={},this._retryOptions={},this.featureFlags={useLinksAPI:!1},e instanceof h||a.isObject(e)&&a.isFunction(e.onChange)?this._authProvider=e:a.isFunction(e)&&(t.useAuthProvider?(this._authProvider=new h(void 0,void 0,e),this._waitingForAuthentication=!0):(this._authProvider=new h(void 0,void 0,(()=>e.call(null,this))),this._waitingForAuthentication=!0)),this._authProvider?this._authProvider.onChange(this._onAuthChange.bind(this)):(this._authProvider=new h,this._authProvider.resume()),this._maxOutstanding=t.maxOutstanding||5,this._withCredentials=t.crossOriginCredentials||!1,this._timeout=null==t.timeout?12e4:t.timeout,this._preferFetch=!0===t.preferFetch,this.featureFlags.useLinksAPI=!0===t.useLinksAPI,t.server&&(this.server=t.server)}get isActive(){return this._isActive}set isActive(e){this._isActive!==e&&(this._isActive=e,e||this._authProvider.logout(),this._checkQueue())}get crossOriginCredentials(){return this._withCredentials}set crossOriginCredentials(e){this._withCredentials=e}get maxOutstanding(){return this._maxOutstanding}set maxOutstanding(e){this._maxOutstanding=e,this._checkQueue()}get handlesRedirects(){return this._handlesRedirects}get server(){return this._server}set server(e){this._server=e&&e.endsWith("/")?e.substr(0,e.length-1):e}_forceXhr(e,t=!1){this._forcedXhr=e,this._handlesRedirects=!t}_useFetchApi(e){this._fetch=e}setAdditionalHeaders(e){this._additionalHeaders=e||{}}setValidateStatus(e){this._isStatusValid=e}setAdditionalNodeOptions(e){this._additionalNodeOptions=e,a.isNode()&&e&&0===e.maxRedirects&&(this._handlesRedirects=!1)}setRetryOptions(e){this._retryOptions=e}set authenticationAllowList(e){this._authProvider.authenticationAllowList=e}get authenticationAllowList(){return this._authProvider.authenticationAllowList}get authProvider(){return this._authProvider}setApiKey(e){this._authProvider.setApiKey(e)}setTimeout(e){this._timeout=e}setAuthToken(e){e?this._authProvider.setAuthToken(e):this._authProvider.logout()}_onAuthChange(e,t){b("_oAC",e);const r=this._waitingForAuthentication;"unauthenticated"===e?this._waitingForAuthentication=!0:(this._waitingForAuthentication=!1,!1!==r&&this._checkQueue())}resume(){this._waitingForAuthentication=!1,this._authProvider.resume(),this._checkQueue()}setRequestHooks(e,t){this._beforeHook=e,this._afterHook=t}invoke(e="GET",t,r={},n,i={},c){b("invoke",e,t,i);let l=(i=i||{}).autoParseJson||!1,h=i.responseType;if(null!=h&&"void"!==h||(l=null==i.autoParseJson||i.autoParseJson,h=i.responseType="text"),"defaultbuffer"===h&&(h=a.isNode()?i.responseType="buffer":i.responseType="arraybuffer"),"buffer"===h){if("function"!=typeof s)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===h){if("function"!=typeof Blob)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Blob class")}else if(h&&"text"!==h&&"json"!==h&&"arraybuffer"!==h&&"stream"!==h)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Unsupported response type: "+h);!a.endPointOf(t)&&this.server&&(t=`${this.server}/${t.startsWith("/")?t.substr(1,t.length):t}`),b("invoke href",t);const u=a.merge({},r,this._additionalHeaders);b("invoke headers",r),i.additionalNodeOptions=Object.assign({},this._additionalNodeOptions||{},i.additionalNodeOptions||{}),i.isStatusValid=i.isStatusValid||this._isStatusValid,i.retryOptions=Object.assign({},this._retryOptions||{},i.retryOptions||{});let p={method:e,href:t,headers:u,token:void 0,body:n,options:i,progress:void 0,autoParseJson:l},f=i.reuseRequestDesc;f&&f instanceof d.default&&"props"in f&&(f=f.props),f&&((this._requestQueue.exists(f)||f.id&&null!=this._requestsOutstanding.get(f.id))&&b("requestDesc still in use"),p=a.merge(f,p)),p.id=p.id||a.generateUuid(),c&&("maxRedirects"in i.additionalNodeOptions&&(i.additionalNodeOptions.maxRedirects=0),i.retryOptions&&0!==Object.keys(i.retryOptions).length||(i.retryOptions={disableRetry:!0}));const _=this._getRequestPromise(p);return _.getPromise().then(this._checkQueue.bind(this)).catch(this._checkQueue.bind(this)),a.isFunction(c)&&(b("invoke - cb"),_.then((e=>{b("invoke - cb - resolve ",e.statusCode);try{c(void 0,e,e.response)}catch(e){console.error("[dcx:http] error in success callback",e,e.stack)}})).catch((e=>{b("invoke - cb - reject: ",e);try{c(e,e.response)}catch(e){console.error("[dcx:http] error in failure callback",e,e.stack)}}))),this._checkQueue(),_}_makeRequest(e){b("_makeRequest(): ",e.id);const t=e.options||{},r=(e=>new C(e))(a.pruneUndefined(Object.assign(Object.assign({url:e.href,autoParseJson:e.autoParseJson,descriptor:e},e),{timeout:t.timeout||this._timeout,authProvider:this._authProvider,forceXhr:this._forcedXhr,fetch:this._fetch,responseType:t.responseType,preCallback:this._beforeHook,postCallback:this._afterHook,isStatusValid:t.isStatusValid,additionalNodeOptions:t.additionalNodeOptions,retryOptions:t.retryOptions,isExternalRequest:t.isExternalRequest,preferFetch:this._preferFetch})));return this._requestsOutstanding.addRequest(e.id,r),e.startTime=(new Date).valueOf(),r}_checkQueue(){queueMicrotask(this._checkQueueLoop.bind(this))}_checkQueueLoop(){if(b("_checkQueueLoop()",this._waitingForAuthentication,this.isActive,this._requestsOutstanding.length,"<?",this.maxOutstanding),!this._isActive){b("_cQL inactive");const e=new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state");this._requestsOutstanding.clear(e),this._requestQueue.clear(e)}let e=!0;for(;e&&!this._waitingForAuthentication&&this._requestsOutstanding.length<this.maxOutstanding&&(e=this._requestQueue.pop(),null!=e);){const t=this._makeRequest(e.descriptor);e.notifySent(t)}b("_cQL done")}_getRequestPromise(e){return b("_getRequestPromise()"),new d.default(((t,r,s)=>{if(!this._isActive)return b("_gRP inactive"),r(new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state"));s((()=>{b("_gRP cancel 1",e.id),this._requestQueue.remove(e)}));let n=e.noSoonerThen||null;return n&&(n-=a.now(),n=n<0?0:n>3e5?3e5:n),delete e.noSoonerThen,this._requestQueue.push(e,n,this._checkQueue.bind(this)).then((n=>(b("_gRP sent",e.id),n.canceled?(b("_gRP reject 1: ",e.id),r(new o.DCXError(o.DCXError.ABORTED,"Request aborted",n.error))):(s((t=>{b("_gRP cancel 2",e.id,t),n.cancel(new o.DCXError(o.DCXError.ABORTED,"Request aborted",t))})),n.getPromise().then((r=>(b("_gRP resolve 1",e.id,r),t(r)))).catch((t=>(b("_gRP reject 2: ",e.id,t),r(t)))))))).catch(r)}),e)}abort(e){e&&e.cancel?e.cancel():this._requestQueue.exists(e)?this._requestQueue.remove(e):this._requestsOutstanding.removeById(e.id)}abortAllWithToken(e){b("abortAllWithToken()"),this._requestsOutstanding.removeAllWithToken(e),this._requestQueue.removeAllWithToken(e)}}const R=P;t.AdobeNetworkHTTPService=R,t.AuthProvider=h,t.HTTPService=P,t.StreamProvider=class{constructor(e,t){this.getStream=e,this.getStreamAsync=t}},t.Xhr=_,t.XhrErrorCodes=f,t.createHTTPService=(e,t)=>new P(e,t||{})},464964:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s,o,n,i,a,d=r(29578);function c(e,r,s="css"){var o,n,i;d.validateParams(["data",r,"object"]),d.validateObject(r,"data",["composite","object"],["response","object"],["error","object",!0]);const{component:a,error:c,composite:h,branch:u,derivationType:p,isBlockTransferred:f}=r,_=(null===(o=r.error)||void 0===o?void 0:o.response)||r.response;let m,E=!1;switch(e){case t.AnalyticsEvent.CreateComposite:E=!0,m=t.AnalyticsEventSubCategory.Create;break;case t.AnalyticsEvent.PushComposite:E=!0,m=t.AnalyticsEventSubCategory.Push;break;case t.AnalyticsEvent.PullComposite:E=!0,m=t.AnalyticsEventSubCategory.MinPull;break;case t.AnalyticsEvent.PullCompositeVersion:E=!0,m=t.AnalyticsEventSubCategory.VersionPull;break;case t.AnalyticsEvent.DownloadComponent:case t.AnalyticsEvent.UploadComponent:d.validateParams(["component",a,"object"]),d.validateObject(a,"data.component",["type","string"]),m=e===t.AnalyticsEvent.DownloadComponent?t.AnalyticsEventSubCategory.Download:t.AnalyticsEventSubCategory.Upload;break;default:m=t.AnalyticsEventSubCategory.Unknown}E&&d.validateParams(["branch",u,"object",!0]);const g={"env.com.name":"dcx-js","env.svc.name":s,"env.com.version":"7.17.0","event.request_id":_.headers["x-request-id"],"event.cloud_id":h.assetId,"custom.content.repository_id":h.repositoryId,"event.type":t.AnalyticsEventType.Success,"event.category":t.AnalyticsEventCategory.CompositeXfer,"event.subcategory":m},A=null===(n=null==c?void 0:c.underlyingError)||void 0===n?void 0:n.code,C=null===(i=null==c?void 0:c.underlyingError)||void 0===i?void 0:i.message;return c&&(g["event.error_code"]=c.code,g["event.error_desc"]=c.message,g["dcx.underlying_error_code"]=A,g["dcx.underlying_error_desc"]=C,g["event.type"]=t.AnalyticsEventType.Error),m===t.AnalyticsEventSubCategory.Unknown?l(g):E?(g["dcx.num_total_components"]=null==u?void 0:u.allComponents().length,g["custom.content.xmp_derivation_type"]=p,c&&(g["dcx.root_error_desc"]=C),l(g)):(g["content.mimetype"]=a.type,c&&(g["dcx.block_transferred"]=null!=f&&f,g["content.type"]=a.type,g["content.size"]=a.length,g["dcx.component_rel"]=a.relationship),l(g))}function l(e){const t={};for(const r in e){const s=e[r];d.isUndefined(s)||Array.isArray(s)||d.isObject(s)||(t[r]=s)}return t}t.AnalyticsEventType=void 0,(s=t.AnalyticsEventType||(t.AnalyticsEventType={}))[s.Success=0]="Success",s[s.Error=1]="Error",t.AnalyticsEventCategory=void 0,(o=t.AnalyticsEventCategory||(t.AnalyticsEventCategory={}))[o.CompositeXfer=0]="CompositeXfer",t.AnalyticsEventSubCategory=void 0,(n=t.AnalyticsEventSubCategory||(t.AnalyticsEventSubCategory={}))[n.Push=0]="Push",n[n.MinPull=1]="MinPull",n[n.VersionPull=2]="VersionPull",n[n.Upload=3]="Upload",n[n.Download=4]="Download",n[n.Create=5]="Create",n[n.Unknown=6]="Unknown",t.AnalyticsEvent=void 0,(i=t.AnalyticsEvent||(t.AnalyticsEvent={})).PushComposite="analyticsPush",i.CreateComposite="analyticsCreate",i.PullComposite="analyticsPull",i.PullCompositeVersion="analyticsPullVersion",i.UploadComponent="analyticsUpload",i.DownloadComponent="analyticsDownload",i.All="*",t.LogLevel=void 0,(a=t.LogLevel||(t.LogLevel={}))[a.Deprecated=0]="Deprecated",a[a.Error=1]="Error",a[a.Warn=2]="Warn",a[a.Log=3]="Log",a[a.Debug=4]="Debug";const h={[t.LogLevel.Deprecated]:"error",[t.LogLevel.Error]:"error",[t.LogLevel.Log]:"log",[t.LogLevel.Warn]:"warn",[t.LogLevel.Debug]:"debug"};class u extends d.EventEmitter{constructor(e){super([t.AnalyticsEvent.CreateComposite,t.AnalyticsEvent.UploadComponent,t.AnalyticsEvent.PushComposite,t.AnalyticsEvent.PullComposite,t.AnalyticsEvent.PullCompositeVersion,t.AnalyticsEvent.DownloadComponent]),this._logLevel=t.LogLevel.Warn,this._prevDebugTime=d.now(),this._debugFormatter=(e,t,r,s)=>`[${e} (+${(1e3*(t-r)).toFixed(0)})] ${s.map((e=>"string"==typeof e?e:JSON.stringify(e))).join(" ")}`,this._debugNamespaces=[],this._debugSkips=[],this.suppressDeprecationWarnings=!1,e&&(this._logCallback=e),this._initNamespaces()}get debugNamespaces(){return this._debugNamespaces}get debugSkips(){return this._debugSkips}set logLevel(e){if(!Object.values(t.LogLevel).includes(e))throw new Error(`Invalid LogLevel, must be one of: ${Object.values(t.LogLevel).join(", ")}.`);this._logLevel=e}get logLevel(){return this._logLevel}on(e,r){if(e!==t.AnalyticsEvent.All)return super.on(e,r);const s=Object.values(t.AnalyticsEvent);let o;for(let e=0,t=s.length;e<t;e++){const t=s[e];o=super.on(t,r)}return o}static getInstance(){return null==u._instance&&(u._instance=new u),u._instance}static newLogger(e){return new u(e)}set logCallback(e){this._logCallback=e}get logCallback(){return this._logCallback}_initNamespaces(){d.isNode()?this.setDebugNamespaces(process.env.DCX_DEBUG||""):d.isObject(globalThis)&&d.isObject(globalThis.dcxjs)&&this.setDebugNamespaces(globalThis.dcxjs.debug||""),this._debugNamespaces.length>0&&(this._logLevel=t.LogLevel.Debug)}_log(e,r,s){try{if(e===u.LEVEL_DEPRECATED)!this.suppressDeprecationWarnings&&this._logLevel>=e&&console.warn(...s);else if("function"==typeof this._logCallback&&this._logLevel>=e)this._logCallback.call(void 0,...s);else if(this._logLevel>=e)if(e===t.LogLevel.Debug){if(this._debugEnabled(r)){const e=this._prevDebugTime;this._prevDebugTime=d.now(),(console.debug||console.log)(this._debugFormatter(r,this._prevDebugTime,e,s))}}else console[h[e]](...s)}catch(e){}}log(...e){this._log(t.LogLevel.Log,void 0,e)}warn(...e){this._log(t.LogLevel.Warn,void 0,e)}error(...e){this._log(t.LogLevel.Error,void 0,e)}deprecated(...e){this._log(t.LogLevel.Deprecated,void 0,e)}_debugEnabled(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=this._debugSkips.length;t<r;t++)if(this._debugSkips[t].test(e))return!1;for(t=0,r=this._debugNamespaces.length;t<r;t++)if(this._debugNamespaces[t].test(e))return!0;return!1}setDebugFormatter(e){this._debugFormatter=e}setDebugNamespaces(e){let t;this._debugNamespaces=[],this._debugSkips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(t=0;t<s;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?this._debugSkips.push(new RegExp("^"+e.substr(1)+"$")):this._debugNamespaces.push(new RegExp("^"+e+"$")))}Debug(e){return(...r)=>{this._log(t.LogLevel.Debug,e,r)}}}u.LEVEL_DEBUG=t.LogLevel.Debug,u.LEVEL_LOG=t.LogLevel.Log,u.LEVEL_WARN=t.LogLevel.Warn,u.LEVEL_ERROR=t.LogLevel.Error,u.LEVEL_DEPRECATED=t.LogLevel.Deprecated;const p=()=>{const e=f();return void 0!==e._logCallback?e:u.getInstance()},f=()=>{if("object"==typeof globalThis&&"object"==typeof globalThis.dcxjs&&globalThis.dcxjs.logger&&globalThis.dcxjs.logger.getInstance)return globalThis.dcxjs.logger.getInstance();const e=()=>{};return{log:e,warn:e,error:e,deprecated:e,debug:e,newLogger:f}};var _=p();t.AdobeDCXLogger=u,t.default=_,t.emitAnalyticsEvent=(e,t)=>{const r=p(),s=c(e,t);try{r.emit(e,[s])}catch(e){r.error("Error in analytics hook: ",e)}},t.getGlobalLogger=f,t.getGlobalOrLocalLogger=p,t.log=(...e)=>{const t=p();e.forEach(t.log.bind(t))},t.makeAnalyticsEvent=c,t.newDebug=e=>p().Debug(e),t.setLogCallback=e=>{f().logCallback=e}},14200:(e,t,r)=>{var s=void 0!==r.g?r.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}var i=o,a=n;function d(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}"function"==typeof s.setTimeout&&(i=setTimeout),"function"==typeof s.clearTimeout&&(a=clearTimeout);var c,l=[],h=!1,u=-1;function p(){h&&c&&(h=!1,c.length?l=c.concat(l):u=-1,l.length&&f())}function f(){if(!h){var e=d(p);h=!0;for(var t=l.length;t;){for(c=l,l=[];++u<t;)c&&c[u].run();u=-1,t=l.length}c=null,h=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===n||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function _(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];l.push(new m(e,t)),1!==l.length||h||d(f)}function m(e,t){this.fun=e,this.array=t}function E(){}m.prototype.run=function(){this.fun.apply(null,this.array)};var g,A=E,C=E,D=E,I=E,y=E,v=E,T=E,b=s.performance||{},P=b.now||b.mozNow||b.msNow||b.oNow||b.webkitNow||function(){return(new Date).getTime()},R=new Date,w={nextTick:_,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:A,addListener:C,once:D,off:I,removeListener:y,removeAllListeners:v,emit:T,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*P.call(b),r=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(r-=e[0],(s-=e[1])<0&&(r--,s+=1e9)),[r,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-R)/1e3}},O="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{};(function(e,t){e.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,s=void 0,o=void 0,n=function(e,t){u[r]=e,u[r+1]=t,2===(r+=2)&&(o?o(p):f())};var i="undefined"!=typeof window?window:void 0,a=i||{},d=a.MutationObserver||a.WebKitMutationObserver,c="undefined"==typeof self&&void 0!==w&&"[object process]"==={}.toString.call(w),l="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function h(){var e=setTimeout;return function(){return e(p,1)}}var u=new Array(1e3);function p(){for(var e=0;e<r;e+=2)(0,u[e])(u[e+1]),u[e]=void 0,u[e+1]=void 0;r=0}var f=void 0;function m(e,t){var r=this,s=new this.constructor(A);void 0===s[g]&&S(s);var o=r._state;if(o){var i=arguments[o-1];n((function(){return R(o,s,i,r._result)}))}else b(r,s,e,t);return s}function E(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(A);return I(t,e),t}f=c?function(){return _(p)}:d?function(){var e=0,t=new d(p),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}():l?function(){var e=new MessageChannel;return e.port1.onmessage=p,function(){return e.port2.postMessage(0)}}():void 0===i?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:h()}catch(e){return h()}}():h();var g=Math.random().toString(36).substring(2);function A(){}var C=void 0;function D(t,r,s){r.constructor===t.constructor&&s===m&&r.constructor.resolve===E?function(e,t){1===t._state?v(e,t._result):2===t._state?T(e,t._result):b(t,void 0,(function(t){return I(e,t)}),(function(t){return T(e,t)}))}(t,r):void 0===s?v(t,r):e(s)?function(e,t,r){n((function(e){var s=!1,o=function(e,t,r,s){try{e.call(t,r,s)}catch(e){return e}}(r,t,(function(r){s||(s=!0,t!==r?I(e,r):v(e,r))}),(function(t){s||(s=!0,T(e,t))}),e._label);!s&&o&&(s=!0,T(e,o))}),e)}(t,r,s):v(t,r)}function I(e,t){if(e===t)T(e,new TypeError("You cannot resolve a promise with itself"));else if(function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)){var r=void 0;try{r=t.then}catch(t){return void T(e,t)}D(e,t,r)}else v(e,t)}function y(e){e._onerror&&e._onerror(e._result),P(e)}function v(e,t){e._state===C&&(e._result=t,e._state=1,0!==e._subscribers.length&&n(P,e))}function T(e,t){e._state===C&&(e._state=2,e._result=t,n(y,e))}function b(e,t,r,s){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+1]=r,o[i+2]=s,0===i&&e._state&&n(P,e)}function P(e){var t=e._subscribers,r=e._state;if(0!==t.length){for(var s=void 0,o=void 0,n=e._result,i=0;i<t.length;i+=3)s=t[i],o=t[i+r],s?R(r,s,o,n):o(n);e._subscribers.length=0}}function R(t,r,s,o){var n=e(s),i=void 0,a=void 0,d=!0;if(n){try{i=s(o)}catch(t){d=!1,a=t}if(r===i)return void T(r,new TypeError("A promises callback cannot return that same promise."))}else i=o;r._state!==C||(n&&d?I(r,i):!1===d?T(r,a):1===t?v(r,i):2===t&&T(r,i))}var N=0;function S(e){e[g]=N++,e._state=void 0,e._result=void 0,e._subscribers=[]}var L=function(){function e(e,r){this._instanceConstructor=e,this.promise=new e(A),this.promise[g]||S(this.promise),t(r)?(this.length=r.length,this._remaining=r.length,this._result=new Array(this.length),0===this.length?v(this.promise,this._result):(this.length=this.length||0,this._enumerate(r),0===this._remaining&&v(this.promise,this._result))):T(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===C&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var r=this._instanceConstructor,s=r.resolve;if(s===E){var o=void 0,n=void 0,i=!1;try{o=e.then}catch(e){i=!0,n=e}if(o===m&&e._state!==C)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(r===k){var a=new r(A);i?T(a,n):D(a,e,o),this._willSettleAt(a,t)}else this._willSettleAt(new r((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,r){var s=this.promise;s._state===C&&(this._remaining--,2===e?T(s,r):this._result[t]=r),0===this._remaining&&v(s,this._result)},e.prototype._willSettleAt=function(e,t){var r=this;b(e,void 0,(function(e){return r._settledAt(1,t,e)}),(function(e){return r._settledAt(2,t,e)}))},e}();var k=function(){function t(e){this[g]=N++,this._result=this._state=void 0,this._subscribers=[],A!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){I(e,t)}),(function(t){T(e,t)}))}catch(t){T(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var r=this,s=r.constructor;return e(t)?r.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):r.then(t,t)},t}();return k.prototype.then=m,k.all=function(e){return new L(this,e).promise},k.race=function(e){var r=this;return t(e)?new r((function(t,s){for(var o=e.length,n=0;n<o;n++)r.resolve(e[n]).then(t,s)})):new r((function(e,t){return t(new TypeError("You must pass an array to race."))}))},k.resolve=E,k.reject=function(e){var t=new this(A);return T(t,e),t},k._setScheduler=function(e){o=e},k._setAsap=function(e){n=e},k._asap=n,k.polyfill=function(){var e=void 0;if(void 0!==O)e=O;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=k},k.Promise=k,k}()}(g={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&g.path)}},g.exports),g.exports).polyfill(),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(t||0,e.length)===e})},528224:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(29578);const o=e=>"[object Function]"===toString.call(e);class n{constructor(e,t){return this._promise=null,this._props={},this._registeredProps=[],this._handlers={cancel:[]},this._done=!1,this._canceled=!1,this._internalKeys=[],this.name="AdobePromise",this._internalKeys=[...Object.keys(this),...Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(this))),"_cancelReason"],t&&"object"==typeof t&&this._setProps(t),this._promise=new Promise(((t,r)=>e.call(this,(e=>{this._done||(this._done=!0,t(e))}),(e=>{this._done||(this._done=!0,r(e))}),this._registerCancelHandler.bind(this)))),new Proxy(this,{set:function(e,t,r){if(e._internalKeys.includes(t)){if(!["_promise","_canceled","_cancelReason","_props","_registeredProps"].includes(t))throw new Error("Cannot overwrite internal AdobePromise property.");e[t]=r}else e._registeredProps.includes(t)||e._registeredProps.push(t),e.props[t]=r;return!0},get:function(e,t){return"symbol"==typeof t||e._internalKeys.includes(t)?e[t]:e.props[t]}})}get[Symbol.toStringTag](){return this.name}static reject(e,t){return new i(((t,r)=>Promise.reject(e).catch((e=>{r&&r(e)}))),t)}static resolve(e,t){return new i((t=>{s.isObject(e)&&o(e.then)?e.then((e=>{t(e)})):t(e)}),t)}static allSettled(e,t){return 0===e.length?i.resolve([],t):new i((t=>{const r=[];e.map(((s,o)=>{s.then((e=>{r[o]={status:"fulfilled",value:e}})).catch((e=>{r[o]={status:"rejected",reason:e}})).then((()=>{r.filter((e=>!!e)).length===e.length&&t(r)}))}))}),t)}get canceled(){return this._canceled}getPromise(){return this._promise}_resolveOrReject(e,t){return this._promise.then((r=>this._canceled?t&&t(this._cancelReason):e(r))).catch((e=>t&&t(this._cancelReason||e)))}then(e,t){if(null==e&&null==t)return this;const r=new i(((e,t,r)=>(r&&r((e=>{this.cancel.call(this,e),t&&t(e)})),this._resolveOrReject.call(this,e,t))),this._props);return r._promise=r.getPromise().then((t=>{const s=e&&e(t);if(s instanceof i){const e=s;this.onCancel((t=>e.cancel(t)));for(const t in this.props)null==e.props[t]&&(e.props[t]=this.props[t]);e._setProps(e.props),this._setProps(e.props),r._setProps(e.props)}return s})).catch(t),r}parallel(e,t){return this._promise.then(e,t)}catch(e){return this._promise=this._promise.catch(e),this}finally(e){return this._promise=this._promise.finally(e),this}cancel(e){this._canceled||(this._canceled=!0,this._cancelReason=e,this._callHandlers("cancel",e||new Error("Aborted")))}abort(e){this.cancel(e)}onCancel(e){o(e)&&this._registerCancelHandler(e)}get props(){return this._props}_setProps(e){if(this._props===e)return;this._props=e;const t=[],r=Object.getOwnPropertyDescriptors(i),s=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(e));if(s.constructor.value!==Object)for(const o in s){if(o in r||o in this&&!this._registeredProps.includes(o))continue;t.push(o);const n=s[o],i=Object.assign({},n);delete i.get,delete i.set,(n.get||n.set)&&(delete i.value,delete i.writable,n.get&&(i.get=n.get.bind(e)),n.set&&(i.set=n.set.bind(e))),Object.defineProperty(this,o,i)}for(const s of Object.keys(e))t.push(s),s in r||s in this&&!this._registeredProps.includes(s)||Object.defineProperty(this,s,{get:()=>this._props[s],set:e=>{this._props[s]=e},configurable:!0});return this._registeredProps=t,this}_registerCancelHandler(e){this._handlers.cancel.push(e)}_callHandlers(e,t){this._handlers[e].map((e=>e&&e(t)))}_destroy(){this._handlers.cancel=[]}}const i=n,a=i;t.AdobePromise=a,t.default=i},616189:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(915561),o=r(6035),n=r(464964),i=r(528224),a=r(29578);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=d(o),l=d(i);class h{constructor(e,t,r,s,o,n){this.id=e,this.etag=t,this.version=r,this.md5=s,this.length=o,this.type=n}}class u{constructor(e,t,r){this.compositeId=e,this.compositeAssetId=t,this.repositoryId=r,this.records={}}addUploadRecord(e,t){a.validateParams(["componentId",e,"string"],["record",t,"object"]),this.records[e]=t}getComponentDescriptor(e){const t=this._checkRAPIComponentParams(e);return JSON.stringify(function(e,t,r,s){try{a.validateObject(s,"UploadRecord",["id","string"],["version","string"],["length","number"],["etag","string"],["type","string"])}catch(e){throw new o.DCXError(o.DCXError.INVALID_STATE,"Invalid record data",e)}const n={versionId:"0",componentId:s.id,cloudAssetId:e,compositeId:t,repositoryId:r,componentRevisionId:s.version,type:s.type,cloudExpiration:void 0,size:s.length,etag:s.etag,hashType:"md5",hashValue:s.md5};return a.pruneUndefined(n)}(this.compositeAssetId,this.compositeId,this.repositoryId,t))}getComponentURL(e,t){const r=this._checkRAPIComponentParams(t);return e.getCompositeComponentUrlForDownload({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,r.length,r.version)}getComponent(e,t,r){const s=this._checkRAPIComponentParams(t);return e.getCompositeComponent({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,s.version,r)}_checkRAPIComponentParams(e){if(!this.repositoryId)throw new o.DCXError(o.DCXError.INVALID_STATE,"Repository ID must be defined.",void 0,void 0,{componentId:e});const t=this.records[e];if(!t)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"UploadRecord does not exist",void 0,void 0,{componentId:e});return t}}function p(e,t,r){return a.validateParams(["compositeId",e,"string",!0],["compositeAssetId",t,"string"],["repositoryId",r,["string","undefined"]]),new u(e,t,r)}function f(e,t,r,s,o,n){return a.validateParams(["componentId",e,"string"],["etag",t,"string"],["version",r,"string"],["md5",s,"string"],["length",o,"number"],["type",n,"string"]),new h(e,t,r,s,o,n)}function _(e,t,r){a.validateParams(["repoUploadResults",t,"object"],["compositeId",r,"string",!0]),a.validateObject(t,"repoUploadResults",["result","object"]);const o=t.asset||t.compositeAsset,{result:n}=t;if(!(o.assetId&&o.repositoryId||o.links||n.links))throw new c.default(c.default.INVALID_PARAMS,"AdobeRepoUploadResult#asset object missing repositoryId or assetId, and links");const i=f(n.id,n.etag,n.revision,n.md5,n.length,n.type);let d;if(o.assetId&&o.repositoryId)d=l.default.resolve(p(r,o.assetId,o.repositoryId));else{a.validateParams(["session",e,"object"]);const t=o.links||n.links,i=s.assertLinksContainAny(t,[s.LinkRelation.PRIMARY,s.LinkRelation.ID,s.LinkRelation.PATH,s.LinkRelation.COMPONENT]),l=a.getLinkHrefTemplated(t,i,{component_id:"manifest"});d=e.headHTTPResource(l).then((e=>{const t=e.headers["repository-id"],s=e.headers["asset-id"];if(!t||!s)throw new c.default(c.default.INVALID_DATA,"Fetched data missing repositoryId or assetId");return p(r,s,t)}))}return d.then((e=>(e.addUploadRecord(n.id,i),e)))}const m=n.newDebug("dcx:repoapisession"),E=n.AdobeDCXLogger.getInstance();class g{constructor(e,t,r){this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._blockUploadThreshold=s.DEFAULT_BLOCK_UPLOAD_THRESHOLD,this._blockDownloadThreshold=s.DEFAULT_BLOCK_DOWNLOAD_THRESHOLD,a.validateParams(["httpService",e,"object"],["server",t,"string"]),this._service=e,this._service._repoAPIBaseUrl=t;const o=a.endPointOf(t);if(!o)throw new c.default(c.default.INVALID_PARAMS,"Could not determine endpoint from: "+t);this._endPoint=o,a.isObject(r)&&a.isFunction(r.getIndexLinks)?this._linksCache=r:this._linksCache=new s.RepositoryLinksCache}get serviceConfig(){return{service:this._service,cache:this._linksCache}}get blockUploadThreshold(){return this._blockUploadThreshold}set blockUploadThreshold(e){a.validateParam("threshold",e,"+number"),this._blockUploadThreshold=e}get blockDownloadThreshold(){return this._blockDownloadThreshold}set blockDownloadThreshold(e){a.validateParam("threshold",e,"+number"),this._blockDownloadThreshold=e}createAsset(e,t,r,o,n,i){return this.fetchLinksIfMissing(e,[s.LinkRelation.CREATE],i).then((()=>s.createAsset(this._service,e,t,r,o,n,i))).then((e=>(this._linksCache.setValueWithAsset(e.result.links,e.result),e)))}createComposite(e,t,r,n,i){if(m("createComposite()"),a.validateParams(["parentDir",e,"object"],["relPath",t,"string"],["contentType",r,"string"]),!r.endsWith("+dcx"))throw new c.default(c.default.INVALID_PARAMS,'Composite contentType must end in "+dcx"');if(!s.isMinimalAdobeAsset(e))throw new c.default(c.default.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return this.createAsset(e,t,!0,r,n,i).then((e=>(this._linksCache.setValueWithAsset(e.result.links,e.result),e))).catch((r=>{if(!r.response||409!==r.response.statusCode)throw o.unexpectedResponse("Error creating composite",r,r.response);if(r.response.headers.link){const t=s.parseLinksFromResponseHeader(r.response);this._linksCache.setValueWithAsset(t,{assetId:r.response.headers["asset-id"]||r.response.headers["x-resource-id"],repositoryId:e.repositoryId})}throw new c.default(c.default.ALREADY_EXISTS,"Composite already exists at "+t,void 0,r.response)}))}getIndexLinks(e){return s.getIndexLinks(this.serviceConfig,e)}getIndexRepository(e){return s.getIndexRepository(this._service,e)}getIndexDocument(e){return s.getIndexDocument(this._service,e)}getDiscoverableAssets(e={},t){return s.getDiscoverableAssets(this.serviceConfig,e,t)}getDiscoverableRepos(e={},t){return s.getDiscoverableRepos(this.serviceConfig,e,t)}headHTTPResource(e,t){return s.headHTTPResource(this._service,e,t)}headCompositeManifest(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.COMPONENT],t).then((()=>s.headCompositeManifest(this._service,e,t)))}resolveAsset(e,t="id",r,o,n){return s.resolveAsset(this.serviceConfig,e,t,r,o,n)}headPrimaryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],t).then((()=>s.headPrimaryResource(this._service,e,t)))}getRepoMetadata(e,t){return this.useLinkOrResolveResource(e,s.LinkRelation.REPO_METADATA,"json",t).then((e=>({result:s.deserializeAsset(e.response.response),response:e.response})))}getEmbeddedMetadata(e,t="json",r){return a.validateParams(["asset",e,"object"],["format",t,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],r).then((()=>s.getEmbeddedMetadata(this._service,e,t)))}putEmbeddedMetadata(e,t,r,o="json",n){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0],["format",o,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],n).then((()=>s.putEmbeddedMetadata(this._service,e,t,r,o,n)))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA]).then((()=>s.patchEmbeddedMetadata(this._service,e,t,r)))}getDirectory(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedChildren(this._service,e,t,r).then((e=>({result:s.directoryTransformer(e.paged.data)[1],paged:e.paged,response:e.response})))))}getDirectoryByURL(e){return s.getDirectoryByURL(this._service,e).then((e=>({response:e.response,result:s.deserializeAsset(e.result)})))}getLinksForAsset(e,t){return s.getLinksForAsset(this.serviceConfig,e,t)}getACLPolicy(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.getACLPolicy(this._service,e,t)))}getPrimaryResource(e,t,r){const o={};return this._withSourcePromise(o).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],r))).then((()=>s.getPrimaryResource.call(o,this._service,e,t,r)))}updatePrimaryResource(e,t,r,o,n,i,a){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],a).then((()=>s.updatePrimaryResource(this._service,e,t,r,o,n,i,a)))}getRepositoryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.REPOSITORY],t).then((()=>s.getRepositoryResource(this._service,e,t)))}getVersions(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedVersions(this._service,e,t,r).then((e=>({result:s.deserializeVersionSet(e.result),response:e.response,paged:e.paged})))))}getVersionResource(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getVersionResource(this._service,e,t,r).then((e=>({result:s.deserializeVersion(e.result),response:e.response})))))}blockDownloadAsset(e,t,r,o,n,i,a){if("string"==typeof e)return s.doBlockDownload(this._service,e,t,r,o,n,i,a);const d={};return this._withSourcePromise(d).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY]))).then((()=>s.doBlockDownload.call(d,this._service,e,t,r,o,n,i,a)))}fetchLinksIfMissing(e,t,r){return s.fetchLinksIfMissing(this.serviceConfig,e,t,void 0,r).then((t=>{if(e.links!==t){if(a.isFunction(e.setLinks)){const r=e.links||{};e.setLinks(a.merge(r,t))}else e.links=a.merge(e.links||{},t);this._linksCache.setValueWithAsset(e.links,e)}return t}))}useLinkOrResolveResource(e,t,r,o){return s.useLinkOrResolveResource(this.serviceConfig,e,t,r,o).then((t=>(e.links!==t.result.links&&(e.links=a.merge(e.links||{},t.result.links),this._linksCache.setValueWithAsset(e.links,e)),t)))}getLinkHrefForAsset(e,t,r="id",s){return this.fetchLinksIfMissing(e,[t],s).then((e=>a.getLinkHref(e,t,r)))}getEffectivePrivileges(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.EFFECTIVE_PRIVILAGES],t).then((()=>s.getEffectivePrivileges(this._service,e,t)))}checkACLPrivilege(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACCESS_CHECK],o).then((()=>s.checkACLPrivilege(this._service,e,t,r,o)))}headAppMetadata(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],t).then((()=>s.headAppMetadata(this._service,e,t)))}getAppMetadata(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],r).then((()=>s.getAppMetadata(this._service,e,t,r)))}putAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.putAppMetadata(this._service,e,t,r,o)))}patchAppMetadata(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA]).then((()=>s.patchAppMetadata(this._service,e,t,r)))}getCompositeManifestUrl(e,t,r){a.validateParams(["asset",e,"object"],["version",t,"string",!0]);const o=this._getAsAdobeAsset(e);return o.version=t||o.version,this.fetchLinksIfMissing(o,[s.LinkRelation.MANIFEST],r).then((()=>s.getCompositeManifestUrl(this._service,o,t,r)))}getCompositeManifest(e,t,r,o){a.validateParams(["asset",e,"object"],["version",t,"string",!0],["etag",r,"string",!0]);const n=this._getAsAdobeAsset(e);return n.version=t||n.version,this.fetchLinksIfMissing(n,[s.LinkRelation.MANIFEST],o).then((()=>s.getCompositeManifest(this._service,n,t,r,o)))}getManifestAndComponentsByPath(e,t,r,o,n){return s.getManifestAndComponentsByPath(this.serviceConfig.service,e,t,r,o,n)}getRendition(e,t,r,o,n){return this.fetchLinksIfMissing(e,[s.LinkRelation.RENDITION]).then((()=>s.getRendition(this._service,e,t,r,o,n)))}getCompositeComponentUrlForDownload(e,t,r,o,n){var i;const a=this._getAsAdobeAsset(e),d=null!==(i=this._isDCXComponentLike(e)?e.length:r)&&void 0!==i?i:0,{id:c,revision:l}=this._resolveComponentIdAndRevision(e,t,o);return d>this.blockDownloadThreshold?s.getCompositeComponentPresignedUrl(this.serviceConfig,a,c,l,n).then((({response:e,result:t})=>({response:e,isPresignedUrl:!0,url:t}))):this.getCompositeComponentUrl(a,c,l,n).then((e=>({response:void 0,url:e,isPresignedUrl:!1})))}getCompositeComponentUrl(e,t,r,o){const n=this._getAsAdobeAsset(e),{id:i,revision:d}=this._resolveComponentIdAndRevision(e,t,r,!1);return this.fetchLinksIfMissing(n,[s.LinkRelation.COMPONENT],o).then((()=>(a.validateParams(["asset",n,"object"],["componentId",i,"string"],["componentRevision",d,"string",!0]),s.getCompositeComponentUrl(this._service,n,i,d))))}getCompositeComponentByPath(e,t,r,o){return s.getCompositeComponentByPath(this._service,this._getAsAdobeAsset(e),t,r,o)}getCompositeComponent(e,t,r,o,n){const i=this._getAsAdobeAsset(e),{id:d,revision:c}=this._resolveComponentIdAndRevision(e,t,r);return this.fetchLinksIfMissing(i,[s.LinkRelation.COMPONENT],n).then((()=>(a.validateParams(["asset",e,"object"],["componentId",d,"string"],["componentRevision",c,"string"],["responseType",o,"enum",!0,s.STREAMABLE_RESPONSE_TYPES]),s.getCompositeComponent(this._service,i,d,c,o,n))))}putCompositeComponent(e,t,r,o,n,i,d,l,h){if(a.validateParams(["asset",e,"object"],["componentId",t,"string"],["contentType",o,"string"],["maybeIsNew",n,"boolean",!0],["size",i,"number",!0],["md5",d,"string",!0]),n&&!a.verifyUuid(t))throw new c.default(c.default.INVALID_PARAMS,"Component id is not a uuid");a.verifyUuid(t)||E.warn("Existing component id is not a uuid");const u=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(u,[s.LinkRelation.COMPONENT,s.LinkRelation.BLOCK_UPLOAD_INIT],h).then((()=>s.putCompositeComponent(this._service,e,t,r,o,n,i,d,l,h)))}performBulkRequest(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.BULK_REQUEST],o).then((()=>s.performBulkRequest(this._service,e,t,r,o)))}updateCompositeManifest(e,t,r,o=1,n,i){m("updateCompositeManifest()"),a.validateParams(["asset",e,"object"],["manifest",t,["object","string"]],["overwrite",r,"boolean"],["validationLevel",o,"+number"],["etag",n,"string",!0]);const d=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(d,[s.LinkRelation.MANIFEST],i).then((()=>s.updateCompositeManifest(this._service,d,t,r,o,n,i)))}patchVersions(e,t,r){return a.validateParams(["asset",e,"object"],["patchDoc",t,["string","array"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY]).then((()=>s.patchVersions(this._service,e,t,r)))}patchACLPolicy(e,t,r){return a.validateParams(["asset",e,"object"],["policy",t,["string","object"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY]).then((()=>s.isACPAccessControlListLike(t)?s.patchACLPolicy(this._service,e,t):s.patchACLPolicy(this._service,e,t,r)))}deleteACLPolicy(e){return a.validateParams(["asset",e,"object"]),this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY]).then((()=>s.deleteACLPolicy(this._service,e)))}copyAsset(e,t,r,o,n){return s.copyAsset(this.serviceConfig,e,t,r,o,n)}moveAsset(e,t,r,o){return s.moveAsset(this.serviceConfig,e,t,r,o)}deleteAsset(e,t,r){return s.deleteAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r).then((t=>(this._linksCache.deleteWithAsset(e),t)))}discardAsset(e,t,r){return s.discardAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r)}restoreAsset(e){return s.restoreAsset(this.serviceConfig,e)}packageAssets(e,t,r,o){return s.packageAssets(this.serviceConfig,e,t,r,o)}performOperation(e,t){return s.getOpsHref(this.serviceConfig,t).then((r=>s.doOperation(this._service,r,e,t)))}performBatchOperation(e,t){return s.getOpsHref(this.serviceConfig).then((r=>s.doBatchOperation(this._service,r,e,t)))}uploadResultsFromAdobeRepoUploadResult(e,t){return _(this,e,t)}updateCachedAssetLinks(e){if(!e.assetId)throw new c.default(c.default.INVALID_PARAMS,"Asset must contain an assetId");this._linksCache.setValueWithAsset(e.links||e._links,e)}updateCachedIndexLinks(e){if(!e)throw new c.default(c.default.INVALID_PARAMS,"Index LinkSet must not be null");this._linksCache.setIndexLinks(e)}getLinksCache(){return this._linksCache}setLinksCache(e){this._linksCache=e}clearLinksCache(){this._linksCache.clear()}_resolveComponentIdAndRevision(e,t,r,o=!0){var n;if(this._isDCXComponentLike(e))return{revision:e.version,id:e.id};if(!t)throw new c.default(c.default.INVALID_PARAMS,"Missing componentId.");if(!1===o||r)return{revision:r,id:t};if(!s.isAdobeDCXCompositeLike(e)||!t)throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");const i=null===(n=e.current)||void 0===n?void 0:n.getComponentWithId(t);if(void 0===(null==i?void 0:i.version))throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");return{revision:i.version,id:t}}_isDCXBranchLike(e){return!!a.isObject(e)&&(null!=e.compositeAssetId||null!=e.compositeRepositoryId||a.isObject(e._core))}_isDCXComponentLike(e){return!!a.isObject(e)&&null!=e.owner&&this._isDCXBranchLike(e.owner)}_withSourcePromise(e){return l.default.resolve(void 0,e)}_getAsAdobeAsset(e){if("object"!=typeof e||Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Invalid asset-like object.");if(s.isMinimalAdobeAsset(e))return e;let t,r={};if(("repositoryId"in e||"assetId"in e||"links"in e||"version"in e)&&(r={repositoryId:e.repositoryId,assetId:e.assetId,links:e.links,version:e.version}),this._isDCXBranchLike(e)&&(t=e._core),this._isDCXComponentLike(e)||t){const s=e,o=t||(s&&s.owner&&s.owner._core?s.owner._core:void 0);if(o){const e=o._getSourceAssetInfoOfComponent(r);e&&"object"==typeof e&&(r.assetId=e.compositeAssetId||r.assetId,r.repositoryId=e.compositeRepositoryId||r.repositoryId,r.links=e.links||r.links,r.version=e.version||r.version)}}const o=e,n=e;return r.assetId=r.assetId?r.assetId:o.owner?o.owner.compositeAssetId:n.compositeAssetId,r.repositoryId=r.repositoryId?r.repositoryId:o.owner?o.owner.compositeRepositoryId:n.compositeRepositoryId,r}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}_resolveUrl(e){return a.endPointOf(e)?e:a.appendPathElements(this._service._repoAPIBaseUrl||this._service.server,e)}registerLinks(e,t,r){e=e._links||e;const s={assetId:r||"urn:aaid:faux:"+a.generateUuid(),repositoryId:t||"faux-repo-id"};return this._linksCache.setValueWithAsset(e,s),s}}t.AdobeRepoAPISession=g,t.createRepoAPISession=(e,t,r)=>new g(e,t,r),t.createUploadRecord=f,t.createUploadResults=p,t.uploadResultsFromAdobeRepoUploadResult=_,t.uploadResultsFromComponentDescriptor=function(e){let t;a.validateParams(["decriptor",e,"string"]);try{t=JSON.parse(e)}catch(e){throw new c.default(c.default.INVALID_JSON,"Invalid component descriptor",e)}switch(t.versionId){case"0":case void 0:if(!t.repositoryId)throw new c.default(c.default.INVALID_DATA,"Component descriptor missing repositoryId");try{const e=p(t.compositeId,t.cloudAssetId,t.repositoryId),r=f(t.componentId,t.etag,t.componentRevisionId,t.hashValue,t.size,t.type);return e.addUploadRecord(t.componentId,r),e}catch(e){throw new c.default(c.default.INVALID_DATA,"Invalid component descriptor",e)}default:throw new c.default(c.default.INVALID_DATA,"ComponentDescriptor serialization versionId not valid or not yet handled.")}}},29578:(e,t,r)=>{var s=r(501933).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(855154),n=r(6035);const i=e=>a(e)&&(d(e.pipe)||d(e.pipeTo)),a=e=>null!=e&&"object"==typeof e,d=e=>"[object Function]"===toString.call(e),c=e=>Array.isArray(e),l=()=>{try{return"[object process]"===Object.prototype.toString.call(r.g.process)}catch(e){return!1}},h=()=>"object"==typeof self&&self.self===self,u=()=>"browser",p=(...e)=>{if(!e||!Array.isArray(e)||e.length<1)return{};const t=e.shift();for(;e.length>0;){const r=e.shift();if("object"==typeof r)for(const e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t},f=(e,...t)=>{if(!t.length)return e;const r=t.shift();if(a(e)&&a(r))for(const t in r)a(r[t])&&!c(r[t])?(e[t]||Object.assign(e,{[t]:{}}),f(e[t],r[t])):c(e[t])&&c(r[t])?Object.assign(e,{[t]:r[t]}):Object.assign(e,{[t]:r[t]});return f(e,...t)},_=/^(CON|PRN|AUX|NUL|COM\d|LPT\d)(\..+)?$/,m=/[\u0000-\u001F\u0022\u002A\u003A\u003C\u003E\u003F\u005C\u007F\u007C]/,E=(e,t=!1)=>{try{if(e.length>65535)return!1;const r=(t?e.slice(1):e).split("/");if(!r||0===r.length)return!1;for(const e of r){if(e.length<1||e.length>255)return!1;if(m.test(e))return!1;if(e.endsWith(".")||e.endsWith(" "))return!1;if(_.test(e))return!1;if(e.startsWith("dcx")||e.startsWith(".dcx"))return!1;if("manifest"===e||"mimetype"===e)return!1}return!(t&&(!e.startsWith("/")||e.endsWith("/")))}catch(e){return!1}},g=()=>{},A=(e,t,r)=>{const s={};let o,n=Object.keys(e),i=n.length;for(let d=0;d<i;d++){if(o=n[d],!r||!r[o]){const s=e[o],n=t[o];if(typeof s!=typeof n)return!1;if(a(s)&&a(n)){if(!A(s,n,r))return!1}else if(s!==n)return!1}s[o]=!0}n=Object.keys(t),i=n.length;for(let e=0;e<i;e++)if(o=n[e],!s[o])return!1;return!0},C=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),D=e=>{const t=e.match(C)||[];return{scheme:t[2],authority:t[4],path:t[5],query:t[7],fragment:t[9]}},I="0".charCodeAt(0),y="1".charCodeAt(0),v="9".charCodeAt(0),T="a".charCodeAt(0),b="A".charCodeAt(0),P="f".charCodeAt(0),R="F".charCodeAt(0),w=e=>{const t=e.charCodeAt(0);return t>=I&&t<=v||t>=T&&t<=P||t>=b&&t<=R},O=e=>e.length>=3&&"%"===e.charAt(0)&&w(e.charAt(1))&&w(e.charAt(2)),N=e=>{const t=e.charCodeAt(0);return t>=I&&t<=v?t-I:t>=T&&t<=P?10+t-T:t>=b&&t<=R?10+t-b:0},S="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.~",L="0123456789ABCDEF",k=e=>{const t=[];for(let r=0;r<128;++r)t.push(-1!==e.indexOf(String.fromCharCode(r)));return t},M=k("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.~:/?#[]@!$&'()*+,;="),X=k(S),x=k(S+"/"),U=(e,t)=>{if(e<128&&t[e])return String.fromCharCode(e);let r="%";return r+=L.charAt(e>>4&15),r+=L.charAt(15&e),r},B=e=>{const t=[];for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):++r<e.length&&(s=65536+((1023&s)<<10|1023&e.charCodeAt(r)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return t},j=(e,t)=>{const r=B(e);let s="";for(let e=0;e<r.length;e++)s+=U(r[e],t);return s},V=e=>(e=e.normalize("NFC"),j(e,X)),H=e=>{e=e.normalize("NFC");let t=0,r="";for(;t<e.length;)O(e.substr(t))?(r+=e.substr(t,3),t+=3):r+=j(e.charAt(t++),M);return r},F=(e,t)=>{let r=0,s="",o=!1,n=!1,i=!1,a=!0,d=!0,c=!1,l="",h="",u=",",p=-1;const f=e=>{if(s+=a?h:c||d?u:",",n&&l&&(a||c||d)&&(s+=V(l),(!i||e.length>0)&&(s+="=")),e){let t;t=o?H(e):V(e),p>0&&(t=((e,t)=>{let r=0;for(;r<e.length&&t>0;){if(O(e.substr(r))){let t=(N(e.substr(r+1))<<4)+N(e.substr(r+2));if(r+=3,192==(192&t))for(;r<e.length&&O(e.substr(r))&&(t=(N(e.substr(r+1))<<4)+N(e.substr(r+2)),r+=3,128==(192&t)););}else++r;--t}return e.substr(0,r)})(t,p)),s+=t}a=!1,d=!1};for(;r<e.length;)if("{"===e.charAt(r)){if(++r<e.length){switch(o=!1,n=!1,h="",u=",",i=!1,e.charAt(r++)){case"+":o=!0;break;case"#":h="#",o=!0;break;case".":h=".",u=".";break;case"/":h="/",u="/";break;case";":h=";",u=";",n=i=!0;break;case"?":h="?",u="&",n=!0;break;case"&":h="&",u="&",n=!0;break;default:--r}for(l="",a=!0,d=!0;r<e.length;)if("}"===e.charAt(r)||","===e.charAt(r)||"*"===e.charAt(r)||":"===e.charAt(r)){if(c=!1,p=-1,"*"===e.charAt(r)){if(c=!0,++r>=e.length)break}else if(":"===e.charAt(r)){if(++r>=e.length)break;for(e.charCodeAt(r)>=y&&e.charCodeAt(r)<=v&&(p=0);r<e.length&&e.charCodeAt(r)>=I&&e.charCodeAt(r)<=v&&p<1e4;)p=10*p+(e.charCodeAt(r++)-I);if(r>=e.length)break}for(;r<e.length&&"}"!==e.charAt(r)&&","!==e.charAt(r);)++r;if(l.length>0&&"*"===l.charAt(l.length-1)&&(c=!0,l=l.substr(0,l.length-1)),l.length>0){const e=t?t[l]:void 0;if(e||""===e)if(Array.isArray(e)){p=-1;for(let t=0;t<e.length;t++)f(String(e[t]))}else if("object"==typeof e&&null!==e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(_=t,m=String(e[t]),s+=a?h:c||d?u:",",n&&l&&a&&!c&&(s+=V(l),(!i||m.length>0)&&(s+="=")),_&&(s+=o?H(_):V(_),s+=c?"=":",",m&&(s+=o?H(m):V(m))),a=!1,d=!1);else f(String(e))}if("}"===e.charAt(r++))break;l="",d=!0}else l+=e.charAt(r++)}}else O(e.substr(r))?(s+=e.substr(r,3),r+=3):s+=j(e.charAt(r++),M);var _,m;return s},Y=(e,t)=>e&&t?e.indexOf(t):-1,W=e=>e?e.search("(text|image|audio|video|ingredient|document|model|application|font)\\/"):-1;function q(e){return this instanceof q?(this.v=e,this):new q(e)}function z(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof q?Promise.resolve(r.value.v).then(d,c):l(n[0][2],r)}catch(e){l(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function l(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function G(e,t){return e?(null!=t&&(e=e.slice(0,t)),(new TextDecoder).decode(e)):""}function K(e){return(new TextEncoder).encode(e)}const $=[/^(?!^501$|^507$)^(5\d{2})$|429|423$/],J=(e,t)=>{return"object"==typeof(r=e)&&"function"==typeof r.test?e.test(t.toString()):t===e;var r},Z=/^([^:]+):(.*)$/,Q=/^\s+|\s+$/g,ee=(e,t,r)=>c(t)?new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' type must be one of: [${t.join(",")}].${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`):new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' must be of type '${t}'.${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`),te=(e,t,r,s=!1,o=[])=>{if(s&&null==t)return!0;if(c(r)){for(const n in r){const i=r[n];try{return te(e,t,i,s,o),!0}catch(e){}}throw ee(e,r,o)}if("null"===r&&null!==t||"undefined"===r&&void 0!==t||"nullish"===r&&null!=t)throw ee(e,r,o);if("null"===r||"undefined"===r||"nullish"===r)return!0;if(!s&&null==t)throw ee(e,r,o);if(r.endsWith("[]")){if(!c(t))throw ee(e,r,o);return t.forEach(((t,s)=>{te(`${e}[${s}]`,t,r.substr(0,r.length-2))})),!0}let n=r.toLowerCase();switch(r){case"integer":case"+number":case"-number":n="number"}if("array"===n){if(!c(t))throw ee(e,r,o)}else if("enum"!==n){if(typeof t!==n)throw ee(e,r,o);if("integer"===r&&("number"!=typeof t||!Number.isInteger(t)))throw ee(e,r,o);if("+number"===r&&("number"!=typeof t||t<0))throw ee(e,r,o);if("-number"===r&&("number"!=typeof t||t>0))throw ee(e,r,o)}if(o.length>0){const s=o.length;let n=!1;for(let e=0;e<s;e++)if(o[e]===t){n=!0;break}if(!n)throw ee(e,r,o)}return!0};function re(...e){return e.map((e=>te(...e)))}function se(e,t){const r={};for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&void 0!==e[t]&&(r[t]=1);for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&delete r[e];return Object.keys(r)}function oe(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function ne(e,t,r,s=ne){if(e===t)return[];const o=c(e),n=c(t);return o&&n?function(e,t,r,s){const o={"0,0":{operations:[],cost:0}},n=isNaN(e.length)||e.length<=0?0:e.length,i=isNaN(t.length)||t.length<=0?0:t.length,a=function r(n,i){const a=`${n},${i}`;let d=o[a];if(void 0===d){if(n>0&&i>0&&!s(e[n-1],t[i-1],new de).length)d=r(n-1,i-1);else{const s=[];if(n>0){const e=r(n-1,i),t={op:"remove",index:n-1};s.push(oe(e,t))}if(i>0){const e=r(n,i-1),o={op:"add",index:n-1,value:t[i-1]};s.push(oe(e,o))}if(n>0&&i>0){const o=r(n-1,i-1),a={op:"replace",index:n-1,original:e[n-1],value:t[i-1]};s.push(oe(o,a))}d=s.sort(((e,t)=>e.cost-t.cost))[0]}o[a]=d}return d}(n,i).operations,[d]=a.reduce((([e,t],o)=>{if(function(e){return"add"===e.op}(o)){const s=o.index+1+t,i=s<n+t?String(s):"-",a={op:o.op,path:r.add(i).toString(),value:o.value};return[e.concat(a),t+1]}if(function(e){return"remove"===e.op}(o)){const s={op:o.op,path:r.add(String(o.index+t)).toString()};return[e.concat(s),t-1]}const i=r.add(String(o.index+t)),a=s(o.original,o.value,i);return[e.concat(...a),t]}),[[],0]);return d}(e,t,r,s):!o&&!n&&a(e)&&a(t)?function(e,t,r,s){const o=[];return se(e,t).forEach((e=>{o.push({op:"remove",path:r.add(e).toString()})})),se(t,e).forEach((e=>{o.push({op:"add",path:r.add(e).toString(),value:t[e]})})),function(e){const t=e.length,r={};for(let s=0;s<t;s++){const t=e[s];for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&(r[e]=(r[e]||0)+1)}for(const e in r)r[e]<t&&delete r[e];return Object.keys(r)}([e,t]).forEach((n=>{o.push(...s(e[n],t[n],r.add(n)))})),o}(e,t,r,s):[{op:"replace",path:r.toString(),value:t}]}function ie(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function ae(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class de{constructor(e=[""]){this.tokens=e}static fromJSON(e){const t=e.split("/").map(ie);if(""!==t[0])throw new n.DCXError(n.DCXError.INVALID_DATA,`Invalid JSON Pointer: ${e}`);return new de(t)}toString(){return this.tokens.map(ae).join("/")}evaluate(e){let t=null,r="",s=e;for(let e=1,o=this.tokens.length;e<o;e++)t=s,r=this.tokens[e],s=(t||{})[r];return{parent:t,key:r,value:s}}get(e){return this.evaluate(e).value}set(e,t){let r=e;for(let e=1,t=this.tokens.length-1,s=this.tokens[e];e<t;e++)r=(r||{})[s];r&&(r[this.tokens[this.tokens.length-1]]=t)}push(e){this.tokens.push(e)}add(e){const t=this.tokens.concat(String(e));return new de(t)}}class ce{constructor(e=[]){this._operations=e}get operations(){return this._operations}getDocument(){return JSON.stringify(this._operations)}add(e,t){return re(["path",e,"string"]),this._operations.push({op:"add",path:e,value:t}),this}addToList(e,t,r){if(re(["path",e,"string"]),"number"!=typeof r&&"end"!==r&&"-"!==r)throw new n.DCXError(n.DCXError.INVALID_PARAMS,'Index must be a number, or either "end"/"-" to append to end.');return this._operations.push({op:"add",value:t,path:`${e.endsWith("/")?e:e+"/"}${"end"===r?"-":r}`}),this}remove(e){return re(["path",e,"string"]),this._operations.push({op:"remove",path:e}),this}replace(e,t){return re(["path",e,"string"]),this._operations.push({op:"replace",path:e,value:t}),this}move(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"move",from:e,path:t}),this}copy(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"copy",from:e,path:t}),this}}function le(e,t){return{property:e,issue:t}}function he(e){const t=[];if("object"!=typeof e||null==e||c(e))return t.push(le("*","Operation not an object.")),t;switch("string"!=typeof e.path&&t.push(le("path","Missing or invalid.")),e.op){case"remove":break;case"add":case"replace":null==e.value&&t.push(le("value","Missing or invalid. Required for add/replace."));break;case"move":case"copy":"string"!=typeof e.from&&t.push(le("from","Missing or invalid. Required for move/copy."));break;default:t.push(le("op","Missing or invalid."))}return!(t.length>0)||t}function ue(e){if(!a(e))throw new Error("Expecting object");const t={};for(const r in e)null!=e[r]&&(t[r]=e[r]);return t}const pe=/^utf-?8|ascii|utf-?16-?le|ucs-?2|base-?64|latin-?1$/i,fe=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,_e=/\s|\uFEFF|\xA0/,me=/\r?\n[\x20\x09]+/g,Ee=/[;,"]/,ge=/[;,"]|\s/;function Ae(e){return e.replace(fe,"")}function Ce(e){return _e.test(e)}function De(e,t){for(;Ce(e[t]);)t++;return t}function Ie(e){return ge.test(e)}class ye{constructor(e){this.refs=[],e&&this.parse(e)}rel(e){const t=[];for(let r=0;r<this.refs.length;r++)this.refs[r].rel===e&&t.push(this.refs[r]);return t}get(e,t){e=e.toLowerCase();const r=[];for(let s=0;s<this.refs.length;s++)this.refs[s][e]===t&&r.push(this.refs[s]);return r}set(e){return this.refs.push(e),this}has(e,t){e=e.toLowerCase();for(let r=0;r<this.refs.length;r++)if(this.refs[r][e]===t)return!0;return!1}parse(e,t=0){let r=t?e.slice(t):e;r=Ae(r).replace(me,"");let s=1;const o=r.length;let n=0,i=null;for(;n<o;)if(1===s){if(Ce(r[n])){n++;continue}if("<"!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);{const e=r.indexOf(">",n);if(-1===e)throw new Error("Expected end of URI delimiter at offset "+n);i={uri:r.slice(n+1,e)},this.refs.push(i),n=e,s=2}n++}else if(2===s){if(Ce(r[n])){n++;continue}if(";"===r[n])s=4,n++;else{if(","!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);s=1,n++}}else{if(4!==s)throw new Error('Unknown parser state "'+s+'"');{if(";"===r[n]||Ce(r[n])){n++;continue}const e=r.indexOf("=",n);if(-1===e)throw new Error("Expected attribute delimiter at offset "+n);const t=Ae(r.slice(n,e)).toLowerCase();let a="";if(n=e+1,n=De(r,n),'"'===r[n])for(n++;n<o;){if('"'===r[n]){n++;break}"\\"===r[n]&&n++,a+=r[n],n++}else{let e=n+1;for(;!Ee.test(r[e])&&e<o;)e++;a=r.slice(n,e),n=e}if(i&&i[t]&&Te(t));else if(i&&"*"===t[t.length-1])i[t]=Pe(a);else if(a="rel"===t||"type"===t?a.toLowerCase():a,i&&null!=i[t]){const e=i[t];c(e)?e.push(a):i[t]=[i[t],a]}else{if(!i)throw new Error("Unexpected null ref");i[t]=a}switch(r[n]){case",":s=1;break;case";":s=4}n++}}return i=null,this}toString(){const e=[];let t,r="";for(let s=0;s<this.refs.length;s++)t=this.refs[s],r=Object.keys(this.refs[s]).reduce((function(e,r){return"uri"===r?e:e+"; "+Re(r,t[r])}),"<"+t.uri+">"),e.push(r);return e.join(", ")}}const ve=e=>pe.test(e),Te=e=>"rel"===e||"type"===e||"media"===e||"title"===e||"title*"===e,be=e=>e.replace(/"/g,'\\"'),Pe=e=>{const t=/([^']+)?(?:'([^']+)')?(.+)/.exec(e)||[];return{language:t[2].toLowerCase(),encoding:ve(t[1])?null:t[1].toLowerCase(),value:ve(t[1])?decodeURIComponent(t[3]):t[3]}},Re=(e,t)=>Array.isArray(t)?t.map((t=>Re(e,t))).join("; "):"*"===e[e.length-1]||"string"!=typeof t?((e,t)=>{const r=(t.encoding||"utf-8").toUpperCase(),o=t.language||"en";let n="";return n=s.isBuffer(t.value)&&ve(r)?t.value.toString(r):s.isBuffer(t.value)?t.value.toString("hex").replace(/[0-9a-f]{2}/gi,"%$1"):encodeURIComponent(t.value),e+"="+r+"'"+o+"'"+n})(e,t):((e=>"rel"===e||"type"===e||"anchor"===e)(e)?t=Ie(t)?'"'+be(t)+'"':be(t):Ie(t)&&(t='"'+(t=(t=encodeURIComponent(t)).replace(/%20/g," ").replace(/%2C/g,",").replace(/%3B/g,";"))+'"'),e+"="+t);function we(e,t,r,s="id"){const o=Le(e)[t];if(o){if(Array.isArray(o)){const e=o.filter((e=>e.mode===s));return e.length>0?e[0][r]:o.length>0?o[0][r]:void 0}return o[r]}}function Oe(e,t,r="id"){const s=Le(e),o=s[t];let i;if(a(o)&&"string"==typeof o.href?i=o.href:Array.isArray(o)&&(i=we(s,t,"href",r)),"string"!=typeof i)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Missing or invalid link href.");return i}function Ne(e,t,r,s="id"){const o=Oe(Le(e),t,s);return F(o,ue(r))}const Se=(e,t=0)=>(new ye).parse(e,t);function Le(e){return a(e)?"_links"in e?e._links:"links"in e?e.links:e:{}}function ke(e,t={mode:"id"}){let r=e[0],s=0;for(const o of e){let e=0;for(const r in o)r in t&&o[r]===t[r]&&e++;e>s&&(s=e,r=o)}return r}let Me;const Xe=()=>{if(Me)return Me;const e=l();return Me=e&&a(r.g.performance)&&d(r.g.performance.now)?r.g.performance:e&&a(r.g.perf_hooks)&&a(r.g.perf_hooks.performance)&&d(r.g.perf_hooks.performance.now)?r.g.perf_hooks.performance:h()&&a(self.performance)&&d(self.performance.now)?self.performance:Date,Me},xe=Object.freeze({__proto__:null,Link:ye,getLinkProperty:we,getLinkHref:Oe,getLinkHrefTemplated:Ne,parse:Se});t.DEFAULT_RETRY_CODES=$,t.EventEmitter=class{constructor(e){this._handlers={},e.forEach((e=>{this._handlers[e]=[]}))}on(e,t){return this._handlers[e].push(t)-1}emit(e,t){this._handlers[e].forEach((e=>{d(e)&&e(...t)}))}removeHandler(e,t){delete this._handlers[e][t]}removeAllHandlers(e){e?this._handlers[e]=[]:this._handlers={}}},t.JSONPatchPointer=de,t.Link=ye,t.LinkUtils=xe,t.SDKType=u,t.WatchProxy=function(e){if(e.__watch_proxy__)return e;if("watchProperty"in e)throw new Error("Cannot proxy object, watchProperty already exists.");let t={};const r=((e,r)=>{t[e]=t[e]||[],t[e].push(r)}).bind({listeners:t}),s={set:function(e,r,s){try{r in t&&c(t[r])&&t[r].map((t=>t.call(void 0,s,e[r],e)))}catch(e){throw e}return e[r]=s,!0}},{proxy:o,revoke:n}=Proxy.revocable(e,s);return Object.defineProperty(o,"__watch_proxy__",{value:!0,enumerable:!1,configurable:!0}),Object.defineProperty(o,"revokeWatchProxy",{value:()=>(n(),t={},delete e.__watch_proxy__,delete e.revokeWatchProxy,delete e.watchProperty,e),enumerable:!1,configurable:!0}),Object.defineProperty(o,"watchProperty",{value:r,enumerable:!1,configurable:!0}),o},t._toUTF8Array=B,t.appendPathElements=(...e)=>{if(!e||!Array.isArray(e))return"";const t=[],r=e.length;for(let s=0;s<r;s++){let o=e[s];"string"==typeof o&&""!==o&&(0===s&&1!==o.length||"/"===o.charAt(0)&&(o=o.slice(1)),s!==r-1&&"/"===o.charAt(o.length-1)&&(o=o.slice(0,o.length-1)),t.push(o))}return t.join("/")},t.arrayBufferToString=G,t.assert=(e,t)=>{if(!1===e())throw new n.DCXError(n.DCXError.INVALID_PARAMS,t)},t.asyncIterableFromStream=function(e){return z(this,arguments,(function*(){const t=e.getReader();try{for(;;){const{done:e,value:r}=yield q(t.read());if(e)return yield q(void 0);yield yield q(r)}}finally{t.releaseLock()}}))},t.checkRetriable=function(e,t=$){return!!e&&(Array.isArray(t)?t.some((t=>J(t,e))):J(t,e))},t.chunkArray=function(e,t){return e.reduce(((e,r,s)=>(s%t==0?e.unshift([r]):e[0].push(r),e)),[]).reverse()},t.combineInPlace=function(...e){if(e.length<2)return;const t=e.shift();p(t,...e),e.map((e=>{Object.assign(t,e)}))},t.concatUint8Arrays=function(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),r},t.consumeStream=(e,t,r)=>{e.on("data",r||g),e.on("end",t||g)},t.createJSONPatch=function(e,t,r){const s=new de;return(r?function(e){return function t(r,s,o){const n=e(r,s,o);return c(n)?n:ne(r,s,o,t)}}(r):ne)(e,t,s)},t.createPatchDocumentBuilder=function(e){return new ce(e)},t.dataToBuffer=function(e){return"string"==typeof e?K(e):e},t.deepCopy=e=>JSON.parse(JSON.stringify(e)),t.endPointOf=e=>{const t=D(e),r=t.scheme,s=t.authority,o="https"===r?443:"http"===r?80:-1;let n;return r&&s&&(n=(r+"://"+s).toLowerCase(),o>=0&&s.indexOf(":")<0&&(n=n+":"+o)),n},t.ensureRelativeHrefStartsWithSlash=e=>{if(e){const t=D(e),r=t.scheme,s=t.authority;r||s||"/"!==e.charAt(0)&&(e="/"+e)}return e},t.escapeURLPath=e=>(String.prototype.normalize?e=e.normalize("NFC"):console.warn("String.normalize not found while escaping URL path. You may be missing a polyfill."),e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),j(e,x)),t.expandURITemplate=F,t.flatCopy=e=>{const t={},r=Object.keys(e),s=r.length;for(let o=0;o<s;o++){const s=r[o];t[s]=e[s]}return t},t.generateUuid=()=>o.v4(),t.getDomainFromURL=e=>{if(!e||"string"!=typeof e)return e;const t=(e=(e=(e=(e=e.indexOf("//")>-1?e.split("/")[2]:e.split("/")[0]).split("?")[0]).split("/")[0]).split(":")[0]).split(".");return t.slice(Math.max(t.length-2,0)).join(".")},t.getFirstRegexpCapture=(e,t)=>{if(!e||"string"!=typeof e||!t)return"";let r;return r="string"==typeof t?e.match(t):t.exec(e),r?r[1]:""},t.getLinkHref=Oe,t.getLinkHrefTemplated=Ne,t.getLinkProperty=we,t.getPerformance=Xe,t.getStartIdxOfMimeType=W,t.getSuffixIdxOfMimeType=Y,t.hexVal=N,t.isAnyFunction=e=>"function"==typeof e,t.isArray=c,t.isArrayBuffer=e=>a(e)&&d(e.constructor)&&"ArrayBuffer"===e.constructor.name&&d(e.slice),t.isArrayBufferView=e=>a(e)&&d(e.constructor)&&"DataView"===e.constructor.name&&a(e.buffer)&&d(e.buffer.slice),t.isAsyncFunction=e=>"[object AsyncFunction]"===toString.call(e),t.isBrowser=h,t.isBrowserSDK=()=>!0,t.isBuffer=e=>a(e)&&d(e.constructor)&&"Buffer"===e.constructor.name&&d(e.slice),t.isDefined=e=>null!=e,t.isFunction=d,t.isHexChar=w,t.isJsonContentType=e=>{if("string"!=typeof e)return!1;const t=e.toLowerCase().split("application/");if(t.length<2)return!1;const r=t[1].split(";")[0].trim();return"json"===r||r.endsWith("+json")},t.isNode=l,t.isNodeReadableStream=e=>i(e)&&d(e.on),t.isObject=a,t.isPctEncoding=O,t.isPromise=e=>null!=e&&a(e)&&d(e.then),t.isReadableStream=i,t.isStreamProvider=e=>a(e)&&(d(e.getStream)||d(e.getStreamAsync)),t.isUndefined=e=>null==e,t.isValidAbsolutePath=e=>E(e,!0),t.isValidAdobeURN=e=>/^urn:aaid:[a-zA-Z]{2}:[a-zA-Z0-9]{2,6}:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),t.isValidPath=E,t.isVoid=e=>null==e,t.isWHATWGReadableStream=e=>i(e)&&d(e.pipeTo),t.isWebWorker=()=>h()&&!!self.WorkerGlobalScope,t.merge=p,t.mergeDeep=f,t.noOp=g,t.normalizeHeaders=e=>{if(null===e||"object"!=typeof e)return{};const t={};for(const[r,s]of Object.entries(e))t[r.toLowerCase()]=c(s)?s.join(";"):s;return t},t.now=()=>Xe().now(),t.objectFromEntries=function(e){const t={};for(const[r,s]of e)t[r]=s;return t},t.objectsEqual=A,t.parse=Se,t.parseHeaders=e=>{const t={},r=e.split(/\r?\n/);let s,o;for(let e=0;e<r.length;++e){const n=r[e];if(n.length>0){const e=n.charCodeAt(0);if(!s||9!==e&&32!==e){const e=Z.exec(n);e&&e.length>1&&(s=e[1].toLowerCase(),o=e[2]||"",o=o.replace(Q,""),t[s]?t[s]=t[s]+","+o:t[s]=o)}else t[s]=t[s]+" "+n.replace(Q,"")}}return t},t.parseURI=D,t.provideLink=function(e,t={},r){const s="function"==typeof t.selector?t.selector:ke,o=Array.isArray(e)?s(e,r):e;if(!o)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Could not select appropriate link for usage");return o.templated?"function"==typeof t.expander?t.expander(o.href,r):F(o.href,r):o.href},t.pruneUndefined=ue,t.removeLeadingSlashForPath=e=>(e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),e),t.safeGet=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},t.stringToBuffer=K,t.timeStamp=(e=!1)=>{let t=(new Date).getTime();return e&&(t-=t%1e3),t},t.validateJSONPatchDocument=function(e){if(!c(e))return[le("doc","Invalid type.")];const t=[];return e.forEach(((e,r)=>{const s=he(e);!0!==s&&s.forEach((e=>{e.property=`doc[${r}].${e.property}`,t.push(e)}))})),!(t.length>0)||t},t.validateJSONPatchOperation=he,t.validateObject=function(e,t,...r){if(t=t?" "+t+" ":" ",!e||"object"!=typeof e)throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid.`);try{r.forEach((t=>{te(t[0],e[t[0]],t[1],t[2]||!1,t[3]||[])}))}catch(e){throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid. ${e.message.replace("Param","Property")}`,e)}},t.validateParam=te,t.validateParams=re,t.verifyUuid=e=>o.validate(e),t.verifyandGetSnapshotMimetype=e=>{const t=G(e,100),r=Y(t,"+dcxucf"),s=W(t);return r>-1&&s>-1?t.substring(s,r+"+dcxucf".length):""},t.withRetries=function e(t,r=3){return t().catch((s=>{if(r)return e(t,r-1);throw s}))}},327350:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(29578);function o(e){return s.isObject(e)&&s.isArray(e.patchDocument)?e.patchDocument:[]}function n(e,t="dcx-js",r=(new Date).toISOString(),n=s.generateUuid()){const i=o(this),d=a(n,e,t,r);return s.createPatchDocumentBuilder(i).add("/xmpMM:History/@list/-",d).replace("/xmpMM:InstanceID",n).replace("/xmp:ModifyDate",r).replace("/xmp:MetadataDate",r).operations}function i(e,t,r){const n=o(this);return s.createPatchDocumentBuilder(n).add(`/${e}:${t}`,r).operations}function a(e,t,r,s){return{"stEvt:action":t,"stEvt:when":s,"stEvt:softwareAgent":r,"stEvt:instanceID":e}}function d(e="dcx-js",t,r=s.generateUuid(),o=(new Date).toISOString()){return`<rdf:li\n    stEvt:action="${t}"\n    stEvt:instanceID="xmp.iid:${r}"\n    stEvt:when="${o}"\n    stEvt:softwareAgent="${e}"/>`}function c(e="dcx-js",t=s.generateUuid(),r=(new Date).toISOString(),o,n){return o||(o=[d(e,"created",t,r)]),`<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 7.1.2">\n        <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">\n            <rdf:Description rdf:about=""\n            xmlns:xmp="http://ns.adobe.com/xap/1.0/"\n            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"\n            ${n?'xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#"':""}\n            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"\n            xmpMM:OriginalDocumentID="xmp.did:${t}"\n            xmp:ModifyDate="${r}"\n            xmp:MetadataDate="${r}"\n            xmp:CreatorTool="${e}"\n            xmp:CreateDate="${r}"\n            xmpMM:DocumentID="xmp.did:${t}"\n            xmpMM:InstanceID="xmp.iid:${t}">\n                <xmpMM:History>\n                    <rdf:Seq>\n                        ${o.join("\n")}\n                    </rdf:Seq>\n                </xmpMM:History>\n                ${n||""}\n            </rdf:Description>\n        </rdf:RDF>\n    </x:xmpmeta>`}class l{constructor(e){this._data=e}getElementsByTagName(e){return this._data.children.filter((t=>"string"!=typeof t&&t.tagName===e)).map(u)}}class h extends l{constructor(e){super(e),this._data=e}setAttribute(e,t){this._data.attributes[e]=t}getAttribute(e){return this._data.attributes[e]}appendChild(e,t={},r=[]){const s={tagName:e,attributes:t,children:r};return this._data.children.push(s),u(s)}}function u(e){return new h(e)}class p extends l{constructor(e){super(e)}parse(e){const t=function(e,t={}){let r=t.pos||0;const s=!!t.keepComments,o=!!t.keepWhitespace,n="<".charCodeAt(0),i=">".charCodeAt(0),a="-".charCodeAt(0),d="/".charCodeAt(0),c="!".charCodeAt(0),l="'".charCodeAt(0),h='"'.charCodeAt(0),u="[".charCodeAt(0),p="]".charCodeAt(0);function f(t){const l=[];for(;e[r];)if(e.charCodeAt(r)===n){if(e.charCodeAt(r+1)===d){const s=r+2;if(r=e.indexOf(">",r),-1===e.substring(s,r).indexOf(t)){const t=e.substring(0,r).split("\n");throw new Error("Unexpected close tag\nLine: "+(t.length-1)+"\nColumn: "+(t[t.length-1].length+1)+"\nChar: "+e[r])}return r+1&&(r+=1),l}if(e.charCodeAt(r+1)===c){if(e.charCodeAt(r+2)===a){const t=r;for(;-1!==r&&(e.charCodeAt(r)!==i||e.charCodeAt(r-1)!==a||e.charCodeAt(r-2)!==a||-1===r);)r=e.indexOf(">",r+1);-1===r&&(r=e.length),s&&l.push(e.substring(t,r+1))}else{if(e.charCodeAt(r+2)===u&&e.charCodeAt(r+8)===u&&"cdata"===e.substr(r+3,5).toLowerCase()){const t=e.indexOf("]]>",r);-1===t?(l.push(e.substr(r+9)),r=e.length):(l.push(e.substring(r+9,t)),r=t+3);continue}{const t=r+1;r+=2;let s=!1;for(;(e.charCodeAt(r)!==i||!0===s)&&e[r];)e.charCodeAt(r)===u?s=!0:!0===s&&e.charCodeAt(r)===p&&(s=!1),r++;l.push(e.substring(t,r))}}r++;continue}const o=A();l.push(o),"?"===o.tagName[0]&&(l.push(...o.children),o.children=[])}else{const e=m();(o||e.trim().length>0)&&l.push(e),r++}return l}function m(){const t=r;return r=e.indexOf("<",r)-1,-2===r&&(r=e.length),e.slice(t,r+1)}function E(){const t=r;for(;-1==="\r\n\t>/= ".indexOf(e[r])&&e[r];)r++;return e.slice(t,r)}const g=t.noChildNodes||["img","br","input","meta","link","hr"];function A(){r++;const t=E(),s={};let o=[];for(;e.charCodeAt(r)!==i&&e[r];){const n=e.charCodeAt(r);if(n>64&&n<91||n>96&&n<123){const n=E();let a,d=e.charCodeAt(r);for(;d&&d!==l&&d!==h&&!(d>64&&d<91||d>96&&d<123)&&d!==i;)r++,d=e.charCodeAt(r);if(d===l||d===h){if(a=C(),-1===r)return{tagName:t,attributes:s,children:o}}else a=null,r--;s[n]=a}r++}if(e.charCodeAt(r-1)!==d)if("script"===t){const t=r+1;r=e.indexOf("<\/script>",r),o=[e.slice(t,r)],r+=9}else if("style"===t){const t=r+1;r=e.indexOf("</style>",r),o=[e.slice(t,r)],r+=8}else-1===g.indexOf(t)?(r++,o=f(t)):r++;else r++;return{tagName:t,attributes:s,children:o}}function C(){const t=e[r],s=r+1;return r=e.indexOf(t,s),e.slice(s,r)}function D(){const r=new RegExp("\\s"+t.attrName+"\\s*=['\"]"+t.attrValue+"['\"]").exec(e);return r?r.index:-1}let I;if(void 0!==t.attrValue)for(t.attrName=t.attrName||"id",I=[];-1!==(r=D());)r=e.lastIndexOf("<",r),-1!==r&&I.push(A()),e=e.substr(r),r=0;else I=t.parseNode?A():f("");return t.simplify?_(Array.isArray(I)?I:[I]):I}(e);return this._data={children:s.isArray(t)?t:[t]},this}getElementsByTagName(e){return super.getElementsByTagName(e)}toString(){return function(e,t=!1){let r="",s=0;function o(e){if(s+=1,e){t&&e.length>0&&"string"!=typeof e[0]&&(r+="\r\n");for(let t=0;t<e.length;t++)"string"==typeof e[t]?r+=e[t].trim():n(e[t]);t&&e.length>0&&"string"!=typeof e[0]&&!r.endsWith("\r\n")&&(r+="\r\n")}s-=1}function n(e){r+=t?"<".padStart(s)+e.tagName:"<"+e.tagName;for(const t in e.attributes)null===e.attributes[t]?r+=" "+t:-1===e.attributes[t].indexOf('"')?r+=" "+t+'="'+e.attributes[t].trim()+'"':r+=" "+t+"='"+e.attributes[t].trim()+"'";"?"!==e.tagName[0]?(r+=">",o(e.children),t&&r.endsWith("\r\n")?r+="</".padStart(s)+e.tagName+">\r\n":r+=t?"</"+e.tagName+">\r\n":"</"+e.tagName+">"):r+=t?"?>\r\n":"?>"}return o(e),r}(this._data.children)}}function f(e){return(new p).parse(e)}function _(e){const t={};if(!e.length)return"";if(1===e.length&&"string"==typeof e[0])return e[0];e.forEach((function(e){if("object"!=typeof e)return;t[e.tagName]||(t[e.tagName]=[]);const r=_(e.children);t[e.tagName].push(r),Object.keys(e.attributes).length&&(r._attributes=e.attributes)}));for(const e in t)1===t[e].length&&(t[e]=t[e][0]);return t}function m(e,t,r){const s=e.getElementsByTagName(t),o=e.getAttribute(t);s.length<1&&null==o&&e.setAttribute(t,r)}t.XMLElement=h,t.XMLParser=p,t.appendHistoryEvent=n,t.deleteProperty=function(e,t){const r=o(this);return s.createPatchDocumentBuilder(r).remove(`/${e}:${t}`).operations},t.initializeXMPJSON=function(e="dcx-js",t=s.generateUuid(),r=(new Date).toISOString()){return{"xmp:ModifyDate":r,"xmp:MetadataDate":r,"xmp:CreatorTool":e,"@context":{xmpMM:"http://ns.adobe.com/xap/1.0/mm/",stEvt:"http://ns.adobe.com/xap/1.0/sType/ResourceEvent#",xmp:"http://ns.adobe.com/xap/1.0/"},"xmpMM:DocumentID":`xmp.did:${t}`,"xmpMM:History":{"@list":[{"stEvt:softwareAgent":e,"stEvt:action":"created","stEvt:when":r,"stEvt:instanceID":`xmp.iid:${t}`}]},"xmp:CreateDate":r,"@id":"","xmpMM:InstanceID":`xmp.iid:${t}`,"xmpMM:OriginalDocumentID":`xmp.did:${t}`}},t.initializeXMPXML=c,t.makeDerivedWithAction=function(e="dcx-js",t,r=s.generateUuid(),i=(new Date).toISOString()){const a=o(this),d=s.createPatchDocumentBuilder(a).add("/@context/stRef","http://ns.adobe.com/xap/1.0/sType/ResourceRef#").add("/@context/xmpMM","http://ns.adobe.com/xap/1.0/mm/").add("/xmpMM:DerivedFrom",{}).copy("/xmpMM:DocumentID","/xmpMM:DerivedFrom/stRef:documentID").copy("/xmp:ModifyDate","/xmpMM:DerivedFrom/stRef:lastModifyDate").copy("/xmpMM:InstanceID","/xmpMM:DerivedFrom/stRef:instanceID").copy("/xmpMM:OriginalDocumentID","/xmpMM:DerivedFrom/stRef:originalDocumentID").replace("/xmpMM:InstanceID",r).replace("/xmpMM:DocumentID",r);return n.call({patchDocument:d.operations},t,e,i,r)},t.makeDerivedWithXML=function(e,t,r,o=(new Date).toISOString()){return e||t||r||(e=s.generateUuid()),`<xmpMM:DerivedFrom\n        stRef:documentID="xmp.did:${t||r||e}"\n        stRef:instanceID="xmp.iid:${r||t||e}"\n        stRef:originalDocumentID="xmp.did:${e||t||r}"\n        stRef:lastModifyDate="${o}"/>`},t.makeHistoryEventXML=d,t.parseXML=f,t.registerNamespace=function(e,t){const r=o(this);return s.createPatchDocumentBuilder(r).add(`/@context/${t}`,e).operations},t.repairXMPXML=function(e,t="dcx-js",r=s.generateUuid(),o=(new Date).toISOString()){const n=f(e),i=n.getElementsByTagName("x:xmpmeta");if(i.length<1)return c(t,r,o);const a=i[0].getElementsByTagName("rdf:RDF");if(a.length<1)return c(t,r,o);const d=a[0].getElementsByTagName("rdf:Description");if(d.length<1)return c(t,r,o);const l=d[0];return m(l,"xmp:ModifyDate",o),m(l,"xmp:MetadataDate",o),m(l,"xmp:CreatorTool",t),m(l,"xmp:CreateDate",o),m(l,"xmpMM:DocumentID",`xmp.did:${r}`),m(l,"xmpMM:InstanceID",`xmp.iid:${r}`),m(l,"xmpMM:OriginalDocumentID",`xmp.did:${r}`),function(e){const t=["xmpMM:History","rdf:Seq"];let r=e;for(;t.length>0;){const e=t.shift(),s=r.getElementsByTagName(e);r=s.length>0?s[0]:r.appendChild(e)}}(l),n.toString()},t.setCreatorTool=function(e){return i.call(this,"xmp","CreatorTool",e)},t.setProperty=i,t.updateLastHistoryEvent=function(e,t,r){const n=o(this);if(null==e&&null==t&&null==r)return n;const i=s.createPatchDocumentBuilder(n);let d=a(s.generateUuid(),e,t,r);d=s.pruneUndefined(d);for(const e in d)i.replace(`/xmpMM:History/@list/-/${e}`,d[e]);return i.operations}}}]);
//# sourceMappingURL=vendor-startup-dcx.264b4b78248493bc5886.js.map